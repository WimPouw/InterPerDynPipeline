---
title: "CRQA Analysis"
author: "Fred Hasselman"
date: "2025-04-27"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    md_extensions: +hard_line_breaks
    highlight: pygments
    theme: spacelab
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, eval=TRUE}
knitr::opts_chunk$set(
	fig.align = "center",
	fig.height = 7,
	fig.width = 10,
	message = FALSE,
	warning = FALSE,
	collapse = FALSE,
	comment = ">",
	dpi = 72,
	tidy = FALSE,
	width = 800
)

```

```{css, echo=FALSE}
p code {
  font-size: 70%;
}
```
# Authors

**An Open-source Standardized Pipeline for Equitable Observations of Interactive Behavioral Dynamics: Theory-driven Measurement, Analysis, and Archiving**

Arkadiusz Białek^1^, Wim Pouw^2^, ^3^, Travis J. Wiltshire^2^, James Trujillo^4^, Fred Hasselman^5^, Babajide Alamu Owoyele^6^, Natalia Siekiera^1^ & Joanna Rączaszek-Leonardi^7^


1 Institute of Psychology, Jagiellonian University
2 Department of Cognitive Science & Artificial Intelligence, Tilburg University
3 Donders Institute for Brain, Cognition and Behaviour, Radboud University Nijmegen
4 Institute for Logic, Language and Computation, University of Amsterdam
5 Behavioural Science Institute, Radboud University Nijmegen
6 Artificial Intelligence and Intelligent Systems, Hasso Plattner Institute Potsdam
7 Human Interactivity and Language Lab, Faculty of Psychology, University of Warsaw


# Setup

Load some packages and set some variables... change the `path_repo` to the path where you downloaded the Github Repository (https://github.com/WimPouw/InterPerDynPipeline).

```{r load}
# Load packages
library(rio)
library(plyr)
library(tidyverse)
library(casnet) # If you have not installed it: devtools::install_github("FredHasselman/casnet")
library(invctr)
library(fpCompare)
library(gplots)
library(testthat)
library(report)


# Paths to files 
path_repo <- "/Users/fred/GitHub/InterPerDynPipeline"
path_meta <- file.path(path_repo,"meta")
path_oridata <- file.path(path_repo,"dataoutput_STEP1_2_timeseries")
path_results <- file.path(path_repo,"dataoutput_STEP3_nonlinearstatistics")
```

# Descriptive

Because the ages vary between measurement occasions, center ages on the mean of the first session.

```{r result}
meta_data <- rio::import(file.path(path_meta,"project_point_metadata_ages.csv"))
crqa_data <- rio::import(file.path(path_results, "crqa_results_all.csv"))

# Figures CRQA ----

# Ages and sessions
brk <- round(colMeans(meta_data[,3:9], na.rm = TRUE),1)
lbls <- paste0("S",1:7,"=",brk)

crqa_data |> 
  filter(subject_nr_n!=1) |> 
  group_by(gender_f) |> 
  summarise(mean = mean(age_days, na.rm = TRUE))

ggplot(crqa_data, aes(x = age_days, y = session, group = subject_nr_n)) + 
  geom_point(aes(colour = subject_nr, shape = gender_f),position = position_jitter(.4,.1)) +
  scale_x_continuous("Age (days)",breaks = brk, labels = lbls) +
  theme_bw() +
  theme(panel.grid.minor.x = element_blank())

```

Explore if there are any trends in the data for *DET*erminism.

```{r raw}
# Linear
ggplot(crqa_data, aes(x = age_days, y = DET, group = subject_nr_n)) + 
  geom_point(aes(fill = subject_nr), pch= 21) +
  geom_smooth(aes(colour = subject_nr), method = "lm", se = FALSE) +
  theme_bw()

# Square
ggplot(crqa_data, aes(x = age_days, y = DET, group = subject_nr_n)) + 
  geom_point(aes(fill = subject_nr), pch= 21) +
  geom_smooth(aes(colour = subject_nr), method = "lm", formula = "y ~ poly(x, 2)", se = FALSE) +
  theme_bw()

# Cube
ggplot(crqa_data, aes(x = age_days, y = DET, group = subject_nr_n)) + 
  geom_point(aes(fill = subject_nr), pch= 21) +
  geom_smooth(aes(colour = subject_nr), method = "lm", formula = "y ~ poly(x, 3)", se = FALSE) +
  theme_bw()

```


Not very clear, but perhaps some quadratics going on....   

# Mixed Models

Let's try a few models:

```{r lmer}
library(lme4)
library(lmerTest)
library(emmeans)
library(future)

# Linear time
m0.1 <- lmer(DET ~ age_days_cS1 + (1|subject_nr_n) + (1|age_days_cS1), crqa_data)
summary(m0.1)

m0.2 <- lmer(DET ~ age_days_cS1 + (age_days_cS1|subject_nr_n), crqa_data)
summary(m0.2)

# Squared time for some reason this throws an error
#m1.1 <- lmer(DET ~ poly(age_days_cS1,2)  +  (1|subject_nr_n) + (1|poly(age_days_cS1,2)) , crqa_data)
#summary(m1.1)

m1.2 <- lmer(DET ~ poly(age_days_cS1,2) + (poly(age_days_cS1,2)|subject_nr_n), crqa_data)
summary(m1.2)


m1.2a <- lmer(DET ~ poly(age_days_cS1,2) +  (poly(age_days_cS1,2)|subject_nr_n), weights = N_sessions, crqa_data)
summary(m1.2a)
```

Not a lot going on so it seems... perhaps we need to consider `gender`?

```{r lmerGender}
# Add gender
m1.3 <- lmer(DET ~ poly(age_days_cS1,2) + gender_f + (poly(age_days_cS1,2)|subject_nr_f), crqa_data)
summary(m1.3)

# Conditional change model
m1.4 <- lmer(DET ~ poly(age_days_cS1,2) * gender_f + (poly(age_days_cS1,2)|subject_nr_f), crqa_data)
saveRDS(m1.4, file = file.path(path_results, "m4_lmer.rds"))
summary(m1.4) 

anova(m1.3,m1.4)

crqa_data$predm14 <- predict(m1.4)

crqa_data_tmp <- crqa_data %>% filter(subject_nr!="point_14")

# Conditional change model without "Father-Daughter" dyad
m1.5 <- lmer(DET ~ poly(age_days_cS1,2) * gender_f + (poly(age_days_cS1,2)|subject_nr_f), crqa_data_tmp)
saveRDS(m1.5, file = file.path(path_results, "mr5_lmer.rds"))
summary(m1.5) 



crqa_data_tmp$predm15 <- predict(m1.5)
```


## Results

`m1.4` is preferred in terms fit indices.


Plot the predicted results:

```{r resultplot}

crqa_data$dyad_kind <- paste("mother -",ifelse(crqa_data$gender_f=="boys", "son","daughter"))
crqa_data$dyad_kind[crqa_data$subject_nr=="point_14"] <- "father - daughter"
crqa_data$dyad_kind <- factor(crqa_data$dyad_kind, c("mother - daughter", "mother - son", "father - daughter"), ordered=TRUE)

ggplot(crqa_data, aes(x = age_days, y = predm14, group = subject_nr_f)) + 
  geom_smooth(aes(colour = dyad_kind), method = "lm", formula = "y ~ poly(x, 2)", se = FALSE) +
  geom_point(aes(shape = dyad_kind, fill = dyad_kind)) +
  scale_y_continuous("Predicted Determinism") +
  scale_x_continuous("Age (days)") +
  scale_fill_manual("Dyad", values = c("steelblue2","thistle2","red2")) +
  scale_colour_manual("Dyad", values = c("steelblue3","thistle3","red3")) +
  scale_shape_manual("Dyad", values = c(21,22,24)) +
  theme_bw()

```


In words:


`r report::report(m1.4)`
