<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Arkadiusz Bia≈Çek">
<meta name="author" content="Wim Pouw">
<meta name="author" content="James Trujillo">
<meta name="author" content="Fred Hasselman">
<meta name="author" content="Babajide Alamu Owoyele">
<meta name="author" content="Natalia Siekiera">
<meta name="author" content="Joanna RƒÖczaszek-Leonardi">
<meta name="author" content="Travis J. Wiltshire">
<meta name="dcterms.date" content="2025-05-30">

<title>An Open-source Standardized Pipeline for Tracing the Behavioral Dynamics in Social Interactions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-84b3b4cc5777f6fdbd4d01919023a4cd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


<link rel="stylesheet" href="quarto_dependencies/styles/styles.css">
</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a></li>
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset"><span class="header-section-number">2</span> Dataset</a>
  <ul class="collapse">
  <li><a href="#dataset-mother-infant" id="toc-dataset-mother-infant" class="nav-link" data-scroll-target="#dataset-mother-infant"><span class="header-section-number">2.0.1</span> Dataset Mother Infant</a></li>
  <li><a href="#dataset-siblings" id="toc-dataset-siblings" class="nav-link" data-scroll-target="#dataset-siblings"><span class="header-section-number">2.0.2</span> Dataset Siblings</a></li>
  </ul></li>
  <li><a href="#step-1-motion-tracking-and-signal-processing-and-wrangling" id="toc-step-1-motion-tracking-and-signal-processing-and-wrangling" class="nav-link" data-scroll-target="#step-1-motion-tracking-and-signal-processing-and-wrangling"><span class="header-section-number">3</span> Step 1: Motion tracking and signal processing and wrangling</a>
  <ul class="collapse">
  <li><a href="#step-1.1-tracking-two-persons-in-videos-for-top-view-python" id="toc-step-1.1-tracking-two-persons-in-videos-for-top-view-python" class="nav-link" data-scroll-target="#step-1.1-tracking-two-persons-in-videos-for-top-view-python"><span class="header-section-number">3.1</span> Step 1.1: Tracking two persons in videos for top-view (Python)</a></li>
  <li><a href="#step-1.2-raw-pose-data-post-processing-for-timeseries-matrices-python" id="toc-step-1.2-raw-pose-data-post-processing-for-timeseries-matrices-python" class="nav-link" data-scroll-target="#step-1.2-raw-pose-data-post-processing-for-timeseries-matrices-python"><span class="header-section-number">3.2</span> Step 1.2: Raw pose data post-processing for timeseries matrices (Python)</a></li>
  <li><a href="#step-1.3-animation-with-original-videodata" id="toc-step-1.3-animation-with-original-videodata" class="nav-link" data-scroll-target="#step-1.3-animation-with-original-videodata"><span class="header-section-number">3.3</span> Step 1.3: Animation with original videodata</a></li>
  </ul></li>
  <li><a href="#step-2-summary-feature-extraction-smoothness-and-other-features" id="toc-step-2-summary-feature-extraction-smoothness-and-other-features" class="nav-link" data-scroll-target="#step-2-summary-feature-extraction-smoothness-and-other-features"><span class="header-section-number">4</span> Step 2: Summary feature extraction: Smoothness and other features</a>
  <ul class="collapse">
  <li><a href="#example-smoothness-results-on-simulated-time-series-data" id="toc-example-smoothness-results-on-simulated-time-series-data" class="nav-link" data-scroll-target="#example-smoothness-results-on-simulated-time-series-data"><span class="header-section-number">4.1</span> Example smoothness results on simulated time series data</a>
  <ul class="collapse">
  <li><a href="#extract-features-for-all-videos-using-tsfresh" id="toc-extract-features-for-all-videos-using-tsfresh" class="nav-link" data-scroll-target="#extract-features-for-all-videos-using-tsfresh"><span class="header-section-number">4.2.1</span> Extract features for all videos using tsfresh</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#step-3-non-linear-time-series-analysis-r" id="toc-step-3-non-linear-time-series-analysis-r" class="nav-link" data-scroll-target="#step-3-non-linear-time-series-analysis-r"><span class="header-section-number">5</span> Step 3: Non-linear time series analysis (R)</a></li>
  <li><a href="#step-4-statistical-analysis-r" id="toc-step-4-statistical-analysis-r" class="nav-link" data-scroll-target="#step-4-statistical-analysis-r"><span class="header-section-number">6</span> Step 4: Statistical analysis (R)</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">7</span> References</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">An Open-source Standardized Pipeline for Tracing the Behavioral Dynamics in Social Interactions</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Computationally Reproducible Extended Methods and Results Section</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Arkadiusz Bia≈Çek </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Jagiellonian University, Poland
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Wim Pouw </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Tilburg University, Netherlands
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">James Trujillo </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Amsterdam, Netherlands
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Fred Hasselman </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Radboud University, Netherlands
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Babajide Alamu Owoyele </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Hasso Plattner Institute, University of Potsdam, Germany
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Natalia Siekiera </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Jagiellonian University, Poland
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Joanna RƒÖczaszek-Leonardi </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Warsaw, Poland
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Travis J. Wiltshire </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Tilburg University, Netherlands
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 30, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p><img src="images/ts.gif" class="img-fluid"></p>
<section id="overview" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Overview</h1>
<p>To increase reproducibility of our approach we have designed this Quarto notebook that provides the user with what is effectively a manual-style extended methods and results section. Next to staging and (visually) explaining key Python and R code elements, the notebook contains detailed further ‚ÄúDo It Yourself‚Äù (DIY) instructions that can be accessed on demand by clicking on DIY sections, for example providing the technical steps needed to install and then run code for YOLO tracking on (user-defined) data. This notebook is therefore not simply an add-on supplemental text, but it is a key part of our contribution as it allows for newcomers to social signal processing to start implement this pipeline step by step.</p>
<p>The Quarto notebook is structured to have the following components, next to traditional text sections:</p>
<ul>
<li><p>üö© <strong>pipeline code</strong> that overview complete code associated with the pipeline, or shorter code chunks to for example explain a particular function. These code blocks are generally not run inside the current notebook. Denoted with the symbol üö©.</p></li>
<li><p>üè¥ <strong>other code chuncks</strong> that we use for this quarto notebook to create sanity checks or animations related to measures or summarizing datasets. These code blocks are generally run inside the notebook. Denoted with the symbol üè¥.</p></li>
<li><p>üìä <strong>example output</strong> that shows example output of the pipeline. Denoted with the symbol üìä.</p></li>
<li><p>üõ†Ô∏è <strong>DIY blocks</strong> that provide shorter, step-by-step links to the full code for executing a particular step in the pipeline on your own data. Denoted with the symbol üõ†Ô∏è.</p></li>
<li><p>‚¨áÔ∏è <strong>dataset download</strong> provide information about how to download the dataset overviewed for our report. Denoted with the symbol ‚¨áÔ∏è.</p></li>
</ul>
<p><strong>What the Quarto notebook is not intended to do:</strong> This notebook is not itself the pipeline (i.e., a collection of code that runs the complete pipeline). It is rather a linear step-by-step manual and explainer of how to understand and implement the pipeline steps. For actually applying this code, the user can further dig into the <strong>DIY</strong> blocks.</p>
</section>
<section id="dataset" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Dataset</h1>
<p>Below is a description of the two datasets that were used as test cases for the pipeline. The datasets are available in masked form to reduce identifiability of the individuals in the dataset. Following the download guide for further information on how to access the datasets.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Download Guide ‚¨áÔ∏è
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The masked data can be downloaded from the repository of Jagellonian University <a href="">here</a>. The unmasked data can be requested from the authors.</p>
<p>Please note that the masked data is not the input of the pipeline. YOLO tracking would not work well on masked data as detailed information about the body is lost, and only represented as the motion tracking data that comes with it (and is present in the repository). Rather the masked data can be used to check for qualitative changes in the behavior of the inviduals, and can be used to create animations such as in step 1.3.</p>
<p><strong>Example of masked videodata</strong> <img src="./images/masked_example.jpeg" class="img-fluid quarto-figure quarto-figure-center" width="600"></p>
</div>
</div>
</div>
<section id="dataset-mother-infant" class="level3" data-number="2.0.1">
<h3 data-number="2.0.1" class="anchored" data-anchor-id="dataset-mother-infant"><span class="header-section-number">2.0.1</span> Dataset Mother Infant</h3>
<p>Thirteen infant-caregiver pairs visited the child laboratory monthly for a total of seven visits. The infants‚Äô ages at the first visit ranged from 7 to 9 months. Parents were instructed to ‚Äúplay as usual,‚Äù with a set of different toys to encourage spontaneous interactions. Each visit lasted approximately 30 minutes and was divided into four stages. For our analyses, we focus on recordings from the stage where the infant was seated in a feeding chair, facing the caregiver sitting directly across. This controlled setup minimizes movement around the room, facilitating video motion tracking analysis. Additionally, our analyses are restricted to top-view recordings, ensuring that both the caregiver and the infant are captured within a single frame.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Plotting code for the Mother-Infant dataset üè¥
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>matplotlib.use(<span class="st">'agg'</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>plt.ioff()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>plt.clf() <span class="co"># Clear any existing figures</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'./meta/project_point_metadata_ages.csv'</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert gender to categorical label</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'gender_label'</span>] <span class="op">=</span> df[<span class="st">'gender'</span>].<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'Female'</span>, <span class="dv">1</span>: <span class="st">'Male'</span>})</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 2x2 subplot layout</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>), gridspec_kw<span class="op">=</span>{<span class="st">'width_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>], <span class="st">'height_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>]})</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Mother-Infant Dataset Overview'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for gender</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Female'</span>: <span class="st">'#C55A11'</span>,   <span class="co"># Orange for females</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Male'</span>: <span class="st">'#4472C4'</span>       <span class="co"># Blue for males</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Line plot - Age progression across time points</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    gender <span class="op">=</span> row[<span class="st">'gender_label'</span>]</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create arrays for days and time points, handling NaN values</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    days <span class="op">=</span> []</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    timepoints <span class="op">=</span> []</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):   <span class="co"># T1 to T7</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        day_col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> day_col <span class="kw">in</span> df.columns <span class="kw">and</span> pd.notna(row[day_col]) <span class="kw">and</span> row[day_col] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>            days.append(row[day_col])</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            timepoints.append(i)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the line for this infant</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>, <span class="dv">0</span>].plot(</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        timepoints,</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        days,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>colors[gender],</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">1.5</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Customize the plot</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Infant Age Progression'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>))</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xticklabels([<span class="ss">f'T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>)])</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Add legend patches</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>legend_elements <span class="op">=</span> [</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    Patch(facecolor<span class="op">=</span>colors[<span class="st">'Female'</span>], edgecolor<span class="op">=</span><span class="st">'w'</span>, label<span class="op">=</span><span class="st">'Female'</span>),</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    Patch(facecolor<span class="op">=</span>colors[<span class="st">'Male'</span>], edgecolor<span class="op">=</span><span class="st">'w'</span>, label<span class="op">=</span><span class="st">'Male'</span>)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Box plot - Age distribution at each time point</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>time_point_data <span class="op">=</span> []</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> []</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):   <span class="co"># T1 to T7</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        valid_data <span class="op">=</span> df[col].dropna()</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>            time_point_data.append(valid_data)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="ss">f'T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Create violin plots</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> time_point_data:</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    violin_parts <span class="op">=</span> axs[<span class="dv">0</span>, <span class="dv">1</span>].violinplot(</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>        time_point_data,</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        showmeans<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>        showmedians<span class="op">=</span><span class="va">True</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Color the violin plots</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, pc <span class="kw">in</span> <span class="bu">enumerate</span>(violin_parts[<span class="st">'bodies'</span>]):</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>        pc.set_facecolor(<span class="st">'#7030A0'</span>)  <span class="co"># Purple</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>        pc.set_edgecolor(<span class="st">'black'</span>)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>        pc.set_alpha(<span class="fl">0.7</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(labels) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels(labels)</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Age Distribution by Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Pie chart - Gender distribution</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>gender_counts <span class="op">=</span> df[<span class="st">'gender_label'</span>].value_counts()</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].pie(</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    gender_counts,</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>gender_counts.index,</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>    autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[colors[g] <span class="cf">for</span> g <span class="kw">in</span> gender_counts.index],</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    wedgeprops<span class="op">=</span>{<span class="st">'edgecolor'</span>: <span class="st">'w'</span>, <span class="st">'linewidth'</span>: <span class="dv">1</span>}</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Gender Distribution'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Summary table</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate averages for each time point, handling NaN values</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>averages_days <span class="op">=</span> []</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>        avg <span class="op">=</span> df[col].mean()</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> pd.isna(avg):</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>            avg_months <span class="op">=</span> avg <span class="op">/</span> <span class="fl">30.44</span>  <span class="co"># Convert to months</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>            averages_days.append([<span class="ss">f"T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> Average Age"</span>, <span class="ss">f"</span><span class="sc">{</span>avg<span class="sc">:.1f}</span><span class="ss"> days (</span><span class="sc">{</span>avg_months<span class="sc">:.1f}</span><span class="ss"> months)"</span>])</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Count participants at each time point</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>participants <span class="op">=</span> []</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> df[col].notna().<span class="bu">sum</span>()</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>        participants.append([<span class="ss">f"Participants at T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"</span><span class="sc">{</span>count<span class="sc">}</span><span class="ss">"</span>])</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall statistics</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> [</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Total Infants"</span>, <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Females"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'gender'</span>] <span class="op">==</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Males"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'gender'</span>] <span class="op">==</span> <span class="dv">1</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a><span class="co"># Add age ranges if columns exist</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'age_T1_days'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>    summary_data.append([<span class="st">"Age Range T1"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'age_T1_days'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df[<span class="st">'age_T1_days'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss"> days"</span>])</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>last_tp <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> last_tp <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>last_tp<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns <span class="kw">and</span> df[col].notna().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>        summary_data.append([<span class="ss">f"Age Range T</span><span class="sc">{</span>last_tp<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"</span><span class="sc">{</span>df[col]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df[col]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss"> days"</span>])</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>    last_tp <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the table with the most important summary statistics</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">1</span>].table(</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>    cellText<span class="op">=</span>summary_data <span class="op">+</span> participants,</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>    cellLoc<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>table.scale(<span class="dv">1</span>, <span class="fl">1.5</span>)</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Dataset Summary'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the figure to a file</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">"images/mother_infant_analysis.png"</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>os.makedirs(os.path.dirname(output_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>plt.close(fig) <span class="co"># Explicitly close the figure object</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/mother_infant_analysis.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="600"></p>
</figure>
</div>
<p>Note that in our github repository we use short sample data from this dataset from an infant-mother pair whom we are allowed to share the video data for the current purposes.</p>
</section>
<section id="dataset-siblings" class="level3" data-number="2.0.2">
<h3 data-number="2.0.2" class="anchored" data-anchor-id="dataset-siblings"><span class="header-section-number">2.0.2</span> Dataset Siblings</h3>
<p>Ten sibling pairs (total = 20 pairs) were observed from Polish urban culture and Yurakar√© indigenous culture each. Observations were made during a semi-structured play situation: in the natural environment of the Yurakar√© community and laboratory conditions in Poland. Siblings were asked to build a tower together using 54 wooden blocks while sitting facing each other. Each pair had 4 minutes to complete the task. This setup allowed for a systematic comparison of coordinated and mutually adjusted movements in siblings, using our pipeline to examine the smoothness of interaction while ‚Äúdoing things together‚Äù in these two cultural groups.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Plotting code for the Siblings dataset üè¥
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'./meta/project_siblings_metadata_ages_gender.csv'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Data preprocessing</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'AgeDifference'</span>] <span class="op">=</span> <span class="bu">abs</span>(df[<span class="st">'P1agedays'</span>] <span class="op">-</span> df[<span class="st">'P2agedays'</span>])</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'AverageAge'</span>] <span class="op">=</span> (df[<span class="st">'P1agedays'</span>] <span class="op">+</span> df[<span class="st">'P2agedays'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'GenderCombo'</span>] <span class="op">=</span> df[<span class="st">'GenderP1'</span>] <span class="op">+</span> <span class="st">'-'</span> <span class="op">+</span> df[<span class="st">'GenderP2'</span>]</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 2x2 subplot layout</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), gridspec_kw<span class="op">=</span>{<span class="st">'width_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>], <span class="st">'height_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>]})</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Sibling Dataset Overview'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for gender combinations</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'M-M'</span>: <span class="st">'#4472C4'</span>,   <span class="co"># Blue</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'M-F'</span>: <span class="st">'#7030A0'</span>,   <span class="co"># Purple</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'F-M'</span>: <span class="st">'#548235'</span>,   <span class="co"># Green</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'F-F'</span>: <span class="st">'#C55A11'</span>    <span class="co"># Rust/Orange</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Scatter plot - P1 age vs P2 age</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gender_combo, group <span class="kw">in</span> df.groupby(<span class="st">'GenderCombo'</span>):</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>, <span class="dv">0</span>].scatter(</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'P1agedays'</span>],</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'P2agedays'</span>],</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>colors.get(gender_combo, <span class="st">'gray'</span>),</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span>gender_combo,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span><span class="dv">50</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Add reference line</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>min_age <span class="op">=</span> <span class="bu">min</span>(df[<span class="st">'P1agedays'</span>].<span class="bu">min</span>(), df[<span class="st">'P2agedays'</span>].<span class="bu">min</span>())</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>max_age <span class="op">=</span> <span class="bu">max</span>(df[<span class="st">'P1agedays'</span>].<span class="bu">max</span>(), df[<span class="st">'P2agedays'</span>].<span class="bu">max</span>())</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].plot([min_age, max_age], [min_age, max_age], <span class="st">'k--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'P1 Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'P2 Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Participant Ages (P1 vs P2)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].legend()</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Bar chart - Age differences</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>bar_positions <span class="op">=</span> np.arange(<span class="bu">len</span>(df))</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>bar_width <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].bar(</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    bar_positions,</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'AgeDifference'</span>],</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span>bar_width,</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>[colors.get(combo, <span class="st">'gray'</span>) <span class="cf">for</span> combo <span class="kw">in</span> df[<span class="st">'GenderCombo'</span>]]</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks(bar_positions)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels(df[<span class="st">'Code'</span>], rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Sibling Pair'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Age Difference (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Age Differences by Sibling Pair'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Pie chart - Gender distribution</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>gender_counts <span class="op">=</span> df[<span class="st">'GenderCombo'</span>].value_counts()</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].pie(</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    gender_counts,</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>gender_counts.index,</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[colors.get(combo, <span class="st">'gray'</span>) <span class="cf">for</span> combo <span class="kw">in</span> gender_counts.index],</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    wedgeprops<span class="op">=</span>{<span class="st">'edgecolor'</span>: <span class="st">'w'</span>, <span class="st">'linewidth'</span>: <span class="dv">1</span>}</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Gender Distribution'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Summary table</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> [</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Total Sibling Pairs"</span>, <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average P1 Age"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'P1agedays'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average P2 Age"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'P2agedays'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average Age Difference"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'AgeDifference'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Number of Males"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'GenderP1'</span>] <span class="op">==</span> <span class="st">'M'</span>)<span class="sc">.</span><span class="bu">sum</span>() <span class="op">+</span> (df[<span class="st">'GenderP2'</span>] <span class="op">==</span> <span class="st">'M'</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Number of Females"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'GenderP1'</span>] <span class="op">==</span> <span class="st">'F'</span>)<span class="sc">.</span><span class="bu">sum</span>() <span class="op">+</span> (df[<span class="st">'GenderP2'</span>] <span class="op">==</span> <span class="st">'F'</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn off axis for table</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">1</span>].table(</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>    cellText<span class="op">=</span>[row <span class="cf">for</span> row <span class="kw">in</span> summary_data],</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    colLabels<span class="op">=</span>[<span class="st">"Measure"</span>, <span class="st">"Value"</span>],</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    cellLoc<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>table.scale(<span class="dv">1</span>, <span class="fl">1.5</span>)</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Dataset Summary'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the figure to a file</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">"images/sibling_analysis.png"</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>os.makedirs(os.path.dirname(output_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/sibling_analysis.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="600"></p>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
DIY: Setting up the repository on your local machine üõ†Ô∏è
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<section id="step-0-github-repo" class="level3 callout-body-container callout-body" data-number="2.0.3">
<h3 data-number="2.0.3" class="anchored" data-anchor-id="step-0-github-repo"><span class="header-section-number">2.0.3</span> Step 0: Github repo</h3>
<p>You should first clone the repository <a href="https://github.com/WimPouw/InterPerDynPipeline">InterPerDynPipeline</a> and move to the root directory. The step 1 code for tracking is in the <code>./code_STEP1_posetrackingprocessing/</code> folder. In this folder you will find the Python script <code>yolo_tracking_processing.py</code>. To check whether you have the correct script you can compare against the code chunk provided below.</p>
<p>First install git if you do not have it installed yet. You can find instructions on how to install git <a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">here</a>.</p>
<p>Then you can clone the repository using the following commands in your (anaconda) terminal:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/WimPouw/InterPerDynPipeline</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ./InterPerDynPipeline/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
</section>
</section>
<section id="step-1-motion-tracking-and-signal-processing-and-wrangling" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Step 1: Motion tracking and signal processing and wrangling</h1>
<p>The motion tracking and signal processing pipeline is divided into three steps: 1. <strong>Tracking</strong>: This step involves tracking the movements of individuals in the videos using YOLOv8. The output is a video with annotated keypoints and a CSV file containing the coordinates of these keypoints. 2. <strong>Signal Processing</strong>: This step involves processing the keypoint data to extract relevant features for analysis. The output are processed timeseries files, and a flat dataset containing our smoothness measures that are directly ready for statistical analysis. 3. <strong>Animations</strong>: This step involves animating the processed data together with the original video data to ensure that the processed data are of sufficient quality to reflect behavioral changes.</p>
<section id="step-1.1-tracking-two-persons-in-videos-for-top-view-python" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="step-1.1-tracking-two-persons-in-videos-for-top-view-python"><span class="header-section-number">3.1</span> Step 1.1: Tracking two persons in videos for top-view (Python)</h2>
<p>We have tried several pose tracking solutions, such as OpenPose (model 25B; <span class="citation" data-cites="caoOpenPoseRealtimeMultiPerson2021a">Cao et al. (<a href="#ref-caoOpenPoseRealtimeMultiPerson2021a" role="doc-biblioref">2021</a>)</span>), Mediapipe (default highest complexity blazepose model; <span class="citation" data-cites="lugaresiMediaPipeFrameworkBuilding2019">Lugaresi et al. (<a href="#ref-lugaresiMediaPipeFrameworkBuilding2019" role="doc-biblioref">2019</a>)</span>). We found that these models are not well equipped to track persons from top view, most likely because these models are not trained on ground-truth poses of persons from top-view camera angles. However, we found the heaviest model of YOLOv8 (‚Äúyolov8x-pose-p6.pt‚Äù) does perform very well, especially as compared to the other models we tested. Thus, for this pipeline we recommend using YOLOv8 model <span class="citation" data-cites="jocherYOLOUltralytics2023">(<a href="#ref-jocherYOLOUltralytics2023" role="doc-biblioref">Jocher, Chaurasia, and Qiu 2023</a>)</span> for top-view tracking.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
DIY Step 1.1 Motion Tracking Set-Up and Execution üõ†Ô∏è
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="step-1-install-requirements" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="step-1-install-requirements"><span class="header-section-number">3.1.1</span> Step 1: Install requirements</h3>
<p>For each script we have provided a <code>requirements.txt</code> file. You can install the requirements using pip, by first navigating to the folder where the script is located and then running the following command in your terminal:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP1_posetrackingprocessing/</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-download-the-yolov8-model" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="step-2-download-the-yolov8-model"><span class="header-section-number">3.1.2</span> Step 2: Download the YOLOv8 model</h3>
<p>In the current GitHub repo we have a light-weight model <code>yolov8n-pose.pt</code> (~6.5MB) for immediate testing of the code. However, this model is not as accurate as the heaviest model.</p>
<p>We should download the heaviest model (<code>yolov8x-pose-p6.pt</code>) and save it to the <code>./code_STEP1_posetrackingprocessing/model/</code> directory:<br>
https://github.com/ultralytics/assets/releases/download/v8.1.0/yolov8x-pose-p6.pt</p>
<p><strong>Note</strong> that if you‚Äôre running the heavyweight model, you will need GPU support for this to run in a reasonable time (we processed our data on a NVIDIA GeForce RTX 4090 GPU). The lightweight model can run on CPU.</p>
</section>
<section id="step-3-run-the-python-script" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="step-3-run-the-python-script"><span class="header-section-number">3.1.3</span> Step 3: Run the python script</h3>
<p>Assuming you have videos in your data folder (<code>./data_raw/</code>) and you have a <code>.pt</code> model in the model folder, you can run the script using the following command:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP1_posetrackingprocessing/</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> yolo_tracking_processing.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
</div>
<p>The code below is the script <code>yolo_tracking_processing.py</code> that you can run to track the videos. The output will be a video with annotated keypoints and a CSV file containing the coordinates of these keypoints. The script processes each video frame-by-frame, detecting people and their pose keypoints (17 points as listed in the script; see the <code>GetKeypoint class</code>). We filter out duplicate detections or skeletons with excessive missing data. Specifically, for each processed video, the script generates two output files: an annotated video showing the original footage with skeleton overlays (green points for accepted keypoints, red for filtered ones, and blue lines connecting the points), and a CSV file containing the raw coordinate data (frame number, person ID, keypoint ID, x-coordinate, y-coordinate). The output filenames include parameters like ‚Äúc150‚Äù (150px proximity threshold) and ‚Äúmiss95‚Äù (95% missing data tolerance), which control how the system handles potential duplicate detections and incomplete skeletons. The user could adjust the parameter <code>close_threshold</code> and <code>miss_tolerance</code> to adjust the detection dynamics. We output the annotated video and the CSV file in the <code>./datatracked_afterSTEP1/</code> folder.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pipeline code 1.1 YOLO tracking üö©
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ultralytics <span class="im">import</span> YOLO</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch <span class="co"># for gpu support</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> combinations</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>torch.cuda.set_device(<span class="dv">0</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>modelfolder <span class="op">=</span> <span class="st">'./model/'</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>modellocation <span class="op">=</span> glob.glob(modelfolder<span class="op">+</span><span class="st">"*.pt"</span>)[<span class="dv">0</span>]</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>modelfile <span class="op">=</span> os.path.basename(modellocation)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"We are loading in the following YOLO model: </span><span class="sc">{</span>modelfile<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> YOLO(modellocation)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co"># main variables</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>video_folder <span class="op">=</span> <span class="st">"../data_raw/"</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># avi mp4 or other video formats</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>video_files <span class="op">=</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mp4"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.avi"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mov"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mkv"</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>step1resultfolder <span class="op">=</span> <span class="st">"../datatracked_afterSTEP1/"</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(video_files)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co"># keypoint names</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GetKeypoint(BaseModel):</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    NOSE:           <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    LEFT_EYE:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    RIGHT_EYE:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    LEFT_EAR:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    RIGHT_EAR:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    LEFT_SHOULDER:  <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    RIGHT_SHOULDER: <span class="bu">int</span> <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    LEFT_ELBOW:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    RIGHT_ELBOW:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    LEFT_WRIST:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    RIGHT_WRIST:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    LEFT_HIP:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">11</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    RIGHT_HIP:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    LEFT_KNEE:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    RIGHT_KNEE:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    LEFT_ANKLE:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    RIGHT_ANKLE:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>get_keypoint <span class="op">=</span> GetKeypoint()</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Define skeleton connections</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>skeleton <span class="op">=</span> [</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.RIGHT_SHOULDER),</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.LEFT_ELBOW),</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_SHOULDER, get_keypoint.RIGHT_ELBOW),</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_ELBOW, get_keypoint.LEFT_WRIST),</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_ELBOW, get_keypoint.RIGHT_WRIST),</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.LEFT_HIP),</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_SHOULDER, get_keypoint.RIGHT_HIP),</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_HIP, get_keypoint.RIGHT_HIP),</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_HIP, get_keypoint.LEFT_KNEE),</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_HIP, get_keypoint.RIGHT_KNEE),</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_KNEE, get_keypoint.LEFT_ANKLE),</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_KNEE, get_keypoint.RIGHT_ANKLE),</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tensor_to_matrix(results_tensor):</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this just takes the results output of YOLO and coverts it to a matrix,</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># making it easier to do quick calculations on the coordinates</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    results_list <span class="op">=</span> results_tensor.tolist()</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>    results_matrix <span class="op">=</span> np.matrix(results_list)</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    results_matrix[results_matrix<span class="op">==</span><span class="dv">0</span>] <span class="op">=</span> np.nan</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_matrix</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_for_duplication(results):</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this threshold determines how close two skeletons must be in order to be</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># considered the same person. Arbitrarily chosen for now.</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    close_threshold <span class="op">=</span><span class="dv">150</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># missing data tolerance</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    miss_tolerance <span class="op">=</span> <span class="fl">0.95</span> <span class="co"># this means we can miss up to 75% of the keypoints</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    drop_indices <span class="op">=</span> []</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>        conf_scores <span class="op">=</span> []</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get detection confidence for each skeleton</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> person <span class="kw">in</span> tensor_to_matrix(results[<span class="dv">0</span>].keypoints.conf):</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>            conf_scores.append(np.mean(person))</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this list will stores which comparisons need to be made</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>        combos <span class="op">=</span> <span class="bu">list</span>(combinations(<span class="bu">range</span>(<span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy)), <span class="dv">2</span>))</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># now loop through these comparisons</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> combo <span class="kw">in</span> combos:</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>            closeness <span class="op">=</span> <span class="bu">abs</span>(np.nanmean(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[combo[<span class="dv">0</span>]]) <span class="op">-</span> </span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>                        tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[combo[<span class="dv">1</span>]])))</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if any of them indicate that two skeletons are very close together,</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>            <span class="co"># we keep the one with higher tracking confidence, and remove the other</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> closeness <span class="op">&lt;</span> close_threshold:</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>                conf_list <span class="op">=</span> [conf_scores[combo[<span class="dv">0</span>]], conf_scores[combo[<span class="dv">1</span>]]]</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>                idx_min <span class="op">=</span> conf_list.index(<span class="bu">min</span>(conf_list))</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>                drop_indices.append(combo[idx_min])</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># additional checks:</span></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> person <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy)):</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>           keypoints_missed <span class="op">=</span>  np.isnan(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[person])).<span class="bu">sum</span>()<span class="op">/</span><span class="dv">2</span></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>           perc_missed <span class="op">=</span> keypoints_missed<span class="op">/</span><span class="bu">len</span>(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[person]))</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>           <span class="cf">if</span> perc_missed <span class="op">&gt;</span> miss_tolerance:</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>               drop_indices.append(person)</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">set</span>(drop_indices))</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> video_path <span class="kw">in</span> video_files:</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Video path</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>    video_path <span class="op">=</span> video_path</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only if the output is not there yet</span></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(step1resultfolder<span class="op">+</span> os.path.basename(video_path).split(<span class="st">'.'</span>)[<span class="dv">0</span>]<span class="op">+</span><span class="st">"_annotated_layer1_c150_miss95.mp4"</span>):</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Output video already exists for </span><span class="sc">{</span>video_path<span class="sc">}</span><span class="ss">. Skipping..."</span>)</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># vidname without extension</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> os.path.basename(video_path)</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> vidname.split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Open the video</span></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>    cap <span class="op">=</span> cv2.VideoCapture(video_path)</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get video properties</span></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>    fps <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FPS))</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the output video writer</span></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>    corename <span class="op">=</span> os.path.basename(video_path).split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>    output_path <span class="op">=</span> step1resultfolder<span class="op">+</span> vidname<span class="op">+</span><span class="st">"_annotated_layer1_c150_miss95.mp4"</span></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>    fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span><span class="st">'mp4v'</span>)</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> cv2.VideoWriter(output_path, fourcc, fps, (width, height))</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare CSV file</span></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>    csv_path <span class="op">=</span> step1resultfolder<span class="op">+</span> vidname<span class="op">+</span><span class="st">'_keypoints_data_layer1.csv'</span></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>    csv_file <span class="op">=</span> <span class="bu">open</span>(csv_path, <span class="st">'w'</span>, newline<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>    csv_writer <span class="op">=</span> csv.writer(csv_file)</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write header</span></span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>    header <span class="op">=</span> [<span class="st">'frame'</span>, <span class="st">'person'</span>, <span class="st">'keypoint'</span>, <span class="st">'x'</span>, <span class="st">'y'</span>]</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>    csv_writer.writerow(header)</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>    frame_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> cap.isOpened():</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>        success, frame <span class="op">=</span> cap.read()</span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run YOLOv8 inference on the frame</span></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> model(frame)</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>        <span class="co"># write empty rows if no person is detected</span></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>            csv_writer.writerow([frame_count, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>])</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>        annotated_frame <span class="op">=</span> frame</span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>        <span class="co"># only do this if a person is detected</span></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process the results</span></span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>            drop_indices <span class="op">=</span> []</span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>            drop_indices <span class="op">=</span> check_for_duplication(results)</span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> person_idx, person_keypoints <span class="kw">in</span> <span class="bu">enumerate</span>(results[<span class="dv">0</span>].keypoints.xy):</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> person_idx <span class="kw">not</span> <span class="kw">in</span> drop_indices:</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>                    colourcode <span class="op">=</span> (<span class="dv">0</span>, <span class="dv">255</span>, <span class="dv">0</span>)</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>                    colourcode <span class="op">=</span> (<span class="dv">255</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> keypoint_idx, keypoint <span class="kw">in</span> <span class="bu">enumerate</span>(person_keypoints):</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>                    x, y <span class="op">=</span> keypoint</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Write to CSV</span></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>                    csv_writer.writerow([frame_count, person_idx, keypoint_idx, x.item(), y.item()])</span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Draw keypoint on the frame</span></span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>                    cv2.circle(annotated_frame, (<span class="bu">int</span>(x), <span class="bu">int</span>(y)), <span class="dv">5</span>, colourcode, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw skeleton</span></span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> connection <span class="kw">in</span> skeleton:</span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> connection[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="bu">len</span>(person_keypoints) <span class="kw">and</span> connection[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="bu">len</span>(person_keypoints):</span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>                        start_point <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">map</span>(<span class="bu">int</span>, person_keypoints[connection[<span class="dv">0</span>]]))</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>                        end_point <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">map</span>(<span class="bu">int</span>, person_keypoints[connection[<span class="dv">1</span>]]))</span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">all</span>(start_point) <span class="kw">and</span> <span class="bu">all</span>(end_point):  <span class="co"># Check if both points are valid</span></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>                            cv2.line(annotated_frame, start_point, end_point, (<span class="dv">255</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">2</span>)</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write the frame to the output video</span></span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>            out.write(annotated_frame)</span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>        frame_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Release everything</span></span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>    cap.release()</span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>    out.release()</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>    cv2.destroyAllWindows()</span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>    csv_file.close()</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Output video saved as </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Keypoints data saved as </span><span class="sc">{</span>csv_path<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>Here is an example of the output video with annotated keypoints and skeletons. The green points indicate accepted keypoints, while the red points indicate filtered ones. The blue lines connect the keypoints to form a skeleton.</p>

<video width="600" height="400" controls="">
<source src="./images/videosrerendered/sample.mp4" type="video/mp4">
Your browser does not support the video tag. </video>

<p>Here is an example of the output csv file containing the coordinates of the keypoints. The CSV file contains the following columns: frame number, person ID, keypoint ID, x-coordinate, and y-coordinate. Each row corresponds to a detected keypoint in a specific frame.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example output and code example for YOLO tracking: üìä
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="im">as</span> glob</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>folderstep1output <span class="op">=</span> <span class="st">"./dataoutput_STEP1_1_rawposedata/"</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> glob.glob(os.path.join(folderstep1output <span class="op">+</span> <span class="st">"*.csv"</span>))[<span class="dv">0</span>]</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(csv_file)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   frame  person  keypoint    x    y
0      0       0         0  0.0  0.0
1      0       0         1  0.0  0.0
2      0       0         2  0.0  0.0
3      0       0         3  0.0  0.0
4      0       0         4  0.0  0.0</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="step-1.2-raw-pose-data-post-processing-for-timeseries-matrices-python" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="step-1.2-raw-pose-data-post-processing-for-timeseries-matrices-python"><span class="header-section-number">3.2</span> Step 1.2: Raw pose data post-processing for timeseries matrices (Python)</h2>
<p>The raw pose data with frame, person, keypoint, and x,y position data that we end up with is not yet in a format that is easy to work with for our purposes. Additionally, sometimes we dont have a person or two persons detected in the frame. We want to transform these raw pose data to timeseries matrix format, whereby we have time in seconds as one column and different time-varying variables in the other columns. Furthermore, we smooth and interpolate the data if necessary. The below python code executes this second step whereby we store the position data per person, and furthe derive interpersonal distances measures, and kinematic metrics (e.g.&nbsp;speed) and tracking quality indicators (e.g.&nbsp;tracking status that says something about where it concerns interpolated data).</p>
<p>Next to determining time in seconds from the frame rate of the videos, the script starts with assigning left and right person IDs based on the horizontal position in the frame (with left being ID 1 and right being ID 2). It then processes the time data to calculate statistics for tracked people using upper body keypoints (as the lower body keypoints are unreliable from top-view and may be ignored). Specifically, we reduce the dimensionality of all upper body keypoints by determined relative positions and their distances: We calculate a bounding box (determined by the outer edges of the keypoints) and determine the center in x and y coordinates (<code>centroid_x</code>, <code>centroid_y</code>) and their P1-P2 distance of those centroids (<code>distance</code>), and the center of mass (<code>com_x</code>, <code>com_y</code>) for each person and the distnace (<code>distance_com</code>). Further we determine the midpoint of the shoulders as another relevant position (<code>shoulder_midpoint_x</code>, <code>shoulder_midpoint_y</code>) and compute its distance (<code>distance_shoulder_midpoint</code>). Additionally, information about body parts such as arm motions by taking the wrist positions (<code>wrist_left_x</code>, <code>wrist_left_y</code>, <code>wrist_right_x</code>, <code>wrist_right_y</code>), and further deriving total motion per second, called speed (based on a euclidean sum of the changes of position along x and y).</p>
<p>The Savitzky-Golay filter is applied for smoothing jittering position data (using a window size of 11 frames, polynomial order of 3). The script handles missing data through two complementary techniques: linear interpolation for brief gaps in tracking (up to 5 frames) and we take the last known location for longer gaps (up to 20 frames). The script also calculates the speed of the center of mass and wrist positions, and here we also smooth the values using the Savitzky-Golay filter to reduce noise that is amplified during differientation (see <span class="citation" data-cites="winterBiomechanicsMotorControl2009">Winter (<a href="#ref-winterBiomechanicsMotorControl2009" role="doc-biblioref">2009</a>)</span>).</p>
<p>The more sophisticated measure that we have created is the proximity calculation measure (see function <code>calculate_approach()</code> in the step2 script). This function establishes initial reference position for both participants and then projects their subsequent movements onto the connecting line between them. This allows for quantifying approach and retreat behaviors for each person seperately (which a distance measure does not allow for) while allowing for relative angle changes between them - positive values indicate movement toward the other person (relative from start), while negative values indicate withdrawal (relative from start).</p>
<p>Below is an animation to exemplify what we are measuring. We are here capturing only movements that are changing the distance between them. When someone moves in a circle around the other person we want to make sure we do not register that as approach or retreat (which we would do if we just capture horizontal position for example). However we also want capture each person their own approach/avoidance value (which would not be possible when using a simple distance measure). By always measuring the signed length of the projected line from the initial position (based on the current connected line), the method tracks cumulative approach/avoidance for each person over time.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Code for creating animation to exemplify behavior of proximity measure üè¥
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.animation <span class="im">import</span> FuncAnimation</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> patches</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.lines <span class="im">as</span> mlines</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Force matplotlib to use Agg backend to avoid display issues</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>matplotlib.use(<span class="st">'Agg'</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">"images/proximity_visualization"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation parameters</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>num_frames <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>p1_color <span class="op">=</span> <span class="st">'#3498db'</span>  <span class="co"># Blue</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>p2_color <span class="op">=</span> <span class="st">'#e74c3c'</span>  <span class="co"># Red</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>vector_color <span class="op">=</span> <span class="st">'#2ecc71'</span>  <span class="co"># Green</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create initial positions for two people - now on a horizontal line</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 1 on the left, Person 2 on the right (same y-coordinate)</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>p1_initial <span class="op">=</span> np.array([<span class="dv">3</span>, <span class="dv">5</span>])</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>p2_initial <span class="op">=</span> np.array([<span class="dv">7</span>, <span class="dv">5</span>])</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate movement paths with MORE EXTREME approach and avoidance</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 1 will make a dramatic approach followed by retreat</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 2 will make a clear retreat followed by approach</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>np.pi, num_frames)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Create more dramatic movement path for Person 1</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Increase the amplitude of movement to make it more extreme</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>p1_path_x <span class="op">=</span> p1_initial[<span class="dv">0</span>] <span class="op">+</span> <span class="fl">2.5</span> <span class="op">*</span> np.sin(t<span class="op">/</span><span class="dv">2</span>)  <span class="co"># Larger horizontal movement (was 1.5)</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>p1_path_y <span class="op">=</span> p1_initial[<span class="dv">1</span>] <span class="op">+</span> <span class="fl">2.5</span> <span class="op">*</span> np.sin(t)   <span class="co"># Larger vertical movement (was 2.0)</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Create more dramatic movement path for Person 2</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the retreat phase more obvious</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>p2_path_x <span class="op">=</span> p2_initial[<span class="dv">0</span>] <span class="op">-</span> <span class="fl">1.2</span> <span class="op">*</span> np.sin(t)    <span class="co"># More horizontal movement (was 0.5)</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>p2_path_y <span class="op">=</span> p2_initial[<span class="dv">1</span>] <span class="op">-</span> <span class="fl">2.0</span> <span class="op">*</span> np.sin(t<span class="op">*</span><span class="fl">1.5</span>)  <span class="co"># More vertical movement (was 1.0)</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Store positions for each frame</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>p1_positions <span class="op">=</span> np.column_stack((p1_path_x, p1_path_y))</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>p2_positions <span class="op">=</span> np.column_stack((p2_path_x, p2_path_y))</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrays to store approach values</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>p1_approach_values <span class="op">=</span> np.zeros(num_frames)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>p2_approach_values <span class="op">=</span> np.zeros(num_frames)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate proximity approach values</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_approach(positions1, positions2):</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate approach values similar to the script's approach"""</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use first frame as reference</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    reference_p1_pos <span class="op">=</span> positions1[<span class="dv">0</span>].copy()</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    reference_p2_pos <span class="op">=</span> positions2[<span class="dv">0</span>].copy()</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    p1_approach <span class="op">=</span> np.zeros(<span class="bu">len</span>(positions1))</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    p2_approach <span class="op">=</span> np.zeros(<span class="bu">len</span>(positions2))</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(positions1)):</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current positions</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> positions1[i]</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> positions2[i]</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current connecting vector and direction</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>        current_connect <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>        current_distance <span class="op">=</span> np.linalg.norm(current_connect)</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_distance <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>            current_direction <span class="op">=</span> current_connect <span class="op">/</span> current_distance</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Vectors from reference positions</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>            p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> reference_p1_pos</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>            p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> reference_p2_pos</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Project onto connecting line</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>            p1_approach[i] <span class="op">=</span> np.dot(p1_vector, current_direction)</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P2, a positive value should mean movement toward P1</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>            <span class="co"># So we use the negative connecting direction (from P2 to P1)</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>            <span class="co"># And a positive dot product means approaching</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>            p2_direction <span class="op">=</span> <span class="op">-</span>current_direction  <span class="co"># Direction from P2 to P1</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>            p2_approach[i] <span class="op">=</span> np.dot(p2_vector, p2_direction)</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> p1_approach, p2_approach</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate approach values</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>p1_approach_values, p2_approach_values <span class="op">=</span> calculate_approach(p1_positions, p2_positions)</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the main visualization</span></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_detailed_animation():</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set up the figure explicitly with DPI</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>), dpi<span class="op">=</span><span class="dv">100</span>)  <span class="co"># Larger figure for better visibility</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> init():</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>        ax.clear()</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>        ax.set_aspect(<span class="st">'equal'</span>)</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> animate(i):</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>        ax.clear()</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set up the axes</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>        ax.set_aspect(<span class="st">'equal'</span>)</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">'Proximity Approach Visualization (Extreme Movements)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">'X Position'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Y Position'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get current positions</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> p1_positions[i]</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> p2_positions[i]</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the initial connecting vector (reference)</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>        ax.plot([p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">0</span>]], </span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>                [p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>]], </span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the current connection vector</span></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>        ax.plot([p1_pos[<span class="dv">0</span>], p2_pos[<span class="dv">0</span>]], [p1_pos[<span class="dv">1</span>], p2_pos[<span class="dv">1</span>]], </span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="fl">2.5</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw person markers</span></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p1_pos[<span class="dv">0</span>], p1_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">180</span>, color<span class="op">=</span>p1_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p2_pos[<span class="dv">0</span>], p2_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">180</span>, color<span class="op">=</span>p2_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw initial positions</span></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span>p1_color, </span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>                   alpha<span class="op">=</span><span class="fl">0.5</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span>p2_color, </span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>                   alpha<span class="op">=</span><span class="fl">0.5</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw trails (last 15 positions)</span></span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>        start_idx <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, i<span class="op">-</span><span class="dv">15</span>)</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>        ax.plot(p1_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">0</span>], p1_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>], </span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-'</span>, color<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>        ax.plot(p2_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">0</span>], p2_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>], </span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-'</span>, color<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Visualize the approach values with text - make them larger and more visible</span></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>        approach_text <span class="op">=</span> (<span class="ss">f"P1 approach: </span><span class="sc">{</span>p1_approach_values[i]<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f"P2 approach: </span><span class="sc">{</span>p2_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.05</span>, <span class="fl">0.95</span>, approach_text, transform<span class="op">=</span>ax.transAxes, </span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>                verticalalignment<span class="op">=</span><span class="st">'top'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>                bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>))</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add projection visualization</span></span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get current connecting direction</span></span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>            connect_vector <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>            connect_distance <span class="op">=</span> np.linalg.norm(connect_vector)</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>            connect_direction <span class="op">=</span> connect_vector <span class="op">/</span> connect_distance</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Person 1 projection</span></span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>            p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> p1_positions[<span class="dv">0</span>]</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>            p1_projection <span class="op">=</span> np.dot(p1_vector, connect_direction) <span class="op">*</span> connect_direction</span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection line for P1</span></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>            p1_proj_point <span class="op">=</span> p1_positions[<span class="dv">0</span>] <span class="op">+</span> p1_projection</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Person 2 projection - use direction from P2 to P1</span></span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>            p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> p2_positions[<span class="dv">0</span>]</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>            p2_direction <span class="op">=</span> <span class="op">-</span>connect_direction  <span class="co"># Direction from P2 to P1</span></span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>            p2_projection <span class="op">=</span> np.dot(p2_vector, p2_direction) <span class="op">*</span> p2_direction</span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection line for P2</span></span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>            p2_proj_point <span class="op">=</span> p2_positions[<span class="dv">0</span>] <span class="op">+</span> p2_projection</span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection lines with arrows to show direction</span></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P1</span></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>            p1_approach <span class="op">=</span> p1_approach_values[i]</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(p1_approach) <span class="op">&gt;</span> <span class="fl">0.1</span>:  <span class="co"># Only draw if there's a significant approach value</span></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw line with increased width</span></span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>                ax.plot([p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_proj_point[<span class="dv">0</span>]], </span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>                        [p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], p1_proj_point[<span class="dv">1</span>]], </span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'--'</span>, color<span class="op">=</span>p1_color, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add arrow to show direction - make arrow larger</span></span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>                arrow_length <span class="op">=</span> <span class="bu">min</span>(<span class="bu">abs</span>(p1_approach) <span class="op">*</span> <span class="fl">0.2</span>, <span class="fl">0.6</span>)  <span class="co"># Scale arrow size</span></span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>                arrow_width <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> p1_approach <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Approaching</span></span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position toward projection point</span></span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>                            arrow_length <span class="op">*</span> connect_direction[<span class="dv">0</span>], arrow_length <span class="op">*</span> connect_direction[<span class="dv">1</span>],</span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p1_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:  <span class="co"># Retreating</span></span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position away from projection point</span></span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>                            <span class="op">-</span>arrow_length <span class="op">*</span> connect_direction[<span class="dv">0</span>], <span class="op">-</span>arrow_length <span class="op">*</span> connect_direction[<span class="dv">1</span>],</span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p1_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add value label near the projection line</span></span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>                mid_x <span class="op">=</span> (p1_positions[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> p1_proj_point[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>                mid_y <span class="op">=</span> (p1_positions[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> p1_proj_point[<span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a>                ax.text(mid_x, mid_y, <span class="ss">f"</span><span class="sc">{</span>p1_approach<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>p1_color, fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a>                        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, boxstyle<span class="op">=</span><span class="st">'round,pad=0.2'</span>))</span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P2</span></span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a>            p2_approach <span class="op">=</span> p2_approach_values[i]</span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(p2_approach) <span class="op">&gt;</span> <span class="fl">0.1</span>:  <span class="co"># Only draw if there's a significant approach value</span></span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw line with increased width</span></span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>                ax.plot([p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_proj_point[<span class="dv">0</span>]], </span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>                        [p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], p2_proj_point[<span class="dv">1</span>]], </span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'--'</span>, color<span class="op">=</span>p2_color, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add arrow to show direction - make arrow larger</span></span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a>                arrow_length <span class="op">=</span> <span class="bu">min</span>(<span class="bu">abs</span>(p2_approach) <span class="op">*</span> <span class="fl">0.2</span>, <span class="fl">0.6</span>)  <span class="co"># Scale arrow size</span></span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a>                arrow_width <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> p2_approach <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Approaching</span></span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position toward P1</span></span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a>                            arrow_length <span class="op">*</span> p2_direction[<span class="dv">0</span>], arrow_length <span class="op">*</span> p2_direction[<span class="dv">1</span>],</span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p2_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:  <span class="co"># Retreating</span></span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position away from P1</span></span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a>                            <span class="op">-</span>arrow_length <span class="op">*</span> p2_direction[<span class="dv">0</span>], <span class="op">-</span>arrow_length <span class="op">*</span> p2_direction[<span class="dv">1</span>],</span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p2_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add value label near the projection line</span></span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a>                mid_x <span class="op">=</span> (p2_positions[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> p2_proj_point[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a>                mid_y <span class="op">=</span> (p2_positions[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> p2_proj_point[<span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a>                ax.text(mid_x, mid_y, <span class="ss">f"</span><span class="sc">{</span>p2_approach<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>p2_color, fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a>                        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, boxstyle<span class="op">=</span><span class="st">'round,pad=0.2'</span>))</span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add small markers at projection points</span></span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_proj_point[<span class="dv">0</span>], p1_proj_point[<span class="dv">1</span>], </span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a>                      color<span class="op">=</span>p1_color, s<span class="op">=</span><span class="dv">70</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_proj_point[<span class="dv">0</span>], p2_proj_point[<span class="dv">1</span>], </span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a>                      color<span class="op">=</span>p2_color, s<span class="op">=</span><span class="dv">70</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw horizontal dotted line at initial y-coordinate to emphasize horizontal start</span></span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a>            ax.axhline(y<span class="op">=</span>p1_initial[<span class="dv">1</span>], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add legend</span></span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a>        legend_elements <span class="op">=</span> [</span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>p1_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Person 1'</span>),</span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>p2_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Person 2'</span>),</span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>vector_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Connection Vector'</span>),</span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a>            mlines.Line2D([], [], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, label<span class="op">=</span><span class="st">'Initial Horizontal Line'</span>),</span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a>            mlines.Line2D([], [], color<span class="op">=</span>p1_color, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Projection Length = Approach Value'</span>)</span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a>        ax.legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add a frame counter</span></span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.95</span>, <span class="fl">0.05</span>, <span class="ss">f"Frame: </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>num_frames<span class="op">-</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>, transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a>               horizontalalignment<span class="op">=</span><span class="st">'right'</span>, verticalalignment<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true" tabindex="-1"></a>               bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add description text</span></span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a>        description <span class="op">=</span> (</span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Proximity Calculation Visualization</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Large dots: Current positions</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Small dots: Initial positions (horizontal alignment)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Green line: Current connecting vector</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Dashed lines: Projection of movement (length = approach value)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Arrows: Direction of approach/retreat</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Positive values: Movement toward other person</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Negative values: Movement away from other person</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- X markers: Projected positions"</span></span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.05</span>, <span class="fl">0.05</span>, description, transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a>               verticalalignment<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a>               bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>))</span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the animation with explicit FPS and DPI</span></span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a>    ani <span class="op">=</span> FuncAnimation(fig, animate, frames<span class="op">=</span>num_frames, init_func<span class="op">=</span>init, </span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a>                        blit<span class="op">=</span><span class="va">True</span>, interval<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the animation as a GIF with explicit DPI</span></span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a>    ani.save(<span class="st">'images/proximity_visualization/proximity_calculation_extreme.gif'</span>, writer<span class="op">=</span><span class="st">'pillow'</span>, fps<span class="op">=</span><span class="dv">10</span>, dpi<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a>    plt.close(fig)</span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the animation</span></span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Creating animation..."</span>)</span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true" tabindex="-1"></a>    create_detailed_animation()</span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GIF created successfully in the 'images/proximity_visualization' folder."</span>)</span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error creating animation: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alternative approach if the above fails - create static frames</span></span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Trying alternative approach with static frames..."</span>)</span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a static image sequence instead</span></span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a>        os.makedirs(<span class="st">"images/proximity_visualization/frames"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create 10 static frames instead of full animation</span></span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a>        sample_frames <span class="op">=</span> np.linspace(<span class="dv">0</span>, num_frames<span class="op">-</span><span class="dv">1</span>, <span class="dv">10</span>, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, i <span class="kw">in</span> <span class="bu">enumerate</span>(sample_frames):</span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a>            fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), dpi<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Set up the axes</span></span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a>            ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a>            ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a>            ax.set_title(<span class="ss">f'Proximity Calculation (Frame </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get current positions</span></span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a>            p1_pos <span class="op">=</span> p1_positions[i]</span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a>            p2_pos <span class="op">=</span> p2_positions[i]</span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw the connection vector</span></span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a>            ax.plot([p1_pos[<span class="dv">0</span>], p2_pos[<span class="dv">0</span>]], [p1_pos[<span class="dv">1</span>], p2_pos[<span class="dv">1</span>]], </span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-315"><a href="#cb9-315" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-316"><a href="#cb9-316" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw person markers</span></span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_pos[<span class="dv">0</span>], p1_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">150</span>, color<span class="op">=</span>p1_color, label<span class="op">=</span><span class="st">'Person 1'</span>)</span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_pos[<span class="dv">0</span>], p2_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">150</span>, color<span class="op">=</span>p2_color, label<span class="op">=</span><span class="st">'Person 2'</span>)</span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw initial positions</span></span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-324"><a href="#cb9-324" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw horizontal dotted line at initial y-coordinate</span></span>
<span id="cb9-325"><a href="#cb9-325" aria-hidden="true" tabindex="-1"></a>            ax.axhline(y<span class="op">=</span>p1_initial[<span class="dv">1</span>], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb9-326"><a href="#cb9-326" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-327"><a href="#cb9-327" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Show approach values</span></span>
<span id="cb9-328"><a href="#cb9-328" aria-hidden="true" tabindex="-1"></a>            ax.text(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="ss">f"Person 1 approach: </span><span class="sc">{</span>p1_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb9-329"><a href="#cb9-329" aria-hidden="true" tabindex="-1"></a>                    transform<span class="op">=</span>ax.transAxes, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb9-330"><a href="#cb9-330" aria-hidden="true" tabindex="-1"></a>                    bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.3</span>))</span>
<span id="cb9-331"><a href="#cb9-331" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-332"><a href="#cb9-332" aria-hidden="true" tabindex="-1"></a>            ax.text(<span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="ss">f"Person 2 approach: </span><span class="sc">{</span>p2_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb9-333"><a href="#cb9-333" aria-hidden="true" tabindex="-1"></a>                    transform<span class="op">=</span>ax.transAxes, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb9-334"><a href="#cb9-334" aria-hidden="true" tabindex="-1"></a>                    bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.3</span>))</span>
<span id="cb9-335"><a href="#cb9-335" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-336"><a href="#cb9-336" aria-hidden="true" tabindex="-1"></a>            ax.legend()</span>
<span id="cb9-337"><a href="#cb9-337" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-338"><a href="#cb9-338" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the frame</span></span>
<span id="cb9-339"><a href="#cb9-339" aria-hidden="true" tabindex="-1"></a>            plt.tight_layout()</span>
<span id="cb9-340"><a href="#cb9-340" aria-hidden="true" tabindex="-1"></a>            plt.savefig(<span class="ss">f'images/proximity_visualization/frames/frame_</span><span class="sc">{</span>idx<span class="sc">:02d}</span><span class="ss">.png'</span>)</span>
<span id="cb9-341"><a href="#cb9-341" aria-hidden="true" tabindex="-1"></a>            plt.close(fig)</span>
<span id="cb9-342"><a href="#cb9-342" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-343"><a href="#cb9-343" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Static frames created successfully in 'images/proximity_visualization/frames' folder."</span>)</span>
<span id="cb9-344"><a href="#cb9-344" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-345"><a href="#cb9-345" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Alternative approach also failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Creating animation...
GIF created successfully in the 'images/proximity_visualization' folder.</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/proximity_visualization/proximity_calculation.gif" class="img-fluid figure-img"></p>
<figcaption>Proximity Calculation Visualization</figcaption>
</figure>
</div>
<p>We further check for any remaining missing values after processing and confirms time continuity to detect any frame drops or temporal misalignments.</p>
<p>The output of this script is a timeseries matrix for each video, which contains the time in seconds and the calculated variables. The timeseries matrices are saved in the <code>./dataoutput_STEP1_2_timeseries/</code> folder. The code below is the script <code>STEP2_process_timeseries.py</code> that you can run to process the raw pose data.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pipeline code step 1.2 for processing to timeseries data üö©
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bisect <span class="im">import</span> bisect_left</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> savgol_filter</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Path Definitions</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>INPUT_LAYER1_PATH <span class="op">=</span> <span class="st">'../dataoutput_STEP1_1_rawposedata/'</span>  <span class="co"># Input directory containing tracked keypoint data from STEP1</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>VIDEO_PATH <span class="op">=</span> <span class="st">"../data_raw/"</span>                        <span class="co"># Raw video files directory</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>OUTPUT_PATH <span class="op">=</span> <span class="st">'../dataoutput_STEP1_2_timeseries/'</span>     <span class="co"># Output directory for processed timeseries data</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable Explanations:</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Positional Variables:</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># - x, y: 2D coordinates in the image frame</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># - x_min, x_max, y_min, y_max: Bounding box coordinates for a person</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># - centroid_x, centroid_y: Center point of a person's bounding box</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co"># - com_x, com_y: Center of mass for a person (average of upper body keypoint positions)</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># - shoulder_midpoint_*: Midpoint between left and right shoulders for each person (p1, p2)</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co"># - wrist_left_*, wrist_right_*: Positions of left and right wrists for each person (p1, p2)</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance Variables:</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance: Euclidean distance between the centroids of both people</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance_com: Euclidean distance between centers of mass of both people</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance_shoulder_midpoint: Distance between shoulder midpoints of both people</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="co"># - *_speed: Euclidean speed of different body parts (calculated from position differences)</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co"># - *_speed_smooth: Smoothed version of speed using Savitzky-Golay filter</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Movement Analysis:</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="co"># - p1_com_approach_pos, p2_com_approach_pos: Position of each person's COM relative to their</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="co">#   initial position, projected onto the connecting line between people. Positive values </span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="co">#   indicate movement toward the other person.</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Tracking Status:</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="co"># - both_tracked: Boolean indicating if both people are tracked in the current frame</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="co"># - single_tracked: Boolean indicating if only one person is tracked in the current frame</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> frame_to_time(ts, fps):</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert frame numbers to time in seconds"""</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    ts[<span class="st">"time"</span>] <span class="op">=</span> [row[<span class="dv">1</span>][<span class="st">"frame"</span>] <span class="op">/</span> fps <span class="cf">for</span> row <span class="kw">in</span> ts.iterrows()]</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> take_closest(myList, myNumber):</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="co">    Assumes myList is sorted. Returns closest value to myNumber.</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="co">    If two numbers are equally close, return the smallest number.</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">=</span> bisect_left(myList, myNumber)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> myList[<span class="dv">0</span>]</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">==</span> <span class="bu">len</span>(myList):</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> myList[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>    before <span class="op">=</span> myList[pos <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    after <span class="op">=</span> myList[pos]</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> after <span class="op">-</span> myNumber <span class="op">&lt;</span> myNumber <span class="op">-</span> before:</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> after</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> before</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_left_right(ts):</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Assign person IDs (0 or 1) based on x-position in the frame"""</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>    min_x <span class="op">=</span> np.<span class="bu">min</span>([val <span class="cf">for</span> val <span class="kw">in</span> ts[<span class="st">'x'</span>] <span class="cf">if</span> val <span class="op">!=</span> <span class="dv">0</span>])</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>    max_x <span class="op">=</span> np.<span class="bu">max</span>([val <span class="cf">for</span> val <span class="kw">in</span> ts[<span class="st">'x'</span>] <span class="cf">if</span> val <span class="op">!=</span> <span class="dv">0</span>])</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> ts.iterrows():</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'x'</span>] <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># Skip untracked points</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> take_closest([min_x, max_x], row[<span class="st">'x'</span>]) <span class="op">==</span> min_x:</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>            ts.loc[index, <span class="st">'person'</span>] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Left person</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>            ts.loc[index, <span class="st">'person'</span>] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Right person</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_time_data(ts):</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate statistics for tracked people using upper body keypoints"""</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    ts_upper <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>] <span class="op">&lt;</span> <span class="dv">11</span>]  <span class="co"># Filter to upper body keypoints only</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate stats per person and time</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> ts_upper.groupby([<span class="st">'time'</span>, <span class="st">'person'</span>]).agg({</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">'x'</span>: [<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>],</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y'</span>: [<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>]</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    stats.columns <span class="op">=</span> [<span class="st">'time'</span>, <span class="st">'person'</span>, <span class="st">'x_min'</span>, <span class="st">'x_max'</span>, <span class="st">'com_x'</span>, <span class="st">'y_min'</span>, <span class="st">'y_max'</span>, <span class="st">'com_y'</span>]</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    stats[<span class="st">'centroid_x'</span>] <span class="op">=</span> (stats[<span class="st">'x_min'</span>] <span class="op">+</span> stats[<span class="st">'x_max'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    stats[<span class="st">'centroid_y'</span>] <span class="op">=</span> (stats[<span class="st">'y_min'</span>] <span class="op">+</span> stats[<span class="st">'y_max'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stats</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_people_data_vectorized(ts, stats):</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a><span class="co">    Process keypoint data to calculate relative positions and distances.</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a><span class="co">    Preserves time alignment and handles COM/centroid assignment.</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all unique times from the original data</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>    all_times <span class="op">=</span> <span class="bu">sorted</span>(ts[<span class="st">'time'</span>].unique())</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>all_times)</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>    result.index.name <span class="op">=</span> <span class="st">'time'</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process shoulders first (keypoints 5 and 6)</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>    shoulders <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>].isin([<span class="dv">5</span>, <span class="dv">6</span>])].groupby([<span class="st">'time'</span>, <span class="st">'person'</span>]).agg({</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>        <span class="st">'x'</span>: <span class="st">'mean'</span>,</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y'</span>: <span class="st">'mean'</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process wrists (keypoints 7 and 8)</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>    wrists <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>].isin([<span class="dv">7</span>, <span class="dv">8</span>])].pivot_table(</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="st">'time'</span>, <span class="st">'person'</span>],</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span><span class="st">'keypoint'</span>,</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[<span class="st">'x'</span>, <span class="st">'y'</span>]</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>    wrists.columns <span class="op">=</span> [<span class="st">'time'</span>, <span class="st">'person'</span>, <span class="st">'left_x'</span>, <span class="st">'right_x'</span>, <span class="st">'left_y'</span>, <span class="st">'right_y'</span>]</span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get person-specific data</span></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>    p0_stats <span class="op">=</span> stats[stats[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">0</span>].set_index(<span class="st">'time'</span>)</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>    p1_stats <span class="op">=</span> stats[stats[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">1</span>].set_index(<span class="st">'time'</span>)</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process distances where both people exist</span></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>    common_times <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>(p0_stats.index) <span class="op">&amp;</span> <span class="bu">set</span>(p1_stats.index))</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> common_times:  <span class="co"># Only calculate if we have common times</span></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>        result.loc[common_times, <span class="st">'distance'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'centroid_x'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'centroid_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'centroid_y'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'centroid_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>        result.loc[common_times, <span class="st">'distance_com'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'com_x'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'com_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'com_y'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'com_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process shoulders per person</span></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> person, prefix <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'p1'</span>), (<span class="dv">1</span>, <span class="st">'p2'</span>)]:</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>        s_person <span class="op">=</span> shoulders[shoulders[<span class="st">'person'</span>] <span class="op">==</span> person].set_index(<span class="st">'time'</span>)</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'shoulder_midpoint_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> s_person[<span class="st">'x'</span>]</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'shoulder_midpoint_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> s_person[<span class="st">'y'</span>]</span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate shoulder midpoint distance where possible</span></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>    shoulder_cols <span class="op">=</span> [<span class="st">'shoulder_midpoint_p1_x'</span>, <span class="st">'shoulder_midpoint_p2_x'</span>,</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'shoulder_midpoint_p1_y'</span>, <span class="st">'shoulder_midpoint_p2_y'</span>]</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>    shoulder_mask <span class="op">=</span> result[shoulder_cols].notna().<span class="bu">all</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> shoulder_mask.<span class="bu">any</span>():</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>        result.loc[shoulder_mask, <span class="st">'distance_shoulder_midpoint'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>            (result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p1_x'</span>] <span class="op">-</span> result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p2_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>            (result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p1_y'</span>] <span class="op">-</span> result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p2_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process wrists per person and add COM/centroid</span></span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> person, prefix <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'p1'</span>), (<span class="dv">1</span>, <span class="st">'p2'</span>)]:</span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>        w_person <span class="op">=</span> wrists[wrists[<span class="st">'person'</span>] <span class="op">==</span> person].set_index(<span class="st">'time'</span>)</span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_left_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> w_person[<span class="st">'left_x'</span>]</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_left_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> w_person[<span class="st">'left_y'</span>]</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_right_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> w_person[<span class="st">'right_x'</span>]</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_right_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> w_person[<span class="st">'right_y'</span>]</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the correct stats object based on person ID</span></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>        person_stats <span class="op">=</span> p0_stats <span class="cf">if</span> person <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> p1_stats</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add com and centroid with the correct stats object</span></span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'com_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> person_stats[<span class="st">'com_x'</span>]</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'com_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> person_stats[<span class="st">'com_y'</span>]</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'centroid_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> person_stats[<span class="st">'centroid_x'</span>]</span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'centroid_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> person_stats[<span class="st">'centroid_y'</span>]</span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add tracking quality indicators using original data</span></span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>    person_counts <span class="op">=</span> ts.groupby(<span class="st">'time'</span>)[<span class="st">'person'</span>].nunique()</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>    result[<span class="st">'both_tracked'</span>] <span class="op">=</span> result.index.<span class="bu">map</span>(<span class="kw">lambda</span> x: person_counts.get(x, <span class="dv">0</span>) <span class="op">==</span> <span class="dv">2</span>)</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>    result[<span class="st">'single_tracked'</span>] <span class="op">=</span> result.index.<span class="bu">map</span>(<span class="kw">lambda</span> x: person_counts.get(x, <span class="dv">0</span>) <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_proximity_approach(timeseries_data):</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate each person's position relative to their initial position,</span></span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a><span class="co">    projecting movement onto the current connecting line between people.</span></span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a><span class="co">    This handles rotation and changing spatial relationships between people.</span></span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a><span class="co">    Positive values indicate movement toward the other person from initial position.</span></span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a><span class="co">    The reference positions are only established when both people are detected.</span></span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create columns for our measurements</span></span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'p1_com_approach_pos'</span> <span class="kw">not</span> <span class="kw">in</span> timeseries_data.columns:</span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> np.nan</span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'p2_com_approach_pos'</span> <span class="kw">not</span> <span class="kw">in</span> timeseries_data.columns:</span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> np.nan</span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort data by time</span></span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a>    sorted_data <span class="op">=</span> timeseries_data.sort_values(<span class="st">'time'</span>)</span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find first valid frame to establish reference positions</span></span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a>    reference_p1_pos <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>    reference_p2_pos <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>    reference_distance <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First pass: find reference frame where both people are detected</span></span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> sorted_data.iterrows():</span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip rows with NaN values or where both_tracked is False</span></span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (np.isnan(row[<span class="st">'com_p1_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p1_y'</span>]) <span class="kw">or</span> </span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>            np.isnan(row[<span class="st">'com_p2_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p2_y'</span>]) <span class="kw">or</span></span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'both_tracked'</span> <span class="kw">in</span> row.index <span class="kw">and</span> row[<span class="st">'both_tracked'</span>] <span class="op">==</span> <span class="va">False</span>)):</span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get positions for this frame</span></span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> np.array([row[<span class="st">'com_p1_x'</span>], row[<span class="st">'com_p1_y'</span>]])</span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> np.array([row[<span class="st">'com_p2_x'</span>], row[<span class="st">'com_p2_y'</span>]])</span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate connecting vector</span></span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a>        connect_vector <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> np.linalg.norm(connect_vector)</span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> distance <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We found a valid reference frame</span></span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a>            reference_p1_pos <span class="op">=</span> p1_pos.copy()</span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>            reference_p2_pos <span class="op">=</span> p2_pos.copy()</span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a>            reference_distance <span class="op">=</span> distance</span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Reference frame established at time=</span><span class="sc">{</span>row[<span class="st">'time'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference p1_pos: </span><span class="sc">{</span>reference_p1_pos<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference p2_pos: </span><span class="sc">{</span>reference_p2_pos<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference distance: </span><span class="sc">{</span>reference_distance<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> reference_p1_pos <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"ERROR: Could not establish a reference frame. No valid frames found with both people detected."</span>)</span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> timeseries_data</span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Second pass: calculate projected positions for all frames</span></span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> sorted_data.iterrows():</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip rows with NaN values</span></span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (np.isnan(row[<span class="st">'com_p1_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p1_y'</span>]) <span class="kw">or</span> </span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a>            np.isnan(row[<span class="st">'com_p2_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p2_y'</span>])):</span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get current positions</span></span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> np.array([row[<span class="st">'com_p1_x'</span>], row[<span class="st">'com_p1_y'</span>]])</span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> np.array([row[<span class="st">'com_p2_x'</span>], row[<span class="st">'com_p2_y'</span>]])</span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate current connecting vector and direction</span></span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a>        current_connect <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a>        current_distance <span class="op">=</span> np.linalg.norm(current_connect)</span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip frames where people are at the same position</span></span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_distance <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a>        current_direction <span class="op">=</span> current_connect <span class="op">/</span> current_distance</span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate vector from reference position to current position</span></span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a>        p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> reference_p1_pos</span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a>        p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> reference_p2_pos</span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Project these vectors onto the current connecting line</span></span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Positive values mean moving toward the other person</span></span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a>        p1_projection <span class="op">=</span> np.dot(p1_vector, current_direction)</span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a>        p2_projection <span class="op">=</span> <span class="op">-</span>np.dot(p2_vector, <span class="op">-</span>current_direction)</span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store values</span></span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>        timeseries_data.loc[idx, <span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> p1_projection</span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a>        timeseries_data.loc[idx, <span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> p2_projection</span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify results</span></span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a>    filled_p1 <span class="op">=</span> timeseries_data[<span class="st">'p1_com_approach_pos'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a>    filled_p2 <span class="op">=</span> timeseries_data[<span class="st">'p2_com_approach_pos'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Frames with filled values - p1: </span><span class="sc">{</span>filled_p1<span class="sc">}</span><span class="ss">, p2: </span><span class="sc">{</span>filled_p2<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> timeseries_data</span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main processing function"""</span></span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a>    os.makedirs(OUTPUT_PATH, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all CSV files from layer 1 processing</span></span>
<span id="cb11-283"><a href="#cb11-283" aria-hidden="true" tabindex="-1"></a>    layer1_files <span class="op">=</span> glob.glob(INPUT_LAYER1_PATH <span class="op">+</span> <span class="st">'*.csv'</span>)</span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each file</span></span>
<span id="cb11-286"><a href="#cb11-286" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_path <span class="kw">in</span> layer1_files:</span>
<span id="cb11-287"><a href="#cb11-287" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract video name from file path</span></span>
<span id="cb11-288"><a href="#cb11-288" aria-hidden="true" tabindex="-1"></a>        vid_name <span class="op">=</span> os.path.basename(file_path).split(<span class="st">'_keypoints_data_layer1.csv'</span>)[<span class="dv">0</span>]</span>
<span id="cb11-289"><a href="#cb11-289" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Processing video: </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-290"><a href="#cb11-290" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-291"><a href="#cb11-291" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if already processed</span></span>
<span id="cb11-292"><a href="#cb11-292" aria-hidden="true" tabindex="-1"></a>        output_file <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>OUTPUT_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">_processed_data_layer2.csv"</span></span>
<span id="cb11-293"><a href="#cb11-293" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(output_file):</span>
<span id="cb11-294"><a href="#cb11-294" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Already processed, skipping..."</span>)</span>
<span id="cb11-295"><a href="#cb11-295" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-296"><a href="#cb11-296" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-297"><a href="#cb11-297" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine video format and get FPS</span></span>
<span id="cb11-298"><a href="#cb11-298" aria-hidden="true" tabindex="-1"></a>        video_path <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-299"><a href="#cb11-299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ext <span class="kw">in</span> [<span class="st">'.avi'</span>, <span class="st">'.mp4'</span>, <span class="st">'.mov'</span>]:</span>
<span id="cb11-300"><a href="#cb11-300" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> os.path.exists(<span class="ss">f"</span><span class="sc">{</span>VIDEO_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}{</span>ext<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb11-301"><a href="#cb11-301" aria-hidden="true" tabindex="-1"></a>                video_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>VIDEO_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}{</span>ext<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb11-302"><a href="#cb11-302" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb11-303"><a href="#cb11-303" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-304"><a href="#cb11-304" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> video_path:</span>
<span id="cb11-305"><a href="#cb11-305" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Video file not found for </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-306"><a href="#cb11-306" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-307"><a href="#cb11-307" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-308"><a href="#cb11-308" aria-hidden="true" tabindex="-1"></a>        cap <span class="op">=</span> cv2.VideoCapture(video_path)</span>
<span id="cb11-309"><a href="#cb11-309" aria-hidden="true" tabindex="-1"></a>        fps <span class="op">=</span> cap.get(cv2.CAP_PROP_FPS)</span>
<span id="cb11-310"><a href="#cb11-310" aria-hidden="true" tabindex="-1"></a>        cap.release()</span>
<span id="cb11-311"><a href="#cb11-311" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Working on: </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss"> with fps = </span><span class="sc">{</span>fps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-312"><a href="#cb11-312" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-313"><a href="#cb11-313" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load and preprocess data</span></span>
<span id="cb11-314"><a href="#cb11-314" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> pd.read_csv(file_path)</span>
<span id="cb11-315"><a href="#cb11-315" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> frame_to_time(ts, fps<span class="op">=</span>fps)</span>
<span id="cb11-316"><a href="#cb11-316" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> assign_left_right(ts)</span>
<span id="cb11-317"><a href="#cb11-317" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-318"><a href="#cb11-318" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate statistics</span></span>
<span id="cb11-319"><a href="#cb11-319" aria-hidden="true" tabindex="-1"></a>        stats <span class="op">=</span> process_time_data(ts)</span>
<span id="cb11-320"><a href="#cb11-320" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-321"><a href="#cb11-321" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process tracked data</span></span>
<span id="cb11-322"><a href="#cb11-322" aria-hidden="true" tabindex="-1"></a>        processed_data <span class="op">=</span> process_people_data_vectorized(ts, stats)</span>
<span id="cb11-323"><a href="#cb11-323" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-324"><a href="#cb11-324" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create final data frame</span></span>
<span id="cb11-325"><a href="#cb11-325" aria-hidden="true" tabindex="-1"></a>        bb_data <span class="op">=</span> pd.merge(</span>
<span id="cb11-326"><a href="#cb11-326" aria-hidden="true" tabindex="-1"></a>            stats, </span>
<span id="cb11-327"><a href="#cb11-327" aria-hidden="true" tabindex="-1"></a>            processed_data.reset_index(), </span>
<span id="cb11-328"><a href="#cb11-328" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">'time'</span>, </span>
<span id="cb11-329"><a href="#cb11-329" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">'outer'</span></span>
<span id="cb11-330"><a href="#cb11-330" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-331"><a href="#cb11-331" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-332"><a href="#cb11-332" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract time series data (using person 0 as reference)</span></span>
<span id="cb11-333"><a href="#cb11-333" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> bb_data[bb_data[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">0</span>].copy()  <span class="co"># Make a copy to avoid SettingWithCopyWarning</span></span>
<span id="cb11-334"><a href="#cb11-334" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-335"><a href="#cb11-335" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove unnecessary columns</span></span>
<span id="cb11-336"><a href="#cb11-336" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.drop(columns<span class="op">=</span><span class="st">'person'</span>)</span>
<span id="cb11-337"><a href="#cb11-337" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-338"><a href="#cb11-338" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate desired time step based on FPS</span></span>
<span id="cb11-339"><a href="#cb11-339" aria-hidden="true" tabindex="-1"></a>        desired_time_step <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>fps</span>
<span id="cb11-340"><a href="#cb11-340" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-341"><a href="#cb11-341" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Interpolate missing values</span></span>
<span id="cb11-342"><a href="#cb11-342" aria-hidden="true" tabindex="-1"></a>        nan_cols <span class="op">=</span> timeseries_data.columns[timeseries_data.isna().<span class="bu">any</span>()].tolist()</span>
<span id="cb11-343"><a href="#cb11-343" aria-hidden="true" tabindex="-1"></a>        timeseries_data[nan_cols] <span class="op">=</span> timeseries_data[nan_cols].interpolate()</span>
<span id="cb11-344"><a href="#cb11-344" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-345"><a href="#cb11-345" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth distance with Savitzky-Golay filter</span></span>
<span id="cb11-346"><a href="#cb11-346" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'distance_smooth'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'distance'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb11-347"><a href="#cb11-347" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-348"><a href="#cb11-348" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate and smooth wrist speeds</span></span>
<span id="cb11-349"><a href="#cb11-349" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> wrist <span class="kw">in</span> [<span class="st">'wrist_left_p1'</span>, <span class="st">'wrist_right_p1'</span>, <span class="st">'wrist_left_p2'</span>, <span class="st">'wrist_right_p2'</span>]:</span>
<span id="cb11-350"><a href="#cb11-350" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate speed as Euclidean distance between consecutive positions</span></span>
<span id="cb11-351"><a href="#cb11-351" aria-hidden="true" tabindex="-1"></a>            timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb11-352"><a href="#cb11-352" aria-hidden="true" tabindex="-1"></a>                timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_x'</span>].diff()<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_y'</span>].diff()<span class="op">**</span><span class="dv">2</span></span>
<span id="cb11-353"><a href="#cb11-353" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-354"><a href="#cb11-354" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-355"><a href="#cb11-355" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Apply Savitzky-Golay filter for smoothing</span></span>
<span id="cb11-356"><a href="#cb11-356" aria-hidden="true" tabindex="-1"></a>            timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed_smooth'</span>] <span class="op">=</span> savgol_filter(</span>
<span id="cb11-357"><a href="#cb11-357" aria-hidden="true" tabindex="-1"></a>                timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed'</span>].values, <span class="dv">11</span>, <span class="dv">3</span></span>
<span id="cb11-358"><a href="#cb11-358" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-359"><a href="#cb11-359" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-360"><a href="#cb11-360" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill NaN values before calculating proximity approach</span></span>
<span id="cb11-361"><a href="#cb11-361" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.fillna(method<span class="op">=</span><span class="st">'ffill'</span>)</span>
<span id="cb11-362"><a href="#cb11-362" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-363"><a href="#cb11-363" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate proximity approach</span></span>
<span id="cb11-364"><a href="#cb11-364" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> calculate_proximity_approach(timeseries_data)</span>
<span id="cb11-365"><a href="#cb11-365" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-366"><a href="#cb11-366" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill any remaining NaN values</span></span>
<span id="cb11-367"><a href="#cb11-367" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.fillna(method<span class="op">=</span><span class="st">'ffill'</span>)</span>
<span id="cb11-368"><a href="#cb11-368" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-369"><a href="#cb11-369" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth proximity approach values</span></span>
<span id="cb11-370"><a href="#cb11-370" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'p1_com_approach_pos'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb11-371"><a href="#cb11-371" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'p2_com_approach_pos'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb11-372"><a href="#cb11-372" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-373"><a href="#cb11-373" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for any remaining NaN values</span></span>
<span id="cb11-374"><a href="#cb11-374" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Checking for NaN values..."</span>)</span>
<span id="cb11-375"><a href="#cb11-375" aria-hidden="true" tabindex="-1"></a>        nan_counts <span class="op">=</span> timeseries_data.isna().<span class="bu">sum</span>()</span>
<span id="cb11-376"><a href="#cb11-376" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> nan_counts.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb11-377"><a href="#cb11-377" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Found NaN values after processing:"</span>)</span>
<span id="cb11-378"><a href="#cb11-378" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(nan_counts)</span>
<span id="cb11-379"><a href="#cb11-379" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-380"><a href="#cb11-380" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No NaN values found."</span>)</span>
<span id="cb11-381"><a href="#cb11-381" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-382"><a href="#cb11-382" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save processed data</span></span>
<span id="cb11-383"><a href="#cb11-383" aria-hidden="true" tabindex="-1"></a>        timeseries_data.to_csv(output_file, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-384"><a href="#cb11-384" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-385"><a href="#cb11-385" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for time continuity</span></span>
<span id="cb11-386"><a href="#cb11-386" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Checking time continuity..."</span>)</span>
<span id="cb11-387"><a href="#cb11-387" aria-hidden="true" tabindex="-1"></a>        time_diffs <span class="op">=</span> np.array([<span class="bu">round</span>(val, <span class="dv">2</span>) <span class="cf">for</span> val <span class="kw">in</span> np.diff(timeseries_data[<span class="st">'time'</span>])])</span>
<span id="cb11-388"><a href="#cb11-388" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.<span class="bu">all</span>(time_diffs <span class="op">==</span> desired_time_step):</span>
<span id="cb11-389"><a href="#cb11-389" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Found gaps at times: </span><span class="sc">{</span>np<span class="sc">.</span>where(time_diffs <span class="op">!=</span> desired_time_step)[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-390"><a href="#cb11-390" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-391"><a href="#cb11-391" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No missing time points."</span>)</span>
<span id="cb11-392"><a href="#cb11-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-393"><a href="#cb11-393" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb11-394"><a href="#cb11-394" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>To provide an example of the data we plot here a timeseries of the resultant data.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example output timeseries: üìä
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="im">as</span> glob</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>folderstep12output <span class="op">=</span> <span class="st">"./dataoutput_STEP1_2_timeseries/"</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> glob.glob(os.path.join(folderstep12output <span class="op">+</span> <span class="st">"*.csv"</span>))[<span class="dv">0</span>]</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(csv_file)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       time  x_min  ...  p1_com_approach_pos  p2_com_approach_pos
0  0.000000    0.0  ...            -4.443445            14.947667
1  0.033333    0.0  ...             3.155868            -8.830902
2  0.066667    0.0  ...             5.291834           -14.177377
3  0.100000    0.0  ...             3.769819            -7.269521
4  0.133333    0.0  ...             0.395189             5.714900

[5 rows x 45 columns]</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="step-1.3-animation-with-original-videodata" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="step-1.3-animation-with-original-videodata"><span class="header-section-number">3.3</span> Step 1.3: Animation with original videodata</h2>
<p>We advise users to double check the quality of the tracking data and the derived variables. The animation below is generated using the code <code>STEP3_animation.py</code> which couples video with quantiative data, allowing for qualitatively checking the timeseries real time against what is happening in the video. The user can select variables need to be plotted in the video plus time series animation. The code below provides the animation. Please check the DIY section for how to set up the motion tracking and run the code.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Code chunk: Animation code for coupling video with quantitative data üö©
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bisect <span class="im">import</span> bisect_left</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> savgol_filter</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tqdm</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> moviepy <span class="im">import</span> VideoFileClip</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Path Definitions</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>INPUT_LAYER1_PATH <span class="op">=</span> <span class="st">'../dataoutput_STEP1_2_timeseries/'</span>  <span class="co"># Input directory containing tracked keypoint data from STEP1</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>VIDEO_PATH <span class="op">=</span> <span class="st">"../dataoutput_STEP1_1_rawposedata/"</span>                        <span class="co"># Raw video files directory</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>OUTPUT_PATH <span class="op">=</span> <span class="st">'../dataoutput_STEP1_3_animations/'</span>     <span class="co"># Output directory for processed timeseries data</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>targetvideo <span class="op">=</span> <span class="st">"*sample_annotated_layer1_c150_miss95.mp4"</span> <span class="co"># note that sample video must be set to True to process only a sample video</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>SAMPLE_VIDEO <span class="op">=</span> <span class="va">True</span>  <span class="co"># Set to True to process only a sample video, False to process all videos</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>os.makedirs(OUTPUT_PATH, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co"># animate only sample video?</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> SAMPLE_VIDEO:</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For sample video, use a specific video file</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    allvidsnew <span class="op">=</span>  glob.glob(VIDEO_PATH <span class="op">+</span> <span class="st">"*"</span> <span class="op">+</span> targetvideo)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    allvidsnew <span class="op">=</span> glob.glob(VIDEO_PATH <span class="op">+</span> <span class="st">"*.mp4"</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(allvidsnew)<span class="sc">}</span><span class="ss"> videos to process"</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co"># what variables to animate with video</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>animate_variables <span class="op">=</span> {</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'x_min'</span>: <span class="va">False</span>,</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'x_max'</span>: <span class="va">False</span>,</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">'y_min'</span>: <span class="va">False</span>,</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'y_max'</span>: <span class="va">False</span>,</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">'distance'</span>: <span class="va">False</span>,</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">'distance_com'</span>: <span class="va">False</span>,</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">'shoulder_midpoint_p1_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'shoulder_midpoint_p1_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">'shoulder_midpoint_p2_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">'shoulder_midpoint_p2_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">'distance_shoulder_midpoint'</span>: <span class="va">True</span>,</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p1_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p1_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p1_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p1_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_p1_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_p1_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_p1_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_p1_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p2_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p2_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p2_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p2_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_p2_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_p2_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_p2_x'</span>: <span class="va">False</span>,</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_p2_y'</span>: <span class="va">False</span>,</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">'distance_smooth'</span>: <span class="va">True</span>,</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p1_speed'</span>: <span class="va">False</span>,</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p1_speed_smooth'</span>: <span class="va">True</span>,</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p1_speed'</span>: <span class="va">False</span>,</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p1_speed_smooth'</span>: <span class="va">True</span>,</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p2_speed'</span>: <span class="va">False</span>,</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p2_speed_smooth'</span>: <span class="va">True</span>,</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p2_speed'</span>: <span class="va">False</span>,</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p2_speed_smooth'</span>: <span class="va">True</span>,</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">'p1_com_approach_pos'</span>: <span class="va">True</span>,</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">'p2_com_approach_pos'</span>: <span class="va">True</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a><span class="co"># plotting functions</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_timeseries(timeseries_data, current_time<span class="op">=</span><span class="va">None</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>)):</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualizing of the processed 1_2 motion variable data together with the original video.</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a><span class="co">    Groups variables by modality with consistent coloring for p1/p2 and left/right.</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a><span class="co">    timeseries_data : pandas.DataFrame</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a><span class="co">         DataFrame containing all the motion analysis columns</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a><span class="co">    current_time : float, optional</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a><span class="co">         current time in seconds to mark with vertical line</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a><span class="co">    figsize : tuple, optional</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a><span class="co">         Figure size in inches (width, height)</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter data for only variables marked as True in animate_variables</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>    active_vars <span class="op">=</span> [var <span class="cf">for</span> var, active <span class="kw">in</span> animate_variables.items() <span class="cf">if</span> active <span class="kw">and</span> var <span class="kw">in</span> timeseries_data.columns]</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> active_vars:</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No variables selected for animation!"</span>)</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define consistent color scheme</span></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Colors for p1/p2 (blue family for p1, red family for p2)</span></span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>    p1_colors <span class="op">=</span> {<span class="st">'left'</span>: <span class="st">'#1f77b4'</span>, <span class="st">'right'</span>: <span class="st">'#aec7e8'</span>}  <span class="co"># Dark blue, light blue</span></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>    p2_colors <span class="op">=</span> {<span class="st">'left'</span>: <span class="st">'#d62728'</span>, <span class="st">'right'</span>: <span class="st">'#ff9896'</span>}  <span class="co"># Dark red, light red</span></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>    other_colors <span class="op">=</span> [<span class="st">'#ff7f0e'</span>, <span class="st">'#2ca02c'</span>, <span class="st">'#9467bd'</span>, <span class="st">'#8c564b'</span>, <span class="st">'#e377c2'</span>, <span class="st">'#7f7f7f'</span>, <span class="st">'#bcbd22'</span>, <span class="st">'#17becf'</span>]</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group variables by modality</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>    distance_vars <span class="op">=</span> [var <span class="cf">for</span> var <span class="kw">in</span> active_vars <span class="cf">if</span> <span class="st">'distance'</span> <span class="kw">in</span> var]</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>    position_vars <span class="op">=</span> [var <span class="cf">for</span> var <span class="kw">in</span> active_vars <span class="cf">if</span> <span class="bu">any</span>(x <span class="kw">in</span> var <span class="cf">for</span> x <span class="kw">in</span> [<span class="st">'_x'</span>, <span class="st">'_y'</span>, <span class="st">'approach_pos'</span>]) <span class="kw">and</span> <span class="st">'distance'</span> <span class="kw">not</span> <span class="kw">in</span> var]</span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>    speed_vars <span class="op">=</span> [var <span class="cf">for</span> var <span class="kw">in</span> active_vars <span class="cf">if</span> <span class="st">'speed'</span> <span class="kw">in</span> var]</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate number of subplots needed</span></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>    n_plots <span class="op">=</span> <span class="bu">sum</span>([<span class="bu">len</span>(distance_vars) <span class="op">&gt;</span> <span class="dv">0</span>, <span class="bu">len</span>(position_vars) <span class="op">&gt;</span> <span class="dv">0</span>, <span class="bu">len</span>(speed_vars) <span class="op">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_plots <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create figure with subplots</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(n_plots, <span class="dv">1</span>, figsize<span class="op">=</span>figsize, squeeze<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> axes.flatten()</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>    plot_idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Helper function to get consistent color and style</span></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_style(var_name):</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine person (p1/p2)</span></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'_p1_'</span> <span class="kw">in</span> var_name:</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>            person <span class="op">=</span> <span class="st">'p1'</span></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'_p2_'</span> <span class="kw">in</span> var_name:</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>            person <span class="op">=</span> <span class="st">'p2'</span></span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>            person <span class="op">=</span> <span class="st">'other'</span></span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine side (left/right)</span></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'left'</span> <span class="kw">in</span> var_name:</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>            side <span class="op">=</span> <span class="st">'left'</span></span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'right'</span> <span class="kw">in</span> var_name:</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>            side <span class="op">=</span> <span class="st">'right'</span></span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>            side <span class="op">=</span> <span class="st">'other'</span></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get color</span></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> person <span class="op">==</span> <span class="st">'p1'</span>:</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> p1_colors.get(side, p1_colors[<span class="st">'left'</span>])</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> person <span class="op">==</span> <span class="st">'p2'</span>:</span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> p2_colors.get(side, p2_colors[<span class="st">'left'</span>])</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> other_colors[<span class="dv">0</span>]  <span class="co"># Use first color for non-person variables</span></span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get linestyle (solid for left, dashed for right)</span></span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> side <span class="op">==</span> <span class="st">'right'</span>:</span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>            linestyle <span class="op">=</span> <span class="st">'--'</span></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>            linestyle <span class="op">=</span> <span class="st">'-'</span></span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get alpha (lower for raw data, full for smoothed)</span></span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'smooth'</span> <span class="kw">in</span> var_name:</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">any</span>(x <span class="kw">in</span> var_name <span class="cf">for</span> x <span class="kw">in</span> [<span class="st">'speed'</span>, <span class="st">'velocity'</span>]) <span class="kw">and</span> <span class="st">'smooth'</span> <span class="kw">not</span> <span class="kw">in</span> var_name:</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> color, linestyle, alpha</span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Distance Plots</span></span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> distance_vars:</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> axes[plot_idx]</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>        color_idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> distance_vars:</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(x <span class="kw">in</span> var <span class="cf">for</span> x <span class="kw">in</span> [<span class="st">'_p1_'</span>, <span class="st">'_p2_'</span>]):</span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>                color, linestyle, alpha <span class="op">=</span> get_style(var)</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>                color <span class="op">=</span> other_colors[color_idx <span class="op">%</span> <span class="bu">len</span>(other_colors)]</span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a>                linestyle <span class="op">=</span> <span class="st">'-'</span></span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a>                alpha <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a>                color_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>            ax.plot(timeseries_data[<span class="st">'time'</span>], timeseries_data[var], </span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span>var.replace(<span class="st">'_'</span>, <span class="st">' '</span>), linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span>color, linestyle<span class="op">=</span>linestyle, alpha<span class="op">=</span>alpha)</span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">'Distances Over Time'</span>)</span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Distance'</span>)</span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>        ax.legend()</span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'distance_shoulder_midpoint'</span> <span class="kw">in</span> distance_vars <span class="kw">or</span> <span class="st">'distance'</span> <span class="kw">in</span> distance_vars:</span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>            ax.invert_yaxis()</span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>        plot_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Position Plots (group p1/p2 and left/right together)</span></span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> position_vars:</span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> axes[plot_idx]</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> position_vars:</span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>            color, linestyle, alpha <span class="op">=</span> get_style(var)</span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>            ax.plot(timeseries_data[<span class="st">'time'</span>], timeseries_data[var], </span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span>var.replace(<span class="st">'_'</span>, <span class="st">' '</span>), linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span>color, linestyle<span class="op">=</span>linestyle, alpha<span class="op">=</span>alpha)</span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">'Positions Over Time'</span>)</span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Position'</span>)</span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>        ax.legend()</span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>        plot_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Speed Plots (group p1/p2 and left/right together)</span></span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> speed_vars:</span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> axes[plot_idx]</span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> speed_vars:</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>            color, linestyle, alpha <span class="op">=</span> get_style(var)</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>            ax.plot(timeseries_data[<span class="st">'time'</span>], timeseries_data[var], </span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span>var.replace(<span class="st">'_'</span>, <span class="st">' '</span>), linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span>color, linestyle<span class="op">=</span>linestyle, alpha<span class="op">=</span>alpha)</span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">'Speeds Over Time'</span>)</span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Speed'</span>)</span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>        ax.legend()</span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>        plot_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add vertical line for current time if specified</span></span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current_time <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ax <span class="kw">in</span> axes[:plot_idx]:</span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a>            ax.axvline(x<span class="op">=</span>current_time, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set common x-label</span></span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>    axes[plot_idx<span class="op">-</span><span class="dv">1</span>].set_xlabel(<span class="st">'Time (seconds)'</span>)</span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust layout</span></span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a><span class="co"># Create animation for each video</span></span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> vids <span class="kw">in</span> allvidsnew:</span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> os.path.basename(vids)</span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remove substring "_annotated_layer1"</span></span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>    lab <span class="op">=</span> <span class="st">"_annotated_layer1"</span></span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> vidname.replace(lab, <span class="st">""</span>)     </span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> vidname[:<span class="op">-</span><span class="dv">4</span>]</span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>    <span class="co"># also remove substring "_c150_miss95"</span></span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> vidname.replace(<span class="st">"_c150_miss95"</span>, <span class="st">""</span>)</span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing video: </span><span class="sc">{</span>vidname<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if CSV file exists</span></span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>    csv_path <span class="op">=</span> os.path.join(INPUT_LAYER1_PATH, <span class="ss">f'</span><span class="sc">{</span>vidname<span class="sc">}</span><span class="ss">_processed_data_layer2.csv'</span>)</span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(csv_path):</span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"CSV file not found: </span><span class="sc">{</span>csv_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the CSV file</span></span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>    timeseries_data <span class="op">=</span> pd.read_csv(csv_path)</span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output paths</span></span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>    temp_output <span class="op">=</span> os.path.join(OUTPUT_PATH, <span class="ss">f'</span><span class="sc">{</span>vidname<span class="sc">}</span><span class="ss">_distance_layer2_temp.mp4'</span>)</span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>    final_output <span class="op">=</span> os.path.join(OUTPUT_PATH, <span class="ss">f'</span><span class="sc">{</span>vidname<span class="sc">}</span><span class="ss">_distance_layer2.mp4'</span>)</span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if already exists, skip</span></span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(final_output):</span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Already processed, skipping..."</span>)</span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load the video file in opencv</span></span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>    cap <span class="op">=</span> cv2.VideoCapture(vids)</span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> cap.isOpened():</span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error opening video: </span><span class="sc">{</span>vids<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get video properties</span></span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>    fps <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FPS))</span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>    total_frames <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Video properties: </span><span class="sc">{</span>width<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>height<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>fps<span class="sc">}</span><span class="ss"> FPS, </span><span class="sc">{</span>total_frames<span class="sc">}</span><span class="ss"> frames"</span>)</span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate time step based on FPS</span></span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>    time_step <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> fps</span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Time step: </span><span class="sc">{</span>time_step<span class="sc">:.4f}</span><span class="ss"> seconds per frame"</span>)</span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the output video writer</span></span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>    fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span><span class="st">'mp4v'</span>)</span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> cv2.VideoWriter(temp_output, fourcc, fps, (width, height))</span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create temporary directory for plots</span></span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tempfile.TemporaryDirectory() <span class="im">as</span> temp_dir:</span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Creating animated video..."</span>)</span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>        <span class="co"># loop over the frames with tqdm progress bar</span></span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>        current_time <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Start at time 0</span></span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> frame_idx <span class="kw">in</span> tqdm.tqdm(<span class="bu">range</span>(total_frames), desc<span class="op">=</span><span class="ss">f"Processing </span><span class="sc">{</span>vidname<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>            <span class="co"># read the frame</span></span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>            success, frame <span class="op">=</span> cap.read()</span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>            <span class="co"># plot the timeseries with current time</span></span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>            fig <span class="op">=</span> plot_timeseries(timeseries_data, current_time)</span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> fig <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"No plot generated, skipping frame"</span>)</span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>                out.write(frame)</span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a>                current_time <span class="op">+=</span> time_step  <span class="co"># Increment by time step</span></span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>            <span class="co"># save the plot to a temp file</span></span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>            plot_path <span class="op">=</span> os.path.join(temp_dir, <span class="ss">f'plot_</span><span class="sc">{</span>frame_idx<span class="sc">:06d}</span><span class="ss">.png'</span>)</span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>            fig.savefig(plot_path, dpi<span class="op">=</span><span class="dv">100</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>            plt.close(fig)  <span class="co"># Important: close figure to free memory</span></span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Read the plot image</span></span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a>            plot_img <span class="op">=</span> cv2.imread(plot_path)</span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> plot_img <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Error reading plot image: </span><span class="sc">{</span>plot_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>                out.write(frame)</span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>                current_time <span class="op">+=</span> time_step  <span class="co"># Increment by time step</span></span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate overlay area (bottom third of the frame)</span></span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>            slice_start <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (height <span class="op">//</span> <span class="dv">3</span>)</span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>            slice_height <span class="op">=</span> height <span class="op">-</span> slice_start</span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Resize plot to fit overlay area</span></span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>            plot_img_resized <span class="op">=</span> cv2.resize(plot_img, (width, slice_height))</span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create overlay on the frame</span></span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>            frame_copy <span class="op">=</span> frame.copy()</span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>            frame_copy[slice_start:slice_start <span class="op">+</span> slice_height, :, :] <span class="op">=</span> plot_img_resized</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>            <span class="co"># write the frame to the output video</span></span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>            out.write(frame_copy)</span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>            current_time <span class="op">+=</span> time_step  <span class="co"># Increment by time step (seconds)</span></span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Release everything</span></span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>        cap.release()</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>        out.release()</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Temporary video saved, now re-encoding with MoviePy..."</span>)</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Re-encode with MoviePy for better compatibility</span></span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a>        clip <span class="op">=</span> VideoFileClip(temp_output)</span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>        clip.write_videofile(final_output, codec<span class="op">=</span><span class="st">'libx264'</span>, audio_codec<span class="op">=</span><span class="st">'aac'</span>)</span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>        clip.close()</span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove temporary file</span></span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(temp_output):</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>            os.remove(temp_output)</span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Final output video saved as </span><span class="sc">{</span>final_output<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error during MoviePy re-encoding: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Temporary video available at: </span><span class="sc">{</span>temp_output<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">All videos processed!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/com_distance_example.gif" class="img-fluid figure-img"></p>
<figcaption>Animation of motion tracking data coupled with video</figcaption>
</figure>
</div>
</section>
</section>
<section id="step-2-summary-feature-extraction-smoothness-and-other-features" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Step 2: Summary feature extraction: Smoothness and other features</h1>
<p>We have motivated in the main paper accompanying this notebook that smoothness can be a useful feature to understand the quality of interactions. And our pipeline focuses on the extraction of this specific feature, while we also show how easy it is to generate other features from the time series data that are processed after step 1.</p>
<p>We take two approaches to quantify smoothness of the movement data. The first approach is based on the spectral arc length metric, which has been shown to be a stable measure of smoothness for prolonged (quasi-cyclical) time series data <span class="citation" data-cites="balasubramanianAnalysisMovementSmoothness2015">(<a href="#ref-balasubramanianAnalysisMovementSmoothness2015" role="doc-biblioref">Balasubramanian et al. 2015</a>)</span>. The approach is based on analyzing the frequency spectrum, specifically the changes in energy over the different frequencies, for the lower frequencies (&lt; 10Hz; but this can be set by the user). Specifally it calculates the spectral arc length (distance of two points along a curve) from Fourier magnitude spectrum of the speed data (or in our case changes in the distance or proximity positions). This code is directly copied from the <a href="https://github.com/siva82kb/smoothness">original repository</a> by the lead developer of the metric, Sivak Balasubramanian. We refer to the <span class="citation" data-cites="balasubramanianAnalysisMovementSmoothness2015">(<a href="#ref-balasubramanianAnalysisMovementSmoothness2015" role="doc-biblioref">Balasubramanian et al. 2015</a>)</span> for further details and validation of this novel measure of smoothness. As can be seen, the higher values of the spectral arc length indicate smoother movements, while lower values indicate more jerky movements.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pipeline code step 2, function for calculating spectral arc length üö©
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># directly copied from the original repository https://github.com/siva82kb/smoothness/blob/master/python/smoothness.py</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spectral_arclength(movement, fs, padlevel<span class="op">=</span><span class="dv">4</span>, fc<span class="op">=</span><span class="fl">10.0</span>, amp_th<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcualtes the smoothness of the given speed profile using the modified spectral</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">    arc length metric.</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">    movement : np.array</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">               The array containing the movement speed profile.</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">    fs       : float</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">               The sampling frequency of the data.</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">    padlevel : integer, optional</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">               Indicates the amount of zero padding to be done to the movement</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">               data for estimating the spectral arc length. [default = 4]</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">    fc       : float, optional</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">               The max. cut off frequency for calculating the spectral arc</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">               length metric. [default = 10.]</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co">    amp_th   : float, optional</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="co">               The amplitude threshold to used for determing the cut off</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co">               frequency upto which the spectral arc length is to be estimated.</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co">               [default = 0.05]</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="co">    sal      : float</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="co">               The spectral arc length estimate of the given movement's</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="co">               smoothness.</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="co">    (f, Mf)  : tuple of two np.arrays</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="co">               This is the frequency(f) and the magntiude spectrum(Mf) of the</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="co">               given movement data. This spectral is from 0. to fs/2.</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="co">    (f_sel, Mf_sel) : tuple of two np.arrays</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="co">                      This is the portion of the spectrum that is selected for</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="co">                      calculating the spectral arc length.</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="co">    Notes</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="co">    -----</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a><span class="co">    This is the modfieid spectral arc length metric, which has been tested only</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a><span class="co">    for discrete movements.</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="co">    It is suitable for movements that are a few seconds long, but for long</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a><span class="co">    movements it might be slow and results might not make sense (like any other</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="co">    smoothness metric).</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; t = np.arange(-1, 1, 0.01)</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; move = np.exp(-5*pow(t, 2))</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; sal, _, _ = spectral_arclength(move, fs=100.)</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; '%.5f' % sal</span></span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a><span class="co">    '-1.41403'</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of zeros to be padded.</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    nfft <span class="op">=</span> <span class="bu">int</span>(<span class="bu">pow</span>(<span class="dv">2</span>, np.ceil(np.log2(<span class="bu">len</span>(movement))) <span class="op">+</span> padlevel))</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Frequency</span></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> np.arange(<span class="dv">0</span>, fs, fs<span class="op">/</span>nfft)</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalized magnitude spectrum</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    Mf <span class="op">=</span> <span class="bu">abs</span>(np.fft.fft(movement, nfft))</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    Mf <span class="op">=</span> Mf<span class="op">/</span><span class="bu">max</span>(Mf)</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Indices to choose only the spectrum within the given cut off frequency Fc.</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: This is a low pass filtering operation to get rid of high frequency</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># noise from affecting the next step (amplitude threshold based cut off for</span></span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># arc length calculation).</span></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    fc_inx <span class="op">=</span> ((f <span class="op">&lt;=</span> fc)<span class="op">*</span><span class="dv">1</span>).nonzero()</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>    f_sel <span class="op">=</span> f[fc_inx]</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>    Mf_sel <span class="op">=</span> Mf[fc_inx]</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose the amplitude threshold based cut off frequency.</span></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Index of the last point on the magnitude spectrum that is greater than</span></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># or equal to the amplitude threshold.</span></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>    inx <span class="op">=</span> ((Mf_sel <span class="op">&gt;=</span> amp_th)<span class="op">*</span><span class="dv">1</span>).nonzero()[<span class="dv">0</span>]</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>    fc_inx <span class="op">=</span> <span class="bu">range</span>(inx[<span class="dv">0</span>], inx[<span class="op">-</span><span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>    f_sel <span class="op">=</span> f_sel[fc_inx]</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>    Mf_sel <span class="op">=</span> Mf_sel[fc_inx]</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate arc length</span></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>    new_sal <span class="op">=</span> <span class="op">-</span><span class="bu">sum</span>(np.sqrt(<span class="bu">pow</span>(np.diff(f_sel)<span class="op">/</span>(f_sel[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> f_sel[<span class="dv">0</span>]), <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>                           <span class="bu">pow</span>(np.diff(Mf_sel), <span class="dv">2</span>)))</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_sal, (f, Mf), (f_sel, Mf_sel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>The second approach is based on the log dimensionless squared jerk metric, which is the traditional measure of smoothness in biomechanics <span class="citation" data-cites="hoganSensitivitySmoothnessMeasures2009">(<a href="#ref-hoganSensitivitySmoothnessMeasures2009" role="doc-biblioref">Hogan and Sternad 2009</a>)</span>. Below the function that calculates the dimensionless squared jerk metric from position data. This measure is based on taking the third derivative with respect to time (jerk), squared and integrated over the movement duration, and then normalized by the amplitude of the movement. The log of this value is taken keep the values in a reasonable range.</p>
<section id="example-smoothness-results-on-simulated-time-series-data" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="example-smoothness-results-on-simulated-time-series-data"><span class="header-section-number">4.1</span> Example smoothness results on simulated time series data</h2>
<p>In the below example we show how the two smoothness metrics behave for three different time series data. The first time series is a smooth sinusoidal signal, the second is a noisy version of the first, and the third is a more noisy version of the second. The spectral arc length metric should be higher for the smooth signal, while the dimensionless squared jerk metric should be lower for the smooth signal (as it is less jerky).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pipeline code step 2, function for calculating log dimensionless jerk üö©
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> interpolate</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> savgol_filter</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.integrate <span class="im">as</span> integrate</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate the dimensionless squared jerk metric from position data</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dimensionless_squared_jerk_from_position(ts, time):</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate the dimensionless squared jerk metric from position data.</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">    ts : array_like</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Position data points, should be a 1D numpy array</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">    time : array_like</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Time points corresponding to the ts data, should be a 1D numpy array</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">    float</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Dimensionless squared jerk metric or NaN if calculation fails</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> np.mean(np.diff(time))  <span class="co"># Calculate time step from the time array</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate speed (exactly as in original)</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    speed <span class="op">=</span> np.gradient(ts, dt)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Smooth savgol filter (maintaining original settings)</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    speed <span class="op">=</span> savgol_filter(speed, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate acceleration (exactly as in original)</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    acceleration <span class="op">=</span> np.gradient(speed, dt)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Smooth (maintaining original settings)</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    acceleration <span class="op">=</span> savgol_filter(acceleration, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate jerk (exactly as in original)</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    jerk <span class="op">=</span> np.gradient(acceleration, dt)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Smooth (maintaining original settings)</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    jerk <span class="op">=</span> savgol_filter(jerk, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate movement duration (D)</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    movement_duration <span class="op">=</span> time[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> time[<span class="dv">0</span>]</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> movement_duration <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error: Movement duration must be positive. Got </span><span class="sc">{</span>movement_duration<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate movement amplitude by integrating speed</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    position <span class="op">=</span> integrate.simpson(speed, x<span class="op">=</span>time)</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    movement_amplitude <span class="op">=</span> <span class="bu">abs</span>(position)  <span class="co"># Use absolute value to ensure positive</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prevent division by zero</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    epsilon <span class="op">=</span> <span class="fl">1e-10</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> movement_amplitude <span class="op">&lt;</span> epsilon:</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Warning: Movement amplitude very small (</span><span class="sc">{</span>movement_amplitude<span class="sc">}</span><span class="ss">). Using epsilon."</span>)</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        movement_amplitude <span class="op">=</span> epsilon</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the squared jerk</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    squared_jerk <span class="op">=</span> jerk <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Integrate the squared jerk</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    integrated_squared_jerk <span class="op">=</span> integrate.simpson(squared_jerk, x<span class="op">=</span>time)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure positive value for integral of squared jerk</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> integrated_squared_jerk <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Warning: Negative integral of squared jerk: </span><span class="sc">{</span>integrated_squared_jerk<span class="sc">}</span><span class="ss">. Using absolute value."</span>)</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>        integrated_squared_jerk <span class="op">=</span> <span class="bu">abs</span>(integrated_squared_jerk)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the dimensionless squared jerk</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>    dimensionless_jerk <span class="op">=</span> integrated_squared_jerk <span class="op">*</span> (movement_duration<span class="op">**</span><span class="dv">5</span> <span class="op">/</span> movement_amplitude<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final sanity check</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.isnan(dimensionless_jerk) <span class="kw">or</span> np.isinf(dimensionless_jerk):</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Warning: Result is </span><span class="sc">{</span>dimensionless_jerk<span class="sc">}</span><span class="ss">. Details: "</span>)</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Movement duration: </span><span class="sc">{</span>movement_duration<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Movement amplitude: </span><span class="sc">{</span>movement_amplitude<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Integrated squared jerk: </span><span class="sc">{</span>integrated_squared_jerk<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log the result</span></span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(f"Dimensionless squared jerk: {dimensionless_jerk}")</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log the dimensionless jerk</span></span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>    dimensionless_jerk <span class="op">=</span> np.log(dimensionless_jerk)</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dimensionless_jerk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<section id="example-code-for-checking-behavior-of-the-smoothness-metrics" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="example-code-for-checking-behavior-of-the-smoothness-metrics"><span class="header-section-number">4.2</span> Example code for checking behavior of the smoothness metrics üè¥</h2>
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the time series data</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>ts1 <span class="op">=</span> np.arange(<span class="dv">5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>ts2 <span class="op">=</span> np.arange(<span class="dv">5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>) <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="bu">len</span>(ts1))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>ts3 <span class="op">=</span> np.arange(<span class="dv">5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>) <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="bu">len</span>(ts1))</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sinusoidal time series</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>time_axis <span class="op">=</span> np.arange(<span class="dv">5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>ts1 <span class="op">=</span> np.sin(ts1)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>ts2 <span class="op">=</span> np.sin(ts2)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>ts3 <span class="op">=</span> np.sin(ts3)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics (assuming you have these functions defined)</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>spects1 <span class="op">=</span> spectral_arclength(ts1, fs<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>spects2 <span class="op">=</span> spectral_arclength(ts2, fs<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>spects3 <span class="op">=</span> spectral_arclength(ts3, fs<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>jerkts1 <span class="op">=</span> dimensionless_squared_jerk_from_position(ts1, time_axis)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>jerkts2 <span class="op">=</span> dimensionless_squared_jerk_from_position(ts2, time_axis)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>jerkts3 <span class="op">=</span> dimensionless_squared_jerk_from_position(ts3, time_axis)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create figure with subplots - 1x3 layout</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">9</span>))</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Time Series Analysis: Spectral Arc Length and Dimensionless Squared Jerk'</span>, </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">0.98</span>)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Colors for consistent styling</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#1f77b4'</span>, <span class="st">'#ff7f0e'</span>, <span class="st">'#d62728'</span>]  <span class="co"># Blue, Orange, Red</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Individual signals separated (left)</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>offset <span class="op">=</span> <span class="dv">3</span>  <span class="co"># Vertical separation between signals</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>ax1.plot(time_axis, ts1 <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>offset, color<span class="op">=</span>colors[<span class="dv">0</span>], linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Smooth Signal'</span>)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>ax1.plot(time_axis, ts2 <span class="op">+</span> offset, color<span class="op">=</span>colors[<span class="dv">1</span>], linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Low Noise Signal'</span>)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>ax1.plot(time_axis, ts3, color<span class="op">=</span>colors[<span class="dv">2</span>], linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'High Noise Signal'</span>)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Separated Time Series'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Amplitude (Offset)'</span>)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>ax1.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Metrics comparison - Spectral Arc Length (middle)</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>signals <span class="op">=</span> [<span class="st">'Smooth</span><span class="ch">\n</span><span class="st">Signal'</span>, <span class="st">'Low Noise</span><span class="ch">\n</span><span class="st">Signal'</span>, <span class="st">'High Noise</span><span class="ch">\n</span><span class="st">Signal'</span>]</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>spect_values <span class="op">=</span> [spects1[<span class="dv">0</span>], spects2[<span class="dv">0</span>], spects3[<span class="dv">0</span>]]</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>bars1 <span class="op">=</span> ax2.bar(signals, spect_values, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Spectral Arc Length Comparison'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Spectral Arc Length'</span>)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels on bars</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bar, value <span class="kw">in</span> <span class="bu">zip</span>(bars1, spect_values):</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> bar.get_height()</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>    ax2.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height <span class="op">+</span> <span class="fl">0.01</span>,</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>             <span class="ss">f'</span><span class="sc">{</span>value<span class="sc">:.3f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 3: Metrics comparison - Dimensionless Squared Jerk (right)</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>ax3 <span class="op">=</span> axes[<span class="dv">2</span>]</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>jerk_values <span class="op">=</span> [jerkts1, jerkts2, jerkts3]</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>bars2 <span class="op">=</span> ax3.bar(signals, jerk_values, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Dimensionless Squared Jerk Comparison'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Dimensionless Squared Jerk'</span>)</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels on bars</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bar, value <span class="kw">in</span> <span class="bu">zip</span>(bars2, jerk_values):</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> bar.get_height()</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    ax3.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height <span class="op">+</span> <span class="bu">max</span>(jerk_values)<span class="op">*</span><span class="fl">0.02</span>,</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>             <span class="ss">f'</span><span class="sc">{</span>value<span class="sc">:.3f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust layout to prevent overlap</span></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.12</span>, <span class="dv">1</span>, <span class="fl">0.95</span>])</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.show()</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a><span class="co"># save plot</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'./images/smoothness_metrics_comparison.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="1728"></p>
</figure>
</div>
</div>
</div>
</section>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/smoothness_metrics_comparison.png" class="img-fluid figure-img"></p>
<figcaption>Smoothness metrics comparison</figcaption>
</figure>
</div>
<p>In the below pipeline code for step 2, we calculate smoothness for the distance between the two hands, as well as the distance to the center of mass (COM) and centroid of the two hands. We also calculate the smoothness of the wrist speed profiles, which are derived from the distance time series data. When SPARC is in the variable name, it refers to the spectral arc length metric, while smoothness will refer to the dimensionless squared jerk metric.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Pipeline code step 2 complete procedure üö©
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> integrate</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> interpolate</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> savgol_filter</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># specifically we might be interested in computing the smoothness of the distance</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>inputfol <span class="op">=</span> <span class="st">'../dataoutput_STEP1_2_timeseries/'</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>outputfol <span class="op">=</span> <span class="st">'../dataoutput_STEP2_features/'</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> pd.read_csv(<span class="st">'../meta/project_pointsibling_metadata_starttimes.csv'</span>, encoding<span class="op">=</span><span class="st">'latin1'</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>constantwindowsize_sec <span class="op">=</span> <span class="dv">100</span> <span class="co"># we want an equal portion of each timeseries to be analyzed</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate spectral arc length</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spectral_arclength(movement, fs, padlevel<span class="op">=</span><span class="dv">4</span>, fc<span class="op">=</span><span class="fl">10.0</span>, amp_th<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcualtes the smoothness of the given speed profile using the modified spectral</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co">    arc length metric.</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co">    movement : np.array</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co">               The array containing the movement speed profile.</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="co">    fs       : float</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="co">               The sampling frequency of the data.</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="co">    padlevel : integer, optional</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="co">               Indicates the amount of zero padding to be done to the movement</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="co">               data for estimating the spectral arc length. [default = 4]</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="co">    fc       : float, optional</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="co">               The max. cut off frequency for calculating the spectral arc</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="co">               length metric. [default = 10.]</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="co">    amp_th   : float, optional</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="co">               The amplitude threshold to used for determing the cut off</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="co">               frequency upto which the spectral arc length is to be estimated.</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="co">               [default = 0.05]</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="co">    sal      : float</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="co">               The spectral arc length estimate of the given movement's</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="co">               smoothness.</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="co">    (f, Mf)  : tuple of two np.arrays</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="co">               This is the frequency(f) and the magntiude spectrum(Mf) of the</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="co">               given movement data. This spectral is from 0. to fs/2.</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="co">    (f_sel, Mf_sel) : tuple of two np.arrays</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="co">                      This is the portion of the spectrum that is selected for</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="co">                      calculating the spectral arc length.</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="co">    Notes</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="co">    -----</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="co">    This is the modfieid spectral arc length metric, which has been tested only</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a><span class="co">    for discrete movements.</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="co">    It is suitable for movements that are a few seconds long, but for long</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="co">    movements it might be slow and results might not make sense (like any other</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="co">    smoothness metric).</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; t = np.arange(-1, 1, 0.01)</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; move = np.exp(-5*pow(t, 2))</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; sal, _, _ = spectral_arclength(move, fs=100.)</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; '%.5f' % sal</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a><span class="co">    '-1.41403'</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of zeros to be padded.</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>    nfft <span class="op">=</span> <span class="bu">int</span>(<span class="bu">pow</span>(<span class="dv">2</span>, np.ceil(np.log2(<span class="bu">len</span>(movement))) <span class="op">+</span> padlevel))</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Frequency</span></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> np.arange(<span class="dv">0</span>, fs, fs<span class="op">/</span>nfft)</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalized magnitude spectrum</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>    Mf <span class="op">=</span> <span class="bu">abs</span>(np.fft.fft(movement, nfft))</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>    Mf <span class="op">=</span> Mf<span class="op">/</span><span class="bu">max</span>(Mf)</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Indices to choose only the spectrum within the given cut off frequency Fc.</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: This is a low pass filtering operation to get rid of high frequency</span></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># noise from affecting the next step (amplitude threshold based cut off for</span></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># arc length calculation).</span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>    fc_inx <span class="op">=</span> ((f <span class="op">&lt;=</span> fc)<span class="op">*</span><span class="dv">1</span>).nonzero()</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>    f_sel <span class="op">=</span> f[fc_inx]</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>    Mf_sel <span class="op">=</span> Mf[fc_inx]</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose the amplitude threshold based cut off frequency.</span></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Index of the last point on the magnitude spectrum that is greater than</span></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># or equal to the amplitude threshold.</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>    inx <span class="op">=</span> ((Mf_sel <span class="op">&gt;=</span> amp_th)<span class="op">*</span><span class="dv">1</span>).nonzero()[<span class="dv">0</span>]</span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>    fc_inx <span class="op">=</span> <span class="bu">range</span>(inx[<span class="dv">0</span>], inx[<span class="op">-</span><span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>    f_sel <span class="op">=</span> f_sel[fc_inx]</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>    Mf_sel <span class="op">=</span> Mf_sel[fc_inx]</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate arc length</span></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>    new_sal <span class="op">=</span> <span class="op">-</span><span class="bu">sum</span>(np.sqrt(<span class="bu">pow</span>(np.diff(f_sel)<span class="op">/</span>(f_sel[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> f_sel[<span class="dv">0</span>]), <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>                           <span class="bu">pow</span>(np.diff(Mf_sel), <span class="dv">2</span>)))</span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_sal, (f, Mf), (f_sel, Mf_sel)</span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate the dimensionless squared jerk metric from position data</span></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dimensionless_squared_jerk_from_position(ts, time):</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate the dimensionless squared jerk metric from position data.</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a><span class="co">    ts : array_like</span></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a><span class="co">        Position data points, should be a 1D numpy array</span></span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a><span class="co">    time : array_like</span></span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a><span class="co">        Time points corresponding to the ts data, should be a 1D numpy array</span></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a><span class="co">    float</span></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a><span class="co">        Dimensionless squared jerk metric or NaN if calculation fails</span></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a>        <span class="co"># First check the raw inputs</span></span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> np.array(ts, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a>        time <span class="op">=</span> np.array(time, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Original shape - ts: </span><span class="sc">{</span>ts<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span>time<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"NaN count before processing - ts: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(ts)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(time)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Input validation before preprocessing</span></span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(ts) <span class="op">!=</span> <span class="bu">len</span>(time):</span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error: Arrays must have the same length. ts: </span><span class="sc">{</span><span class="bu">len</span>(ts)<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span><span class="bu">len</span>(time)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(ts) <span class="op">&lt;</span> <span class="dv">11</span>:  <span class="co"># Minimum length for savgol filter</span></span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error: Input arrays too short for savgol window size=11. Length: </span><span class="sc">{</span><span class="bu">len</span>(ts)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if time has NaNs - we need to fix time first</span></span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(time).<span class="bu">any</span>():</span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Warning: Time array contains NaNs, filling with linear sequence"</span>)</span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a>            valid_time_mask <span class="op">=</span> <span class="op">~</span>np.isnan(time)</span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> valid_time_mask.<span class="bu">any</span>():</span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Error: All time values are NaN"</span>)</span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> np.nan</span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a proper time sequence</span></span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a>            time <span class="op">=</span> np.linspace(np.nanmin(time), np.nanmax(time), <span class="bu">len</span>(time))</span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if input data is all NaN</span></span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(ts).<span class="bu">all</span>():</span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Error: All input values are NaN"</span>)</span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify valid data points for interpolation</span></span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a>        valid_mask <span class="op">=</span> <span class="op">~</span>np.isnan(ts)</span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a>        valid_indices <span class="op">=</span> np.where(valid_mask)[<span class="dv">0</span>]</span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_indices) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error: Not enough valid data points for interpolation. Found </span><span class="sc">{</span><span class="bu">len</span>(valid_indices)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle the interpolation more carefully</span></span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Use valid points to interpolate</span></span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(ts).<span class="bu">any</span>():</span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:               </span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create interpolator with valid points only</span></span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a>                valid_time <span class="op">=</span> time[valid_mask]</span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a>                valid_data <span class="op">=</span> ts[valid_mask]</span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Sort by time to ensure proper interpolation</span></span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a>                sort_idx <span class="op">=</span> np.argsort(valid_time)</span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a>                valid_time <span class="op">=</span> valid_time[sort_idx]</span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a>                valid_data <span class="op">=</span> valid_data[sort_idx]</span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create interpolation function</span></span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a>                f <span class="op">=</span> interpolate.interp1d(</span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a>                    valid_time, valid_data,</span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a>                    bounds_error<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb18-175"><a href="#cb18-175" aria-hidden="true" tabindex="-1"></a>                    fill_value<span class="op">=</span>(valid_data[<span class="dv">0</span>], valid_data[<span class="op">-</span><span class="dv">1</span>])  <span class="co"># Extrapolate with edge values</span></span>
<span id="cb18-176"><a href="#cb18-176" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Apply interpolation</span></span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a>                ts_interpolated <span class="op">=</span> f(time)</span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check if interpolation fixed all NaNs</span></span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> np.isnan(ts_interpolated).<span class="bu">any</span>():</span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"Warning: Interpolation failed to fix all NaNs. Remaining: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(ts_interpolated)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Last resort: replace any remaining NaNs with nearest valid value</span></span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a>                    ts_interpolated <span class="op">=</span> pd.Series(ts_interpolated).fillna(method<span class="op">=</span><span class="st">'ffill'</span>).fillna(method<span class="op">=</span><span class="st">'bfill'</span>).values</span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb18-187"><a href="#cb18-187" aria-hidden="true" tabindex="-1"></a>                ts <span class="op">=</span> ts_interpolated</span>
<span id="cb18-188"><a href="#cb18-188" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Error during interpolation: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-190"><a href="#cb18-190" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> np.nan</span>
<span id="cb18-191"><a href="#cb18-191" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verify no NaNs remain after preprocessing</span></span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(ts).<span class="bu">any</span>() <span class="kw">or</span> np.isnan(time).<span class="bu">any</span>():</span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Error: Failed to remove all NaN values"</span>)</span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure time steps are uniform for derivative calculation</span></span>
<span id="cb18-198"><a href="#cb18-198" aria-hidden="true" tabindex="-1"></a>        uniform_time <span class="op">=</span> np.linspace(time[<span class="dv">0</span>], time[<span class="op">-</span><span class="dv">1</span>], <span class="bu">len</span>(time))</span>
<span id="cb18-199"><a href="#cb18-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.allclose(time, uniform_time):</span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If time is not uniform, resample the data</span></span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Warning: Time steps not uniform, resampling data"</span>)</span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use scipy's interpolation again to resample</span></span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a>            f <span class="op">=</span> interpolate.interp1d(time, ts, bounds_error<span class="op">=</span><span class="va">False</span>, fill_value<span class="op">=</span><span class="st">'extrapolate'</span>)</span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a>            ts <span class="op">=</span> f(uniform_time)</span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a>            time <span class="op">=</span> uniform_time</span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the time step</span></span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a>        dt <span class="op">=</span> np.diff(time)[<span class="dv">0</span>]</span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dt <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error: Time steps must be positive. Got dt=</span><span class="sc">{</span>dt<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print state after preprocessing</span></span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Data after preprocessing - Length: </span><span class="sc">{</span><span class="bu">len</span>(ts)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"NaN check after preprocessing - ts: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(ts)<span class="sc">.</span><span class="bu">any</span>()<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(time)<span class="sc">.</span><span class="bu">any</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Range - ts: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(ts)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(ts)<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(time)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(time)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate speed (exactly as in original)</span></span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a>        speed <span class="op">=</span> np.gradient(ts, dt)</span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-222"><a href="#cb18-222" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth savgol filter (maintaining original settings)</span></span>
<span id="cb18-223"><a href="#cb18-223" aria-hidden="true" tabindex="-1"></a>        speed <span class="op">=</span> savgol_filter(speed, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb18-224"><a href="#cb18-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate acceleration (exactly as in original)</span></span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a>        acceleration <span class="op">=</span> np.gradient(speed, dt)</span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-228"><a href="#cb18-228" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth (maintaining original settings)</span></span>
<span id="cb18-229"><a href="#cb18-229" aria-hidden="true" tabindex="-1"></a>        acceleration <span class="op">=</span> savgol_filter(acceleration, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb18-230"><a href="#cb18-230" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-231"><a href="#cb18-231" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate jerk (exactly as in original)</span></span>
<span id="cb18-232"><a href="#cb18-232" aria-hidden="true" tabindex="-1"></a>        jerk <span class="op">=</span> np.gradient(acceleration, dt)</span>
<span id="cb18-233"><a href="#cb18-233" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-234"><a href="#cb18-234" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth (maintaining original settings)</span></span>
<span id="cb18-235"><a href="#cb18-235" aria-hidden="true" tabindex="-1"></a>        jerk <span class="op">=</span> savgol_filter(jerk, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb18-236"><a href="#cb18-236" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-237"><a href="#cb18-237" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate movement duration (D)</span></span>
<span id="cb18-238"><a href="#cb18-238" aria-hidden="true" tabindex="-1"></a>        movement_duration <span class="op">=</span> time[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> time[<span class="dv">0</span>]</span>
<span id="cb18-239"><a href="#cb18-239" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-240"><a href="#cb18-240" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> movement_duration <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb18-241"><a href="#cb18-241" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error: Movement duration must be positive. Got </span><span class="sc">{</span>movement_duration<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-242"><a href="#cb18-242" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb18-243"><a href="#cb18-243" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-244"><a href="#cb18-244" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate movement amplitude by integrating speed</span></span>
<span id="cb18-245"><a href="#cb18-245" aria-hidden="true" tabindex="-1"></a>        position <span class="op">=</span> integrate.simpson(speed, x<span class="op">=</span>time)</span>
<span id="cb18-246"><a href="#cb18-246" aria-hidden="true" tabindex="-1"></a>        movement_amplitude <span class="op">=</span> <span class="bu">abs</span>(position)  <span class="co"># Use absolute value to ensure positive</span></span>
<span id="cb18-247"><a href="#cb18-247" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-248"><a href="#cb18-248" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prevent division by zero</span></span>
<span id="cb18-249"><a href="#cb18-249" aria-hidden="true" tabindex="-1"></a>        epsilon <span class="op">=</span> <span class="fl">1e-10</span></span>
<span id="cb18-250"><a href="#cb18-250" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> movement_amplitude <span class="op">&lt;</span> epsilon:</span>
<span id="cb18-251"><a href="#cb18-251" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Warning: Movement amplitude very small (</span><span class="sc">{</span>movement_amplitude<span class="sc">}</span><span class="ss">). Using epsilon."</span>)</span>
<span id="cb18-252"><a href="#cb18-252" aria-hidden="true" tabindex="-1"></a>            movement_amplitude <span class="op">=</span> epsilon</span>
<span id="cb18-253"><a href="#cb18-253" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb18-254"><a href="#cb18-254" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the squared jerk</span></span>
<span id="cb18-255"><a href="#cb18-255" aria-hidden="true" tabindex="-1"></a>        squared_jerk <span class="op">=</span> jerk <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb18-256"><a href="#cb18-256" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-257"><a href="#cb18-257" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Integrate the squared jerk</span></span>
<span id="cb18-258"><a href="#cb18-258" aria-hidden="true" tabindex="-1"></a>        integrated_squared_jerk <span class="op">=</span> integrate.simpson(squared_jerk, x<span class="op">=</span>time)</span>
<span id="cb18-259"><a href="#cb18-259" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-260"><a href="#cb18-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure positive value for integral of squared jerk</span></span>
<span id="cb18-261"><a href="#cb18-261" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> integrated_squared_jerk <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb18-262"><a href="#cb18-262" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Warning: Negative integral of squared jerk: </span><span class="sc">{</span>integrated_squared_jerk<span class="sc">}</span><span class="ss">. Using absolute value."</span>)</span>
<span id="cb18-263"><a href="#cb18-263" aria-hidden="true" tabindex="-1"></a>            integrated_squared_jerk <span class="op">=</span> <span class="bu">abs</span>(integrated_squared_jerk)</span>
<span id="cb18-264"><a href="#cb18-264" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-265"><a href="#cb18-265" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the dimensionless squared jerk</span></span>
<span id="cb18-266"><a href="#cb18-266" aria-hidden="true" tabindex="-1"></a>        dimensionless_jerk <span class="op">=</span> integrated_squared_jerk <span class="op">*</span> (movement_duration<span class="op">**</span><span class="dv">5</span> <span class="op">/</span> movement_amplitude<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb18-267"><a href="#cb18-267" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-268"><a href="#cb18-268" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Final sanity check</span></span>
<span id="cb18-269"><a href="#cb18-269" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(dimensionless_jerk) <span class="kw">or</span> np.isinf(dimensionless_jerk):</span>
<span id="cb18-270"><a href="#cb18-270" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Warning: Result is </span><span class="sc">{</span>dimensionless_jerk<span class="sc">}</span><span class="ss">. Details: "</span>)</span>
<span id="cb18-271"><a href="#cb18-271" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Movement duration: </span><span class="sc">{</span>movement_duration<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-272"><a href="#cb18-272" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Movement amplitude: </span><span class="sc">{</span>movement_amplitude<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-273"><a href="#cb18-273" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Integrated squared jerk: </span><span class="sc">{</span>integrated_squared_jerk<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-274"><a href="#cb18-274" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb18-275"><a href="#cb18-275" aria-hidden="true" tabindex="-1"></a>        <span class="co"># log the result</span></span>
<span id="cb18-276"><a href="#cb18-276" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-277"><a href="#cb18-277" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Dimensionless squared jerk: </span><span class="sc">{</span>dimensionless_jerk<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-278"><a href="#cb18-278" aria-hidden="true" tabindex="-1"></a>        <span class="co"># log the dimensionless jerk</span></span>
<span id="cb18-279"><a href="#cb18-279" aria-hidden="true" tabindex="-1"></a>        dimensionless_jerk <span class="op">=</span> np.log(dimensionless_jerk)</span>
<span id="cb18-280"><a href="#cb18-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-281"><a href="#cb18-281" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dimensionless_jerk</span>
<span id="cb18-282"><a href="#cb18-282" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-283"><a href="#cb18-283" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb18-284"><a href="#cb18-284" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error calculating dimensionless squared jerk: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-285"><a href="#cb18-285" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb18-286"><a href="#cb18-286" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-287"><a href="#cb18-287" aria-hidden="true" tabindex="-1"></a><span class="co"># df for smoothness date</span></span>
<span id="cb18-288"><a href="#cb18-288" aria-hidden="true" tabindex="-1"></a>newdfcolumns <span class="op">=</span> [<span class="st">'videoID'</span>,<span class="st">'timeadjusted'</span>, <span class="st">'originalsamples'</span>,<span class="st">'adjustedsamples'</span>, <span class="st">'start_time_analysiswindow'</span>, <span class="st">'end_time_analysiswindow'</span>, <span class="st">'perc_twopersonsdetected'</span>, <span class="st">'average_com_movementp1'</span>, <span class="st">'average_com_movementp2'</span>, <span class="st">'smoothness_distancecom'</span>, <span class="st">'SPARC_smoothness_distancecom'</span>, <span class="st">'smoothness_distancecentroid'</span>, <span class="st">'smoothness_xy_average_com_p1'</span>, <span class="st">'smoothness_xy_average_com_p2'</span>, <span class="st">'smoothness_xy_average_centroid_p1'</span>, <span class="st">'smoothness_xy_average_centroid_p2'</span>, <span class="st">'smoothness_p1_proximity'</span>, <span class="st">'smoothness_p2_proximity'</span>]</span>
<span id="cb18-289"><a href="#cb18-289" aria-hidden="true" tabindex="-1"></a>newdf <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>newdfcolumns)</span>
<span id="cb18-290"><a href="#cb18-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-291"><a href="#cb18-291" aria-hidden="true" tabindex="-1"></a><span class="co"># check for each csv file for layer2 data</span></span>
<span id="cb18-292"><a href="#cb18-292" aria-hidden="true" tabindex="-1"></a>layer2dat <span class="op">=</span> glob.glob(inputfol <span class="op">+</span> <span class="st">'*.csv'</span>)</span>
<span id="cb18-293"><a href="#cb18-293" aria-hidden="true" tabindex="-1"></a><span class="co">#print(layer2dat)</span></span>
<span id="cb18-294"><a href="#cb18-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-295"><a href="#cb18-295" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over the csv layer 2 data</span></span>
<span id="cb18-296"><a href="#cb18-296" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> vids <span class="kw">in</span> layer2dat:</span>
<span id="cb18-297"><a href="#cb18-297" aria-hidden="true" tabindex="-1"></a>     <span class="bu">print</span>(vids)</span>
<span id="cb18-298"><a href="#cb18-298" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Load the CSV timeseries file</span></span>
<span id="cb18-299"><a href="#cb18-299" aria-hidden="true" tabindex="-1"></a>     ts <span class="op">=</span> pd.read_csv(vids)</span>
<span id="cb18-300"><a href="#cb18-300" aria-hidden="true" tabindex="-1"></a>     <span class="co"># get the features</span></span>
<span id="cb18-301"><a href="#cb18-301" aria-hidden="true" tabindex="-1"></a>     videoID <span class="op">=</span> os.path.basename(vids).split(<span class="st">'_processed_data_layer2.csv'</span>)[<span class="dv">0</span>]</span>
<span id="cb18-302"><a href="#cb18-302" aria-hidden="true" tabindex="-1"></a>     originalsamples <span class="op">=</span> <span class="bu">len</span>(ts[<span class="st">"time"</span>])</span>
<span id="cb18-303"><a href="#cb18-303" aria-hidden="true" tabindex="-1"></a>     perc_twopersonsdetected <span class="op">=</span> ts[<span class="st">'both_tracked'</span>].<span class="bu">sum</span>() <span class="op">/</span> <span class="bu">len</span>(ts)</span>
<span id="cb18-304"><a href="#cb18-304" aria-hidden="true" tabindex="-1"></a>     <span class="co"># check metadata start</span></span>
<span id="cb18-305"><a href="#cb18-305" aria-hidden="true" tabindex="-1"></a>     start <span class="op">=</span> metadata[metadata[<span class="st">'VIDEO_ID'</span>] <span class="op">==</span> videoID][<span class="st">'start'</span>].values</span>
<span id="cb18-306"><a href="#cb18-306" aria-hidden="true" tabindex="-1"></a>     <span class="bu">print</span>(<span class="st">"start time of this video: "</span> <span class="op">+</span> <span class="bu">str</span>(start))</span>
<span id="cb18-307"><a href="#cb18-307" aria-hidden="true" tabindex="-1"></a>     <span class="co"># calculate the average movement of the com for each person</span></span>
<span id="cb18-308"><a href="#cb18-308" aria-hidden="true" tabindex="-1"></a>     average_com_movementp1 <span class="op">=</span> np.mean(np.sqrt((ts[<span class="st">'com_p1_x'</span>].diff()<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> ts[<span class="st">'com_p1_y'</span>].diff()<span class="op">**</span><span class="dv">2</span>)))</span>
<span id="cb18-309"><a href="#cb18-309" aria-hidden="true" tabindex="-1"></a>     average_com_movementp2 <span class="op">=</span> np.mean(np.sqrt((ts[<span class="st">'com_p2_x'</span>].diff()<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> ts[<span class="st">'com_p2_y'</span>].diff()<span class="op">**</span><span class="dv">2</span>)))</span>
<span id="cb18-310"><a href="#cb18-310" aria-hidden="true" tabindex="-1"></a>     <span class="co"># add a time adjusted variable to the dataset</span></span>
<span id="cb18-311"><a href="#cb18-311" aria-hidden="true" tabindex="-1"></a>     <span class="cf">if</span> start.size <span class="op">&gt;</span> <span class="dv">0</span>: </span>
<span id="cb18-312"><a href="#cb18-312" aria-hidden="true" tabindex="-1"></a>        <span class="co"># check if endtime not greater than the last time in the dataset</span></span>
<span id="cb18-313"><a href="#cb18-313" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (start[<span class="dv">0</span>] <span class="op">+</span> constantwindowsize_sec) <span class="op">&gt;</span> ts[<span class="st">'time'</span>].<span class="bu">max</span>():</span>
<span id="cb18-314"><a href="#cb18-314" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"End time is greater than the last time in the dataset, setting end time to max value"</span>)</span>
<span id="cb18-315"><a href="#cb18-315" aria-hidden="true" tabindex="-1"></a>        timeadjusted <span class="op">=</span> <span class="st">"TRUE - Adjusted to start at + "</span> <span class="op">+</span> <span class="bu">str</span>(start[<span class="dv">0</span>]) <span class="op">+</span> <span class="st">"With a window length of: "</span> <span class="op">+</span> <span class="bu">str</span>(constantwindowsize_sec) <span class="op">+</span> <span class="st">" seconds"</span></span>
<span id="cb18-316"><a href="#cb18-316" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Take a timeseries chunk of 150 seconds</span></span>
<span id="cb18-317"><a href="#cb18-317" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> ts[(ts[<span class="st">'time'</span>] <span class="op">&gt;=</span> start[<span class="dv">0</span>]) <span class="op">&amp;</span> (ts[<span class="st">'time'</span>] <span class="op">&lt;=</span> start[<span class="dv">0</span>] <span class="op">+</span> constantwindowsize_sec)]</span>
<span id="cb18-318"><a href="#cb18-318" aria-hidden="true" tabindex="-1"></a>     <span class="cf">if</span> start.size <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb18-319"><a href="#cb18-319" aria-hidden="true" tabindex="-1"></a>        timeadjusted <span class="op">=</span> <span class="st">"FALSE - Not adjusted to start time as no start time was given for this video, window length is still set to: "</span> <span class="op">+</span> <span class="bu">str</span>(constantwindowsize_sec) <span class="op">+</span> <span class="st">" seconds"</span></span>
<span id="cb18-320"><a href="#cb18-320" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> ts[(ts[<span class="st">'time'</span>] <span class="op">&lt;=</span> constantwindowsize_sec)]</span>
<span id="cb18-321"><a href="#cb18-321" aria-hidden="true" tabindex="-1"></a>     adjustedsamples <span class="op">=</span> <span class="bu">len</span>(ts[<span class="st">"time"</span>])</span>
<span id="cb18-322"><a href="#cb18-322" aria-hidden="true" tabindex="-1"></a>     <span class="bu">print</span>(timeadjusted) </span>
<span id="cb18-323"><a href="#cb18-323" aria-hidden="true" tabindex="-1"></a>     <span class="co"># fps is mode timestaps per second </span></span>
<span id="cb18-324"><a href="#cb18-324" aria-hidden="true" tabindex="-1"></a>     fps <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>(ts[<span class="st">'time'</span>].diff().mode()[<span class="dv">0</span>])</span>
<span id="cb18-325"><a href="#cb18-325" aria-hidden="true" tabindex="-1"></a>     <span class="co"># add time start and time end</span></span>
<span id="cb18-326"><a href="#cb18-326" aria-hidden="true" tabindex="-1"></a>     start_time_analysiswindow <span class="op">=</span> start[<span class="dv">0</span>] <span class="cf">if</span> start.size <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb18-327"><a href="#cb18-327" aria-hidden="true" tabindex="-1"></a>     end_time_analysiswindow <span class="op">=</span> start_time_analysiswindow <span class="op">+</span> constantwindowsize_sec</span>
<span id="cb18-328"><a href="#cb18-328" aria-hidden="true" tabindex="-1"></a>     <span class="co"># calculate the smoothness of the distance between the com and centroid</span></span>
<span id="cb18-329"><a href="#cb18-329" aria-hidden="true" tabindex="-1"></a>     smoothness_distancecom <span class="op">=</span> dimensionless_squared_jerk_from_position(ts[<span class="st">'distance_com'</span>].values, ts[<span class="st">'time'</span>].values)</span>
<span id="cb18-330"><a href="#cb18-330" aria-hidden="true" tabindex="-1"></a>     <span class="co"># take the derivative of the distance</span></span>
<span id="cb18-331"><a href="#cb18-331" aria-hidden="true" tabindex="-1"></a>     distancecomspeed <span class="op">=</span> np.gradient(ts[<span class="st">'distance_com'</span>].values, ts[<span class="st">'time'</span>].values)</span>
<span id="cb18-332"><a href="#cb18-332" aria-hidden="true" tabindex="-1"></a>     SPARCsmoothness_distancecom <span class="op">=</span> spectral_arclength(distancecomspeed, <span class="dv">1</span><span class="op">/</span>fps, padlevel<span class="op">=</span><span class="dv">4</span>, fc<span class="op">=</span><span class="fl">10.0</span>, amp_th<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb18-333"><a href="#cb18-333" aria-hidden="true" tabindex="-1"></a>     <span class="co"># it is the first value of the distancecomspeed</span></span>
<span id="cb18-334"><a href="#cb18-334" aria-hidden="true" tabindex="-1"></a>     SPARCsmoothness_distancecom <span class="op">=</span> SPARCsmoothness_distancecom[<span class="dv">0</span>]</span>
<span id="cb18-335"><a href="#cb18-335" aria-hidden="true" tabindex="-1"></a>     <span class="co">#print(smoothness_distancecom)</span></span>
<span id="cb18-336"><a href="#cb18-336" aria-hidden="true" tabindex="-1"></a>     smoothness_distancecentroid <span class="op">=</span> dimensionless_squared_jerk_from_position(ts[<span class="st">'distance'</span>].values, ts[<span class="st">'time'</span>].values)</span>
<span id="cb18-337"><a href="#cb18-337" aria-hidden="true" tabindex="-1"></a>     <span class="co"># calculate the smoothness of the xy positions for each person</span></span>
<span id="cb18-338"><a href="#cb18-338" aria-hidden="true" tabindex="-1"></a>     smoothness_xy_average_com_p1 <span class="op">=</span> (dimensionless_squared_jerk_from_position(ts[<span class="st">'com_p1_x'</span>],ts[<span class="st">'time'</span>].values)<span class="op">+</span>dimensionless_squared_jerk_from_position(ts[<span class="st">'com_p1_y'</span>],ts[<span class="st">'time'</span>].values))<span class="op">/</span><span class="dv">2</span></span>
<span id="cb18-339"><a href="#cb18-339" aria-hidden="true" tabindex="-1"></a>     smoothness_xy_average_com_p2 <span class="op">=</span> (dimensionless_squared_jerk_from_position(ts[<span class="st">'com_p2_x'</span>],ts[<span class="st">'time'</span>].values)<span class="op">+</span>dimensionless_squared_jerk_from_position(ts[<span class="st">'com_p2_y'</span>],ts[<span class="st">'time'</span>].values))<span class="op">/</span><span class="dv">2</span></span>
<span id="cb18-340"><a href="#cb18-340" aria-hidden="true" tabindex="-1"></a>     smoothness_xy_average_centroid_p1 <span class="op">=</span> (dimensionless_squared_jerk_from_position(ts[<span class="st">'centroid_p1_x'</span>],ts[<span class="st">'time'</span>].values)<span class="op">+</span>dimensionless_squared_jerk_from_position(ts[<span class="st">'centroid_p1_y'</span>],ts[<span class="st">'time'</span>].values))<span class="op">/</span><span class="dv">2</span></span>
<span id="cb18-341"><a href="#cb18-341" aria-hidden="true" tabindex="-1"></a>     smoothness_xy_average_centroid_p2 <span class="op">=</span> (dimensionless_squared_jerk_from_position(ts[<span class="st">'centroid_p2_x'</span>],ts[<span class="st">'time'</span>].values)<span class="op">+</span>dimensionless_squared_jerk_from_position(ts[<span class="st">'centroid_p2_y'</span>],ts[<span class="st">'time'</span>].values))<span class="op">/</span><span class="dv">2</span></span>
<span id="cb18-342"><a href="#cb18-342" aria-hidden="true" tabindex="-1"></a>     <span class="co"># calculate the smoothness of the proximity approach</span></span>
<span id="cb18-343"><a href="#cb18-343" aria-hidden="true" tabindex="-1"></a>     smoothness_p1_proximity <span class="op">=</span> dimensionless_squared_jerk_from_position(ts[<span class="st">'p1_com_approach_pos'</span>].values, ts[<span class="st">'time'</span>].values)</span>
<span id="cb18-344"><a href="#cb18-344" aria-hidden="true" tabindex="-1"></a>     smoothness_p2_proximity <span class="op">=</span> dimensionless_squared_jerk_from_position(ts[<span class="st">'p2_com_approach_pos'</span>].values, ts[<span class="st">'time'</span>].values)</span>
<span id="cb18-345"><a href="#cb18-345" aria-hidden="true" tabindex="-1"></a>     <span class="co"># append to the new df using concat</span></span>
<span id="cb18-346"><a href="#cb18-346" aria-hidden="true" tabindex="-1"></a>     newdf <span class="op">=</span> pd.concat([newdf, pd.DataFrame([[videoID, timeadjusted, originalsamples, adjustedsamples, start_time_analysiswindow, end_time_analysiswindow, perc_twopersonsdetected, average_com_movementp1, average_com_movementp2, smoothness_distancecom, SPARCsmoothness_distancecom, smoothness_distancecentroid, smoothness_xy_average_com_p1, smoothness_xy_average_com_p2, smoothness_xy_average_centroid_p1, smoothness_xy_average_centroid_p2, smoothness_p1_proximity, smoothness_p2_proximity]], columns<span class="op">=</span>newdfcolumns)], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-347"><a href="#cb18-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-348"><a href="#cb18-348" aria-hidden="true" tabindex="-1"></a><span class="co"># save the new df</span></span>
<span id="cb18-349"><a href="#cb18-349" aria-hidden="true" tabindex="-1"></a>newdf.to_csv(outputfol <span class="op">+</span> <span class="st">'smoothness_data.csv'</span>, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">'latin1'</span>)</span>
<span id="cb18-350"><a href="#cb18-350" aria-hidden="true" tabindex="-1"></a>newdf.head()</span>
<span id="cb18-351"><a href="#cb18-351" aria-hidden="true" tabindex="-1"></a><span class="co"># print done</span></span>
<span id="cb18-352"><a href="#cb18-352" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Done with smoothness processing pipeline!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example output smoothness: üìä
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For each video we will now have a smoothness feature set.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="im">as</span> glob</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">"./dataoutput_STEP2_features/smoothness_data.csv"</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(csv_file)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   videoID  ... smoothness_p2_proximity
0  cop_p01  ...               41.324389
1  cop_p02  ...               36.829275
2  cop_p03  ...               40.650390
3  cop_p04  ...               42.232620
4  cop_p05  ...               38.103251

[5 rows x 18 columns]</code></pre>
</div>
</div>
</div>
</div>
</div>
<section id="extract-features-for-all-videos-using-tsfresh" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="extract-features-for-all-videos-using-tsfresh"><span class="header-section-number">4.2.1</span> Extract features for all videos using tsfresh</h3>
<p>To show how easy it is to extract features from the time series data, we use the <code>tsfresh</code> library <span class="citation" data-cites="christTimeSeriesFeatuRe2018">(<a href="#ref-christTimeSeriesFeatuRe2018" role="doc-biblioref">Christ et al. 2018</a>)</span>. This library contains a large number of features designed to characterize time series data. While we do not use them in our analysis, it provides a convenient example of how easy it is to extract features from the created time series in a data-driven way. The user can of course change this code to add more features or to extract only a subset of features.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Extracting more features example tsfresh üè¥
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tsfresh <span class="im">import</span> extract_features</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize list to store features from each file</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>all_features <span class="op">=</span> []</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>timeseries <span class="op">=</span> glob.glob(<span class="st">'./dataoutput_STEP1_2_timeseries/*_processed_data_layer2.csv'</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># for checking lets do the first 2 time series</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>timeseries <span class="op">=</span> timeseries[:<span class="dv">2</span>] <span class="co"># comment this line to process all files</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Process each file individually</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> timeseries:</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    ts_data <span class="op">=</span> pd.read_csv(<span class="bu">file</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    video_id <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'_processed'</span>)[<span class="dv">0</span>]</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean NaN values for the current file</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    distance_data <span class="op">=</span> ts_data[<span class="st">'distance_com'</span>].copy()</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    distance_data <span class="op">=</span> distance_data.interpolate(method<span class="op">=</span><span class="st">'linear'</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    distance_data <span class="op">=</span> distance_data.fillna(method<span class="op">=</span><span class="st">'ffill'</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    distance_data <span class="op">=</span> distance_data.fillna(method<span class="op">=</span><span class="st">'bfill'</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create DataFrame for current file only</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    current_data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'id'</span>: video_id,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'time'</span>: <span class="bu">range</span>(<span class="bu">len</span>(distance_data)),</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'distance_com'</span>: distance_data</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract features for current file only</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    current_features <span class="op">=</span> extract_features(current_data, column_id<span class="op">=</span><span class="st">'id'</span>, column_sort<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add to our collection</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    all_features.append(current_features)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: print progress</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processed </span><span class="sc">{</span>video_id<span class="sc">}</span><span class="ss"> - extracted </span><span class="sc">{</span><span class="bu">len</span>(current_features.columns)<span class="sc">}</span><span class="ss"> features"</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clear variables to free memory</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> ts_data, distance_data, current_data, current_features</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Processed dataoutput_STEP1_2_timeseries\cop_p01 - extracted 783 features
Processed dataoutput_STEP1_2_timeseries\cop_p02 - extracted 783 features


Feature Extraction:   0%|          | 0/1 [00:00&lt;?, ?it/s]
Feature Extraction: 100%|##########| 1/1 [00:11&lt;00:00, 11.74s/it]
Feature Extraction: 100%|##########| 1/1 [00:11&lt;00:00, 11.74s/it]

Feature Extraction:   0%|          | 0/1 [00:00&lt;?, ?it/s]
Feature Extraction: 100%|##########| 1/1 [00:21&lt;00:00, 21.90s/it]
Feature Extraction: 100%|##########| 1/1 [00:21&lt;00:00, 21.90s/it]</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all features at the end</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>combined_features <span class="op">=</span> pd.concat(all_features, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total: Extracted </span><span class="sc">{</span><span class="bu">len</span>(combined_features.columns)<span class="sc">}</span><span class="ss"> features from </span><span class="sc">{</span><span class="bu">len</span>(combined_features)<span class="sc">}</span><span class="ss"> videos"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Total: Extracted 783 features from 2 videos</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>combined_features.to_csv(<span class="st">'./dataoutput_STEP2_features/tsfresh_features_fromCOMdistance.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example output tsfresh: üìä
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For each video we will now have a smoothness feature set.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="im">as</span> glob</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">"./dataoutput_STEP2_features/tsfresh_features_fromCOMdistance.csv"</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(csv_file)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Unnamed: 0  ...  distance_com__mean_n_absolute_max__number_of_maxima_7
0           0  ...                                        1108.660524    
1           1  ...                                        1398.293592    

[2 rows x 784 columns]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
DIY STEP 2: Feature Extraction üõ†Ô∏è
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="step-1-install-requirements-1" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="step-1-install-requirements-1"><span class="header-section-number">4.2.2</span> Step 1: Install requirements</h3>
<p>For each script we have provided a <code>requirements.txt</code> file. You can install the requirements using pip, by first navigating to the folder where the script is located and then running the following command in your terminal:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP2_smoothness_features/</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-run-the-python-script" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="step-2-run-the-python-script"><span class="header-section-number">4.2.3</span> Step 2: Run the python script</h3>
<p>Assuming you have timeseries data (<code>./dataoutput_STEP1_2_timeseries/</code>), you can run the script using the following command:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP2_smoothness_features/</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> STEP2_featureextraction.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="step-3-non-linear-time-series-analysis-r" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Step 3: Non-linear time series analysis (R)</h1>
</section>
<section id="step-4-statistical-analysis-r" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Step 4: Statistical analysis (R)</h1>
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># manually edited this CSV</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"C:/Users/wiltshir/GitHub/InterPerDynPipelineAnalysis/Re_ Behavioral Dynamics in Social Interactions AP_SI/smoothness_data_top_view_clean.csv"</span>) </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">#data_cross_cultur&lt;-data[1:18,]</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove a row</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>data<span class="ot">&lt;-</span> <span class="fu">subset</span>(data, data<span class="sc">$</span>videoID<span class="sc">!=</span><span class="st">"cop_b09 z g√≥ry"</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a culture grouping variable</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>culture <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"g√≥ry$"</span>, data<span class="sc">$</span>videoID), <span class="st">"Yurakare"</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"kam_5$"</span>, data<span class="sc">$</span>videoID), <span class="st">"Polish"</span>, <span class="cn">NA</span>))</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Restructure data into long format</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>data_long <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(smoothness_p1_proximity, smoothness_p2_proximity),</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"person"</span>,</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"smoothness_value"</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4) </span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest) </span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(smoothness_value <span class="sc">~</span> culture <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> videoID), <span class="at">data =</span> data_long)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
DIY: Analysis üõ†Ô∏è
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
</section>
<section id="references" class="level1" data-number="7">

<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">7 References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-balasubramanianAnalysisMovementSmoothness2015" class="csl-entry" role="listitem">
Balasubramanian, Sivakumar, Alejandro Melendez-Calderon, Agnes Roby-Brami, and Etienne Burdet. 2015. <span>‚ÄúOn the Analysis of Movement Smoothness.‚Äù</span> <em>Journal of NeuroEngineering and Rehabilitation</em> 12 (1): 112. <a href="https://doi.org/10.1186/s12984-015-0090-9">https://doi.org/10.1186/s12984-015-0090-9</a>.
</div>
<div id="ref-caoOpenPoseRealtimeMultiPerson2021a" class="csl-entry" role="listitem">
Cao, Zhe, Gines Hidalgo, Tomas Simon, Shih-En Wei, and Yaser Sheikh. 2021. <span>‚Äú<span>OpenPose</span>: <span>Realtime Multi-Person 2D Pose Estimation Using Part Affinity Fields</span>.‚Äù</span> <em>IEEE Transactions on Pattern Analysis and Machine Intelligence</em> 43 (1): 172‚Äì86. <a href="https://doi.org/10.1109/TPAMI.2019.2929257">https://doi.org/10.1109/TPAMI.2019.2929257</a>.
</div>
<div id="ref-christTimeSeriesFeatuRe2018" class="csl-entry" role="listitem">
Christ, Maximilian, Nils Braun, Julius Neuffer, and Andreas W. Kempa-Liehr. 2018. <span>‚ÄúTime <span>Series FeatuRe Extraction</span> on Basis of <span>Scalable Hypothesis</span> Tests (Tsfresh ‚Äì <span>A Python</span> Package).‚Äù</span> <em>Neurocomputing</em> 307 (September): 72‚Äì77. <a href="https://doi.org/10.1016/j.neucom.2018.03.067">https://doi.org/10.1016/j.neucom.2018.03.067</a>.
</div>
<div id="ref-hoganSensitivitySmoothnessMeasures2009" class="csl-entry" role="listitem">
Hogan, Neville, and Dagmar Sternad. 2009. <span>‚ÄúSensitivity of <span>Smoothness Measures</span> to <span>Movement Duration</span>, <span>Amplitude</span> and <span>Arrests</span>.‚Äù</span> <em>Journal of Motor Behavior</em> 41 (6): 529‚Äì34. <a href="https://doi.org/10.3200/35-09-004-RC">https://doi.org/10.3200/35-09-004-RC</a>.
</div>
<div id="ref-jocherYOLOUltralytics2023" class="csl-entry" role="listitem">
Jocher, Glenn, Ayush Chaurasia, and Jing Qiu. 2023. <span>‚Äú<span>YOLO</span> by <span>Ultralytics</span>.‚Äù</span>
</div>
<div id="ref-lugaresiMediaPipeFrameworkBuilding2019" class="csl-entry" role="listitem">
Lugaresi, Camillo, Jiuqiang Tang, Hadon Nash, Chris McClanahan, Esha Uboweja, Michael Hays, Fan Zhang, et al. 2019. <span>‚Äú<span>MediaPipe</span>: <span>A Framework</span> for <span>Building Perception Pipelines</span>.‚Äù</span> arXiv. <a href="https://doi.org/10.48550/arXiv.1906.08172">https://doi.org/10.48550/arXiv.1906.08172</a>.
</div>
<div id="ref-winterBiomechanicsMotorControl2009" class="csl-entry" role="listitem">
Winter, David A. 2009. <em>Biomechanics and <span>Motor Control</span> of <span>Human Movement</span></em>. John Wiley &amp; Sons.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "An Open-source Standardized Pipeline for Tracing the Behavioral Dynamics in Social Interactions"</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Computationally Reproducible Extended Methods and Results Section"</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "`r format(Sys.time(), '%B %d, %Y')`"</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> </span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Arkadiusz Bia≈Çek</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Jagiellonian University, Poland</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Wim Pouw</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Tilburg University, Netherlands</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: James Trujillo</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: University of Amsterdam, Netherlands</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Fred Hasselman</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Radboud University, Netherlands</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Babajide Alamu Owoyele</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Hasso Plattner Institute, University of Potsdam, Germany</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Natalia Siekiera</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Jagiellonian University, Poland</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Joanna RƒÖczaszek-Leonardi</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: University of Warsaw, Poland</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Travis J. Wiltshire</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Tilburg University, Netherlands</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="an">contact:</span><span class="co"> </span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Wim Pouw</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="co">    email: w.pouw@tilburguniversity.edu</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> quarto_dependencies/references/refs.bib</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="an">theme:</span><span class="co"> journal</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="an">css:</span><span class="co"> quarto_dependencies/styles/styles.css</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: left</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-title: "Contents"</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/ts.gif)</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="fu"># Overview</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>To increase reproducibility of our approach we have designed this Quarto notebook that provides the user with what is effectively a manual-style extended methods and results section. Next to staging and (visually) explaining key Python and R code elements, the notebook contains detailed further ‚ÄúDo It Yourself‚Äù (DIY) instructions that can be accessed on demand by clicking on DIY sections, for example providing the technical steps needed to install and then run code for YOLO tracking on (user-defined) data. This notebook is therefore not simply an add-on supplemental text, but it is a key part of our contribution as it allows for newcomers to social signal processing to start implement this pipeline step by step.</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>The Quarto notebook is structured to have the following components, next to traditional text sections:</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>üö© **pipeline code** that overview complete code associated with the pipeline, or shorter code chunks to for example explain a particular function. These code blocks are generally not run inside the current notebook. Denoted with the symbol üö©.</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>üè¥ **other code chuncks** that we use for this quarto notebook to create sanity checks or animations related to measures or summarizing datasets. These code blocks are generally run inside the notebook. Denoted with the symbol üè¥.</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>üìä **example output** that shows example output of the pipeline. Denoted with the symbol üìä.</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>üõ†Ô∏è **DIY blocks** that provide shorter, step-by-step links to the full code for executing a particular step in the pipeline on your own data.  Denoted with the symbol üõ†Ô∏è.</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>‚¨áÔ∏è **dataset download** provide information about how to download the dataset overviewed for our report. Denoted with the symbol ‚¨áÔ∏è.</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>**What the Quarto notebook is not intended to do:** This notebook is not itself the pipeline (i.e., a collection of code that runs the complete pipeline). It is rather a linear step-by-step manual and explainer of how to understand and implement the pipeline steps. For actually applying this code, the user can further dig into the **DIY** blocks. </span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a><span class="fu"># Dataset</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>Below is a description of the two datasets that were used as test cases for the pipeline. The datasets are available in masked form to reduce identifiability of the individuals in the dataset. Following the download guide for further information on how to access the datasets.</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-download collapse="true"}</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a><span class="fu">## Download Guide ‚¨áÔ∏è</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>The masked data can be downloaded from the repository of Jagellonian University <span class="co">[</span><span class="ot">here</span><span class="co">]()</span>. The unmasked data can be requested from the authors.</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>Please note that the masked data is not the input of the pipeline. YOLO tracking would not work well on masked data as detailed information about the body is lost, and only represented as the motion tracking data that comes with it (and is present in the repository). Rather the masked data can be used to check for qualitative changes in the behavior of the inviduals, and can be used to create animations such as in step 1.3.</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>**Example of masked videodata**</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a><span class="al">![](./images/masked_example.jpeg)</span>{fig-align="center" width=600}</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dataset Mother Infant</span></span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>Thirteen infant-caregiver pairs visited the child laboratory monthly for a total of seven visits. The infants' ages at the first visit ranged from 7 to 9 months. Parents were instructed to "play as usual," with a set of different toys to encourage spontaneous interactions. Each visit lasted approximately 30 minutes and was divided into four stages. For our analyses, we focus on recordings from the stage where the infant was seated in a feeding chair, facing the caregiver sitting directly across. This controlled setup minimizes movement around the room, facilitating video motion tracking analysis. Additionally, our analyses are restricted to top-view recordings, ensuring that both the caregiver and the infant are captured within a single frame.</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-download collapse="true"}</span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a><span class="fu">## Plotting code for the Mother-Infant dataset üè¥</span></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, eval=FALSE}</span></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>matplotlib.use(<span class="st">'agg'</span>)</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>plt.ioff()</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>plt.clf() <span class="co"># Clear any existing figures</span></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'./meta/project_point_metadata_ages.csv'</span>)</span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert gender to categorical label</span></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'gender_label'</span>] <span class="op">=</span> df[<span class="st">'gender'</span>].<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'Female'</span>, <span class="dv">1</span>: <span class="st">'Male'</span>})</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 2x2 subplot layout</span></span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>), gridspec_kw<span class="op">=</span>{<span class="st">'width_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>], <span class="st">'height_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>]})</span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Mother-Infant Dataset Overview'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for gender</span></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Female'</span>: <span class="st">'#C55A11'</span>,   <span class="co"># Orange for females</span></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Male'</span>: <span class="st">'#4472C4'</span>       <span class="co"># Blue for males</span></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Line plot - Age progression across time points</span></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>    gender <span class="op">=</span> row[<span class="st">'gender_label'</span>]</span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create arrays for days and time points, handling NaN values</span></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>    days <span class="op">=</span> []</span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>    timepoints <span class="op">=</span> []</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):   <span class="co"># T1 to T7</span></span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>        day_col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> day_col <span class="kw">in</span> df.columns <span class="kw">and</span> pd.notna(row[day_col]) <span class="kw">and</span> row[day_col] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a>            days.append(row[day_col])</span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>            timepoints.append(i)</span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the line for this infant</span></span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>, <span class="dv">0</span>].plot(</span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a>        timepoints,</span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a>        days,</span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a>        marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>colors[gender],</span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">1.5</span></span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Customize the plot</span></span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Infant Age Progression'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>))</span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xticklabels([<span class="ss">f'T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>)])</span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a><span class="co"># Add legend patches</span></span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a>legend_elements <span class="op">=</span> [</span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>    Patch(facecolor<span class="op">=</span>colors[<span class="st">'Female'</span>], edgecolor<span class="op">=</span><span class="st">'w'</span>, label<span class="op">=</span><span class="st">'Female'</span>),</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a>    Patch(facecolor<span class="op">=</span>colors[<span class="st">'Male'</span>], edgecolor<span class="op">=</span><span class="st">'w'</span>, label<span class="op">=</span><span class="st">'Male'</span>)</span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Box plot - Age distribution at each time point</span></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>time_point_data <span class="op">=</span> []</span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> []</span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):   <span class="co"># T1 to T7</span></span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>        valid_data <span class="op">=</span> df[col].dropna()</span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>            time_point_data.append(valid_data)</span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="ss">f'T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Create violin plots</span></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> time_point_data:</span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>    violin_parts <span class="op">=</span> axs[<span class="dv">0</span>, <span class="dv">1</span>].violinplot(</span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>        time_point_data,</span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>        showmeans<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a>        showmedians<span class="op">=</span><span class="va">True</span></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Color the violin plots</span></span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, pc <span class="kw">in</span> <span class="bu">enumerate</span>(violin_parts[<span class="st">'bodies'</span>]):</span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>        pc.set_facecolor(<span class="st">'#7030A0'</span>)  <span class="co"># Purple</span></span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a>        pc.set_edgecolor(<span class="st">'black'</span>)</span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>        pc.set_alpha(<span class="fl">0.7</span>)</span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels</span></span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(labels) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels(labels)</span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Age Distribution by Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Pie chart - Gender distribution</span></span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a>gender_counts <span class="op">=</span> df[<span class="st">'gender_label'</span>].value_counts()</span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].pie(</span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a>    gender_counts,</span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>gender_counts.index,</span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a>    autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[colors[g] <span class="cf">for</span> g <span class="kw">in</span> gender_counts.index],</span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a>    wedgeprops<span class="op">=</span>{<span class="st">'edgecolor'</span>: <span class="st">'w'</span>, <span class="st">'linewidth'</span>: <span class="dv">1</span>}</span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Gender Distribution'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Summary table</span></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate averages for each time point, handling NaN values</span></span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a>averages_days <span class="op">=</span> []</span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):</span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a>        avg <span class="op">=</span> df[col].mean()</span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> pd.isna(avg):</span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a>            avg_months <span class="op">=</span> avg <span class="op">/</span> <span class="fl">30.44</span>  <span class="co"># Convert to months</span></span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>            averages_days.append([<span class="ss">f"T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> Average Age"</span>, <span class="ss">f"</span><span class="sc">{</span>avg<span class="sc">:.1f}</span><span class="ss"> days (</span><span class="sc">{</span>avg_months<span class="sc">:.1f}</span><span class="ss"> months)"</span>])</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Count participants at each time point</span></span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>participants <span class="op">=</span> []</span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):</span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> df[col].notna().<span class="bu">sum</span>()</span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a>        participants.append([<span class="ss">f"Participants at T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"</span><span class="sc">{</span>count<span class="sc">}</span><span class="ss">"</span>])</span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall statistics</span></span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> [</span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Total Infants"</span>, <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Females"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'gender'</span>] <span class="op">==</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Males"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'gender'</span>] <span class="op">==</span> <span class="dv">1</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Add age ranges if columns exist</span></span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'age_T1_days'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a>    summary_data.append([<span class="st">"Age Range T1"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'age_T1_days'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df[<span class="st">'age_T1_days'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss"> days"</span>])</span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a>last_tp <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> last_tp <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>last_tp<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns <span class="kw">and</span> df[col].notna().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>        summary_data.append([<span class="ss">f"Age Range T</span><span class="sc">{</span>last_tp<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"</span><span class="sc">{</span>df[col]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df[col]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss"> days"</span>])</span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a>    last_tp <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the table with the most important summary statistics</span></span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">1</span>].table(</span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a>    cellText<span class="op">=</span>summary_data <span class="op">+</span> participants,</span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a>    cellLoc<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a>table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a>table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a>table.scale(<span class="dv">1</span>, <span class="fl">1.5</span>)</span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Dataset Summary'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the figure to a file</span></span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">"images/mother_infant_analysis.png"</span></span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a>os.makedirs(os.path.dirname(output_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a>plt.close(fig) <span class="co"># Explicitly close the figure object</span></span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/mother_infant_analysis.png)</span>{fig-align="center" width=600}</span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a>Note that in our github repository we use short sample data from this dataset from an infant-mother pair whom we are allowed to share the video data for the current purposes.</span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dataset Siblings</span></span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a>Ten sibling pairs (total = 20 pairs) were observed from Polish urban culture and Yurakar√© indigenous culture each. Observations were made during a semi-structured play situation: in the natural environment of the Yurakar√© community and laboratory conditions in Poland. Siblings were asked to build a tower together using 54 wooden blocks while sitting facing each other. Each pair had 4 minutes to complete the task. This setup allowed for a systematic comparison of coordinated and mutually adjusted movements in siblings, using our pipeline to examine the smoothness of interaction while "doing things together" in these two cultural groups.</span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-download collapse="true"}</span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a><span class="fu">## Plotting code for the Siblings dataset üè¥</span></span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-265"><a href="#cb31-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-266"><a href="#cb31-266" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'./meta/project_siblings_metadata_ages_gender.csv'</span>)</span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a><span class="co"># Data preprocessing</span></span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'AgeDifference'</span>] <span class="op">=</span> <span class="bu">abs</span>(df[<span class="st">'P1agedays'</span>] <span class="op">-</span> df[<span class="st">'P2agedays'</span>])</span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'AverageAge'</span>] <span class="op">=</span> (df[<span class="st">'P1agedays'</span>] <span class="op">+</span> df[<span class="st">'P2agedays'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'GenderCombo'</span>] <span class="op">=</span> df[<span class="st">'GenderP1'</span>] <span class="op">+</span> <span class="st">'-'</span> <span class="op">+</span> df[<span class="st">'GenderP2'</span>]</span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 2x2 subplot layout</span></span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), gridspec_kw<span class="op">=</span>{<span class="st">'width_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>], <span class="st">'height_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>]})</span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Sibling Dataset Overview'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for gender combinations</span></span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {</span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a>    <span class="st">'M-M'</span>: <span class="st">'#4472C4'</span>,   <span class="co"># Blue</span></span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a>    <span class="st">'M-F'</span>: <span class="st">'#7030A0'</span>,   <span class="co"># Purple</span></span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a>    <span class="st">'F-M'</span>: <span class="st">'#548235'</span>,   <span class="co"># Green</span></span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a>    <span class="st">'F-F'</span>: <span class="st">'#C55A11'</span>    <span class="co"># Rust/Orange</span></span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Scatter plot - P1 age vs P2 age</span></span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gender_combo, group <span class="kw">in</span> df.groupby(<span class="st">'GenderCombo'</span>):</span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>, <span class="dv">0</span>].scatter(</span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'P1agedays'</span>],</span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'P2agedays'</span>],</span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>colors.get(gender_combo, <span class="st">'gray'</span>),</span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span>gender_combo,</span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span><span class="dv">50</span></span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a><span class="co"># Add reference line</span></span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a>min_age <span class="op">=</span> <span class="bu">min</span>(df[<span class="st">'P1agedays'</span>].<span class="bu">min</span>(), df[<span class="st">'P2agedays'</span>].<span class="bu">min</span>())</span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a>max_age <span class="op">=</span> <span class="bu">max</span>(df[<span class="st">'P1agedays'</span>].<span class="bu">max</span>(), df[<span class="st">'P2agedays'</span>].<span class="bu">max</span>())</span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].plot([min_age, max_age], [min_age, max_age], <span class="st">'k--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'P1 Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'P2 Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Participant Ages (P1 vs P2)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb31-305"><a href="#cb31-305" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].legend()</span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Bar chart - Age differences</span></span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a>bar_positions <span class="op">=</span> np.arange(<span class="bu">len</span>(df))</span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a>bar_width <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].bar(</span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a>    bar_positions,</span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'AgeDifference'</span>],</span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span>bar_width,</span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>[colors.get(combo, <span class="st">'gray'</span>) <span class="cf">for</span> combo <span class="kw">in</span> df[<span class="st">'GenderCombo'</span>]]</span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks(bar_positions)</span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels(df[<span class="st">'Code'</span>], rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Sibling Pair'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Age Difference (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Age Differences by Sibling Pair'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Pie chart - Gender distribution</span></span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a>gender_counts <span class="op">=</span> df[<span class="st">'GenderCombo'</span>].value_counts()</span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].pie(</span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a>    gender_counts,</span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>gender_counts.index,</span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a>    autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[colors.get(combo, <span class="st">'gray'</span>) <span class="cf">for</span> combo <span class="kw">in</span> gender_counts.index],</span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a>    wedgeprops<span class="op">=</span>{<span class="st">'edgecolor'</span>: <span class="st">'w'</span>, <span class="st">'linewidth'</span>: <span class="dv">1</span>}</span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Gender Distribution'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Summary table</span></span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> [</span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Total Sibling Pairs"</span>, <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average P1 Age"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'P1agedays'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average P2 Age"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'P2agedays'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average Age Difference"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'AgeDifference'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb31-340"><a href="#cb31-340" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Number of Males"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'GenderP1'</span>] <span class="op">==</span> <span class="st">'M'</span>)<span class="sc">.</span><span class="bu">sum</span>() <span class="op">+</span> (df[<span class="st">'GenderP2'</span>] <span class="op">==</span> <span class="st">'M'</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Number of Females"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'GenderP1'</span>] <span class="op">==</span> <span class="st">'F'</span>)<span class="sc">.</span><span class="bu">sum</span>() <span class="op">+</span> (df[<span class="st">'GenderP2'</span>] <span class="op">==</span> <span class="st">'F'</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn off axis for table</span></span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">1</span>].table(</span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a>    cellText<span class="op">=</span>[row <span class="cf">for</span> row <span class="kw">in</span> summary_data],</span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a>    colLabels<span class="op">=</span>[<span class="st">"Measure"</span>, <span class="st">"Value"</span>],</span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a>    cellLoc<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a>table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a>table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a>table.scale(<span class="dv">1</span>, <span class="fl">1.5</span>)</span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Dataset Summary'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb31-358"><a href="#cb31-358" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb31-359"><a href="#cb31-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the figure to a file</span></span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">"images/sibling_analysis.png"</span></span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a>os.makedirs(os.path.dirname(output_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/sibling_analysis.png)</span>{fig-align="center" width=600}</span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-settingup collapse="true"}</span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a><span class="fu">## DIY: Setting up the repository on your local machine üõ†Ô∏è</span></span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 0: Github repo</span></span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a>You should first clone the repository <span class="co">[</span><span class="ot">InterPerDynPipeline</span><span class="co">](https://github.com/WimPouw/InterPerDynPipeline)</span> and move to the root directory. The step 1 code for tracking is in the <span class="in">`./code_STEP1_posetrackingprocessing/`</span> folder. In this folder you will find the Python script <span class="in">`yolo_tracking_processing.py`</span>. To check whether you have the correct script you can compare against the code chunk provided below.</span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a>First install git if you do not have it installed yet. You can find instructions on how to install git <span class="co">[</span><span class="ot">here</span><span class="co">](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git)</span>.</span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a>Then you can clone the repository using the following commands in your (anaconda) terminal:</span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/WimPouw/InterPerDynPipeline</span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ./InterPerDynPipeline/</span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 1: Motion tracking and signal processing and wrangling</span></span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a>The motion tracking and signal processing pipeline is divided into three steps: </span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Tracking**: This step involves tracking the movements of individuals in the videos using YOLOv8. The output is a video with annotated keypoints and a CSV file containing the coordinates of these keypoints. 2. **Signal Processing**: This step involves processing the keypoint data to extract relevant features for analysis. The output are processed timeseries files, and a flat dataset containing our smoothness measures that are directly ready for statistical analysis. 3. **Animations**: This step involves animating the processed data together with the original video data to ensure that the processed data are of sufficient quality to reflect behavioral changes.</span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-392"><a href="#cb31-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-393"><a href="#cb31-393" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1.1: Tracking two persons in videos for top-view (Python)</span></span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a>We have tried several pose tracking solutions, such as OpenPose (model 25B; @caoOpenPoseRealtimeMultiPerson2021a), Mediapipe (default highest complexity blazepose model; @lugaresiMediaPipeFrameworkBuilding2019). We found that these models are not well equipped to track persons from top view, most likely because these models are not trained on ground-truth poses of persons from top-view camera angles. However, we found the heaviest model of YOLOv8 ("yolov8x-pose-p6.pt") does perform very well, especially as compared to the other models we tested. Thus, for this pipeline we recommend using YOLOv8 model <span class="co">[</span><span class="ot">@jocherYOLOUltralytics2023</span><span class="co">]</span> for top-view tracking.</span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a><span class="fu">## DIY Step 1.1 Motion Tracking Set-Up and Execution üõ†Ô∏è</span></span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 1: Install requirements</span></span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a>For each script we have provided a <span class="in">`requirements.txt`</span> file. You can install the requirements using pip, by first navigating to the folder where the script is located and then running the following command in your terminal:</span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP1_posetrackingprocessing/</span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 2: Download the YOLOv8 model</span></span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a>In the current GitHub repo we have a light-weight model <span class="in">`yolov8n-pose.pt`</span> (~6.5MB) for immediate testing of the code. However, this model is not as accurate as the heaviest model.</span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a>We should download the heaviest model (<span class="in">`yolov8x-pose-p6.pt`</span>) and save it to the <span class="in">`./code_STEP1_posetrackingprocessing/model/`</span> directory:  </span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a>https://github.com/ultralytics/assets/releases/download/v8.1.0/yolov8x-pose-p6.pt</span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a>**Note** that if you're running the heavyweight model, you will need GPU support for this to run in a reasonable time (we processed our data on a NVIDIA GeForce RTX 4090 GPU). The lightweight model can run on CPU.</span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 3: Run the python script</span></span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a>Assuming you have videos in your data folder (<span class="in">`./data_raw/`</span>) and you have a <span class="in">`.pt`</span> model in the model folder, you can run the script using the following command:</span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP1_posetrackingprocessing/</span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> yolo_tracking_processing.py</span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-423"><a href="#cb31-423" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-424"><a href="#cb31-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a>The code below is the script <span class="in">`yolo_tracking_processing.py`</span> that you can run to track the videos. The output will be a video with annotated keypoints and a CSV file containing the coordinates of these keypoints. The script processes each video frame-by-frame, detecting people and their pose keypoints (17 points as listed in the script; see the <span class="in">`GetKeypoint class`</span>). We filter out duplicate detections or skeletons with excessive missing data. Specifically, for each processed video, the script generates two output files: an annotated video showing the original footage with skeleton overlays (green points for accepted keypoints, red for filtered ones, and blue lines connecting the points), and a CSV file containing the raw coordinate data (frame number, person ID, keypoint ID, x-coordinate, y-coordinate). The output filenames include parameters like "c150" (150px proximity threshold) and "miss95" (95% missing data tolerance), which control how the system handles potential duplicate detections and incomplete skeletons. The user could adjust the parameter <span class="in">`close_threshold`</span> and <span class="in">`miss_tolerance`</span> to adjust the detection dynamics. We output the annotated video and the CSV file in the <span class="in">`./datatracked_afterSTEP1/`</span> folder.</span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-429"><a href="#cb31-429" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pipeline code 1.1 YOLO tracking üö©</span></span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ultralytics <span class="im">import</span> YOLO</span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel</span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch <span class="co"># for gpu support</span></span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> combinations</span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-443"><a href="#cb31-443" aria-hidden="true" tabindex="-1"></a>torch.cuda.set_device(<span class="dv">0</span>)</span>
<span id="cb31-444"><a href="#cb31-444" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model</span></span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a>modelfolder <span class="op">=</span> <span class="st">'./model/'</span></span>
<span id="cb31-446"><a href="#cb31-446" aria-hidden="true" tabindex="-1"></a>modellocation <span class="op">=</span> glob.glob(modelfolder<span class="op">+</span><span class="st">"*.pt"</span>)[<span class="dv">0</span>]</span>
<span id="cb31-447"><a href="#cb31-447" aria-hidden="true" tabindex="-1"></a>modelfile <span class="op">=</span> os.path.basename(modellocation)</span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"We are loading in the following YOLO model: </span><span class="sc">{</span>modelfile<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> YOLO(modellocation)</span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a><span class="co"># main variables</span></span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a>video_folder <span class="op">=</span> <span class="st">"../data_raw/"</span></span>
<span id="cb31-452"><a href="#cb31-452" aria-hidden="true" tabindex="-1"></a><span class="co"># avi mp4 or other video formats</span></span>
<span id="cb31-453"><a href="#cb31-453" aria-hidden="true" tabindex="-1"></a>video_files <span class="op">=</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mp4"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.avi"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mov"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mkv"</span>)</span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a>step1resultfolder <span class="op">=</span> <span class="st">"../datatracked_afterSTEP1/"</span></span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(video_files)</span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-457"><a href="#cb31-457" aria-hidden="true" tabindex="-1"></a><span class="co"># keypoint names</span></span>
<span id="cb31-458"><a href="#cb31-458" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GetKeypoint(BaseModel):</span>
<span id="cb31-459"><a href="#cb31-459" aria-hidden="true" tabindex="-1"></a>    NOSE:           <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-460"><a href="#cb31-460" aria-hidden="true" tabindex="-1"></a>    LEFT_EYE:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb31-461"><a href="#cb31-461" aria-hidden="true" tabindex="-1"></a>    RIGHT_EYE:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb31-462"><a href="#cb31-462" aria-hidden="true" tabindex="-1"></a>    LEFT_EAR:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb31-463"><a href="#cb31-463" aria-hidden="true" tabindex="-1"></a>    RIGHT_EAR:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb31-464"><a href="#cb31-464" aria-hidden="true" tabindex="-1"></a>    LEFT_SHOULDER:  <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb31-465"><a href="#cb31-465" aria-hidden="true" tabindex="-1"></a>    RIGHT_SHOULDER: <span class="bu">int</span> <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb31-466"><a href="#cb31-466" aria-hidden="true" tabindex="-1"></a>    LEFT_ELBOW:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb31-467"><a href="#cb31-467" aria-hidden="true" tabindex="-1"></a>    RIGHT_ELBOW:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb31-468"><a href="#cb31-468" aria-hidden="true" tabindex="-1"></a>    LEFT_WRIST:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb31-469"><a href="#cb31-469" aria-hidden="true" tabindex="-1"></a>    RIGHT_WRIST:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb31-470"><a href="#cb31-470" aria-hidden="true" tabindex="-1"></a>    LEFT_HIP:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">11</span></span>
<span id="cb31-471"><a href="#cb31-471" aria-hidden="true" tabindex="-1"></a>    RIGHT_HIP:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb31-472"><a href="#cb31-472" aria-hidden="true" tabindex="-1"></a>    LEFT_KNEE:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb31-473"><a href="#cb31-473" aria-hidden="true" tabindex="-1"></a>    RIGHT_KNEE:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb31-474"><a href="#cb31-474" aria-hidden="true" tabindex="-1"></a>    LEFT_ANKLE:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb31-475"><a href="#cb31-475" aria-hidden="true" tabindex="-1"></a>    RIGHT_ANKLE:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb31-476"><a href="#cb31-476" aria-hidden="true" tabindex="-1"></a>get_keypoint <span class="op">=</span> GetKeypoint()</span>
<span id="cb31-477"><a href="#cb31-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-478"><a href="#cb31-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-479"><a href="#cb31-479" aria-hidden="true" tabindex="-1"></a><span class="co"># Define skeleton connections</span></span>
<span id="cb31-480"><a href="#cb31-480" aria-hidden="true" tabindex="-1"></a>skeleton <span class="op">=</span> [</span>
<span id="cb31-481"><a href="#cb31-481" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.RIGHT_SHOULDER),</span>
<span id="cb31-482"><a href="#cb31-482" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.LEFT_ELBOW),</span>
<span id="cb31-483"><a href="#cb31-483" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_SHOULDER, get_keypoint.RIGHT_ELBOW),</span>
<span id="cb31-484"><a href="#cb31-484" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_ELBOW, get_keypoint.LEFT_WRIST),</span>
<span id="cb31-485"><a href="#cb31-485" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_ELBOW, get_keypoint.RIGHT_WRIST),</span>
<span id="cb31-486"><a href="#cb31-486" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.LEFT_HIP),</span>
<span id="cb31-487"><a href="#cb31-487" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_SHOULDER, get_keypoint.RIGHT_HIP),</span>
<span id="cb31-488"><a href="#cb31-488" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_HIP, get_keypoint.RIGHT_HIP),</span>
<span id="cb31-489"><a href="#cb31-489" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_HIP, get_keypoint.LEFT_KNEE),</span>
<span id="cb31-490"><a href="#cb31-490" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_HIP, get_keypoint.RIGHT_KNEE),</span>
<span id="cb31-491"><a href="#cb31-491" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_KNEE, get_keypoint.LEFT_ANKLE),</span>
<span id="cb31-492"><a href="#cb31-492" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_KNEE, get_keypoint.RIGHT_ANKLE),</span>
<span id="cb31-493"><a href="#cb31-493" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-494"><a href="#cb31-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-495"><a href="#cb31-495" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tensor_to_matrix(results_tensor):</span>
<span id="cb31-496"><a href="#cb31-496" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this just takes the results output of YOLO and coverts it to a matrix,</span></span>
<span id="cb31-497"><a href="#cb31-497" aria-hidden="true" tabindex="-1"></a>    <span class="co"># making it easier to do quick calculations on the coordinates</span></span>
<span id="cb31-498"><a href="#cb31-498" aria-hidden="true" tabindex="-1"></a>    results_list <span class="op">=</span> results_tensor.tolist()</span>
<span id="cb31-499"><a href="#cb31-499" aria-hidden="true" tabindex="-1"></a>    results_matrix <span class="op">=</span> np.matrix(results_list)</span>
<span id="cb31-500"><a href="#cb31-500" aria-hidden="true" tabindex="-1"></a>    results_matrix[results_matrix<span class="op">==</span><span class="dv">0</span>] <span class="op">=</span> np.nan</span>
<span id="cb31-501"><a href="#cb31-501" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_matrix</span>
<span id="cb31-502"><a href="#cb31-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-503"><a href="#cb31-503" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_for_duplication(results):</span>
<span id="cb31-504"><a href="#cb31-504" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this threshold determines how close two skeletons must be in order to be</span></span>
<span id="cb31-505"><a href="#cb31-505" aria-hidden="true" tabindex="-1"></a>    <span class="co"># considered the same person. Arbitrarily chosen for now.</span></span>
<span id="cb31-506"><a href="#cb31-506" aria-hidden="true" tabindex="-1"></a>    close_threshold <span class="op">=</span><span class="dv">150</span></span>
<span id="cb31-507"><a href="#cb31-507" aria-hidden="true" tabindex="-1"></a>    <span class="co"># missing data tolerance</span></span>
<span id="cb31-508"><a href="#cb31-508" aria-hidden="true" tabindex="-1"></a>    miss_tolerance <span class="op">=</span> <span class="fl">0.95</span> <span class="co"># this means we can miss up to 75% of the keypoints</span></span>
<span id="cb31-509"><a href="#cb31-509" aria-hidden="true" tabindex="-1"></a>    drop_indices <span class="op">=</span> []</span>
<span id="cb31-510"><a href="#cb31-510" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb31-511"><a href="#cb31-511" aria-hidden="true" tabindex="-1"></a>        conf_scores <span class="op">=</span> []</span>
<span id="cb31-512"><a href="#cb31-512" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get detection confidence for each skeleton</span></span>
<span id="cb31-513"><a href="#cb31-513" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> person <span class="kw">in</span> tensor_to_matrix(results[<span class="dv">0</span>].keypoints.conf):</span>
<span id="cb31-514"><a href="#cb31-514" aria-hidden="true" tabindex="-1"></a>            conf_scores.append(np.mean(person))</span>
<span id="cb31-515"><a href="#cb31-515" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb31-516"><a href="#cb31-516" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this list will stores which comparisons need to be made</span></span>
<span id="cb31-517"><a href="#cb31-517" aria-hidden="true" tabindex="-1"></a>        combos <span class="op">=</span> <span class="bu">list</span>(combinations(<span class="bu">range</span>(<span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy)), <span class="dv">2</span>))</span>
<span id="cb31-518"><a href="#cb31-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-519"><a href="#cb31-519" aria-hidden="true" tabindex="-1"></a>        <span class="co"># now loop through these comparisons</span></span>
<span id="cb31-520"><a href="#cb31-520" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> combo <span class="kw">in</span> combos:</span>
<span id="cb31-521"><a href="#cb31-521" aria-hidden="true" tabindex="-1"></a>            closeness <span class="op">=</span> <span class="bu">abs</span>(np.nanmean(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[combo[<span class="dv">0</span>]]) <span class="op">-</span> </span>
<span id="cb31-522"><a href="#cb31-522" aria-hidden="true" tabindex="-1"></a>                        tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[combo[<span class="dv">1</span>]])))</span>
<span id="cb31-523"><a href="#cb31-523" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if any of them indicate that two skeletons are very close together,</span></span>
<span id="cb31-524"><a href="#cb31-524" aria-hidden="true" tabindex="-1"></a>            <span class="co"># we keep the one with higher tracking confidence, and remove the other</span></span>
<span id="cb31-525"><a href="#cb31-525" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> closeness <span class="op">&lt;</span> close_threshold:</span>
<span id="cb31-526"><a href="#cb31-526" aria-hidden="true" tabindex="-1"></a>                conf_list <span class="op">=</span> [conf_scores[combo[<span class="dv">0</span>]], conf_scores[combo[<span class="dv">1</span>]]]</span>
<span id="cb31-527"><a href="#cb31-527" aria-hidden="true" tabindex="-1"></a>                idx_min <span class="op">=</span> conf_list.index(<span class="bu">min</span>(conf_list))</span>
<span id="cb31-528"><a href="#cb31-528" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-529"><a href="#cb31-529" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-530"><a href="#cb31-530" aria-hidden="true" tabindex="-1"></a>                drop_indices.append(combo[idx_min])</span>
<span id="cb31-531"><a href="#cb31-531" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-532"><a href="#cb31-532" aria-hidden="true" tabindex="-1"></a>        <span class="co"># additional checks:</span></span>
<span id="cb31-533"><a href="#cb31-533" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> person <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy)):</span>
<span id="cb31-534"><a href="#cb31-534" aria-hidden="true" tabindex="-1"></a>           keypoints_missed <span class="op">=</span>  np.isnan(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[person])).<span class="bu">sum</span>()<span class="op">/</span><span class="dv">2</span></span>
<span id="cb31-535"><a href="#cb31-535" aria-hidden="true" tabindex="-1"></a>           perc_missed <span class="op">=</span> keypoints_missed<span class="op">/</span><span class="bu">len</span>(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[person]))</span>
<span id="cb31-536"><a href="#cb31-536" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb31-537"><a href="#cb31-537" aria-hidden="true" tabindex="-1"></a>           <span class="cf">if</span> perc_missed <span class="op">&gt;</span> miss_tolerance:</span>
<span id="cb31-538"><a href="#cb31-538" aria-hidden="true" tabindex="-1"></a>               drop_indices.append(person)</span>
<span id="cb31-539"><a href="#cb31-539" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-540"><a href="#cb31-540" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">set</span>(drop_indices))</span>
<span id="cb31-541"><a href="#cb31-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-542"><a href="#cb31-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-543"><a href="#cb31-543" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> video_path <span class="kw">in</span> video_files:</span>
<span id="cb31-544"><a href="#cb31-544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Video path</span></span>
<span id="cb31-545"><a href="#cb31-545" aria-hidden="true" tabindex="-1"></a>    video_path <span class="op">=</span> video_path</span>
<span id="cb31-546"><a href="#cb31-546" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only if the output is not there yet</span></span>
<span id="cb31-547"><a href="#cb31-547" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(step1resultfolder<span class="op">+</span> os.path.basename(video_path).split(<span class="st">'.'</span>)[<span class="dv">0</span>]<span class="op">+</span><span class="st">"_annotated_layer1_c150_miss95.mp4"</span>):</span>
<span id="cb31-548"><a href="#cb31-548" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Output video already exists for </span><span class="sc">{</span>video_path<span class="sc">}</span><span class="ss">. Skipping..."</span>)</span>
<span id="cb31-549"><a href="#cb31-549" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb31-550"><a href="#cb31-550" aria-hidden="true" tabindex="-1"></a>    <span class="co"># vidname without extension</span></span>
<span id="cb31-551"><a href="#cb31-551" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> os.path.basename(video_path)</span>
<span id="cb31-552"><a href="#cb31-552" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> vidname.split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb31-553"><a href="#cb31-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-554"><a href="#cb31-554" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Open the video</span></span>
<span id="cb31-555"><a href="#cb31-555" aria-hidden="true" tabindex="-1"></a>    cap <span class="op">=</span> cv2.VideoCapture(video_path)</span>
<span id="cb31-556"><a href="#cb31-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-557"><a href="#cb31-557" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get video properties</span></span>
<span id="cb31-558"><a href="#cb31-558" aria-hidden="true" tabindex="-1"></a>    fps <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FPS))</span>
<span id="cb31-559"><a href="#cb31-559" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span>
<span id="cb31-560"><a href="#cb31-560" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span>
<span id="cb31-561"><a href="#cb31-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-562"><a href="#cb31-562" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the output video writer</span></span>
<span id="cb31-563"><a href="#cb31-563" aria-hidden="true" tabindex="-1"></a>    corename <span class="op">=</span> os.path.basename(video_path).split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb31-564"><a href="#cb31-564" aria-hidden="true" tabindex="-1"></a>    output_path <span class="op">=</span> step1resultfolder<span class="op">+</span> vidname<span class="op">+</span><span class="st">"_annotated_layer1_c150_miss95.mp4"</span></span>
<span id="cb31-565"><a href="#cb31-565" aria-hidden="true" tabindex="-1"></a>    fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span><span class="st">'mp4v'</span>)</span>
<span id="cb31-566"><a href="#cb31-566" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> cv2.VideoWriter(output_path, fourcc, fps, (width, height))</span>
<span id="cb31-567"><a href="#cb31-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-568"><a href="#cb31-568" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare CSV file</span></span>
<span id="cb31-569"><a href="#cb31-569" aria-hidden="true" tabindex="-1"></a>    csv_path <span class="op">=</span> step1resultfolder<span class="op">+</span> vidname<span class="op">+</span><span class="st">'_keypoints_data_layer1.csv'</span></span>
<span id="cb31-570"><a href="#cb31-570" aria-hidden="true" tabindex="-1"></a>    csv_file <span class="op">=</span> <span class="bu">open</span>(csv_path, <span class="st">'w'</span>, newline<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb31-571"><a href="#cb31-571" aria-hidden="true" tabindex="-1"></a>    csv_writer <span class="op">=</span> csv.writer(csv_file)</span>
<span id="cb31-572"><a href="#cb31-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-573"><a href="#cb31-573" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write header</span></span>
<span id="cb31-574"><a href="#cb31-574" aria-hidden="true" tabindex="-1"></a>    header <span class="op">=</span> [<span class="st">'frame'</span>, <span class="st">'person'</span>, <span class="st">'keypoint'</span>, <span class="st">'x'</span>, <span class="st">'y'</span>]</span>
<span id="cb31-575"><a href="#cb31-575" aria-hidden="true" tabindex="-1"></a>    csv_writer.writerow(header)</span>
<span id="cb31-576"><a href="#cb31-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-577"><a href="#cb31-577" aria-hidden="true" tabindex="-1"></a>    frame_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-578"><a href="#cb31-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-579"><a href="#cb31-579" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> cap.isOpened():</span>
<span id="cb31-580"><a href="#cb31-580" aria-hidden="true" tabindex="-1"></a>        success, frame <span class="op">=</span> cap.read()</span>
<span id="cb31-581"><a href="#cb31-581" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb31-582"><a href="#cb31-582" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb31-583"><a href="#cb31-583" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-584"><a href="#cb31-584" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run YOLOv8 inference on the frame</span></span>
<span id="cb31-585"><a href="#cb31-585" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> model(frame)</span>
<span id="cb31-586"><a href="#cb31-586" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb31-587"><a href="#cb31-587" aria-hidden="true" tabindex="-1"></a>        <span class="co"># write empty rows if no person is detected</span></span>
<span id="cb31-588"><a href="#cb31-588" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb31-589"><a href="#cb31-589" aria-hidden="true" tabindex="-1"></a>            csv_writer.writerow([frame_count, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>])</span>
<span id="cb31-590"><a href="#cb31-590" aria-hidden="true" tabindex="-1"></a>        annotated_frame <span class="op">=</span> frame</span>
<span id="cb31-591"><a href="#cb31-591" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-592"><a href="#cb31-592" aria-hidden="true" tabindex="-1"></a>        <span class="co"># only do this if a person is detected</span></span>
<span id="cb31-593"><a href="#cb31-593" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-594"><a href="#cb31-594" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process the results</span></span>
<span id="cb31-595"><a href="#cb31-595" aria-hidden="true" tabindex="-1"></a>            drop_indices <span class="op">=</span> []</span>
<span id="cb31-596"><a href="#cb31-596" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-597"><a href="#cb31-597" aria-hidden="true" tabindex="-1"></a>            drop_indices <span class="op">=</span> check_for_duplication(results)</span>
<span id="cb31-598"><a href="#cb31-598" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-599"><a href="#cb31-599" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-600"><a href="#cb31-600" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> person_idx, person_keypoints <span class="kw">in</span> <span class="bu">enumerate</span>(results[<span class="dv">0</span>].keypoints.xy):</span>
<span id="cb31-601"><a href="#cb31-601" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> person_idx <span class="kw">not</span> <span class="kw">in</span> drop_indices:</span>
<span id="cb31-602"><a href="#cb31-602" aria-hidden="true" tabindex="-1"></a>                    colourcode <span class="op">=</span> (<span class="dv">0</span>, <span class="dv">255</span>, <span class="dv">0</span>)</span>
<span id="cb31-603"><a href="#cb31-603" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb31-604"><a href="#cb31-604" aria-hidden="true" tabindex="-1"></a>                    colourcode <span class="op">=</span> (<span class="dv">255</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb31-605"><a href="#cb31-605" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-606"><a href="#cb31-606" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> keypoint_idx, keypoint <span class="kw">in</span> <span class="bu">enumerate</span>(person_keypoints):</span>
<span id="cb31-607"><a href="#cb31-607" aria-hidden="true" tabindex="-1"></a>                    x, y <span class="op">=</span> keypoint</span>
<span id="cb31-608"><a href="#cb31-608" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb31-609"><a href="#cb31-609" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Write to CSV</span></span>
<span id="cb31-610"><a href="#cb31-610" aria-hidden="true" tabindex="-1"></a>                    csv_writer.writerow([frame_count, person_idx, keypoint_idx, x.item(), y.item()])</span>
<span id="cb31-611"><a href="#cb31-611" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb31-612"><a href="#cb31-612" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Draw keypoint on the frame</span></span>
<span id="cb31-613"><a href="#cb31-613" aria-hidden="true" tabindex="-1"></a>                    cv2.circle(annotated_frame, (<span class="bu">int</span>(x), <span class="bu">int</span>(y)), <span class="dv">5</span>, colourcode, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb31-614"><a href="#cb31-614" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-615"><a href="#cb31-615" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw skeleton</span></span>
<span id="cb31-616"><a href="#cb31-616" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> connection <span class="kw">in</span> skeleton:</span>
<span id="cb31-617"><a href="#cb31-617" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> connection[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="bu">len</span>(person_keypoints) <span class="kw">and</span> connection[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="bu">len</span>(person_keypoints):</span>
<span id="cb31-618"><a href="#cb31-618" aria-hidden="true" tabindex="-1"></a>                        start_point <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">map</span>(<span class="bu">int</span>, person_keypoints[connection[<span class="dv">0</span>]]))</span>
<span id="cb31-619"><a href="#cb31-619" aria-hidden="true" tabindex="-1"></a>                        end_point <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">map</span>(<span class="bu">int</span>, person_keypoints[connection[<span class="dv">1</span>]]))</span>
<span id="cb31-620"><a href="#cb31-620" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">all</span>(start_point) <span class="kw">and</span> <span class="bu">all</span>(end_point):  <span class="co"># Check if both points are valid</span></span>
<span id="cb31-621"><a href="#cb31-621" aria-hidden="true" tabindex="-1"></a>                            cv2.line(annotated_frame, start_point, end_point, (<span class="dv">255</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">2</span>)</span>
<span id="cb31-622"><a href="#cb31-622" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-623"><a href="#cb31-623" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write the frame to the output video</span></span>
<span id="cb31-624"><a href="#cb31-624" aria-hidden="true" tabindex="-1"></a>            out.write(annotated_frame)</span>
<span id="cb31-625"><a href="#cb31-625" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-626"><a href="#cb31-626" aria-hidden="true" tabindex="-1"></a>        frame_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb31-627"><a href="#cb31-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-628"><a href="#cb31-628" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Release everything</span></span>
<span id="cb31-629"><a href="#cb31-629" aria-hidden="true" tabindex="-1"></a>    cap.release()</span>
<span id="cb31-630"><a href="#cb31-630" aria-hidden="true" tabindex="-1"></a>    out.release()</span>
<span id="cb31-631"><a href="#cb31-631" aria-hidden="true" tabindex="-1"></a>    cv2.destroyAllWindows()</span>
<span id="cb31-632"><a href="#cb31-632" aria-hidden="true" tabindex="-1"></a>    csv_file.close()</span>
<span id="cb31-633"><a href="#cb31-633" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Output video saved as </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-634"><a href="#cb31-634" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Keypoints data saved as </span><span class="sc">{</span>csv_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-635"><a href="#cb31-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-636"><a href="#cb31-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-637"><a href="#cb31-637" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-638"><a href="#cb31-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-639"><a href="#cb31-639" aria-hidden="true" tabindex="-1"></a>Here is an example of the output video with annotated keypoints and skeletons. The green points indicate accepted keypoints, while the red points indicate filtered ones. The blue lines connect the keypoints to form a skeleton.</span>
<span id="cb31-640"><a href="#cb31-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-641"><a href="#cb31-641" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb31-642"><a href="#cb31-642" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">video</span><span class="ot"> width</span><span class="op">=</span><span class="st">"600"</span><span class="ot"> height</span><span class="op">=</span><span class="st">"400"</span><span class="ot"> controls</span><span class="dt">&gt;</span></span>
<span id="cb31-643"><a href="#cb31-643" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">source</span><span class="ot"> src</span><span class="op">=</span><span class="st">"./images/videosrerendered/sample.mp4"</span><span class="ot"> type</span><span class="op">=</span><span class="st">"video/mp4"</span><span class="dt">&gt;</span></span>
<span id="cb31-644"><a href="#cb31-644" aria-hidden="true" tabindex="-1"></a>  Your browser does not support the video tag.</span>
<span id="cb31-645"><a href="#cb31-645" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">video</span><span class="dt">&gt;</span></span>
<span id="cb31-646"><a href="#cb31-646" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb31-647"><a href="#cb31-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-648"><a href="#cb31-648" aria-hidden="true" tabindex="-1"></a>Here is an example of the output csv file containing the coordinates of the keypoints. The CSV file contains the following columns: frame number, person ID, keypoint ID, x-coordinate, and y-coordinate. Each row corresponds to a detected keypoint in a specific frame.</span>
<span id="cb31-649"><a href="#cb31-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-650"><a href="#cb31-650" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-651"><a href="#cb31-651" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example output and code example for YOLO tracking: üìä</span></span>
<span id="cb31-652"><a href="#cb31-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-653"><a href="#cb31-653" aria-hidden="true" tabindex="-1"></a><span class="in">```{python examplecsvfile}</span></span>
<span id="cb31-654"><a href="#cb31-654" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-655"><a href="#cb31-655" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="im">as</span> glob</span>
<span id="cb31-656"><a href="#cb31-656" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-657"><a href="#cb31-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-658"><a href="#cb31-658" aria-hidden="true" tabindex="-1"></a>folderstep1output <span class="op">=</span> <span class="st">"./dataoutput_STEP1_1_rawposedata/"</span></span>
<span id="cb31-659"><a href="#cb31-659" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file</span></span>
<span id="cb31-660"><a href="#cb31-660" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> glob.glob(os.path.join(folderstep1output <span class="op">+</span> <span class="st">"*.csv"</span>))[<span class="dv">0</span>]</span>
<span id="cb31-661"><a href="#cb31-661" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(csv_file)</span>
<span id="cb31-662"><a href="#cb31-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-663"><a href="#cb31-663" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb31-664"><a href="#cb31-664" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span>
<span id="cb31-665"><a href="#cb31-665" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-666"><a href="#cb31-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-667"><a href="#cb31-667" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-668"><a href="#cb31-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-669"><a href="#cb31-669" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1.2: Raw pose data post-processing for timeseries matrices (Python)</span></span>
<span id="cb31-670"><a href="#cb31-670" aria-hidden="true" tabindex="-1"></a>The raw pose data with frame, person, keypoint, and x,y  position data that we end up with is not yet in a format that is easy to work with for our purposes. Additionally, sometimes we dont have a person or two persons detected in the frame. We want to transform these raw pose data to timeseries matrix format, whereby we have time in seconds as one column and different time-varying variables in the other columns. Furthermore, we smooth and interpolate the data if necessary. The below python code executes this second step whereby we store the position data per person, and furthe derive interpersonal distances measures, and kinematic metrics (e.g. speed) and tracking quality indicators (e.g. tracking status that says something about where it concerns interpolated data).</span>
<span id="cb31-671"><a href="#cb31-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-672"><a href="#cb31-672" aria-hidden="true" tabindex="-1"></a>Next to determining time in seconds from the frame rate of the videos, the script starts with assigning left and right person IDs based on the horizontal position in the frame (with left being ID 1 and right being ID 2). It then processes the time data to calculate statistics for tracked people using upper body keypoints (as the lower body keypoints are unreliable from top-view and may be ignored). Specifically, we reduce the dimensionality of all upper body keypoints by determined relative positions and their distances: We calculate a bounding box (determined by the outer edges of the keypoints) and determine the center in x and y coordinates (<span class="in">`centroid_x`</span>, <span class="in">`centroid_y`</span>) and their P1-P2 distance of those centroids (<span class="in">`distance`</span>), and the center of mass (<span class="in">`com_x`</span>, <span class="in">`com_y`</span>) for each person and the distnace (<span class="in">`distance_com`</span>). Further we determine the midpoint of the shoulders as another relevant position (<span class="in">`shoulder_midpoint_x`</span>, <span class="in">`shoulder_midpoint_y`</span>) and compute its distance (<span class="in">`distance_shoulder_midpoint`</span>). Additionally, information about body parts such as arm motions by taking the wrist positions (<span class="in">`wrist_left_x`</span>, <span class="in">`wrist_left_y`</span>, <span class="in">`wrist_right_x`</span>, <span class="in">`wrist_right_y`</span>), and further deriving total motion per second, called speed (based on a euclidean sum of the changes of position along x and y). </span>
<span id="cb31-673"><a href="#cb31-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-674"><a href="#cb31-674" aria-hidden="true" tabindex="-1"></a>The Savitzky-Golay filter is applied for smoothing jittering position data (using a window size of 11 frames, polynomial order of 3). The script handles missing data through two complementary techniques: linear interpolation for brief gaps in tracking (up to 5 frames) and we take the last known location for longer gaps (up to 20 frames). The script also calculates the speed of the center of mass and wrist positions, and here we also smooth the values using the Savitzky-Golay filter to reduce noise that is amplified during differientation (see @winterBiomechanicsMotorControl2009).</span>
<span id="cb31-675"><a href="#cb31-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-676"><a href="#cb31-676" aria-hidden="true" tabindex="-1"></a>The more sophisticated measure that we have created is the proximity calculation measure (see function <span class="in">`calculate_approach()`</span> in the step2 script). This function establishes initial reference position for both participants and then projects their subsequent movements onto the connecting line between them. This allows for quantifying approach and retreat behaviors for each person seperately (which a distance measure does not allow for) while allowing for relative angle changes between them - positive values indicate movement toward the other person (relative from start), while negative values indicate withdrawal (relative from start).</span>
<span id="cb31-677"><a href="#cb31-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-678"><a href="#cb31-678" aria-hidden="true" tabindex="-1"></a>Below is an animation to exemplify what we are measuring. We are here capturing only movements that are changing the distance between them. When someone moves in a circle around the other person we want to make sure we do not register that as approach or retreat (which we would do if we just capture horizontal position for example). However we also want capture each person their own approach/avoidance value (which would not be possible when using a simple distance measure). By always measuring the signed length of the projected line from the initial position (based on the current connected line), the method tracks cumulative approach/avoidance for each person over time. </span>
<span id="cb31-679"><a href="#cb31-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-680"><a href="#cb31-680" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-681"><a href="#cb31-681" aria-hidden="true" tabindex="-1"></a><span class="fu">## Code for creating animation to exemplify behavior of proximity measure üè¥</span></span>
<span id="cb31-682"><a href="#cb31-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-683"><a href="#cb31-683" aria-hidden="true" tabindex="-1"></a><span class="in">```{python,}</span></span>
<span id="cb31-684"><a href="#cb31-684" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-685"><a href="#cb31-685" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb31-686"><a href="#cb31-686" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.animation <span class="im">import</span> FuncAnimation</span>
<span id="cb31-687"><a href="#cb31-687" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> patches</span>
<span id="cb31-688"><a href="#cb31-688" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.lines <span class="im">as</span> mlines</span>
<span id="cb31-689"><a href="#cb31-689" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-690"><a href="#cb31-690" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb31-691"><a href="#cb31-691" aria-hidden="true" tabindex="-1"></a><span class="co"># Force matplotlib to use Agg backend to avoid display issues</span></span>
<span id="cb31-692"><a href="#cb31-692" aria-hidden="true" tabindex="-1"></a>matplotlib.use(<span class="st">'Agg'</span>)</span>
<span id="cb31-693"><a href="#cb31-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-694"><a href="#cb31-694" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb31-695"><a href="#cb31-695" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">"images/proximity_visualization"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-696"><a href="#cb31-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-697"><a href="#cb31-697" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation parameters</span></span>
<span id="cb31-698"><a href="#cb31-698" aria-hidden="true" tabindex="-1"></a>num_frames <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb31-699"><a href="#cb31-699" aria-hidden="true" tabindex="-1"></a>p1_color <span class="op">=</span> <span class="st">'#3498db'</span>  <span class="co"># Blue</span></span>
<span id="cb31-700"><a href="#cb31-700" aria-hidden="true" tabindex="-1"></a>p2_color <span class="op">=</span> <span class="st">'#e74c3c'</span>  <span class="co"># Red</span></span>
<span id="cb31-701"><a href="#cb31-701" aria-hidden="true" tabindex="-1"></a>vector_color <span class="op">=</span> <span class="st">'#2ecc71'</span>  <span class="co"># Green</span></span>
<span id="cb31-702"><a href="#cb31-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-703"><a href="#cb31-703" aria-hidden="true" tabindex="-1"></a><span class="co"># Create initial positions for two people - now on a horizontal line</span></span>
<span id="cb31-704"><a href="#cb31-704" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 1 on the left, Person 2 on the right (same y-coordinate)</span></span>
<span id="cb31-705"><a href="#cb31-705" aria-hidden="true" tabindex="-1"></a>p1_initial <span class="op">=</span> np.array([<span class="dv">3</span>, <span class="dv">5</span>])</span>
<span id="cb31-706"><a href="#cb31-706" aria-hidden="true" tabindex="-1"></a>p2_initial <span class="op">=</span> np.array([<span class="dv">7</span>, <span class="dv">5</span>])</span>
<span id="cb31-707"><a href="#cb31-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-708"><a href="#cb31-708" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate movement paths with MORE EXTREME approach and avoidance</span></span>
<span id="cb31-709"><a href="#cb31-709" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 1 will make a dramatic approach followed by retreat</span></span>
<span id="cb31-710"><a href="#cb31-710" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 2 will make a clear retreat followed by approach</span></span>
<span id="cb31-711"><a href="#cb31-711" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>np.pi, num_frames)</span>
<span id="cb31-712"><a href="#cb31-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-713"><a href="#cb31-713" aria-hidden="true" tabindex="-1"></a><span class="co"># Create more dramatic movement path for Person 1</span></span>
<span id="cb31-714"><a href="#cb31-714" aria-hidden="true" tabindex="-1"></a><span class="co"># Increase the amplitude of movement to make it more extreme</span></span>
<span id="cb31-715"><a href="#cb31-715" aria-hidden="true" tabindex="-1"></a>p1_path_x <span class="op">=</span> p1_initial[<span class="dv">0</span>] <span class="op">+</span> <span class="fl">2.5</span> <span class="op">*</span> np.sin(t<span class="op">/</span><span class="dv">2</span>)  <span class="co"># Larger horizontal movement (was 1.5)</span></span>
<span id="cb31-716"><a href="#cb31-716" aria-hidden="true" tabindex="-1"></a>p1_path_y <span class="op">=</span> p1_initial[<span class="dv">1</span>] <span class="op">+</span> <span class="fl">2.5</span> <span class="op">*</span> np.sin(t)   <span class="co"># Larger vertical movement (was 2.0)</span></span>
<span id="cb31-717"><a href="#cb31-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-718"><a href="#cb31-718" aria-hidden="true" tabindex="-1"></a><span class="co"># Create more dramatic movement path for Person 2</span></span>
<span id="cb31-719"><a href="#cb31-719" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the retreat phase more obvious</span></span>
<span id="cb31-720"><a href="#cb31-720" aria-hidden="true" tabindex="-1"></a>p2_path_x <span class="op">=</span> p2_initial[<span class="dv">0</span>] <span class="op">-</span> <span class="fl">1.2</span> <span class="op">*</span> np.sin(t)    <span class="co"># More horizontal movement (was 0.5)</span></span>
<span id="cb31-721"><a href="#cb31-721" aria-hidden="true" tabindex="-1"></a>p2_path_y <span class="op">=</span> p2_initial[<span class="dv">1</span>] <span class="op">-</span> <span class="fl">2.0</span> <span class="op">*</span> np.sin(t<span class="op">*</span><span class="fl">1.5</span>)  <span class="co"># More vertical movement (was 1.0)</span></span>
<span id="cb31-722"><a href="#cb31-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-723"><a href="#cb31-723" aria-hidden="true" tabindex="-1"></a><span class="co"># Store positions for each frame</span></span>
<span id="cb31-724"><a href="#cb31-724" aria-hidden="true" tabindex="-1"></a>p1_positions <span class="op">=</span> np.column_stack((p1_path_x, p1_path_y))</span>
<span id="cb31-725"><a href="#cb31-725" aria-hidden="true" tabindex="-1"></a>p2_positions <span class="op">=</span> np.column_stack((p2_path_x, p2_path_y))</span>
<span id="cb31-726"><a href="#cb31-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-727"><a href="#cb31-727" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrays to store approach values</span></span>
<span id="cb31-728"><a href="#cb31-728" aria-hidden="true" tabindex="-1"></a>p1_approach_values <span class="op">=</span> np.zeros(num_frames)</span>
<span id="cb31-729"><a href="#cb31-729" aria-hidden="true" tabindex="-1"></a>p2_approach_values <span class="op">=</span> np.zeros(num_frames)</span>
<span id="cb31-730"><a href="#cb31-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-731"><a href="#cb31-731" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate proximity approach values</span></span>
<span id="cb31-732"><a href="#cb31-732" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_approach(positions1, positions2):</span>
<span id="cb31-733"><a href="#cb31-733" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate approach values similar to the script's approach"""</span></span>
<span id="cb31-734"><a href="#cb31-734" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use first frame as reference</span></span>
<span id="cb31-735"><a href="#cb31-735" aria-hidden="true" tabindex="-1"></a>    reference_p1_pos <span class="op">=</span> positions1[<span class="dv">0</span>].copy()</span>
<span id="cb31-736"><a href="#cb31-736" aria-hidden="true" tabindex="-1"></a>    reference_p2_pos <span class="op">=</span> positions2[<span class="dv">0</span>].copy()</span>
<span id="cb31-737"><a href="#cb31-737" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-738"><a href="#cb31-738" aria-hidden="true" tabindex="-1"></a>    p1_approach <span class="op">=</span> np.zeros(<span class="bu">len</span>(positions1))</span>
<span id="cb31-739"><a href="#cb31-739" aria-hidden="true" tabindex="-1"></a>    p2_approach <span class="op">=</span> np.zeros(<span class="bu">len</span>(positions2))</span>
<span id="cb31-740"><a href="#cb31-740" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-741"><a href="#cb31-741" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(positions1)):</span>
<span id="cb31-742"><a href="#cb31-742" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current positions</span></span>
<span id="cb31-743"><a href="#cb31-743" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> positions1[i]</span>
<span id="cb31-744"><a href="#cb31-744" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> positions2[i]</span>
<span id="cb31-745"><a href="#cb31-745" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-746"><a href="#cb31-746" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current connecting vector and direction</span></span>
<span id="cb31-747"><a href="#cb31-747" aria-hidden="true" tabindex="-1"></a>        current_connect <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb31-748"><a href="#cb31-748" aria-hidden="true" tabindex="-1"></a>        current_distance <span class="op">=</span> np.linalg.norm(current_connect)</span>
<span id="cb31-749"><a href="#cb31-749" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-750"><a href="#cb31-750" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_distance <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-751"><a href="#cb31-751" aria-hidden="true" tabindex="-1"></a>            current_direction <span class="op">=</span> current_connect <span class="op">/</span> current_distance</span>
<span id="cb31-752"><a href="#cb31-752" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-753"><a href="#cb31-753" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Vectors from reference positions</span></span>
<span id="cb31-754"><a href="#cb31-754" aria-hidden="true" tabindex="-1"></a>            p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> reference_p1_pos</span>
<span id="cb31-755"><a href="#cb31-755" aria-hidden="true" tabindex="-1"></a>            p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> reference_p2_pos</span>
<span id="cb31-756"><a href="#cb31-756" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-757"><a href="#cb31-757" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Project onto connecting line</span></span>
<span id="cb31-758"><a href="#cb31-758" aria-hidden="true" tabindex="-1"></a>            p1_approach[i] <span class="op">=</span> np.dot(p1_vector, current_direction)</span>
<span id="cb31-759"><a href="#cb31-759" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-760"><a href="#cb31-760" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P2, a positive value should mean movement toward P1</span></span>
<span id="cb31-761"><a href="#cb31-761" aria-hidden="true" tabindex="-1"></a>            <span class="co"># So we use the negative connecting direction (from P2 to P1)</span></span>
<span id="cb31-762"><a href="#cb31-762" aria-hidden="true" tabindex="-1"></a>            <span class="co"># And a positive dot product means approaching</span></span>
<span id="cb31-763"><a href="#cb31-763" aria-hidden="true" tabindex="-1"></a>            p2_direction <span class="op">=</span> <span class="op">-</span>current_direction  <span class="co"># Direction from P2 to P1</span></span>
<span id="cb31-764"><a href="#cb31-764" aria-hidden="true" tabindex="-1"></a>            p2_approach[i] <span class="op">=</span> np.dot(p2_vector, p2_direction)</span>
<span id="cb31-765"><a href="#cb31-765" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-766"><a href="#cb31-766" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> p1_approach, p2_approach</span>
<span id="cb31-767"><a href="#cb31-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-768"><a href="#cb31-768" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate approach values</span></span>
<span id="cb31-769"><a href="#cb31-769" aria-hidden="true" tabindex="-1"></a>p1_approach_values, p2_approach_values <span class="op">=</span> calculate_approach(p1_positions, p2_positions)</span>
<span id="cb31-770"><a href="#cb31-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-771"><a href="#cb31-771" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the main visualization</span></span>
<span id="cb31-772"><a href="#cb31-772" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_detailed_animation():</span>
<span id="cb31-773"><a href="#cb31-773" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set up the figure explicitly with DPI</span></span>
<span id="cb31-774"><a href="#cb31-774" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>), dpi<span class="op">=</span><span class="dv">100</span>)  <span class="co"># Larger figure for better visibility</span></span>
<span id="cb31-775"><a href="#cb31-775" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-776"><a href="#cb31-776" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> init():</span>
<span id="cb31-777"><a href="#cb31-777" aria-hidden="true" tabindex="-1"></a>        ax.clear()</span>
<span id="cb31-778"><a href="#cb31-778" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb31-779"><a href="#cb31-779" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb31-780"><a href="#cb31-780" aria-hidden="true" tabindex="-1"></a>        ax.set_aspect(<span class="st">'equal'</span>)</span>
<span id="cb31-781"><a href="#cb31-781" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb31-782"><a href="#cb31-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-783"><a href="#cb31-783" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> animate(i):</span>
<span id="cb31-784"><a href="#cb31-784" aria-hidden="true" tabindex="-1"></a>        ax.clear()</span>
<span id="cb31-785"><a href="#cb31-785" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-786"><a href="#cb31-786" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set up the axes</span></span>
<span id="cb31-787"><a href="#cb31-787" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb31-788"><a href="#cb31-788" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb31-789"><a href="#cb31-789" aria-hidden="true" tabindex="-1"></a>        ax.set_aspect(<span class="st">'equal'</span>)</span>
<span id="cb31-790"><a href="#cb31-790" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">'Proximity Approach Visualization (Extreme Movements)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb31-791"><a href="#cb31-791" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">'X Position'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb31-792"><a href="#cb31-792" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Y Position'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb31-793"><a href="#cb31-793" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-794"><a href="#cb31-794" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get current positions</span></span>
<span id="cb31-795"><a href="#cb31-795" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> p1_positions[i]</span>
<span id="cb31-796"><a href="#cb31-796" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> p2_positions[i]</span>
<span id="cb31-797"><a href="#cb31-797" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-798"><a href="#cb31-798" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the initial connecting vector (reference)</span></span>
<span id="cb31-799"><a href="#cb31-799" aria-hidden="true" tabindex="-1"></a>        ax.plot([p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">0</span>]], </span>
<span id="cb31-800"><a href="#cb31-800" aria-hidden="true" tabindex="-1"></a>                [p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>]], </span>
<span id="cb31-801"><a href="#cb31-801" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb31-802"><a href="#cb31-802" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-803"><a href="#cb31-803" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the current connection vector</span></span>
<span id="cb31-804"><a href="#cb31-804" aria-hidden="true" tabindex="-1"></a>        ax.plot([p1_pos[<span class="dv">0</span>], p2_pos[<span class="dv">0</span>]], [p1_pos[<span class="dv">1</span>], p2_pos[<span class="dv">1</span>]], </span>
<span id="cb31-805"><a href="#cb31-805" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="fl">2.5</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-806"><a href="#cb31-806" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-807"><a href="#cb31-807" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw person markers</span></span>
<span id="cb31-808"><a href="#cb31-808" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p1_pos[<span class="dv">0</span>], p1_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">180</span>, color<span class="op">=</span>p1_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb31-809"><a href="#cb31-809" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p2_pos[<span class="dv">0</span>], p2_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">180</span>, color<span class="op">=</span>p2_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb31-810"><a href="#cb31-810" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-811"><a href="#cb31-811" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw initial positions</span></span>
<span id="cb31-812"><a href="#cb31-812" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span>p1_color, </span>
<span id="cb31-813"><a href="#cb31-813" aria-hidden="true" tabindex="-1"></a>                   alpha<span class="op">=</span><span class="fl">0.5</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-814"><a href="#cb31-814" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span>p2_color, </span>
<span id="cb31-815"><a href="#cb31-815" aria-hidden="true" tabindex="-1"></a>                   alpha<span class="op">=</span><span class="fl">0.5</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-816"><a href="#cb31-816" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-817"><a href="#cb31-817" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw trails (last 15 positions)</span></span>
<span id="cb31-818"><a href="#cb31-818" aria-hidden="true" tabindex="-1"></a>        start_idx <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, i<span class="op">-</span><span class="dv">15</span>)</span>
<span id="cb31-819"><a href="#cb31-819" aria-hidden="true" tabindex="-1"></a>        ax.plot(p1_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">0</span>], p1_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>], </span>
<span id="cb31-820"><a href="#cb31-820" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-'</span>, color<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-821"><a href="#cb31-821" aria-hidden="true" tabindex="-1"></a>        ax.plot(p2_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">0</span>], p2_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>], </span>
<span id="cb31-822"><a href="#cb31-822" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-'</span>, color<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-823"><a href="#cb31-823" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-824"><a href="#cb31-824" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Visualize the approach values with text - make them larger and more visible</span></span>
<span id="cb31-825"><a href="#cb31-825" aria-hidden="true" tabindex="-1"></a>        approach_text <span class="op">=</span> (<span class="ss">f"P1 approach: </span><span class="sc">{</span>p1_approach_values[i]<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb31-826"><a href="#cb31-826" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f"P2 approach: </span><span class="sc">{</span>p2_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb31-827"><a href="#cb31-827" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.05</span>, <span class="fl">0.95</span>, approach_text, transform<span class="op">=</span>ax.transAxes, </span>
<span id="cb31-828"><a href="#cb31-828" aria-hidden="true" tabindex="-1"></a>                verticalalignment<span class="op">=</span><span class="st">'top'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb31-829"><a href="#cb31-829" aria-hidden="true" tabindex="-1"></a>                bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>))</span>
<span id="cb31-830"><a href="#cb31-830" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-831"><a href="#cb31-831" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add projection visualization</span></span>
<span id="cb31-832"><a href="#cb31-832" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-833"><a href="#cb31-833" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get current connecting direction</span></span>
<span id="cb31-834"><a href="#cb31-834" aria-hidden="true" tabindex="-1"></a>            connect_vector <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb31-835"><a href="#cb31-835" aria-hidden="true" tabindex="-1"></a>            connect_distance <span class="op">=</span> np.linalg.norm(connect_vector)</span>
<span id="cb31-836"><a href="#cb31-836" aria-hidden="true" tabindex="-1"></a>            connect_direction <span class="op">=</span> connect_vector <span class="op">/</span> connect_distance</span>
<span id="cb31-837"><a href="#cb31-837" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-838"><a href="#cb31-838" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Person 1 projection</span></span>
<span id="cb31-839"><a href="#cb31-839" aria-hidden="true" tabindex="-1"></a>            p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> p1_positions[<span class="dv">0</span>]</span>
<span id="cb31-840"><a href="#cb31-840" aria-hidden="true" tabindex="-1"></a>            p1_projection <span class="op">=</span> np.dot(p1_vector, connect_direction) <span class="op">*</span> connect_direction</span>
<span id="cb31-841"><a href="#cb31-841" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-842"><a href="#cb31-842" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection line for P1</span></span>
<span id="cb31-843"><a href="#cb31-843" aria-hidden="true" tabindex="-1"></a>            p1_proj_point <span class="op">=</span> p1_positions[<span class="dv">0</span>] <span class="op">+</span> p1_projection</span>
<span id="cb31-844"><a href="#cb31-844" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-845"><a href="#cb31-845" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Person 2 projection - use direction from P2 to P1</span></span>
<span id="cb31-846"><a href="#cb31-846" aria-hidden="true" tabindex="-1"></a>            p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> p2_positions[<span class="dv">0</span>]</span>
<span id="cb31-847"><a href="#cb31-847" aria-hidden="true" tabindex="-1"></a>            p2_direction <span class="op">=</span> <span class="op">-</span>connect_direction  <span class="co"># Direction from P2 to P1</span></span>
<span id="cb31-848"><a href="#cb31-848" aria-hidden="true" tabindex="-1"></a>            p2_projection <span class="op">=</span> np.dot(p2_vector, p2_direction) <span class="op">*</span> p2_direction</span>
<span id="cb31-849"><a href="#cb31-849" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-850"><a href="#cb31-850" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection line for P2</span></span>
<span id="cb31-851"><a href="#cb31-851" aria-hidden="true" tabindex="-1"></a>            p2_proj_point <span class="op">=</span> p2_positions[<span class="dv">0</span>] <span class="op">+</span> p2_projection</span>
<span id="cb31-852"><a href="#cb31-852" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-853"><a href="#cb31-853" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection lines with arrows to show direction</span></span>
<span id="cb31-854"><a href="#cb31-854" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P1</span></span>
<span id="cb31-855"><a href="#cb31-855" aria-hidden="true" tabindex="-1"></a>            p1_approach <span class="op">=</span> p1_approach_values[i]</span>
<span id="cb31-856"><a href="#cb31-856" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(p1_approach) <span class="op">&gt;</span> <span class="fl">0.1</span>:  <span class="co"># Only draw if there's a significant approach value</span></span>
<span id="cb31-857"><a href="#cb31-857" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw line with increased width</span></span>
<span id="cb31-858"><a href="#cb31-858" aria-hidden="true" tabindex="-1"></a>                ax.plot([p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_proj_point[<span class="dv">0</span>]], </span>
<span id="cb31-859"><a href="#cb31-859" aria-hidden="true" tabindex="-1"></a>                        [p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], p1_proj_point[<span class="dv">1</span>]], </span>
<span id="cb31-860"><a href="#cb31-860" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'--'</span>, color<span class="op">=</span>p1_color, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb31-861"><a href="#cb31-861" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-862"><a href="#cb31-862" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add arrow to show direction - make arrow larger</span></span>
<span id="cb31-863"><a href="#cb31-863" aria-hidden="true" tabindex="-1"></a>                arrow_length <span class="op">=</span> <span class="bu">min</span>(<span class="bu">abs</span>(p1_approach) <span class="op">*</span> <span class="fl">0.2</span>, <span class="fl">0.6</span>)  <span class="co"># Scale arrow size</span></span>
<span id="cb31-864"><a href="#cb31-864" aria-hidden="true" tabindex="-1"></a>                arrow_width <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb31-865"><a href="#cb31-865" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> p1_approach <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Approaching</span></span>
<span id="cb31-866"><a href="#cb31-866" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position toward projection point</span></span>
<span id="cb31-867"><a href="#cb31-867" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb31-868"><a href="#cb31-868" aria-hidden="true" tabindex="-1"></a>                            arrow_length <span class="op">*</span> connect_direction[<span class="dv">0</span>], arrow_length <span class="op">*</span> connect_direction[<span class="dv">1</span>],</span>
<span id="cb31-869"><a href="#cb31-869" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb31-870"><a href="#cb31-870" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p1_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb31-871"><a href="#cb31-871" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:  <span class="co"># Retreating</span></span>
<span id="cb31-872"><a href="#cb31-872" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position away from projection point</span></span>
<span id="cb31-873"><a href="#cb31-873" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb31-874"><a href="#cb31-874" aria-hidden="true" tabindex="-1"></a>                            <span class="op">-</span>arrow_length <span class="op">*</span> connect_direction[<span class="dv">0</span>], <span class="op">-</span>arrow_length <span class="op">*</span> connect_direction[<span class="dv">1</span>],</span>
<span id="cb31-875"><a href="#cb31-875" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb31-876"><a href="#cb31-876" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p1_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb31-877"><a href="#cb31-877" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-878"><a href="#cb31-878" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add value label near the projection line</span></span>
<span id="cb31-879"><a href="#cb31-879" aria-hidden="true" tabindex="-1"></a>                mid_x <span class="op">=</span> (p1_positions[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> p1_proj_point[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb31-880"><a href="#cb31-880" aria-hidden="true" tabindex="-1"></a>                mid_y <span class="op">=</span> (p1_positions[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> p1_proj_point[<span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb31-881"><a href="#cb31-881" aria-hidden="true" tabindex="-1"></a>                ax.text(mid_x, mid_y, <span class="ss">f"</span><span class="sc">{</span>p1_approach<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb31-882"><a href="#cb31-882" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>p1_color, fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb31-883"><a href="#cb31-883" aria-hidden="true" tabindex="-1"></a>                        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, boxstyle<span class="op">=</span><span class="st">'round,pad=0.2'</span>))</span>
<span id="cb31-884"><a href="#cb31-884" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-885"><a href="#cb31-885" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P2</span></span>
<span id="cb31-886"><a href="#cb31-886" aria-hidden="true" tabindex="-1"></a>            p2_approach <span class="op">=</span> p2_approach_values[i]</span>
<span id="cb31-887"><a href="#cb31-887" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(p2_approach) <span class="op">&gt;</span> <span class="fl">0.1</span>:  <span class="co"># Only draw if there's a significant approach value</span></span>
<span id="cb31-888"><a href="#cb31-888" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw line with increased width</span></span>
<span id="cb31-889"><a href="#cb31-889" aria-hidden="true" tabindex="-1"></a>                ax.plot([p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_proj_point[<span class="dv">0</span>]], </span>
<span id="cb31-890"><a href="#cb31-890" aria-hidden="true" tabindex="-1"></a>                        [p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], p2_proj_point[<span class="dv">1</span>]], </span>
<span id="cb31-891"><a href="#cb31-891" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'--'</span>, color<span class="op">=</span>p2_color, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb31-892"><a href="#cb31-892" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-893"><a href="#cb31-893" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add arrow to show direction - make arrow larger</span></span>
<span id="cb31-894"><a href="#cb31-894" aria-hidden="true" tabindex="-1"></a>                arrow_length <span class="op">=</span> <span class="bu">min</span>(<span class="bu">abs</span>(p2_approach) <span class="op">*</span> <span class="fl">0.2</span>, <span class="fl">0.6</span>)  <span class="co"># Scale arrow size</span></span>
<span id="cb31-895"><a href="#cb31-895" aria-hidden="true" tabindex="-1"></a>                arrow_width <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb31-896"><a href="#cb31-896" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> p2_approach <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Approaching</span></span>
<span id="cb31-897"><a href="#cb31-897" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position toward P1</span></span>
<span id="cb31-898"><a href="#cb31-898" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb31-899"><a href="#cb31-899" aria-hidden="true" tabindex="-1"></a>                            arrow_length <span class="op">*</span> p2_direction[<span class="dv">0</span>], arrow_length <span class="op">*</span> p2_direction[<span class="dv">1</span>],</span>
<span id="cb31-900"><a href="#cb31-900" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb31-901"><a href="#cb31-901" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p2_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb31-902"><a href="#cb31-902" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:  <span class="co"># Retreating</span></span>
<span id="cb31-903"><a href="#cb31-903" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position away from P1</span></span>
<span id="cb31-904"><a href="#cb31-904" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb31-905"><a href="#cb31-905" aria-hidden="true" tabindex="-1"></a>                            <span class="op">-</span>arrow_length <span class="op">*</span> p2_direction[<span class="dv">0</span>], <span class="op">-</span>arrow_length <span class="op">*</span> p2_direction[<span class="dv">1</span>],</span>
<span id="cb31-906"><a href="#cb31-906" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb31-907"><a href="#cb31-907" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p2_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb31-908"><a href="#cb31-908" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-909"><a href="#cb31-909" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add value label near the projection line</span></span>
<span id="cb31-910"><a href="#cb31-910" aria-hidden="true" tabindex="-1"></a>                mid_x <span class="op">=</span> (p2_positions[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> p2_proj_point[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb31-911"><a href="#cb31-911" aria-hidden="true" tabindex="-1"></a>                mid_y <span class="op">=</span> (p2_positions[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> p2_proj_point[<span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb31-912"><a href="#cb31-912" aria-hidden="true" tabindex="-1"></a>                ax.text(mid_x, mid_y, <span class="ss">f"</span><span class="sc">{</span>p2_approach<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb31-913"><a href="#cb31-913" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>p2_color, fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb31-914"><a href="#cb31-914" aria-hidden="true" tabindex="-1"></a>                        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, boxstyle<span class="op">=</span><span class="st">'round,pad=0.2'</span>))</span>
<span id="cb31-915"><a href="#cb31-915" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-916"><a href="#cb31-916" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add small markers at projection points</span></span>
<span id="cb31-917"><a href="#cb31-917" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_proj_point[<span class="dv">0</span>], p1_proj_point[<span class="dv">1</span>], </span>
<span id="cb31-918"><a href="#cb31-918" aria-hidden="true" tabindex="-1"></a>                      color<span class="op">=</span>p1_color, s<span class="op">=</span><span class="dv">70</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb31-919"><a href="#cb31-919" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_proj_point[<span class="dv">0</span>], p2_proj_point[<span class="dv">1</span>], </span>
<span id="cb31-920"><a href="#cb31-920" aria-hidden="true" tabindex="-1"></a>                      color<span class="op">=</span>p2_color, s<span class="op">=</span><span class="dv">70</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb31-921"><a href="#cb31-921" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-922"><a href="#cb31-922" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw horizontal dotted line at initial y-coordinate to emphasize horizontal start</span></span>
<span id="cb31-923"><a href="#cb31-923" aria-hidden="true" tabindex="-1"></a>            ax.axhline(y<span class="op">=</span>p1_initial[<span class="dv">1</span>], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb31-924"><a href="#cb31-924" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-925"><a href="#cb31-925" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add legend</span></span>
<span id="cb31-926"><a href="#cb31-926" aria-hidden="true" tabindex="-1"></a>        legend_elements <span class="op">=</span> [</span>
<span id="cb31-927"><a href="#cb31-927" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>p1_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Person 1'</span>),</span>
<span id="cb31-928"><a href="#cb31-928" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>p2_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Person 2'</span>),</span>
<span id="cb31-929"><a href="#cb31-929" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>vector_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Connection Vector'</span>),</span>
<span id="cb31-930"><a href="#cb31-930" aria-hidden="true" tabindex="-1"></a>            mlines.Line2D([], [], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, label<span class="op">=</span><span class="st">'Initial Horizontal Line'</span>),</span>
<span id="cb31-931"><a href="#cb31-931" aria-hidden="true" tabindex="-1"></a>            mlines.Line2D([], [], color<span class="op">=</span>p1_color, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Projection Length = Approach Value'</span>)</span>
<span id="cb31-932"><a href="#cb31-932" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb31-933"><a href="#cb31-933" aria-hidden="true" tabindex="-1"></a>        ax.legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb31-934"><a href="#cb31-934" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-935"><a href="#cb31-935" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add a frame counter</span></span>
<span id="cb31-936"><a href="#cb31-936" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.95</span>, <span class="fl">0.05</span>, <span class="ss">f"Frame: </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>num_frames<span class="op">-</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>, transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb31-937"><a href="#cb31-937" aria-hidden="true" tabindex="-1"></a>               horizontalalignment<span class="op">=</span><span class="st">'right'</span>, verticalalignment<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb31-938"><a href="#cb31-938" aria-hidden="true" tabindex="-1"></a>               bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb31-939"><a href="#cb31-939" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-940"><a href="#cb31-940" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add description text</span></span>
<span id="cb31-941"><a href="#cb31-941" aria-hidden="true" tabindex="-1"></a>        description <span class="op">=</span> (</span>
<span id="cb31-942"><a href="#cb31-942" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Proximity Calculation Visualization</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb31-943"><a href="#cb31-943" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Large dots: Current positions</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb31-944"><a href="#cb31-944" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Small dots: Initial positions (horizontal alignment)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb31-945"><a href="#cb31-945" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Green line: Current connecting vector</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb31-946"><a href="#cb31-946" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Dashed lines: Projection of movement (length = approach value)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb31-947"><a href="#cb31-947" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Arrows: Direction of approach/retreat</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb31-948"><a href="#cb31-948" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Positive values: Movement toward other person</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb31-949"><a href="#cb31-949" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Negative values: Movement away from other person</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb31-950"><a href="#cb31-950" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- X markers: Projected positions"</span></span>
<span id="cb31-951"><a href="#cb31-951" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-952"><a href="#cb31-952" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.05</span>, <span class="fl">0.05</span>, description, transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb31-953"><a href="#cb31-953" aria-hidden="true" tabindex="-1"></a>               verticalalignment<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb31-954"><a href="#cb31-954" aria-hidden="true" tabindex="-1"></a>               bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>))</span>
<span id="cb31-955"><a href="#cb31-955" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-956"><a href="#cb31-956" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb31-957"><a href="#cb31-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-958"><a href="#cb31-958" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the animation with explicit FPS and DPI</span></span>
<span id="cb31-959"><a href="#cb31-959" aria-hidden="true" tabindex="-1"></a>    ani <span class="op">=</span> FuncAnimation(fig, animate, frames<span class="op">=</span>num_frames, init_func<span class="op">=</span>init, </span>
<span id="cb31-960"><a href="#cb31-960" aria-hidden="true" tabindex="-1"></a>                        blit<span class="op">=</span><span class="va">True</span>, interval<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb31-961"><a href="#cb31-961" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-962"><a href="#cb31-962" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the animation as a GIF with explicit DPI</span></span>
<span id="cb31-963"><a href="#cb31-963" aria-hidden="true" tabindex="-1"></a>    ani.save(<span class="st">'images/proximity_visualization/proximity_calculation_extreme.gif'</span>, writer<span class="op">=</span><span class="st">'pillow'</span>, fps<span class="op">=</span><span class="dv">10</span>, dpi<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb31-964"><a href="#cb31-964" aria-hidden="true" tabindex="-1"></a>    plt.close(fig)</span>
<span id="cb31-965"><a href="#cb31-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-966"><a href="#cb31-966" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the animation</span></span>
<span id="cb31-967"><a href="#cb31-967" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb31-968"><a href="#cb31-968" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Creating animation..."</span>)</span>
<span id="cb31-969"><a href="#cb31-969" aria-hidden="true" tabindex="-1"></a>    create_detailed_animation()</span>
<span id="cb31-970"><a href="#cb31-970" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GIF created successfully in the 'images/proximity_visualization' folder."</span>)</span>
<span id="cb31-971"><a href="#cb31-971" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb31-972"><a href="#cb31-972" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error creating animation: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-973"><a href="#cb31-973" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-974"><a href="#cb31-974" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alternative approach if the above fails - create static frames</span></span>
<span id="cb31-975"><a href="#cb31-975" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Trying alternative approach with static frames..."</span>)</span>
<span id="cb31-976"><a href="#cb31-976" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb31-977"><a href="#cb31-977" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a static image sequence instead</span></span>
<span id="cb31-978"><a href="#cb31-978" aria-hidden="true" tabindex="-1"></a>        os.makedirs(<span class="st">"images/proximity_visualization/frames"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-979"><a href="#cb31-979" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-980"><a href="#cb31-980" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create 10 static frames instead of full animation</span></span>
<span id="cb31-981"><a href="#cb31-981" aria-hidden="true" tabindex="-1"></a>        sample_frames <span class="op">=</span> np.linspace(<span class="dv">0</span>, num_frames<span class="op">-</span><span class="dv">1</span>, <span class="dv">10</span>, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb31-982"><a href="#cb31-982" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-983"><a href="#cb31-983" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, i <span class="kw">in</span> <span class="bu">enumerate</span>(sample_frames):</span>
<span id="cb31-984"><a href="#cb31-984" aria-hidden="true" tabindex="-1"></a>            fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), dpi<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb31-985"><a href="#cb31-985" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-986"><a href="#cb31-986" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Set up the axes</span></span>
<span id="cb31-987"><a href="#cb31-987" aria-hidden="true" tabindex="-1"></a>            ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb31-988"><a href="#cb31-988" aria-hidden="true" tabindex="-1"></a>            ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb31-989"><a href="#cb31-989" aria-hidden="true" tabindex="-1"></a>            ax.set_title(<span class="ss">f'Proximity Calculation (Frame </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb31-990"><a href="#cb31-990" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-991"><a href="#cb31-991" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get current positions</span></span>
<span id="cb31-992"><a href="#cb31-992" aria-hidden="true" tabindex="-1"></a>            p1_pos <span class="op">=</span> p1_positions[i]</span>
<span id="cb31-993"><a href="#cb31-993" aria-hidden="true" tabindex="-1"></a>            p2_pos <span class="op">=</span> p2_positions[i]</span>
<span id="cb31-994"><a href="#cb31-994" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-995"><a href="#cb31-995" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw the connection vector</span></span>
<span id="cb31-996"><a href="#cb31-996" aria-hidden="true" tabindex="-1"></a>            ax.plot([p1_pos[<span class="dv">0</span>], p2_pos[<span class="dv">0</span>]], [p1_pos[<span class="dv">1</span>], p2_pos[<span class="dv">1</span>]], </span>
<span id="cb31-997"><a href="#cb31-997" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-998"><a href="#cb31-998" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-999"><a href="#cb31-999" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw person markers</span></span>
<span id="cb31-1000"><a href="#cb31-1000" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_pos[<span class="dv">0</span>], p1_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">150</span>, color<span class="op">=</span>p1_color, label<span class="op">=</span><span class="st">'Person 1'</span>)</span>
<span id="cb31-1001"><a href="#cb31-1001" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_pos[<span class="dv">0</span>], p2_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">150</span>, color<span class="op">=</span>p2_color, label<span class="op">=</span><span class="st">'Person 2'</span>)</span>
<span id="cb31-1002"><a href="#cb31-1002" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1003"><a href="#cb31-1003" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw initial positions</span></span>
<span id="cb31-1004"><a href="#cb31-1004" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb31-1005"><a href="#cb31-1005" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb31-1006"><a href="#cb31-1006" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1007"><a href="#cb31-1007" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw horizontal dotted line at initial y-coordinate</span></span>
<span id="cb31-1008"><a href="#cb31-1008" aria-hidden="true" tabindex="-1"></a>            ax.axhline(y<span class="op">=</span>p1_initial[<span class="dv">1</span>], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb31-1009"><a href="#cb31-1009" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1010"><a href="#cb31-1010" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Show approach values</span></span>
<span id="cb31-1011"><a href="#cb31-1011" aria-hidden="true" tabindex="-1"></a>            ax.text(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="ss">f"Person 1 approach: </span><span class="sc">{</span>p1_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb31-1012"><a href="#cb31-1012" aria-hidden="true" tabindex="-1"></a>                    transform<span class="op">=</span>ax.transAxes, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb31-1013"><a href="#cb31-1013" aria-hidden="true" tabindex="-1"></a>                    bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.3</span>))</span>
<span id="cb31-1014"><a href="#cb31-1014" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1015"><a href="#cb31-1015" aria-hidden="true" tabindex="-1"></a>            ax.text(<span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="ss">f"Person 2 approach: </span><span class="sc">{</span>p2_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb31-1016"><a href="#cb31-1016" aria-hidden="true" tabindex="-1"></a>                    transform<span class="op">=</span>ax.transAxes, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb31-1017"><a href="#cb31-1017" aria-hidden="true" tabindex="-1"></a>                    bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.3</span>))</span>
<span id="cb31-1018"><a href="#cb31-1018" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1019"><a href="#cb31-1019" aria-hidden="true" tabindex="-1"></a>            ax.legend()</span>
<span id="cb31-1020"><a href="#cb31-1020" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1021"><a href="#cb31-1021" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the frame</span></span>
<span id="cb31-1022"><a href="#cb31-1022" aria-hidden="true" tabindex="-1"></a>            plt.tight_layout()</span>
<span id="cb31-1023"><a href="#cb31-1023" aria-hidden="true" tabindex="-1"></a>            plt.savefig(<span class="ss">f'images/proximity_visualization/frames/frame_</span><span class="sc">{</span>idx<span class="sc">:02d}</span><span class="ss">.png'</span>)</span>
<span id="cb31-1024"><a href="#cb31-1024" aria-hidden="true" tabindex="-1"></a>            plt.close(fig)</span>
<span id="cb31-1025"><a href="#cb31-1025" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1026"><a href="#cb31-1026" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Static frames created successfully in 'images/proximity_visualization/frames' folder."</span>)</span>
<span id="cb31-1027"><a href="#cb31-1027" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb31-1028"><a href="#cb31-1028" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Alternative approach also failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1029"><a href="#cb31-1029" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1030"><a href="#cb31-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1031"><a href="#cb31-1031" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-1032"><a href="#cb31-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1033"><a href="#cb31-1033" aria-hidden="true" tabindex="-1"></a><span class="al">![Proximity Calculation Visualization](./images/proximity_visualization/proximity_calculation.gif)</span></span>
<span id="cb31-1034"><a href="#cb31-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1035"><a href="#cb31-1035" aria-hidden="true" tabindex="-1"></a>We further check for any remaining missing values after processing and confirms time continuity to detect any frame drops or temporal misalignments. </span>
<span id="cb31-1036"><a href="#cb31-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1037"><a href="#cb31-1037" aria-hidden="true" tabindex="-1"></a>The output of this script is a timeseries matrix for each video, which contains the time in seconds and the calculated variables. The timeseries matrices are saved in the <span class="in">`./dataoutput_STEP1_2_timeseries/`</span> folder. The code below is the script <span class="in">`STEP2_process_timeseries.py`</span> that you can run to process the raw pose data.</span>
<span id="cb31-1038"><a href="#cb31-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1039"><a href="#cb31-1039" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-1040"><a href="#cb31-1040" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pipeline code step 1.2 for processing to timeseries data üö©</span></span>
<span id="cb31-1041"><a href="#cb31-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1042"><a href="#cb31-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb31-1043"><a href="#cb31-1043" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-1044"><a href="#cb31-1044" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-1045"><a href="#cb31-1045" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb31-1046"><a href="#cb31-1046" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-1047"><a href="#cb31-1047" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb31-1048"><a href="#cb31-1048" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb31-1049"><a href="#cb31-1049" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bisect <span class="im">import</span> bisect_left</span>
<span id="cb31-1050"><a href="#cb31-1050" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> savgol_filter</span>
<span id="cb31-1051"><a href="#cb31-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1052"><a href="#cb31-1052" aria-hidden="true" tabindex="-1"></a><span class="co"># Path Definitions</span></span>
<span id="cb31-1053"><a href="#cb31-1053" aria-hidden="true" tabindex="-1"></a>INPUT_LAYER1_PATH <span class="op">=</span> <span class="st">'../dataoutput_STEP1_1_rawposedata/'</span>  <span class="co"># Input directory containing tracked keypoint data from STEP1</span></span>
<span id="cb31-1054"><a href="#cb31-1054" aria-hidden="true" tabindex="-1"></a>VIDEO_PATH <span class="op">=</span> <span class="st">"../data_raw/"</span>                        <span class="co"># Raw video files directory</span></span>
<span id="cb31-1055"><a href="#cb31-1055" aria-hidden="true" tabindex="-1"></a>OUTPUT_PATH <span class="op">=</span> <span class="st">'../dataoutput_STEP1_2_timeseries/'</span>     <span class="co"># Output directory for processed timeseries data</span></span>
<span id="cb31-1056"><a href="#cb31-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1057"><a href="#cb31-1057" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable Explanations:</span></span>
<span id="cb31-1058"><a href="#cb31-1058" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb31-1059"><a href="#cb31-1059" aria-hidden="true" tabindex="-1"></a><span class="co"># Positional Variables:</span></span>
<span id="cb31-1060"><a href="#cb31-1060" aria-hidden="true" tabindex="-1"></a><span class="co"># - x, y: 2D coordinates in the image frame</span></span>
<span id="cb31-1061"><a href="#cb31-1061" aria-hidden="true" tabindex="-1"></a><span class="co"># - x_min, x_max, y_min, y_max: Bounding box coordinates for a person</span></span>
<span id="cb31-1062"><a href="#cb31-1062" aria-hidden="true" tabindex="-1"></a><span class="co"># - centroid_x, centroid_y: Center point of a person's bounding box</span></span>
<span id="cb31-1063"><a href="#cb31-1063" aria-hidden="true" tabindex="-1"></a><span class="co"># - com_x, com_y: Center of mass for a person (average of upper body keypoint positions)</span></span>
<span id="cb31-1064"><a href="#cb31-1064" aria-hidden="true" tabindex="-1"></a><span class="co"># - shoulder_midpoint_*: Midpoint between left and right shoulders for each person (p1, p2)</span></span>
<span id="cb31-1065"><a href="#cb31-1065" aria-hidden="true" tabindex="-1"></a><span class="co"># - wrist_left_*, wrist_right_*: Positions of left and right wrists for each person (p1, p2)</span></span>
<span id="cb31-1066"><a href="#cb31-1066" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb31-1067"><a href="#cb31-1067" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance Variables:</span></span>
<span id="cb31-1068"><a href="#cb31-1068" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance: Euclidean distance between the centroids of both people</span></span>
<span id="cb31-1069"><a href="#cb31-1069" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance_com: Euclidean distance between centers of mass of both people</span></span>
<span id="cb31-1070"><a href="#cb31-1070" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance_shoulder_midpoint: Distance between shoulder midpoints of both people</span></span>
<span id="cb31-1071"><a href="#cb31-1071" aria-hidden="true" tabindex="-1"></a><span class="co"># - *_speed: Euclidean speed of different body parts (calculated from position differences)</span></span>
<span id="cb31-1072"><a href="#cb31-1072" aria-hidden="true" tabindex="-1"></a><span class="co"># - *_speed_smooth: Smoothed version of speed using Savitzky-Golay filter</span></span>
<span id="cb31-1073"><a href="#cb31-1073" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb31-1074"><a href="#cb31-1074" aria-hidden="true" tabindex="-1"></a><span class="co"># Movement Analysis:</span></span>
<span id="cb31-1075"><a href="#cb31-1075" aria-hidden="true" tabindex="-1"></a><span class="co"># - p1_com_approach_pos, p2_com_approach_pos: Position of each person's COM relative to their</span></span>
<span id="cb31-1076"><a href="#cb31-1076" aria-hidden="true" tabindex="-1"></a><span class="co">#   initial position, projected onto the connecting line between people. Positive values </span></span>
<span id="cb31-1077"><a href="#cb31-1077" aria-hidden="true" tabindex="-1"></a><span class="co">#   indicate movement toward the other person.</span></span>
<span id="cb31-1078"><a href="#cb31-1078" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb31-1079"><a href="#cb31-1079" aria-hidden="true" tabindex="-1"></a><span class="co"># Tracking Status:</span></span>
<span id="cb31-1080"><a href="#cb31-1080" aria-hidden="true" tabindex="-1"></a><span class="co"># - both_tracked: Boolean indicating if both people are tracked in the current frame</span></span>
<span id="cb31-1081"><a href="#cb31-1081" aria-hidden="true" tabindex="-1"></a><span class="co"># - single_tracked: Boolean indicating if only one person is tracked in the current frame</span></span>
<span id="cb31-1082"><a href="#cb31-1082" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb31-1083"><a href="#cb31-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1084"><a href="#cb31-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1085"><a href="#cb31-1085" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> frame_to_time(ts, fps):</span>
<span id="cb31-1086"><a href="#cb31-1086" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert frame numbers to time in seconds"""</span></span>
<span id="cb31-1087"><a href="#cb31-1087" aria-hidden="true" tabindex="-1"></a>    ts[<span class="st">"time"</span>] <span class="op">=</span> [row[<span class="dv">1</span>][<span class="st">"frame"</span>] <span class="op">/</span> fps <span class="cf">for</span> row <span class="kw">in</span> ts.iterrows()]</span>
<span id="cb31-1088"><a href="#cb31-1088" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts</span>
<span id="cb31-1089"><a href="#cb31-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1090"><a href="#cb31-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1091"><a href="#cb31-1091" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> take_closest(myList, myNumber):</span>
<span id="cb31-1092"><a href="#cb31-1092" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-1093"><a href="#cb31-1093" aria-hidden="true" tabindex="-1"></a><span class="co">    Assumes myList is sorted. Returns closest value to myNumber.</span></span>
<span id="cb31-1094"><a href="#cb31-1094" aria-hidden="true" tabindex="-1"></a><span class="co">    If two numbers are equally close, return the smallest number.</span></span>
<span id="cb31-1095"><a href="#cb31-1095" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-1096"><a href="#cb31-1096" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">=</span> bisect_left(myList, myNumber)</span>
<span id="cb31-1097"><a href="#cb31-1097" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb31-1098"><a href="#cb31-1098" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> myList[<span class="dv">0</span>]</span>
<span id="cb31-1099"><a href="#cb31-1099" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">==</span> <span class="bu">len</span>(myList):</span>
<span id="cb31-1100"><a href="#cb31-1100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> myList[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb31-1101"><a href="#cb31-1101" aria-hidden="true" tabindex="-1"></a>    before <span class="op">=</span> myList[pos <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb31-1102"><a href="#cb31-1102" aria-hidden="true" tabindex="-1"></a>    after <span class="op">=</span> myList[pos]</span>
<span id="cb31-1103"><a href="#cb31-1103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> after <span class="op">-</span> myNumber <span class="op">&lt;</span> myNumber <span class="op">-</span> before:</span>
<span id="cb31-1104"><a href="#cb31-1104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> after</span>
<span id="cb31-1105"><a href="#cb31-1105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb31-1106"><a href="#cb31-1106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> before</span>
<span id="cb31-1107"><a href="#cb31-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1108"><a href="#cb31-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1109"><a href="#cb31-1109" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_left_right(ts):</span>
<span id="cb31-1110"><a href="#cb31-1110" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Assign person IDs (0 or 1) based on x-position in the frame"""</span></span>
<span id="cb31-1111"><a href="#cb31-1111" aria-hidden="true" tabindex="-1"></a>    min_x <span class="op">=</span> np.<span class="bu">min</span>([val <span class="cf">for</span> val <span class="kw">in</span> ts[<span class="st">'x'</span>] <span class="cf">if</span> val <span class="op">!=</span> <span class="dv">0</span>])</span>
<span id="cb31-1112"><a href="#cb31-1112" aria-hidden="true" tabindex="-1"></a>    max_x <span class="op">=</span> np.<span class="bu">max</span>([val <span class="cf">for</span> val <span class="kw">in</span> ts[<span class="st">'x'</span>] <span class="cf">if</span> val <span class="op">!=</span> <span class="dv">0</span>])</span>
<span id="cb31-1113"><a href="#cb31-1113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> ts.iterrows():</span>
<span id="cb31-1114"><a href="#cb31-1114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'x'</span>] <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># Skip untracked points</span></span>
<span id="cb31-1115"><a href="#cb31-1115" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb31-1116"><a href="#cb31-1116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> take_closest([min_x, max_x], row[<span class="st">'x'</span>]) <span class="op">==</span> min_x:</span>
<span id="cb31-1117"><a href="#cb31-1117" aria-hidden="true" tabindex="-1"></a>            ts.loc[index, <span class="st">'person'</span>] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Left person</span></span>
<span id="cb31-1118"><a href="#cb31-1118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-1119"><a href="#cb31-1119" aria-hidden="true" tabindex="-1"></a>            ts.loc[index, <span class="st">'person'</span>] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Right person</span></span>
<span id="cb31-1120"><a href="#cb31-1120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts</span>
<span id="cb31-1121"><a href="#cb31-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1122"><a href="#cb31-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1123"><a href="#cb31-1123" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_time_data(ts):</span>
<span id="cb31-1124"><a href="#cb31-1124" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate statistics for tracked people using upper body keypoints"""</span></span>
<span id="cb31-1125"><a href="#cb31-1125" aria-hidden="true" tabindex="-1"></a>    ts_upper <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>] <span class="op">&lt;</span> <span class="dv">11</span>]  <span class="co"># Filter to upper body keypoints only</span></span>
<span id="cb31-1126"><a href="#cb31-1126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1127"><a href="#cb31-1127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate stats per person and time</span></span>
<span id="cb31-1128"><a href="#cb31-1128" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> ts_upper.groupby([<span class="st">'time'</span>, <span class="st">'person'</span>]).agg({</span>
<span id="cb31-1129"><a href="#cb31-1129" aria-hidden="true" tabindex="-1"></a>        <span class="st">'x'</span>: [<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>],</span>
<span id="cb31-1130"><a href="#cb31-1130" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y'</span>: [<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>]</span>
<span id="cb31-1131"><a href="#cb31-1131" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb31-1132"><a href="#cb31-1132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1133"><a href="#cb31-1133" aria-hidden="true" tabindex="-1"></a>    stats.columns <span class="op">=</span> [<span class="st">'time'</span>, <span class="st">'person'</span>, <span class="st">'x_min'</span>, <span class="st">'x_max'</span>, <span class="st">'com_x'</span>, <span class="st">'y_min'</span>, <span class="st">'y_max'</span>, <span class="st">'com_y'</span>]</span>
<span id="cb31-1134"><a href="#cb31-1134" aria-hidden="true" tabindex="-1"></a>    stats[<span class="st">'centroid_x'</span>] <span class="op">=</span> (stats[<span class="st">'x_min'</span>] <span class="op">+</span> stats[<span class="st">'x_max'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb31-1135"><a href="#cb31-1135" aria-hidden="true" tabindex="-1"></a>    stats[<span class="st">'centroid_y'</span>] <span class="op">=</span> (stats[<span class="st">'y_min'</span>] <span class="op">+</span> stats[<span class="st">'y_max'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb31-1136"><a href="#cb31-1136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1137"><a href="#cb31-1137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stats</span>
<span id="cb31-1138"><a href="#cb31-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1139"><a href="#cb31-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1140"><a href="#cb31-1140" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_people_data_vectorized(ts, stats):</span>
<span id="cb31-1141"><a href="#cb31-1141" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-1142"><a href="#cb31-1142" aria-hidden="true" tabindex="-1"></a><span class="co">    Process keypoint data to calculate relative positions and distances.</span></span>
<span id="cb31-1143"><a href="#cb31-1143" aria-hidden="true" tabindex="-1"></a><span class="co">    Preserves time alignment and handles COM/centroid assignment.</span></span>
<span id="cb31-1144"><a href="#cb31-1144" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-1145"><a href="#cb31-1145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all unique times from the original data</span></span>
<span id="cb31-1146"><a href="#cb31-1146" aria-hidden="true" tabindex="-1"></a>    all_times <span class="op">=</span> <span class="bu">sorted</span>(ts[<span class="st">'time'</span>].unique())</span>
<span id="cb31-1147"><a href="#cb31-1147" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>all_times)</span>
<span id="cb31-1148"><a href="#cb31-1148" aria-hidden="true" tabindex="-1"></a>    result.index.name <span class="op">=</span> <span class="st">'time'</span></span>
<span id="cb31-1149"><a href="#cb31-1149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1150"><a href="#cb31-1150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process shoulders first (keypoints 5 and 6)</span></span>
<span id="cb31-1151"><a href="#cb31-1151" aria-hidden="true" tabindex="-1"></a>    shoulders <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>].isin([<span class="dv">5</span>, <span class="dv">6</span>])].groupby([<span class="st">'time'</span>, <span class="st">'person'</span>]).agg({</span>
<span id="cb31-1152"><a href="#cb31-1152" aria-hidden="true" tabindex="-1"></a>        <span class="st">'x'</span>: <span class="st">'mean'</span>,</span>
<span id="cb31-1153"><a href="#cb31-1153" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y'</span>: <span class="st">'mean'</span></span>
<span id="cb31-1154"><a href="#cb31-1154" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb31-1155"><a href="#cb31-1155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1156"><a href="#cb31-1156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process wrists (keypoints 7 and 8)</span></span>
<span id="cb31-1157"><a href="#cb31-1157" aria-hidden="true" tabindex="-1"></a>    wrists <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>].isin([<span class="dv">7</span>, <span class="dv">8</span>])].pivot_table(</span>
<span id="cb31-1158"><a href="#cb31-1158" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="st">'time'</span>, <span class="st">'person'</span>],</span>
<span id="cb31-1159"><a href="#cb31-1159" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span><span class="st">'keypoint'</span>,</span>
<span id="cb31-1160"><a href="#cb31-1160" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[<span class="st">'x'</span>, <span class="st">'y'</span>]</span>
<span id="cb31-1161"><a href="#cb31-1161" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb31-1162"><a href="#cb31-1162" aria-hidden="true" tabindex="-1"></a>    wrists.columns <span class="op">=</span> [<span class="st">'time'</span>, <span class="st">'person'</span>, <span class="st">'left_x'</span>, <span class="st">'right_x'</span>, <span class="st">'left_y'</span>, <span class="st">'right_y'</span>]</span>
<span id="cb31-1163"><a href="#cb31-1163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1164"><a href="#cb31-1164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get person-specific data</span></span>
<span id="cb31-1165"><a href="#cb31-1165" aria-hidden="true" tabindex="-1"></a>    p0_stats <span class="op">=</span> stats[stats[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">0</span>].set_index(<span class="st">'time'</span>)</span>
<span id="cb31-1166"><a href="#cb31-1166" aria-hidden="true" tabindex="-1"></a>    p1_stats <span class="op">=</span> stats[stats[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">1</span>].set_index(<span class="st">'time'</span>)</span>
<span id="cb31-1167"><a href="#cb31-1167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1168"><a href="#cb31-1168" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process distances where both people exist</span></span>
<span id="cb31-1169"><a href="#cb31-1169" aria-hidden="true" tabindex="-1"></a>    common_times <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>(p0_stats.index) <span class="op">&amp;</span> <span class="bu">set</span>(p1_stats.index))</span>
<span id="cb31-1170"><a href="#cb31-1170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> common_times:  <span class="co"># Only calculate if we have common times</span></span>
<span id="cb31-1171"><a href="#cb31-1171" aria-hidden="true" tabindex="-1"></a>        result.loc[common_times, <span class="st">'distance'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb31-1172"><a href="#cb31-1172" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'centroid_x'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'centroid_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb31-1173"><a href="#cb31-1173" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'centroid_y'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'centroid_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb31-1174"><a href="#cb31-1174" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1175"><a href="#cb31-1175" aria-hidden="true" tabindex="-1"></a>        result.loc[common_times, <span class="st">'distance_com'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb31-1176"><a href="#cb31-1176" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'com_x'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'com_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb31-1177"><a href="#cb31-1177" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'com_y'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'com_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb31-1178"><a href="#cb31-1178" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1179"><a href="#cb31-1179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1180"><a href="#cb31-1180" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process shoulders per person</span></span>
<span id="cb31-1181"><a href="#cb31-1181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> person, prefix <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'p1'</span>), (<span class="dv">1</span>, <span class="st">'p2'</span>)]:</span>
<span id="cb31-1182"><a href="#cb31-1182" aria-hidden="true" tabindex="-1"></a>        s_person <span class="op">=</span> shoulders[shoulders[<span class="st">'person'</span>] <span class="op">==</span> person].set_index(<span class="st">'time'</span>)</span>
<span id="cb31-1183"><a href="#cb31-1183" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'shoulder_midpoint_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> s_person[<span class="st">'x'</span>]</span>
<span id="cb31-1184"><a href="#cb31-1184" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'shoulder_midpoint_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> s_person[<span class="st">'y'</span>]</span>
<span id="cb31-1185"><a href="#cb31-1185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1186"><a href="#cb31-1186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate shoulder midpoint distance where possible</span></span>
<span id="cb31-1187"><a href="#cb31-1187" aria-hidden="true" tabindex="-1"></a>    shoulder_cols <span class="op">=</span> [<span class="st">'shoulder_midpoint_p1_x'</span>, <span class="st">'shoulder_midpoint_p2_x'</span>,</span>
<span id="cb31-1188"><a href="#cb31-1188" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'shoulder_midpoint_p1_y'</span>, <span class="st">'shoulder_midpoint_p2_y'</span>]</span>
<span id="cb31-1189"><a href="#cb31-1189" aria-hidden="true" tabindex="-1"></a>    shoulder_mask <span class="op">=</span> result[shoulder_cols].notna().<span class="bu">all</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-1190"><a href="#cb31-1190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> shoulder_mask.<span class="bu">any</span>():</span>
<span id="cb31-1191"><a href="#cb31-1191" aria-hidden="true" tabindex="-1"></a>        result.loc[shoulder_mask, <span class="st">'distance_shoulder_midpoint'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb31-1192"><a href="#cb31-1192" aria-hidden="true" tabindex="-1"></a>            (result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p1_x'</span>] <span class="op">-</span> result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p2_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb31-1193"><a href="#cb31-1193" aria-hidden="true" tabindex="-1"></a>            (result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p1_y'</span>] <span class="op">-</span> result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p2_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb31-1194"><a href="#cb31-1194" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1195"><a href="#cb31-1195" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1196"><a href="#cb31-1196" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process wrists per person and add COM/centroid</span></span>
<span id="cb31-1197"><a href="#cb31-1197" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> person, prefix <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'p1'</span>), (<span class="dv">1</span>, <span class="st">'p2'</span>)]:</span>
<span id="cb31-1198"><a href="#cb31-1198" aria-hidden="true" tabindex="-1"></a>        w_person <span class="op">=</span> wrists[wrists[<span class="st">'person'</span>] <span class="op">==</span> person].set_index(<span class="st">'time'</span>)</span>
<span id="cb31-1199"><a href="#cb31-1199" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_left_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> w_person[<span class="st">'left_x'</span>]</span>
<span id="cb31-1200"><a href="#cb31-1200" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_left_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> w_person[<span class="st">'left_y'</span>]</span>
<span id="cb31-1201"><a href="#cb31-1201" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_right_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> w_person[<span class="st">'right_x'</span>]</span>
<span id="cb31-1202"><a href="#cb31-1202" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_right_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> w_person[<span class="st">'right_y'</span>]</span>
<span id="cb31-1203"><a href="#cb31-1203" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1204"><a href="#cb31-1204" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the correct stats object based on person ID</span></span>
<span id="cb31-1205"><a href="#cb31-1205" aria-hidden="true" tabindex="-1"></a>        person_stats <span class="op">=</span> p0_stats <span class="cf">if</span> person <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> p1_stats</span>
<span id="cb31-1206"><a href="#cb31-1206" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1207"><a href="#cb31-1207" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add com and centroid with the correct stats object</span></span>
<span id="cb31-1208"><a href="#cb31-1208" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'com_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> person_stats[<span class="st">'com_x'</span>]</span>
<span id="cb31-1209"><a href="#cb31-1209" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'com_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> person_stats[<span class="st">'com_y'</span>]</span>
<span id="cb31-1210"><a href="#cb31-1210" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'centroid_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> person_stats[<span class="st">'centroid_x'</span>]</span>
<span id="cb31-1211"><a href="#cb31-1211" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'centroid_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> person_stats[<span class="st">'centroid_y'</span>]</span>
<span id="cb31-1212"><a href="#cb31-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1213"><a href="#cb31-1213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add tracking quality indicators using original data</span></span>
<span id="cb31-1214"><a href="#cb31-1214" aria-hidden="true" tabindex="-1"></a>    person_counts <span class="op">=</span> ts.groupby(<span class="st">'time'</span>)[<span class="st">'person'</span>].nunique()</span>
<span id="cb31-1215"><a href="#cb31-1215" aria-hidden="true" tabindex="-1"></a>    result[<span class="st">'both_tracked'</span>] <span class="op">=</span> result.index.<span class="bu">map</span>(<span class="kw">lambda</span> x: person_counts.get(x, <span class="dv">0</span>) <span class="op">==</span> <span class="dv">2</span>)</span>
<span id="cb31-1216"><a href="#cb31-1216" aria-hidden="true" tabindex="-1"></a>    result[<span class="st">'single_tracked'</span>] <span class="op">=</span> result.index.<span class="bu">map</span>(<span class="kw">lambda</span> x: person_counts.get(x, <span class="dv">0</span>) <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb31-1217"><a href="#cb31-1217" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1218"><a href="#cb31-1218" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb31-1219"><a href="#cb31-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1220"><a href="#cb31-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1221"><a href="#cb31-1221" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_proximity_approach(timeseries_data):</span>
<span id="cb31-1222"><a href="#cb31-1222" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-1223"><a href="#cb31-1223" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate each person's position relative to their initial position,</span></span>
<span id="cb31-1224"><a href="#cb31-1224" aria-hidden="true" tabindex="-1"></a><span class="co">    projecting movement onto the current connecting line between people.</span></span>
<span id="cb31-1225"><a href="#cb31-1225" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-1226"><a href="#cb31-1226" aria-hidden="true" tabindex="-1"></a><span class="co">    This handles rotation and changing spatial relationships between people.</span></span>
<span id="cb31-1227"><a href="#cb31-1227" aria-hidden="true" tabindex="-1"></a><span class="co">    Positive values indicate movement toward the other person from initial position.</span></span>
<span id="cb31-1228"><a href="#cb31-1228" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-1229"><a href="#cb31-1229" aria-hidden="true" tabindex="-1"></a><span class="co">    The reference positions are only established when both people are detected.</span></span>
<span id="cb31-1230"><a href="#cb31-1230" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-1231"><a href="#cb31-1231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create columns for our measurements</span></span>
<span id="cb31-1232"><a href="#cb31-1232" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'p1_com_approach_pos'</span> <span class="kw">not</span> <span class="kw">in</span> timeseries_data.columns:</span>
<span id="cb31-1233"><a href="#cb31-1233" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> np.nan</span>
<span id="cb31-1234"><a href="#cb31-1234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'p2_com_approach_pos'</span> <span class="kw">not</span> <span class="kw">in</span> timeseries_data.columns:</span>
<span id="cb31-1235"><a href="#cb31-1235" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> np.nan</span>
<span id="cb31-1236"><a href="#cb31-1236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1237"><a href="#cb31-1237" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort data by time</span></span>
<span id="cb31-1238"><a href="#cb31-1238" aria-hidden="true" tabindex="-1"></a>    sorted_data <span class="op">=</span> timeseries_data.sort_values(<span class="st">'time'</span>)</span>
<span id="cb31-1239"><a href="#cb31-1239" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1240"><a href="#cb31-1240" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find first valid frame to establish reference positions</span></span>
<span id="cb31-1241"><a href="#cb31-1241" aria-hidden="true" tabindex="-1"></a>    reference_p1_pos <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-1242"><a href="#cb31-1242" aria-hidden="true" tabindex="-1"></a>    reference_p2_pos <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-1243"><a href="#cb31-1243" aria-hidden="true" tabindex="-1"></a>    reference_distance <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-1244"><a href="#cb31-1244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1245"><a href="#cb31-1245" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First pass: find reference frame where both people are detected</span></span>
<span id="cb31-1246"><a href="#cb31-1246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> sorted_data.iterrows():</span>
<span id="cb31-1247"><a href="#cb31-1247" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip rows with NaN values or where both_tracked is False</span></span>
<span id="cb31-1248"><a href="#cb31-1248" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (np.isnan(row[<span class="st">'com_p1_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p1_y'</span>]) <span class="kw">or</span> </span>
<span id="cb31-1249"><a href="#cb31-1249" aria-hidden="true" tabindex="-1"></a>            np.isnan(row[<span class="st">'com_p2_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p2_y'</span>]) <span class="kw">or</span></span>
<span id="cb31-1250"><a href="#cb31-1250" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'both_tracked'</span> <span class="kw">in</span> row.index <span class="kw">and</span> row[<span class="st">'both_tracked'</span>] <span class="op">==</span> <span class="va">False</span>)):</span>
<span id="cb31-1251"><a href="#cb31-1251" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb31-1252"><a href="#cb31-1252" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1253"><a href="#cb31-1253" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get positions for this frame</span></span>
<span id="cb31-1254"><a href="#cb31-1254" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> np.array([row[<span class="st">'com_p1_x'</span>], row[<span class="st">'com_p1_y'</span>]])</span>
<span id="cb31-1255"><a href="#cb31-1255" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> np.array([row[<span class="st">'com_p2_x'</span>], row[<span class="st">'com_p2_y'</span>]])</span>
<span id="cb31-1256"><a href="#cb31-1256" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1257"><a href="#cb31-1257" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate connecting vector</span></span>
<span id="cb31-1258"><a href="#cb31-1258" aria-hidden="true" tabindex="-1"></a>        connect_vector <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb31-1259"><a href="#cb31-1259" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> np.linalg.norm(connect_vector)</span>
<span id="cb31-1260"><a href="#cb31-1260" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1261"><a href="#cb31-1261" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> distance <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-1262"><a href="#cb31-1262" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We found a valid reference frame</span></span>
<span id="cb31-1263"><a href="#cb31-1263" aria-hidden="true" tabindex="-1"></a>            reference_p1_pos <span class="op">=</span> p1_pos.copy()</span>
<span id="cb31-1264"><a href="#cb31-1264" aria-hidden="true" tabindex="-1"></a>            reference_p2_pos <span class="op">=</span> p2_pos.copy()</span>
<span id="cb31-1265"><a href="#cb31-1265" aria-hidden="true" tabindex="-1"></a>            reference_distance <span class="op">=</span> distance</span>
<span id="cb31-1266"><a href="#cb31-1266" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Reference frame established at time=</span><span class="sc">{</span>row[<span class="st">'time'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1267"><a href="#cb31-1267" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference p1_pos: </span><span class="sc">{</span>reference_p1_pos<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1268"><a href="#cb31-1268" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference p2_pos: </span><span class="sc">{</span>reference_p2_pos<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1269"><a href="#cb31-1269" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference distance: </span><span class="sc">{</span>reference_distance<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1270"><a href="#cb31-1270" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb31-1271"><a href="#cb31-1271" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1272"><a href="#cb31-1272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> reference_p1_pos <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-1273"><a href="#cb31-1273" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"ERROR: Could not establish a reference frame. No valid frames found with both people detected."</span>)</span>
<span id="cb31-1274"><a href="#cb31-1274" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> timeseries_data</span>
<span id="cb31-1275"><a href="#cb31-1275" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1276"><a href="#cb31-1276" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Second pass: calculate projected positions for all frames</span></span>
<span id="cb31-1277"><a href="#cb31-1277" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> sorted_data.iterrows():</span>
<span id="cb31-1278"><a href="#cb31-1278" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip rows with NaN values</span></span>
<span id="cb31-1279"><a href="#cb31-1279" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (np.isnan(row[<span class="st">'com_p1_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p1_y'</span>]) <span class="kw">or</span> </span>
<span id="cb31-1280"><a href="#cb31-1280" aria-hidden="true" tabindex="-1"></a>            np.isnan(row[<span class="st">'com_p2_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p2_y'</span>])):</span>
<span id="cb31-1281"><a href="#cb31-1281" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb31-1282"><a href="#cb31-1282" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1283"><a href="#cb31-1283" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get current positions</span></span>
<span id="cb31-1284"><a href="#cb31-1284" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> np.array([row[<span class="st">'com_p1_x'</span>], row[<span class="st">'com_p1_y'</span>]])</span>
<span id="cb31-1285"><a href="#cb31-1285" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> np.array([row[<span class="st">'com_p2_x'</span>], row[<span class="st">'com_p2_y'</span>]])</span>
<span id="cb31-1286"><a href="#cb31-1286" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1287"><a href="#cb31-1287" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate current connecting vector and direction</span></span>
<span id="cb31-1288"><a href="#cb31-1288" aria-hidden="true" tabindex="-1"></a>        current_connect <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb31-1289"><a href="#cb31-1289" aria-hidden="true" tabindex="-1"></a>        current_distance <span class="op">=</span> np.linalg.norm(current_connect)</span>
<span id="cb31-1290"><a href="#cb31-1290" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1291"><a href="#cb31-1291" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip frames where people are at the same position</span></span>
<span id="cb31-1292"><a href="#cb31-1292" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_distance <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb31-1293"><a href="#cb31-1293" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb31-1294"><a href="#cb31-1294" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1295"><a href="#cb31-1295" aria-hidden="true" tabindex="-1"></a>        current_direction <span class="op">=</span> current_connect <span class="op">/</span> current_distance</span>
<span id="cb31-1296"><a href="#cb31-1296" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1297"><a href="#cb31-1297" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate vector from reference position to current position</span></span>
<span id="cb31-1298"><a href="#cb31-1298" aria-hidden="true" tabindex="-1"></a>        p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> reference_p1_pos</span>
<span id="cb31-1299"><a href="#cb31-1299" aria-hidden="true" tabindex="-1"></a>        p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> reference_p2_pos</span>
<span id="cb31-1300"><a href="#cb31-1300" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1301"><a href="#cb31-1301" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Project these vectors onto the current connecting line</span></span>
<span id="cb31-1302"><a href="#cb31-1302" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Positive values mean moving toward the other person</span></span>
<span id="cb31-1303"><a href="#cb31-1303" aria-hidden="true" tabindex="-1"></a>        p1_projection <span class="op">=</span> np.dot(p1_vector, current_direction)</span>
<span id="cb31-1304"><a href="#cb31-1304" aria-hidden="true" tabindex="-1"></a>        p2_projection <span class="op">=</span> <span class="op">-</span>np.dot(p2_vector, <span class="op">-</span>current_direction)</span>
<span id="cb31-1305"><a href="#cb31-1305" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1306"><a href="#cb31-1306" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store values</span></span>
<span id="cb31-1307"><a href="#cb31-1307" aria-hidden="true" tabindex="-1"></a>        timeseries_data.loc[idx, <span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> p1_projection</span>
<span id="cb31-1308"><a href="#cb31-1308" aria-hidden="true" tabindex="-1"></a>        timeseries_data.loc[idx, <span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> p2_projection</span>
<span id="cb31-1309"><a href="#cb31-1309" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1310"><a href="#cb31-1310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify results</span></span>
<span id="cb31-1311"><a href="#cb31-1311" aria-hidden="true" tabindex="-1"></a>    filled_p1 <span class="op">=</span> timeseries_data[<span class="st">'p1_com_approach_pos'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb31-1312"><a href="#cb31-1312" aria-hidden="true" tabindex="-1"></a>    filled_p2 <span class="op">=</span> timeseries_data[<span class="st">'p2_com_approach_pos'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb31-1313"><a href="#cb31-1313" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1314"><a href="#cb31-1314" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Frames with filled values - p1: </span><span class="sc">{</span>filled_p1<span class="sc">}</span><span class="ss">, p2: </span><span class="sc">{</span>filled_p2<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1315"><a href="#cb31-1315" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1316"><a href="#cb31-1316" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> timeseries_data</span>
<span id="cb31-1317"><a href="#cb31-1317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1318"><a href="#cb31-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1319"><a href="#cb31-1319" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb31-1320"><a href="#cb31-1320" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main processing function"""</span></span>
<span id="cb31-1321"><a href="#cb31-1321" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb31-1322"><a href="#cb31-1322" aria-hidden="true" tabindex="-1"></a>    os.makedirs(OUTPUT_PATH, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-1323"><a href="#cb31-1323" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1324"><a href="#cb31-1324" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all CSV files from layer 1 processing</span></span>
<span id="cb31-1325"><a href="#cb31-1325" aria-hidden="true" tabindex="-1"></a>    layer1_files <span class="op">=</span> glob.glob(INPUT_LAYER1_PATH <span class="op">+</span> <span class="st">'*.csv'</span>)</span>
<span id="cb31-1326"><a href="#cb31-1326" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1327"><a href="#cb31-1327" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each file</span></span>
<span id="cb31-1328"><a href="#cb31-1328" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_path <span class="kw">in</span> layer1_files:</span>
<span id="cb31-1329"><a href="#cb31-1329" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract video name from file path</span></span>
<span id="cb31-1330"><a href="#cb31-1330" aria-hidden="true" tabindex="-1"></a>        vid_name <span class="op">=</span> os.path.basename(file_path).split(<span class="st">'_keypoints_data_layer1.csv'</span>)[<span class="dv">0</span>]</span>
<span id="cb31-1331"><a href="#cb31-1331" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Processing video: </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1332"><a href="#cb31-1332" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1333"><a href="#cb31-1333" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if already processed</span></span>
<span id="cb31-1334"><a href="#cb31-1334" aria-hidden="true" tabindex="-1"></a>        output_file <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>OUTPUT_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">_processed_data_layer2.csv"</span></span>
<span id="cb31-1335"><a href="#cb31-1335" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(output_file):</span>
<span id="cb31-1336"><a href="#cb31-1336" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Already processed, skipping..."</span>)</span>
<span id="cb31-1337"><a href="#cb31-1337" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb31-1338"><a href="#cb31-1338" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1339"><a href="#cb31-1339" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine video format and get FPS</span></span>
<span id="cb31-1340"><a href="#cb31-1340" aria-hidden="true" tabindex="-1"></a>        video_path <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-1341"><a href="#cb31-1341" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ext <span class="kw">in</span> [<span class="st">'.avi'</span>, <span class="st">'.mp4'</span>, <span class="st">'.mov'</span>]:</span>
<span id="cb31-1342"><a href="#cb31-1342" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> os.path.exists(<span class="ss">f"</span><span class="sc">{</span>VIDEO_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}{</span>ext<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb31-1343"><a href="#cb31-1343" aria-hidden="true" tabindex="-1"></a>                video_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>VIDEO_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}{</span>ext<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb31-1344"><a href="#cb31-1344" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb31-1345"><a href="#cb31-1345" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-1346"><a href="#cb31-1346" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> video_path:</span>
<span id="cb31-1347"><a href="#cb31-1347" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Video file not found for </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1348"><a href="#cb31-1348" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb31-1349"><a href="#cb31-1349" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1350"><a href="#cb31-1350" aria-hidden="true" tabindex="-1"></a>        cap <span class="op">=</span> cv2.VideoCapture(video_path)</span>
<span id="cb31-1351"><a href="#cb31-1351" aria-hidden="true" tabindex="-1"></a>        fps <span class="op">=</span> cap.get(cv2.CAP_PROP_FPS)</span>
<span id="cb31-1352"><a href="#cb31-1352" aria-hidden="true" tabindex="-1"></a>        cap.release()</span>
<span id="cb31-1353"><a href="#cb31-1353" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Working on: </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss"> with fps = </span><span class="sc">{</span>fps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1354"><a href="#cb31-1354" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1355"><a href="#cb31-1355" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load and preprocess data</span></span>
<span id="cb31-1356"><a href="#cb31-1356" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> pd.read_csv(file_path)</span>
<span id="cb31-1357"><a href="#cb31-1357" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> frame_to_time(ts, fps<span class="op">=</span>fps)</span>
<span id="cb31-1358"><a href="#cb31-1358" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> assign_left_right(ts)</span>
<span id="cb31-1359"><a href="#cb31-1359" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1360"><a href="#cb31-1360" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate statistics</span></span>
<span id="cb31-1361"><a href="#cb31-1361" aria-hidden="true" tabindex="-1"></a>        stats <span class="op">=</span> process_time_data(ts)</span>
<span id="cb31-1362"><a href="#cb31-1362" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1363"><a href="#cb31-1363" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process tracked data</span></span>
<span id="cb31-1364"><a href="#cb31-1364" aria-hidden="true" tabindex="-1"></a>        processed_data <span class="op">=</span> process_people_data_vectorized(ts, stats)</span>
<span id="cb31-1365"><a href="#cb31-1365" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1366"><a href="#cb31-1366" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create final data frame</span></span>
<span id="cb31-1367"><a href="#cb31-1367" aria-hidden="true" tabindex="-1"></a>        bb_data <span class="op">=</span> pd.merge(</span>
<span id="cb31-1368"><a href="#cb31-1368" aria-hidden="true" tabindex="-1"></a>            stats, </span>
<span id="cb31-1369"><a href="#cb31-1369" aria-hidden="true" tabindex="-1"></a>            processed_data.reset_index(), </span>
<span id="cb31-1370"><a href="#cb31-1370" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">'time'</span>, </span>
<span id="cb31-1371"><a href="#cb31-1371" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">'outer'</span></span>
<span id="cb31-1372"><a href="#cb31-1372" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-1373"><a href="#cb31-1373" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1374"><a href="#cb31-1374" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract time series data (using person 0 as reference)</span></span>
<span id="cb31-1375"><a href="#cb31-1375" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> bb_data[bb_data[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">0</span>].copy()  <span class="co"># Make a copy to avoid SettingWithCopyWarning</span></span>
<span id="cb31-1376"><a href="#cb31-1376" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1377"><a href="#cb31-1377" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove unnecessary columns</span></span>
<span id="cb31-1378"><a href="#cb31-1378" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.drop(columns<span class="op">=</span><span class="st">'person'</span>)</span>
<span id="cb31-1379"><a href="#cb31-1379" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1380"><a href="#cb31-1380" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate desired time step based on FPS</span></span>
<span id="cb31-1381"><a href="#cb31-1381" aria-hidden="true" tabindex="-1"></a>        desired_time_step <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>fps</span>
<span id="cb31-1382"><a href="#cb31-1382" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1383"><a href="#cb31-1383" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Interpolate missing values</span></span>
<span id="cb31-1384"><a href="#cb31-1384" aria-hidden="true" tabindex="-1"></a>        nan_cols <span class="op">=</span> timeseries_data.columns[timeseries_data.isna().<span class="bu">any</span>()].tolist()</span>
<span id="cb31-1385"><a href="#cb31-1385" aria-hidden="true" tabindex="-1"></a>        timeseries_data[nan_cols] <span class="op">=</span> timeseries_data[nan_cols].interpolate()</span>
<span id="cb31-1386"><a href="#cb31-1386" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1387"><a href="#cb31-1387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth distance with Savitzky-Golay filter</span></span>
<span id="cb31-1388"><a href="#cb31-1388" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'distance_smooth'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'distance'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb31-1389"><a href="#cb31-1389" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1390"><a href="#cb31-1390" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate and smooth wrist speeds</span></span>
<span id="cb31-1391"><a href="#cb31-1391" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> wrist <span class="kw">in</span> [<span class="st">'wrist_left_p1'</span>, <span class="st">'wrist_right_p1'</span>, <span class="st">'wrist_left_p2'</span>, <span class="st">'wrist_right_p2'</span>]:</span>
<span id="cb31-1392"><a href="#cb31-1392" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate speed as Euclidean distance between consecutive positions</span></span>
<span id="cb31-1393"><a href="#cb31-1393" aria-hidden="true" tabindex="-1"></a>            timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb31-1394"><a href="#cb31-1394" aria-hidden="true" tabindex="-1"></a>                timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_x'</span>].diff()<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_y'</span>].diff()<span class="op">**</span><span class="dv">2</span></span>
<span id="cb31-1395"><a href="#cb31-1395" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb31-1396"><a href="#cb31-1396" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1397"><a href="#cb31-1397" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Apply Savitzky-Golay filter for smoothing</span></span>
<span id="cb31-1398"><a href="#cb31-1398" aria-hidden="true" tabindex="-1"></a>            timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed_smooth'</span>] <span class="op">=</span> savgol_filter(</span>
<span id="cb31-1399"><a href="#cb31-1399" aria-hidden="true" tabindex="-1"></a>                timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed'</span>].values, <span class="dv">11</span>, <span class="dv">3</span></span>
<span id="cb31-1400"><a href="#cb31-1400" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb31-1401"><a href="#cb31-1401" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1402"><a href="#cb31-1402" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill NaN values before calculating proximity approach</span></span>
<span id="cb31-1403"><a href="#cb31-1403" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.fillna(method<span class="op">=</span><span class="st">'ffill'</span>)</span>
<span id="cb31-1404"><a href="#cb31-1404" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1405"><a href="#cb31-1405" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate proximity approach</span></span>
<span id="cb31-1406"><a href="#cb31-1406" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> calculate_proximity_approach(timeseries_data)</span>
<span id="cb31-1407"><a href="#cb31-1407" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1408"><a href="#cb31-1408" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill any remaining NaN values</span></span>
<span id="cb31-1409"><a href="#cb31-1409" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.fillna(method<span class="op">=</span><span class="st">'ffill'</span>)</span>
<span id="cb31-1410"><a href="#cb31-1410" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1411"><a href="#cb31-1411" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth proximity approach values</span></span>
<span id="cb31-1412"><a href="#cb31-1412" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'p1_com_approach_pos'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb31-1413"><a href="#cb31-1413" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'p2_com_approach_pos'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb31-1414"><a href="#cb31-1414" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1415"><a href="#cb31-1415" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for any remaining NaN values</span></span>
<span id="cb31-1416"><a href="#cb31-1416" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Checking for NaN values..."</span>)</span>
<span id="cb31-1417"><a href="#cb31-1417" aria-hidden="true" tabindex="-1"></a>        nan_counts <span class="op">=</span> timeseries_data.isna().<span class="bu">sum</span>()</span>
<span id="cb31-1418"><a href="#cb31-1418" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> nan_counts.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-1419"><a href="#cb31-1419" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Found NaN values after processing:"</span>)</span>
<span id="cb31-1420"><a href="#cb31-1420" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(nan_counts)</span>
<span id="cb31-1421"><a href="#cb31-1421" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-1422"><a href="#cb31-1422" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No NaN values found."</span>)</span>
<span id="cb31-1423"><a href="#cb31-1423" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1424"><a href="#cb31-1424" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save processed data</span></span>
<span id="cb31-1425"><a href="#cb31-1425" aria-hidden="true" tabindex="-1"></a>        timeseries_data.to_csv(output_file, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-1426"><a href="#cb31-1426" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1427"><a href="#cb31-1427" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for time continuity</span></span>
<span id="cb31-1428"><a href="#cb31-1428" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Checking time continuity..."</span>)</span>
<span id="cb31-1429"><a href="#cb31-1429" aria-hidden="true" tabindex="-1"></a>        time_diffs <span class="op">=</span> np.array([<span class="bu">round</span>(val, <span class="dv">2</span>) <span class="cf">for</span> val <span class="kw">in</span> np.diff(timeseries_data[<span class="st">'time'</span>])])</span>
<span id="cb31-1430"><a href="#cb31-1430" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.<span class="bu">all</span>(time_diffs <span class="op">==</span> desired_time_step):</span>
<span id="cb31-1431"><a href="#cb31-1431" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Found gaps at times: </span><span class="sc">{</span>np<span class="sc">.</span>where(time_diffs <span class="op">!=</span> desired_time_step)[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1432"><a href="#cb31-1432" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-1433"><a href="#cb31-1433" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No missing time points."</span>)</span>
<span id="cb31-1434"><a href="#cb31-1434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1435"><a href="#cb31-1435" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb31-1436"><a href="#cb31-1436" aria-hidden="true" tabindex="-1"></a>    main()</span>
<span id="cb31-1437"><a href="#cb31-1437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1438"><a href="#cb31-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1439"><a href="#cb31-1439" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-1440"><a href="#cb31-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1441"><a href="#cb31-1441" aria-hidden="true" tabindex="-1"></a>To provide an example of the data we plot here a timeseries of the resultant data.</span>
<span id="cb31-1442"><a href="#cb31-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1443"><a href="#cb31-1443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1444"><a href="#cb31-1444" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-1445"><a href="#cb31-1445" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example output timeseries: üìä</span></span>
<span id="cb31-1446"><a href="#cb31-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1447"><a href="#cb31-1447" aria-hidden="true" tabindex="-1"></a><span class="in">```{python examplecsvfilelayer12}</span></span>
<span id="cb31-1448"><a href="#cb31-1448" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-1449"><a href="#cb31-1449" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="im">as</span> glob</span>
<span id="cb31-1450"><a href="#cb31-1450" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-1451"><a href="#cb31-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1452"><a href="#cb31-1452" aria-hidden="true" tabindex="-1"></a>folderstep12output <span class="op">=</span> <span class="st">"./dataoutput_STEP1_2_timeseries/"</span></span>
<span id="cb31-1453"><a href="#cb31-1453" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file</span></span>
<span id="cb31-1454"><a href="#cb31-1454" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> glob.glob(os.path.join(folderstep12output <span class="op">+</span> <span class="st">"*.csv"</span>))[<span class="dv">0</span>]</span>
<span id="cb31-1455"><a href="#cb31-1455" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(csv_file)</span>
<span id="cb31-1456"><a href="#cb31-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1457"><a href="#cb31-1457" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb31-1458"><a href="#cb31-1458" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span>
<span id="cb31-1459"><a href="#cb31-1459" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1460"><a href="#cb31-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1461"><a href="#cb31-1461" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-1462"><a href="#cb31-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1463"><a href="#cb31-1463" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1.3: Animation with original videodata</span></span>
<span id="cb31-1464"><a href="#cb31-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1465"><a href="#cb31-1465" aria-hidden="true" tabindex="-1"></a>We advise users to double check the quality of the tracking data and the derived variables. The animation below is generated using the code <span class="in">`STEP3_animation.py`</span> which couples video with quantiative data, allowing for qualitatively checking the timeseries real time against what is happening in the video. The user can select variables need to be plotted in the video plus time series animation. The code below provides the animation. Please check the DIY section for how to set up the motion tracking and run the code.</span>
<span id="cb31-1466"><a href="#cb31-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1467"><a href="#cb31-1467" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-1468"><a href="#cb31-1468" aria-hidden="true" tabindex="-1"></a><span class="fu">## Code chunk: Animation code for coupling video with quantitative data üö© </span></span>
<span id="cb31-1469"><a href="#cb31-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1470"><a href="#cb31-1470" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb31-1471"><a href="#cb31-1471" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-1472"><a href="#cb31-1472" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-1473"><a href="#cb31-1473" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb31-1474"><a href="#cb31-1474" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-1475"><a href="#cb31-1475" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb31-1476"><a href="#cb31-1476" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb31-1477"><a href="#cb31-1477" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bisect <span class="im">import</span> bisect_left</span>
<span id="cb31-1478"><a href="#cb31-1478" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> savgol_filter</span>
<span id="cb31-1479"><a href="#cb31-1479" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb31-1480"><a href="#cb31-1480" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb31-1481"><a href="#cb31-1481" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tqdm</span>
<span id="cb31-1482"><a href="#cb31-1482" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb31-1483"><a href="#cb31-1483" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> moviepy <span class="im">import</span> VideoFileClip</span>
<span id="cb31-1484"><a href="#cb31-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1485"><a href="#cb31-1485" aria-hidden="true" tabindex="-1"></a><span class="co"># Path Definitions</span></span>
<span id="cb31-1486"><a href="#cb31-1486" aria-hidden="true" tabindex="-1"></a>INPUT_LAYER1_PATH <span class="op">=</span> <span class="st">'../dataoutput_STEP1_2_timeseries/'</span>  <span class="co"># Input directory containing tracked keypoint data from STEP1</span></span>
<span id="cb31-1487"><a href="#cb31-1487" aria-hidden="true" tabindex="-1"></a>VIDEO_PATH <span class="op">=</span> <span class="st">"../dataoutput_STEP1_1_rawposedata/"</span>                        <span class="co"># Raw video files directory</span></span>
<span id="cb31-1488"><a href="#cb31-1488" aria-hidden="true" tabindex="-1"></a>OUTPUT_PATH <span class="op">=</span> <span class="st">'../dataoutput_STEP1_3_animations/'</span>     <span class="co"># Output directory for processed timeseries data</span></span>
<span id="cb31-1489"><a href="#cb31-1489" aria-hidden="true" tabindex="-1"></a>targetvideo <span class="op">=</span> <span class="st">"*sample_annotated_layer1_c150_miss95.mp4"</span> <span class="co"># note that sample video must be set to True to process only a sample video</span></span>
<span id="cb31-1490"><a href="#cb31-1490" aria-hidden="true" tabindex="-1"></a>SAMPLE_VIDEO <span class="op">=</span> <span class="va">True</span>  <span class="co"># Set to True to process only a sample video, False to process all videos</span></span>
<span id="cb31-1491"><a href="#cb31-1491" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb31-1492"><a href="#cb31-1492" aria-hidden="true" tabindex="-1"></a>os.makedirs(OUTPUT_PATH, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-1493"><a href="#cb31-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1494"><a href="#cb31-1494" aria-hidden="true" tabindex="-1"></a><span class="co"># animate only sample video?</span></span>
<span id="cb31-1495"><a href="#cb31-1495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1496"><a href="#cb31-1496" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> SAMPLE_VIDEO:</span>
<span id="cb31-1497"><a href="#cb31-1497" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For sample video, use a specific video file</span></span>
<span id="cb31-1498"><a href="#cb31-1498" aria-hidden="true" tabindex="-1"></a>    allvidsnew <span class="op">=</span>  glob.glob(VIDEO_PATH <span class="op">+</span> <span class="st">"*"</span> <span class="op">+</span> targetvideo)</span>
<span id="cb31-1499"><a href="#cb31-1499" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb31-1500"><a href="#cb31-1500" aria-hidden="true" tabindex="-1"></a>    allvidsnew <span class="op">=</span> glob.glob(VIDEO_PATH <span class="op">+</span> <span class="st">"*.mp4"</span>)</span>
<span id="cb31-1501"><a href="#cb31-1501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1502"><a href="#cb31-1502" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(allvidsnew)<span class="sc">}</span><span class="ss"> videos to process"</span>)</span>
<span id="cb31-1503"><a href="#cb31-1503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1504"><a href="#cb31-1504" aria-hidden="true" tabindex="-1"></a><span class="co"># what variables to animate with video</span></span>
<span id="cb31-1505"><a href="#cb31-1505" aria-hidden="true" tabindex="-1"></a>animate_variables <span class="op">=</span> {</span>
<span id="cb31-1506"><a href="#cb31-1506" aria-hidden="true" tabindex="-1"></a>    <span class="st">'x_min'</span>: <span class="va">False</span>,</span>
<span id="cb31-1507"><a href="#cb31-1507" aria-hidden="true" tabindex="-1"></a>    <span class="st">'x_max'</span>: <span class="va">False</span>,</span>
<span id="cb31-1508"><a href="#cb31-1508" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1509"><a href="#cb31-1509" aria-hidden="true" tabindex="-1"></a>    <span class="st">'y_min'</span>: <span class="va">False</span>,</span>
<span id="cb31-1510"><a href="#cb31-1510" aria-hidden="true" tabindex="-1"></a>    <span class="st">'y_max'</span>: <span class="va">False</span>,</span>
<span id="cb31-1511"><a href="#cb31-1511" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1512"><a href="#cb31-1512" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1513"><a href="#cb31-1513" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1514"><a href="#cb31-1514" aria-hidden="true" tabindex="-1"></a>    <span class="st">'distance'</span>: <span class="va">False</span>,</span>
<span id="cb31-1515"><a href="#cb31-1515" aria-hidden="true" tabindex="-1"></a>    <span class="st">'distance_com'</span>: <span class="va">False</span>,</span>
<span id="cb31-1516"><a href="#cb31-1516" aria-hidden="true" tabindex="-1"></a>    <span class="st">'shoulder_midpoint_p1_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1517"><a href="#cb31-1517" aria-hidden="true" tabindex="-1"></a>    <span class="st">'shoulder_midpoint_p1_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1518"><a href="#cb31-1518" aria-hidden="true" tabindex="-1"></a>    <span class="st">'shoulder_midpoint_p2_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1519"><a href="#cb31-1519" aria-hidden="true" tabindex="-1"></a>    <span class="st">'shoulder_midpoint_p2_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1520"><a href="#cb31-1520" aria-hidden="true" tabindex="-1"></a>    <span class="st">'distance_shoulder_midpoint'</span>: <span class="va">True</span>,</span>
<span id="cb31-1521"><a href="#cb31-1521" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p1_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1522"><a href="#cb31-1522" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p1_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1523"><a href="#cb31-1523" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p1_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1524"><a href="#cb31-1524" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p1_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1525"><a href="#cb31-1525" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_p1_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1526"><a href="#cb31-1526" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_p1_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1527"><a href="#cb31-1527" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_p1_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1528"><a href="#cb31-1528" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_p1_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1529"><a href="#cb31-1529" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p2_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1530"><a href="#cb31-1530" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p2_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1531"><a href="#cb31-1531" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p2_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1532"><a href="#cb31-1532" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p2_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1533"><a href="#cb31-1533" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_p2_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1534"><a href="#cb31-1534" aria-hidden="true" tabindex="-1"></a>    <span class="st">'com_p2_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1535"><a href="#cb31-1535" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_p2_x'</span>: <span class="va">False</span>,</span>
<span id="cb31-1536"><a href="#cb31-1536" aria-hidden="true" tabindex="-1"></a>    <span class="st">'centroid_p2_y'</span>: <span class="va">False</span>,</span>
<span id="cb31-1537"><a href="#cb31-1537" aria-hidden="true" tabindex="-1"></a>    <span class="st">'distance_smooth'</span>: <span class="va">True</span>,</span>
<span id="cb31-1538"><a href="#cb31-1538" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p1_speed'</span>: <span class="va">False</span>,</span>
<span id="cb31-1539"><a href="#cb31-1539" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p1_speed_smooth'</span>: <span class="va">True</span>,</span>
<span id="cb31-1540"><a href="#cb31-1540" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p1_speed'</span>: <span class="va">False</span>,</span>
<span id="cb31-1541"><a href="#cb31-1541" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p1_speed_smooth'</span>: <span class="va">True</span>,</span>
<span id="cb31-1542"><a href="#cb31-1542" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p2_speed'</span>: <span class="va">False</span>,</span>
<span id="cb31-1543"><a href="#cb31-1543" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_left_p2_speed_smooth'</span>: <span class="va">True</span>,</span>
<span id="cb31-1544"><a href="#cb31-1544" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p2_speed'</span>: <span class="va">False</span>,</span>
<span id="cb31-1545"><a href="#cb31-1545" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wrist_right_p2_speed_smooth'</span>: <span class="va">True</span>,</span>
<span id="cb31-1546"><a href="#cb31-1546" aria-hidden="true" tabindex="-1"></a>    <span class="st">'p1_com_approach_pos'</span>: <span class="va">True</span>,</span>
<span id="cb31-1547"><a href="#cb31-1547" aria-hidden="true" tabindex="-1"></a>    <span class="st">'p2_com_approach_pos'</span>: <span class="va">True</span></span>
<span id="cb31-1548"><a href="#cb31-1548" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-1549"><a href="#cb31-1549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1550"><a href="#cb31-1550" aria-hidden="true" tabindex="-1"></a><span class="co"># plotting functions</span></span>
<span id="cb31-1551"><a href="#cb31-1551" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_timeseries(timeseries_data, current_time<span class="op">=</span><span class="va">None</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>)):</span>
<span id="cb31-1552"><a href="#cb31-1552" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-1553"><a href="#cb31-1553" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualizing of the processed 1_2 motion variable data together with the original video.</span></span>
<span id="cb31-1554"><a href="#cb31-1554" aria-hidden="true" tabindex="-1"></a><span class="co">    Groups variables by modality with consistent coloring for p1/p2 and left/right.</span></span>
<span id="cb31-1555"><a href="#cb31-1555" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-1556"><a href="#cb31-1556" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb31-1557"><a href="#cb31-1557" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb31-1558"><a href="#cb31-1558" aria-hidden="true" tabindex="-1"></a><span class="co">    timeseries_data : pandas.DataFrame</span></span>
<span id="cb31-1559"><a href="#cb31-1559" aria-hidden="true" tabindex="-1"></a><span class="co">         DataFrame containing all the motion analysis columns</span></span>
<span id="cb31-1560"><a href="#cb31-1560" aria-hidden="true" tabindex="-1"></a><span class="co">    current_time : float, optional</span></span>
<span id="cb31-1561"><a href="#cb31-1561" aria-hidden="true" tabindex="-1"></a><span class="co">         current time in seconds to mark with vertical line</span></span>
<span id="cb31-1562"><a href="#cb31-1562" aria-hidden="true" tabindex="-1"></a><span class="co">    figsize : tuple, optional</span></span>
<span id="cb31-1563"><a href="#cb31-1563" aria-hidden="true" tabindex="-1"></a><span class="co">         Figure size in inches (width, height)</span></span>
<span id="cb31-1564"><a href="#cb31-1564" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-1565"><a href="#cb31-1565" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter data for only variables marked as True in animate_variables</span></span>
<span id="cb31-1566"><a href="#cb31-1566" aria-hidden="true" tabindex="-1"></a>    active_vars <span class="op">=</span> [var <span class="cf">for</span> var, active <span class="kw">in</span> animate_variables.items() <span class="cf">if</span> active <span class="kw">and</span> var <span class="kw">in</span> timeseries_data.columns]</span>
<span id="cb31-1567"><a href="#cb31-1567" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1568"><a href="#cb31-1568" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> active_vars:</span>
<span id="cb31-1569"><a href="#cb31-1569" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No variables selected for animation!"</span>)</span>
<span id="cb31-1570"><a href="#cb31-1570" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb31-1571"><a href="#cb31-1571" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1572"><a href="#cb31-1572" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define consistent color scheme</span></span>
<span id="cb31-1573"><a href="#cb31-1573" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Colors for p1/p2 (blue family for p1, red family for p2)</span></span>
<span id="cb31-1574"><a href="#cb31-1574" aria-hidden="true" tabindex="-1"></a>    p1_colors <span class="op">=</span> {<span class="st">'left'</span>: <span class="st">'#1f77b4'</span>, <span class="st">'right'</span>: <span class="st">'#aec7e8'</span>}  <span class="co"># Dark blue, light blue</span></span>
<span id="cb31-1575"><a href="#cb31-1575" aria-hidden="true" tabindex="-1"></a>    p2_colors <span class="op">=</span> {<span class="st">'left'</span>: <span class="st">'#d62728'</span>, <span class="st">'right'</span>: <span class="st">'#ff9896'</span>}  <span class="co"># Dark red, light red</span></span>
<span id="cb31-1576"><a href="#cb31-1576" aria-hidden="true" tabindex="-1"></a>    other_colors <span class="op">=</span> [<span class="st">'#ff7f0e'</span>, <span class="st">'#2ca02c'</span>, <span class="st">'#9467bd'</span>, <span class="st">'#8c564b'</span>, <span class="st">'#e377c2'</span>, <span class="st">'#7f7f7f'</span>, <span class="st">'#bcbd22'</span>, <span class="st">'#17becf'</span>]</span>
<span id="cb31-1577"><a href="#cb31-1577" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1578"><a href="#cb31-1578" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group variables by modality</span></span>
<span id="cb31-1579"><a href="#cb31-1579" aria-hidden="true" tabindex="-1"></a>    distance_vars <span class="op">=</span> [var <span class="cf">for</span> var <span class="kw">in</span> active_vars <span class="cf">if</span> <span class="st">'distance'</span> <span class="kw">in</span> var]</span>
<span id="cb31-1580"><a href="#cb31-1580" aria-hidden="true" tabindex="-1"></a>    position_vars <span class="op">=</span> [var <span class="cf">for</span> var <span class="kw">in</span> active_vars <span class="cf">if</span> <span class="bu">any</span>(x <span class="kw">in</span> var <span class="cf">for</span> x <span class="kw">in</span> [<span class="st">'_x'</span>, <span class="st">'_y'</span>, <span class="st">'approach_pos'</span>]) <span class="kw">and</span> <span class="st">'distance'</span> <span class="kw">not</span> <span class="kw">in</span> var]</span>
<span id="cb31-1581"><a href="#cb31-1581" aria-hidden="true" tabindex="-1"></a>    speed_vars <span class="op">=</span> [var <span class="cf">for</span> var <span class="kw">in</span> active_vars <span class="cf">if</span> <span class="st">'speed'</span> <span class="kw">in</span> var]</span>
<span id="cb31-1582"><a href="#cb31-1582" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1583"><a href="#cb31-1583" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate number of subplots needed</span></span>
<span id="cb31-1584"><a href="#cb31-1584" aria-hidden="true" tabindex="-1"></a>    n_plots <span class="op">=</span> <span class="bu">sum</span>([<span class="bu">len</span>(distance_vars) <span class="op">&gt;</span> <span class="dv">0</span>, <span class="bu">len</span>(position_vars) <span class="op">&gt;</span> <span class="dv">0</span>, <span class="bu">len</span>(speed_vars) <span class="op">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb31-1585"><a href="#cb31-1585" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1586"><a href="#cb31-1586" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_plots <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb31-1587"><a href="#cb31-1587" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb31-1588"><a href="#cb31-1588" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1589"><a href="#cb31-1589" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create figure with subplots</span></span>
<span id="cb31-1590"><a href="#cb31-1590" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(n_plots, <span class="dv">1</span>, figsize<span class="op">=</span>figsize, squeeze<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-1591"><a href="#cb31-1591" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> axes.flatten()</span>
<span id="cb31-1592"><a href="#cb31-1592" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1593"><a href="#cb31-1593" aria-hidden="true" tabindex="-1"></a>    plot_idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-1594"><a href="#cb31-1594" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1595"><a href="#cb31-1595" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Helper function to get consistent color and style</span></span>
<span id="cb31-1596"><a href="#cb31-1596" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_style(var_name):</span>
<span id="cb31-1597"><a href="#cb31-1597" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine person (p1/p2)</span></span>
<span id="cb31-1598"><a href="#cb31-1598" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'_p1_'</span> <span class="kw">in</span> var_name:</span>
<span id="cb31-1599"><a href="#cb31-1599" aria-hidden="true" tabindex="-1"></a>            person <span class="op">=</span> <span class="st">'p1'</span></span>
<span id="cb31-1600"><a href="#cb31-1600" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'_p2_'</span> <span class="kw">in</span> var_name:</span>
<span id="cb31-1601"><a href="#cb31-1601" aria-hidden="true" tabindex="-1"></a>            person <span class="op">=</span> <span class="st">'p2'</span></span>
<span id="cb31-1602"><a href="#cb31-1602" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-1603"><a href="#cb31-1603" aria-hidden="true" tabindex="-1"></a>            person <span class="op">=</span> <span class="st">'other'</span></span>
<span id="cb31-1604"><a href="#cb31-1604" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1605"><a href="#cb31-1605" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine side (left/right)</span></span>
<span id="cb31-1606"><a href="#cb31-1606" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'left'</span> <span class="kw">in</span> var_name:</span>
<span id="cb31-1607"><a href="#cb31-1607" aria-hidden="true" tabindex="-1"></a>            side <span class="op">=</span> <span class="st">'left'</span></span>
<span id="cb31-1608"><a href="#cb31-1608" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'right'</span> <span class="kw">in</span> var_name:</span>
<span id="cb31-1609"><a href="#cb31-1609" aria-hidden="true" tabindex="-1"></a>            side <span class="op">=</span> <span class="st">'right'</span></span>
<span id="cb31-1610"><a href="#cb31-1610" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-1611"><a href="#cb31-1611" aria-hidden="true" tabindex="-1"></a>            side <span class="op">=</span> <span class="st">'other'</span></span>
<span id="cb31-1612"><a href="#cb31-1612" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1613"><a href="#cb31-1613" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get color</span></span>
<span id="cb31-1614"><a href="#cb31-1614" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> person <span class="op">==</span> <span class="st">'p1'</span>:</span>
<span id="cb31-1615"><a href="#cb31-1615" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> p1_colors.get(side, p1_colors[<span class="st">'left'</span>])</span>
<span id="cb31-1616"><a href="#cb31-1616" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> person <span class="op">==</span> <span class="st">'p2'</span>:</span>
<span id="cb31-1617"><a href="#cb31-1617" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> p2_colors.get(side, p2_colors[<span class="st">'left'</span>])</span>
<span id="cb31-1618"><a href="#cb31-1618" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-1619"><a href="#cb31-1619" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> other_colors[<span class="dv">0</span>]  <span class="co"># Use first color for non-person variables</span></span>
<span id="cb31-1620"><a href="#cb31-1620" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1621"><a href="#cb31-1621" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get linestyle (solid for left, dashed for right)</span></span>
<span id="cb31-1622"><a href="#cb31-1622" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> side <span class="op">==</span> <span class="st">'right'</span>:</span>
<span id="cb31-1623"><a href="#cb31-1623" aria-hidden="true" tabindex="-1"></a>            linestyle <span class="op">=</span> <span class="st">'--'</span></span>
<span id="cb31-1624"><a href="#cb31-1624" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-1625"><a href="#cb31-1625" aria-hidden="true" tabindex="-1"></a>            linestyle <span class="op">=</span> <span class="st">'-'</span></span>
<span id="cb31-1626"><a href="#cb31-1626" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1627"><a href="#cb31-1627" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get alpha (lower for raw data, full for smoothed)</span></span>
<span id="cb31-1628"><a href="#cb31-1628" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'smooth'</span> <span class="kw">in</span> var_name:</span>
<span id="cb31-1629"><a href="#cb31-1629" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb31-1630"><a href="#cb31-1630" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">any</span>(x <span class="kw">in</span> var_name <span class="cf">for</span> x <span class="kw">in</span> [<span class="st">'speed'</span>, <span class="st">'velocity'</span>]) <span class="kw">and</span> <span class="st">'smooth'</span> <span class="kw">not</span> <span class="kw">in</span> var_name:</span>
<span id="cb31-1631"><a href="#cb31-1631" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb31-1632"><a href="#cb31-1632" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb31-1633"><a href="#cb31-1633" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb31-1634"><a href="#cb31-1634" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1635"><a href="#cb31-1635" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> color, linestyle, alpha</span>
<span id="cb31-1636"><a href="#cb31-1636" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1637"><a href="#cb31-1637" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Distance Plots</span></span>
<span id="cb31-1638"><a href="#cb31-1638" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> distance_vars:</span>
<span id="cb31-1639"><a href="#cb31-1639" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> axes[plot_idx]</span>
<span id="cb31-1640"><a href="#cb31-1640" aria-hidden="true" tabindex="-1"></a>        color_idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-1641"><a href="#cb31-1641" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> distance_vars:</span>
<span id="cb31-1642"><a href="#cb31-1642" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(x <span class="kw">in</span> var <span class="cf">for</span> x <span class="kw">in</span> [<span class="st">'_p1_'</span>, <span class="st">'_p2_'</span>]):</span>
<span id="cb31-1643"><a href="#cb31-1643" aria-hidden="true" tabindex="-1"></a>                color, linestyle, alpha <span class="op">=</span> get_style(var)</span>
<span id="cb31-1644"><a href="#cb31-1644" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb31-1645"><a href="#cb31-1645" aria-hidden="true" tabindex="-1"></a>                color <span class="op">=</span> other_colors[color_idx <span class="op">%</span> <span class="bu">len</span>(other_colors)]</span>
<span id="cb31-1646"><a href="#cb31-1646" aria-hidden="true" tabindex="-1"></a>                linestyle <span class="op">=</span> <span class="st">'-'</span></span>
<span id="cb31-1647"><a href="#cb31-1647" aria-hidden="true" tabindex="-1"></a>                alpha <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb31-1648"><a href="#cb31-1648" aria-hidden="true" tabindex="-1"></a>                color_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb31-1649"><a href="#cb31-1649" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1650"><a href="#cb31-1650" aria-hidden="true" tabindex="-1"></a>            ax.plot(timeseries_data[<span class="st">'time'</span>], timeseries_data[var], </span>
<span id="cb31-1651"><a href="#cb31-1651" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span>var.replace(<span class="st">'_'</span>, <span class="st">' '</span>), linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb31-1652"><a href="#cb31-1652" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span>color, linestyle<span class="op">=</span>linestyle, alpha<span class="op">=</span>alpha)</span>
<span id="cb31-1653"><a href="#cb31-1653" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1654"><a href="#cb31-1654" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">'Distances Over Time'</span>)</span>
<span id="cb31-1655"><a href="#cb31-1655" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Distance'</span>)</span>
<span id="cb31-1656"><a href="#cb31-1656" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb31-1657"><a href="#cb31-1657" aria-hidden="true" tabindex="-1"></a>        ax.legend()</span>
<span id="cb31-1658"><a href="#cb31-1658" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'distance_shoulder_midpoint'</span> <span class="kw">in</span> distance_vars <span class="kw">or</span> <span class="st">'distance'</span> <span class="kw">in</span> distance_vars:</span>
<span id="cb31-1659"><a href="#cb31-1659" aria-hidden="true" tabindex="-1"></a>            ax.invert_yaxis()</span>
<span id="cb31-1660"><a href="#cb31-1660" aria-hidden="true" tabindex="-1"></a>        plot_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb31-1661"><a href="#cb31-1661" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1662"><a href="#cb31-1662" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Position Plots (group p1/p2 and left/right together)</span></span>
<span id="cb31-1663"><a href="#cb31-1663" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> position_vars:</span>
<span id="cb31-1664"><a href="#cb31-1664" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> axes[plot_idx]</span>
<span id="cb31-1665"><a href="#cb31-1665" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1666"><a href="#cb31-1666" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> position_vars:</span>
<span id="cb31-1667"><a href="#cb31-1667" aria-hidden="true" tabindex="-1"></a>            color, linestyle, alpha <span class="op">=</span> get_style(var)</span>
<span id="cb31-1668"><a href="#cb31-1668" aria-hidden="true" tabindex="-1"></a>            ax.plot(timeseries_data[<span class="st">'time'</span>], timeseries_data[var], </span>
<span id="cb31-1669"><a href="#cb31-1669" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span>var.replace(<span class="st">'_'</span>, <span class="st">' '</span>), linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb31-1670"><a href="#cb31-1670" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span>color, linestyle<span class="op">=</span>linestyle, alpha<span class="op">=</span>alpha)</span>
<span id="cb31-1671"><a href="#cb31-1671" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1672"><a href="#cb31-1672" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">'Positions Over Time'</span>)</span>
<span id="cb31-1673"><a href="#cb31-1673" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Position'</span>)</span>
<span id="cb31-1674"><a href="#cb31-1674" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb31-1675"><a href="#cb31-1675" aria-hidden="true" tabindex="-1"></a>        ax.legend()</span>
<span id="cb31-1676"><a href="#cb31-1676" aria-hidden="true" tabindex="-1"></a>        plot_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb31-1677"><a href="#cb31-1677" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1678"><a href="#cb31-1678" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Speed Plots (group p1/p2 and left/right together)</span></span>
<span id="cb31-1679"><a href="#cb31-1679" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> speed_vars:</span>
<span id="cb31-1680"><a href="#cb31-1680" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> axes[plot_idx]</span>
<span id="cb31-1681"><a href="#cb31-1681" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1682"><a href="#cb31-1682" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> var <span class="kw">in</span> speed_vars:</span>
<span id="cb31-1683"><a href="#cb31-1683" aria-hidden="true" tabindex="-1"></a>            color, linestyle, alpha <span class="op">=</span> get_style(var)</span>
<span id="cb31-1684"><a href="#cb31-1684" aria-hidden="true" tabindex="-1"></a>            ax.plot(timeseries_data[<span class="st">'time'</span>], timeseries_data[var], </span>
<span id="cb31-1685"><a href="#cb31-1685" aria-hidden="true" tabindex="-1"></a>                   label<span class="op">=</span>var.replace(<span class="st">'_'</span>, <span class="st">' '</span>), linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb31-1686"><a href="#cb31-1686" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span>color, linestyle<span class="op">=</span>linestyle, alpha<span class="op">=</span>alpha)</span>
<span id="cb31-1687"><a href="#cb31-1687" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1688"><a href="#cb31-1688" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">'Speeds Over Time'</span>)</span>
<span id="cb31-1689"><a href="#cb31-1689" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Speed'</span>)</span>
<span id="cb31-1690"><a href="#cb31-1690" aria-hidden="true" tabindex="-1"></a>        ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb31-1691"><a href="#cb31-1691" aria-hidden="true" tabindex="-1"></a>        ax.legend()</span>
<span id="cb31-1692"><a href="#cb31-1692" aria-hidden="true" tabindex="-1"></a>        plot_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb31-1693"><a href="#cb31-1693" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1694"><a href="#cb31-1694" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add vertical line for current time if specified</span></span>
<span id="cb31-1695"><a href="#cb31-1695" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current_time <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb31-1696"><a href="#cb31-1696" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ax <span class="kw">in</span> axes[:plot_idx]:</span>
<span id="cb31-1697"><a href="#cb31-1697" aria-hidden="true" tabindex="-1"></a>            ax.axvline(x<span class="op">=</span>current_time, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-1698"><a href="#cb31-1698" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1699"><a href="#cb31-1699" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set common x-label</span></span>
<span id="cb31-1700"><a href="#cb31-1700" aria-hidden="true" tabindex="-1"></a>    axes[plot_idx<span class="op">-</span><span class="dv">1</span>].set_xlabel(<span class="st">'Time (seconds)'</span>)</span>
<span id="cb31-1701"><a href="#cb31-1701" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1702"><a href="#cb31-1702" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust layout</span></span>
<span id="cb31-1703"><a href="#cb31-1703" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb31-1704"><a href="#cb31-1704" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1705"><a href="#cb31-1705" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span>
<span id="cb31-1706"><a href="#cb31-1706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1707"><a href="#cb31-1707" aria-hidden="true" tabindex="-1"></a><span class="co"># Create animation for each video</span></span>
<span id="cb31-1708"><a href="#cb31-1708" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> vids <span class="kw">in</span> allvidsnew:</span>
<span id="cb31-1709"><a href="#cb31-1709" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> os.path.basename(vids)</span>
<span id="cb31-1710"><a href="#cb31-1710" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remove substring "_annotated_layer1"</span></span>
<span id="cb31-1711"><a href="#cb31-1711" aria-hidden="true" tabindex="-1"></a>    lab <span class="op">=</span> <span class="st">"_annotated_layer1"</span></span>
<span id="cb31-1712"><a href="#cb31-1712" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> vidname.replace(lab, <span class="st">""</span>)     </span>
<span id="cb31-1713"><a href="#cb31-1713" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> vidname[:<span class="op">-</span><span class="dv">4</span>]</span>
<span id="cb31-1714"><a href="#cb31-1714" aria-hidden="true" tabindex="-1"></a>    <span class="co"># also remove substring "_c150_miss95"</span></span>
<span id="cb31-1715"><a href="#cb31-1715" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> vidname.replace(<span class="st">"_c150_miss95"</span>, <span class="st">""</span>)</span>
<span id="cb31-1716"><a href="#cb31-1716" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1717"><a href="#cb31-1717" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing video: </span><span class="sc">{</span>vidname<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1718"><a href="#cb31-1718" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1719"><a href="#cb31-1719" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1720"><a href="#cb31-1720" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if CSV file exists</span></span>
<span id="cb31-1721"><a href="#cb31-1721" aria-hidden="true" tabindex="-1"></a>    csv_path <span class="op">=</span> os.path.join(INPUT_LAYER1_PATH, <span class="ss">f'</span><span class="sc">{</span>vidname<span class="sc">}</span><span class="ss">_processed_data_layer2.csv'</span>)</span>
<span id="cb31-1722"><a href="#cb31-1722" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(csv_path):</span>
<span id="cb31-1723"><a href="#cb31-1723" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"CSV file not found: </span><span class="sc">{</span>csv_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1724"><a href="#cb31-1724" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb31-1725"><a href="#cb31-1725" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1726"><a href="#cb31-1726" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the CSV file</span></span>
<span id="cb31-1727"><a href="#cb31-1727" aria-hidden="true" tabindex="-1"></a>    timeseries_data <span class="op">=</span> pd.read_csv(csv_path)</span>
<span id="cb31-1728"><a href="#cb31-1728" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1729"><a href="#cb31-1729" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output paths</span></span>
<span id="cb31-1730"><a href="#cb31-1730" aria-hidden="true" tabindex="-1"></a>    temp_output <span class="op">=</span> os.path.join(OUTPUT_PATH, <span class="ss">f'</span><span class="sc">{</span>vidname<span class="sc">}</span><span class="ss">_distance_layer2_temp.mp4'</span>)</span>
<span id="cb31-1731"><a href="#cb31-1731" aria-hidden="true" tabindex="-1"></a>    final_output <span class="op">=</span> os.path.join(OUTPUT_PATH, <span class="ss">f'</span><span class="sc">{</span>vidname<span class="sc">}</span><span class="ss">_distance_layer2.mp4'</span>)</span>
<span id="cb31-1732"><a href="#cb31-1732" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1733"><a href="#cb31-1733" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if already exists, skip</span></span>
<span id="cb31-1734"><a href="#cb31-1734" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(final_output):</span>
<span id="cb31-1735"><a href="#cb31-1735" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Already processed, skipping..."</span>)</span>
<span id="cb31-1736"><a href="#cb31-1736" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb31-1737"><a href="#cb31-1737" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1738"><a href="#cb31-1738" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load the video file in opencv</span></span>
<span id="cb31-1739"><a href="#cb31-1739" aria-hidden="true" tabindex="-1"></a>    cap <span class="op">=</span> cv2.VideoCapture(vids)</span>
<span id="cb31-1740"><a href="#cb31-1740" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> cap.isOpened():</span>
<span id="cb31-1741"><a href="#cb31-1741" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error opening video: </span><span class="sc">{</span>vids<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1742"><a href="#cb31-1742" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb31-1743"><a href="#cb31-1743" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1744"><a href="#cb31-1744" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get video properties</span></span>
<span id="cb31-1745"><a href="#cb31-1745" aria-hidden="true" tabindex="-1"></a>    fps <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FPS))</span>
<span id="cb31-1746"><a href="#cb31-1746" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span>
<span id="cb31-1747"><a href="#cb31-1747" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span>
<span id="cb31-1748"><a href="#cb31-1748" aria-hidden="true" tabindex="-1"></a>    total_frames <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span>
<span id="cb31-1749"><a href="#cb31-1749" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1750"><a href="#cb31-1750" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Video properties: </span><span class="sc">{</span>width<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>height<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>fps<span class="sc">}</span><span class="ss"> FPS, </span><span class="sc">{</span>total_frames<span class="sc">}</span><span class="ss"> frames"</span>)</span>
<span id="cb31-1751"><a href="#cb31-1751" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1752"><a href="#cb31-1752" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate time step based on FPS</span></span>
<span id="cb31-1753"><a href="#cb31-1753" aria-hidden="true" tabindex="-1"></a>    time_step <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> fps</span>
<span id="cb31-1754"><a href="#cb31-1754" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Time step: </span><span class="sc">{</span>time_step<span class="sc">:.4f}</span><span class="ss"> seconds per frame"</span>)</span>
<span id="cb31-1755"><a href="#cb31-1755" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1756"><a href="#cb31-1756" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the output video writer</span></span>
<span id="cb31-1757"><a href="#cb31-1757" aria-hidden="true" tabindex="-1"></a>    fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span><span class="st">'mp4v'</span>)</span>
<span id="cb31-1758"><a href="#cb31-1758" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> cv2.VideoWriter(temp_output, fourcc, fps, (width, height))</span>
<span id="cb31-1759"><a href="#cb31-1759" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1760"><a href="#cb31-1760" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create temporary directory for plots</span></span>
<span id="cb31-1761"><a href="#cb31-1761" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> tempfile.TemporaryDirectory() <span class="im">as</span> temp_dir:</span>
<span id="cb31-1762"><a href="#cb31-1762" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Creating animated video..."</span>)</span>
<span id="cb31-1763"><a href="#cb31-1763" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1764"><a href="#cb31-1764" aria-hidden="true" tabindex="-1"></a>        <span class="co"># loop over the frames with tqdm progress bar</span></span>
<span id="cb31-1765"><a href="#cb31-1765" aria-hidden="true" tabindex="-1"></a>        current_time <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Start at time 0</span></span>
<span id="cb31-1766"><a href="#cb31-1766" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> frame_idx <span class="kw">in</span> tqdm.tqdm(<span class="bu">range</span>(total_frames), desc<span class="op">=</span><span class="ss">f"Processing </span><span class="sc">{</span>vidname<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb31-1767"><a href="#cb31-1767" aria-hidden="true" tabindex="-1"></a>            <span class="co"># read the frame</span></span>
<span id="cb31-1768"><a href="#cb31-1768" aria-hidden="true" tabindex="-1"></a>            success, frame <span class="op">=</span> cap.read()</span>
<span id="cb31-1769"><a href="#cb31-1769" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb31-1770"><a href="#cb31-1770" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb31-1771"><a href="#cb31-1771" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1772"><a href="#cb31-1772" aria-hidden="true" tabindex="-1"></a>            <span class="co"># plot the timeseries with current time</span></span>
<span id="cb31-1773"><a href="#cb31-1773" aria-hidden="true" tabindex="-1"></a>            fig <span class="op">=</span> plot_timeseries(timeseries_data, current_time)</span>
<span id="cb31-1774"><a href="#cb31-1774" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> fig <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-1775"><a href="#cb31-1775" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"No plot generated, skipping frame"</span>)</span>
<span id="cb31-1776"><a href="#cb31-1776" aria-hidden="true" tabindex="-1"></a>                out.write(frame)</span>
<span id="cb31-1777"><a href="#cb31-1777" aria-hidden="true" tabindex="-1"></a>                current_time <span class="op">+=</span> time_step  <span class="co"># Increment by time step</span></span>
<span id="cb31-1778"><a href="#cb31-1778" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb31-1779"><a href="#cb31-1779" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1780"><a href="#cb31-1780" aria-hidden="true" tabindex="-1"></a>            <span class="co"># save the plot to a temp file</span></span>
<span id="cb31-1781"><a href="#cb31-1781" aria-hidden="true" tabindex="-1"></a>            plot_path <span class="op">=</span> os.path.join(temp_dir, <span class="ss">f'plot_</span><span class="sc">{</span>frame_idx<span class="sc">:06d}</span><span class="ss">.png'</span>)</span>
<span id="cb31-1782"><a href="#cb31-1782" aria-hidden="true" tabindex="-1"></a>            fig.savefig(plot_path, dpi<span class="op">=</span><span class="dv">100</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb31-1783"><a href="#cb31-1783" aria-hidden="true" tabindex="-1"></a>            plt.close(fig)  <span class="co"># Important: close figure to free memory</span></span>
<span id="cb31-1784"><a href="#cb31-1784" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1785"><a href="#cb31-1785" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Read the plot image</span></span>
<span id="cb31-1786"><a href="#cb31-1786" aria-hidden="true" tabindex="-1"></a>            plot_img <span class="op">=</span> cv2.imread(plot_path)</span>
<span id="cb31-1787"><a href="#cb31-1787" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> plot_img <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-1788"><a href="#cb31-1788" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Error reading plot image: </span><span class="sc">{</span>plot_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1789"><a href="#cb31-1789" aria-hidden="true" tabindex="-1"></a>                out.write(frame)</span>
<span id="cb31-1790"><a href="#cb31-1790" aria-hidden="true" tabindex="-1"></a>                current_time <span class="op">+=</span> time_step  <span class="co"># Increment by time step</span></span>
<span id="cb31-1791"><a href="#cb31-1791" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb31-1792"><a href="#cb31-1792" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1793"><a href="#cb31-1793" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate overlay area (bottom third of the frame)</span></span>
<span id="cb31-1794"><a href="#cb31-1794" aria-hidden="true" tabindex="-1"></a>            slice_start <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (height <span class="op">//</span> <span class="dv">3</span>)</span>
<span id="cb31-1795"><a href="#cb31-1795" aria-hidden="true" tabindex="-1"></a>            slice_height <span class="op">=</span> height <span class="op">-</span> slice_start</span>
<span id="cb31-1796"><a href="#cb31-1796" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1797"><a href="#cb31-1797" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Resize plot to fit overlay area</span></span>
<span id="cb31-1798"><a href="#cb31-1798" aria-hidden="true" tabindex="-1"></a>            plot_img_resized <span class="op">=</span> cv2.resize(plot_img, (width, slice_height))</span>
<span id="cb31-1799"><a href="#cb31-1799" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1800"><a href="#cb31-1800" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create overlay on the frame</span></span>
<span id="cb31-1801"><a href="#cb31-1801" aria-hidden="true" tabindex="-1"></a>            frame_copy <span class="op">=</span> frame.copy()</span>
<span id="cb31-1802"><a href="#cb31-1802" aria-hidden="true" tabindex="-1"></a>            frame_copy[slice_start:slice_start <span class="op">+</span> slice_height, :, :] <span class="op">=</span> plot_img_resized</span>
<span id="cb31-1803"><a href="#cb31-1803" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1804"><a href="#cb31-1804" aria-hidden="true" tabindex="-1"></a>            <span class="co"># write the frame to the output video</span></span>
<span id="cb31-1805"><a href="#cb31-1805" aria-hidden="true" tabindex="-1"></a>            out.write(frame_copy)</span>
<span id="cb31-1806"><a href="#cb31-1806" aria-hidden="true" tabindex="-1"></a>            current_time <span class="op">+=</span> time_step  <span class="co"># Increment by time step (seconds)</span></span>
<span id="cb31-1807"><a href="#cb31-1807" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1808"><a href="#cb31-1808" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Release everything</span></span>
<span id="cb31-1809"><a href="#cb31-1809" aria-hidden="true" tabindex="-1"></a>        cap.release()</span>
<span id="cb31-1810"><a href="#cb31-1810" aria-hidden="true" tabindex="-1"></a>        out.release()</span>
<span id="cb31-1811"><a href="#cb31-1811" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1812"><a href="#cb31-1812" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Temporary video saved, now re-encoding with MoviePy..."</span>)</span>
<span id="cb31-1813"><a href="#cb31-1813" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1814"><a href="#cb31-1814" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Re-encode with MoviePy for better compatibility</span></span>
<span id="cb31-1815"><a href="#cb31-1815" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb31-1816"><a href="#cb31-1816" aria-hidden="true" tabindex="-1"></a>        clip <span class="op">=</span> VideoFileClip(temp_output)</span>
<span id="cb31-1817"><a href="#cb31-1817" aria-hidden="true" tabindex="-1"></a>        clip.write_videofile(final_output, codec<span class="op">=</span><span class="st">'libx264'</span>, audio_codec<span class="op">=</span><span class="st">'aac'</span>)</span>
<span id="cb31-1818"><a href="#cb31-1818" aria-hidden="true" tabindex="-1"></a>        clip.close()</span>
<span id="cb31-1819"><a href="#cb31-1819" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1820"><a href="#cb31-1820" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove temporary file</span></span>
<span id="cb31-1821"><a href="#cb31-1821" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(temp_output):</span>
<span id="cb31-1822"><a href="#cb31-1822" aria-hidden="true" tabindex="-1"></a>            os.remove(temp_output)</span>
<span id="cb31-1823"><a href="#cb31-1823" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-1824"><a href="#cb31-1824" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Final output video saved as </span><span class="sc">{</span>final_output<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1825"><a href="#cb31-1825" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-1826"><a href="#cb31-1826" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb31-1827"><a href="#cb31-1827" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error during MoviePy re-encoding: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1828"><a href="#cb31-1828" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Temporary video available at: </span><span class="sc">{</span>temp_output<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1829"><a href="#cb31-1829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1830"><a href="#cb31-1830" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">All videos processed!"</span>)</span>
<span id="cb31-1831"><a href="#cb31-1831" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1832"><a href="#cb31-1832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1833"><a href="#cb31-1833" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-1834"><a href="#cb31-1834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1835"><a href="#cb31-1835" aria-hidden="true" tabindex="-1"></a><span class="al">![Animation of motion tracking data coupled with video](./images/com_distance_example.gif)</span></span>
<span id="cb31-1836"><a href="#cb31-1836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1837"><a href="#cb31-1837" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 2: Summary feature extraction: Smoothness and other features</span></span>
<span id="cb31-1838"><a href="#cb31-1838" aria-hidden="true" tabindex="-1"></a>We have motivated in the main paper accompanying this notebook that smoothness can be a useful feature to understand the quality of interactions. And our pipeline focuses on the extraction of this specific feature, while we also show how easy it is to generate other features from the time series data that are processed after step 1.</span>
<span id="cb31-1839"><a href="#cb31-1839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1840"><a href="#cb31-1840" aria-hidden="true" tabindex="-1"></a>We take two approaches to quantify smoothness of the movement data. The first approach is based on the spectral arc length metric, which has been shown to be a stable measure of smoothness for prolonged (quasi-cyclical) time series data <span class="co">[</span><span class="ot">@balasubramanianAnalysisMovementSmoothness2015</span><span class="co">]</span>. The approach is based on analyzing the frequency spectrum, specifically the changes in energy over the different frequencies, for the lower frequencies (&lt; 10Hz; but this can be set by the user). Specifally it calculates the spectral arc length (distance of two points along a curve) from Fourier magnitude spectrum of the speed data (or in our case changes in the distance or proximity positions). This code is directly copied from the <span class="co">[</span><span class="ot">original repository</span><span class="co">](https://github.com/siva82kb/smoothness)</span> by the lead developer of the metric, Sivak Balasubramanian. We refer to the <span class="co">[</span><span class="ot">@balasubramanianAnalysisMovementSmoothness2015</span><span class="co">]</span> for further details and validation of this novel measure of smoothness. As can be seen, the higher values of the spectral arc length indicate smoother movements, while lower values indicate more jerky movements.</span>
<span id="cb31-1841"><a href="#cb31-1841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1842"><a href="#cb31-1842" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-1843"><a href="#cb31-1843" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pipeline code step 2, function for calculating spectral arc length üö© </span></span>
<span id="cb31-1844"><a href="#cb31-1844" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, code_folding="hide"}</span></span>
<span id="cb31-1845"><a href="#cb31-1845" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-1846"><a href="#cb31-1846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1847"><a href="#cb31-1847" aria-hidden="true" tabindex="-1"></a><span class="co"># directly copied from the original repository https://github.com/siva82kb/smoothness/blob/master/python/smoothness.py</span></span>
<span id="cb31-1848"><a href="#cb31-1848" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spectral_arclength(movement, fs, padlevel<span class="op">=</span><span class="dv">4</span>, fc<span class="op">=</span><span class="fl">10.0</span>, amp_th<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb31-1849"><a href="#cb31-1849" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-1850"><a href="#cb31-1850" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcualtes the smoothness of the given speed profile using the modified spectral</span></span>
<span id="cb31-1851"><a href="#cb31-1851" aria-hidden="true" tabindex="-1"></a><span class="co">    arc length metric.</span></span>
<span id="cb31-1852"><a href="#cb31-1852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1853"><a href="#cb31-1853" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb31-1854"><a href="#cb31-1854" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb31-1855"><a href="#cb31-1855" aria-hidden="true" tabindex="-1"></a><span class="co">    movement : np.array</span></span>
<span id="cb31-1856"><a href="#cb31-1856" aria-hidden="true" tabindex="-1"></a><span class="co">               The array containing the movement speed profile.</span></span>
<span id="cb31-1857"><a href="#cb31-1857" aria-hidden="true" tabindex="-1"></a><span class="co">    fs       : float</span></span>
<span id="cb31-1858"><a href="#cb31-1858" aria-hidden="true" tabindex="-1"></a><span class="co">               The sampling frequency of the data.</span></span>
<span id="cb31-1859"><a href="#cb31-1859" aria-hidden="true" tabindex="-1"></a><span class="co">    padlevel : integer, optional</span></span>
<span id="cb31-1860"><a href="#cb31-1860" aria-hidden="true" tabindex="-1"></a><span class="co">               Indicates the amount of zero padding to be done to the movement</span></span>
<span id="cb31-1861"><a href="#cb31-1861" aria-hidden="true" tabindex="-1"></a><span class="co">               data for estimating the spectral arc length. [default = 4]</span></span>
<span id="cb31-1862"><a href="#cb31-1862" aria-hidden="true" tabindex="-1"></a><span class="co">    fc       : float, optional</span></span>
<span id="cb31-1863"><a href="#cb31-1863" aria-hidden="true" tabindex="-1"></a><span class="co">               The max. cut off frequency for calculating the spectral arc</span></span>
<span id="cb31-1864"><a href="#cb31-1864" aria-hidden="true" tabindex="-1"></a><span class="co">               length metric. [default = 10.]</span></span>
<span id="cb31-1865"><a href="#cb31-1865" aria-hidden="true" tabindex="-1"></a><span class="co">    amp_th   : float, optional</span></span>
<span id="cb31-1866"><a href="#cb31-1866" aria-hidden="true" tabindex="-1"></a><span class="co">               The amplitude threshold to used for determing the cut off</span></span>
<span id="cb31-1867"><a href="#cb31-1867" aria-hidden="true" tabindex="-1"></a><span class="co">               frequency upto which the spectral arc length is to be estimated.</span></span>
<span id="cb31-1868"><a href="#cb31-1868" aria-hidden="true" tabindex="-1"></a><span class="co">               [default = 0.05]</span></span>
<span id="cb31-1869"><a href="#cb31-1869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1870"><a href="#cb31-1870" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb31-1871"><a href="#cb31-1871" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb31-1872"><a href="#cb31-1872" aria-hidden="true" tabindex="-1"></a><span class="co">    sal      : float</span></span>
<span id="cb31-1873"><a href="#cb31-1873" aria-hidden="true" tabindex="-1"></a><span class="co">               The spectral arc length estimate of the given movement's</span></span>
<span id="cb31-1874"><a href="#cb31-1874" aria-hidden="true" tabindex="-1"></a><span class="co">               smoothness.</span></span>
<span id="cb31-1875"><a href="#cb31-1875" aria-hidden="true" tabindex="-1"></a><span class="co">    (f, Mf)  : tuple of two np.arrays</span></span>
<span id="cb31-1876"><a href="#cb31-1876" aria-hidden="true" tabindex="-1"></a><span class="co">               This is the frequency(f) and the magntiude spectrum(Mf) of the</span></span>
<span id="cb31-1877"><a href="#cb31-1877" aria-hidden="true" tabindex="-1"></a><span class="co">               given movement data. This spectral is from 0. to fs/2.</span></span>
<span id="cb31-1878"><a href="#cb31-1878" aria-hidden="true" tabindex="-1"></a><span class="co">    (f_sel, Mf_sel) : tuple of two np.arrays</span></span>
<span id="cb31-1879"><a href="#cb31-1879" aria-hidden="true" tabindex="-1"></a><span class="co">                      This is the portion of the spectrum that is selected for</span></span>
<span id="cb31-1880"><a href="#cb31-1880" aria-hidden="true" tabindex="-1"></a><span class="co">                      calculating the spectral arc length.</span></span>
<span id="cb31-1881"><a href="#cb31-1881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1882"><a href="#cb31-1882" aria-hidden="true" tabindex="-1"></a><span class="co">    Notes</span></span>
<span id="cb31-1883"><a href="#cb31-1883" aria-hidden="true" tabindex="-1"></a><span class="co">    -----</span></span>
<span id="cb31-1884"><a href="#cb31-1884" aria-hidden="true" tabindex="-1"></a><span class="co">    This is the modfieid spectral arc length metric, which has been tested only</span></span>
<span id="cb31-1885"><a href="#cb31-1885" aria-hidden="true" tabindex="-1"></a><span class="co">    for discrete movements.</span></span>
<span id="cb31-1886"><a href="#cb31-1886" aria-hidden="true" tabindex="-1"></a><span class="co">    It is suitable for movements that are a few seconds long, but for long</span></span>
<span id="cb31-1887"><a href="#cb31-1887" aria-hidden="true" tabindex="-1"></a><span class="co">    movements it might be slow and results might not make sense (like any other</span></span>
<span id="cb31-1888"><a href="#cb31-1888" aria-hidden="true" tabindex="-1"></a><span class="co">    smoothness metric).</span></span>
<span id="cb31-1889"><a href="#cb31-1889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1890"><a href="#cb31-1890" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb31-1891"><a href="#cb31-1891" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb31-1892"><a href="#cb31-1892" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; t = np.arange(-1, 1, 0.01)</span></span>
<span id="cb31-1893"><a href="#cb31-1893" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; move = np.exp(-5*pow(t, 2))</span></span>
<span id="cb31-1894"><a href="#cb31-1894" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; sal, _, _ = spectral_arclength(move, fs=100.)</span></span>
<span id="cb31-1895"><a href="#cb31-1895" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; '%.5f' % sal</span></span>
<span id="cb31-1896"><a href="#cb31-1896" aria-hidden="true" tabindex="-1"></a><span class="co">    '-1.41403'</span></span>
<span id="cb31-1897"><a href="#cb31-1897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1898"><a href="#cb31-1898" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-1899"><a href="#cb31-1899" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of zeros to be padded.</span></span>
<span id="cb31-1900"><a href="#cb31-1900" aria-hidden="true" tabindex="-1"></a>    nfft <span class="op">=</span> <span class="bu">int</span>(<span class="bu">pow</span>(<span class="dv">2</span>, np.ceil(np.log2(<span class="bu">len</span>(movement))) <span class="op">+</span> padlevel))</span>
<span id="cb31-1901"><a href="#cb31-1901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1902"><a href="#cb31-1902" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Frequency</span></span>
<span id="cb31-1903"><a href="#cb31-1903" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> np.arange(<span class="dv">0</span>, fs, fs<span class="op">/</span>nfft)</span>
<span id="cb31-1904"><a href="#cb31-1904" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalized magnitude spectrum</span></span>
<span id="cb31-1905"><a href="#cb31-1905" aria-hidden="true" tabindex="-1"></a>    Mf <span class="op">=</span> <span class="bu">abs</span>(np.fft.fft(movement, nfft))</span>
<span id="cb31-1906"><a href="#cb31-1906" aria-hidden="true" tabindex="-1"></a>    Mf <span class="op">=</span> Mf<span class="op">/</span><span class="bu">max</span>(Mf)</span>
<span id="cb31-1907"><a href="#cb31-1907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1908"><a href="#cb31-1908" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Indices to choose only the spectrum within the given cut off frequency Fc.</span></span>
<span id="cb31-1909"><a href="#cb31-1909" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: This is a low pass filtering operation to get rid of high frequency</span></span>
<span id="cb31-1910"><a href="#cb31-1910" aria-hidden="true" tabindex="-1"></a>    <span class="co"># noise from affecting the next step (amplitude threshold based cut off for</span></span>
<span id="cb31-1911"><a href="#cb31-1911" aria-hidden="true" tabindex="-1"></a>    <span class="co"># arc length calculation).</span></span>
<span id="cb31-1912"><a href="#cb31-1912" aria-hidden="true" tabindex="-1"></a>    fc_inx <span class="op">=</span> ((f <span class="op">&lt;=</span> fc)<span class="op">*</span><span class="dv">1</span>).nonzero()</span>
<span id="cb31-1913"><a href="#cb31-1913" aria-hidden="true" tabindex="-1"></a>    f_sel <span class="op">=</span> f[fc_inx]</span>
<span id="cb31-1914"><a href="#cb31-1914" aria-hidden="true" tabindex="-1"></a>    Mf_sel <span class="op">=</span> Mf[fc_inx]</span>
<span id="cb31-1915"><a href="#cb31-1915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1916"><a href="#cb31-1916" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose the amplitude threshold based cut off frequency.</span></span>
<span id="cb31-1917"><a href="#cb31-1917" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Index of the last point on the magnitude spectrum that is greater than</span></span>
<span id="cb31-1918"><a href="#cb31-1918" aria-hidden="true" tabindex="-1"></a>    <span class="co"># or equal to the amplitude threshold.</span></span>
<span id="cb31-1919"><a href="#cb31-1919" aria-hidden="true" tabindex="-1"></a>    inx <span class="op">=</span> ((Mf_sel <span class="op">&gt;=</span> amp_th)<span class="op">*</span><span class="dv">1</span>).nonzero()[<span class="dv">0</span>]</span>
<span id="cb31-1920"><a href="#cb31-1920" aria-hidden="true" tabindex="-1"></a>    fc_inx <span class="op">=</span> <span class="bu">range</span>(inx[<span class="dv">0</span>], inx[<span class="op">-</span><span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb31-1921"><a href="#cb31-1921" aria-hidden="true" tabindex="-1"></a>    f_sel <span class="op">=</span> f_sel[fc_inx]</span>
<span id="cb31-1922"><a href="#cb31-1922" aria-hidden="true" tabindex="-1"></a>    Mf_sel <span class="op">=</span> Mf_sel[fc_inx]</span>
<span id="cb31-1923"><a href="#cb31-1923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1924"><a href="#cb31-1924" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate arc length</span></span>
<span id="cb31-1925"><a href="#cb31-1925" aria-hidden="true" tabindex="-1"></a>    new_sal <span class="op">=</span> <span class="op">-</span><span class="bu">sum</span>(np.sqrt(<span class="bu">pow</span>(np.diff(f_sel)<span class="op">/</span>(f_sel[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> f_sel[<span class="dv">0</span>]), <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb31-1926"><a href="#cb31-1926" aria-hidden="true" tabindex="-1"></a>                           <span class="bu">pow</span>(np.diff(Mf_sel), <span class="dv">2</span>)))</span>
<span id="cb31-1927"><a href="#cb31-1927" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_sal, (f, Mf), (f_sel, Mf_sel)</span>
<span id="cb31-1928"><a href="#cb31-1928" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1929"><a href="#cb31-1929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1930"><a href="#cb31-1930" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-1931"><a href="#cb31-1931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1932"><a href="#cb31-1932" aria-hidden="true" tabindex="-1"></a>The second approach is based on the log dimensionless squared jerk metric, which is the traditional measure of smoothness in biomechanics <span class="co">[</span><span class="ot">@hoganSensitivitySmoothnessMeasures2009</span><span class="co">]</span>. Below the function that calculates the dimensionless squared jerk metric from position data.  This measure is based on taking the third derivative with respect to time (jerk), squared and integrated over the movement duration, and then normalized by the amplitude of the movement. The log of this value is taken keep the values in a reasonable range. </span>
<span id="cb31-1933"><a href="#cb31-1933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1934"><a href="#cb31-1934" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example smoothness results on simulated time series data</span></span>
<span id="cb31-1935"><a href="#cb31-1935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1936"><a href="#cb31-1936" aria-hidden="true" tabindex="-1"></a>In the below example we show how the two smoothness metrics behave for three different time series data. The first time series is a smooth sinusoidal signal, the second is a noisy version of the first, and the third is a more noisy version of the second. The spectral arc length metric should be higher for the smooth signal, while the dimensionless squared jerk metric should be lower for the smooth signal (as it is less jerky).</span>
<span id="cb31-1937"><a href="#cb31-1937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1938"><a href="#cb31-1938" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-1939"><a href="#cb31-1939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1940"><a href="#cb31-1940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1941"><a href="#cb31-1941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1942"><a href="#cb31-1942" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-1943"><a href="#cb31-1943" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pipeline code step 2, function for calculating log dimensionless jerk üö© </span></span>
<span id="cb31-1944"><a href="#cb31-1944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1945"><a href="#cb31-1945" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, code_folding="hide"}</span></span>
<span id="cb31-1946"><a href="#cb31-1946" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-1947"><a href="#cb31-1947" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> interpolate</span>
<span id="cb31-1948"><a href="#cb31-1948" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> savgol_filter</span>
<span id="cb31-1949"><a href="#cb31-1949" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-1950"><a href="#cb31-1950" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.integrate <span class="im">as</span> integrate</span>
<span id="cb31-1951"><a href="#cb31-1951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1952"><a href="#cb31-1952" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate the dimensionless squared jerk metric from position data</span></span>
<span id="cb31-1953"><a href="#cb31-1953" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dimensionless_squared_jerk_from_position(ts, time):</span>
<span id="cb31-1954"><a href="#cb31-1954" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-1955"><a href="#cb31-1955" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate the dimensionless squared jerk metric from position data.</span></span>
<span id="cb31-1956"><a href="#cb31-1956" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-1957"><a href="#cb31-1957" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb31-1958"><a href="#cb31-1958" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb31-1959"><a href="#cb31-1959" aria-hidden="true" tabindex="-1"></a><span class="co">    ts : array_like</span></span>
<span id="cb31-1960"><a href="#cb31-1960" aria-hidden="true" tabindex="-1"></a><span class="co">        Position data points, should be a 1D numpy array</span></span>
<span id="cb31-1961"><a href="#cb31-1961" aria-hidden="true" tabindex="-1"></a><span class="co">    time : array_like</span></span>
<span id="cb31-1962"><a href="#cb31-1962" aria-hidden="true" tabindex="-1"></a><span class="co">        Time points corresponding to the ts data, should be a 1D numpy array</span></span>
<span id="cb31-1963"><a href="#cb31-1963" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-1964"><a href="#cb31-1964" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb31-1965"><a href="#cb31-1965" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb31-1966"><a href="#cb31-1966" aria-hidden="true" tabindex="-1"></a><span class="co">    float</span></span>
<span id="cb31-1967"><a href="#cb31-1967" aria-hidden="true" tabindex="-1"></a><span class="co">        Dimensionless squared jerk metric or NaN if calculation fails</span></span>
<span id="cb31-1968"><a href="#cb31-1968" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-1969"><a href="#cb31-1969" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> np.mean(np.diff(time))  <span class="co"># Calculate time step from the time array</span></span>
<span id="cb31-1970"><a href="#cb31-1970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1971"><a href="#cb31-1971" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate speed (exactly as in original)</span></span>
<span id="cb31-1972"><a href="#cb31-1972" aria-hidden="true" tabindex="-1"></a>    speed <span class="op">=</span> np.gradient(ts, dt)</span>
<span id="cb31-1973"><a href="#cb31-1973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1974"><a href="#cb31-1974" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Smooth savgol filter (maintaining original settings)</span></span>
<span id="cb31-1975"><a href="#cb31-1975" aria-hidden="true" tabindex="-1"></a>    speed <span class="op">=</span> savgol_filter(speed, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb31-1976"><a href="#cb31-1976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1977"><a href="#cb31-1977" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate acceleration (exactly as in original)</span></span>
<span id="cb31-1978"><a href="#cb31-1978" aria-hidden="true" tabindex="-1"></a>    acceleration <span class="op">=</span> np.gradient(speed, dt)</span>
<span id="cb31-1979"><a href="#cb31-1979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1980"><a href="#cb31-1980" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Smooth (maintaining original settings)</span></span>
<span id="cb31-1981"><a href="#cb31-1981" aria-hidden="true" tabindex="-1"></a>    acceleration <span class="op">=</span> savgol_filter(acceleration, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb31-1982"><a href="#cb31-1982" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1983"><a href="#cb31-1983" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate jerk (exactly as in original)</span></span>
<span id="cb31-1984"><a href="#cb31-1984" aria-hidden="true" tabindex="-1"></a>    jerk <span class="op">=</span> np.gradient(acceleration, dt)</span>
<span id="cb31-1985"><a href="#cb31-1985" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1986"><a href="#cb31-1986" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Smooth (maintaining original settings)</span></span>
<span id="cb31-1987"><a href="#cb31-1987" aria-hidden="true" tabindex="-1"></a>    jerk <span class="op">=</span> savgol_filter(jerk, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb31-1988"><a href="#cb31-1988" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1989"><a href="#cb31-1989" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate movement duration (D)</span></span>
<span id="cb31-1990"><a href="#cb31-1990" aria-hidden="true" tabindex="-1"></a>    movement_duration <span class="op">=</span> time[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> time[<span class="dv">0</span>]</span>
<span id="cb31-1991"><a href="#cb31-1991" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1992"><a href="#cb31-1992" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> movement_duration <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb31-1993"><a href="#cb31-1993" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error: Movement duration must be positive. Got </span><span class="sc">{</span>movement_duration<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-1994"><a href="#cb31-1994" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb31-1995"><a href="#cb31-1995" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-1996"><a href="#cb31-1996" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate movement amplitude by integrating speed</span></span>
<span id="cb31-1997"><a href="#cb31-1997" aria-hidden="true" tabindex="-1"></a>    position <span class="op">=</span> integrate.simpson(speed, x<span class="op">=</span>time)</span>
<span id="cb31-1998"><a href="#cb31-1998" aria-hidden="true" tabindex="-1"></a>    movement_amplitude <span class="op">=</span> <span class="bu">abs</span>(position)  <span class="co"># Use absolute value to ensure positive</span></span>
<span id="cb31-1999"><a href="#cb31-1999" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2000"><a href="#cb31-2000" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prevent division by zero</span></span>
<span id="cb31-2001"><a href="#cb31-2001" aria-hidden="true" tabindex="-1"></a>    epsilon <span class="op">=</span> <span class="fl">1e-10</span></span>
<span id="cb31-2002"><a href="#cb31-2002" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> movement_amplitude <span class="op">&lt;</span> epsilon:</span>
<span id="cb31-2003"><a href="#cb31-2003" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Warning: Movement amplitude very small (</span><span class="sc">{</span>movement_amplitude<span class="sc">}</span><span class="ss">). Using epsilon."</span>)</span>
<span id="cb31-2004"><a href="#cb31-2004" aria-hidden="true" tabindex="-1"></a>        movement_amplitude <span class="op">=</span> epsilon</span>
<span id="cb31-2005"><a href="#cb31-2005" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2006"><a href="#cb31-2006" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the squared jerk</span></span>
<span id="cb31-2007"><a href="#cb31-2007" aria-hidden="true" tabindex="-1"></a>    squared_jerk <span class="op">=</span> jerk <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb31-2008"><a href="#cb31-2008" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2009"><a href="#cb31-2009" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Integrate the squared jerk</span></span>
<span id="cb31-2010"><a href="#cb31-2010" aria-hidden="true" tabindex="-1"></a>    integrated_squared_jerk <span class="op">=</span> integrate.simpson(squared_jerk, x<span class="op">=</span>time)</span>
<span id="cb31-2011"><a href="#cb31-2011" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2012"><a href="#cb31-2012" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure positive value for integral of squared jerk</span></span>
<span id="cb31-2013"><a href="#cb31-2013" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> integrated_squared_jerk <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb31-2014"><a href="#cb31-2014" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Warning: Negative integral of squared jerk: </span><span class="sc">{</span>integrated_squared_jerk<span class="sc">}</span><span class="ss">. Using absolute value."</span>)</span>
<span id="cb31-2015"><a href="#cb31-2015" aria-hidden="true" tabindex="-1"></a>        integrated_squared_jerk <span class="op">=</span> <span class="bu">abs</span>(integrated_squared_jerk)</span>
<span id="cb31-2016"><a href="#cb31-2016" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2017"><a href="#cb31-2017" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the dimensionless squared jerk</span></span>
<span id="cb31-2018"><a href="#cb31-2018" aria-hidden="true" tabindex="-1"></a>    dimensionless_jerk <span class="op">=</span> integrated_squared_jerk <span class="op">*</span> (movement_duration<span class="op">**</span><span class="dv">5</span> <span class="op">/</span> movement_amplitude<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb31-2019"><a href="#cb31-2019" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2020"><a href="#cb31-2020" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final sanity check</span></span>
<span id="cb31-2021"><a href="#cb31-2021" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.isnan(dimensionless_jerk) <span class="kw">or</span> np.isinf(dimensionless_jerk):</span>
<span id="cb31-2022"><a href="#cb31-2022" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Warning: Result is </span><span class="sc">{</span>dimensionless_jerk<span class="sc">}</span><span class="ss">. Details: "</span>)</span>
<span id="cb31-2023"><a href="#cb31-2023" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Movement duration: </span><span class="sc">{</span>movement_duration<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2024"><a href="#cb31-2024" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Movement amplitude: </span><span class="sc">{</span>movement_amplitude<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2025"><a href="#cb31-2025" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Integrated squared jerk: </span><span class="sc">{</span>integrated_squared_jerk<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2026"><a href="#cb31-2026" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb31-2027"><a href="#cb31-2027" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log the result</span></span>
<span id="cb31-2028"><a href="#cb31-2028" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2029"><a href="#cb31-2029" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(f"Dimensionless squared jerk: {dimensionless_jerk}")</span></span>
<span id="cb31-2030"><a href="#cb31-2030" aria-hidden="true" tabindex="-1"></a>    <span class="co"># log the dimensionless jerk</span></span>
<span id="cb31-2031"><a href="#cb31-2031" aria-hidden="true" tabindex="-1"></a>    dimensionless_jerk <span class="op">=</span> np.log(dimensionless_jerk)</span>
<span id="cb31-2032"><a href="#cb31-2032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2033"><a href="#cb31-2033" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dimensionless_jerk</span>
<span id="cb31-2034"><a href="#cb31-2034" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2035"><a href="#cb31-2035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2036"><a href="#cb31-2036" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-2037"><a href="#cb31-2037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2038"><a href="#cb31-2038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2039"><a href="#cb31-2039" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example code for checking behavior of the smoothness metrics üè¥</span></span>
<span id="cb31-2040"><a href="#cb31-2040" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, code_folding="hide"}</span></span>
<span id="cb31-2041"><a href="#cb31-2041" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb31-2042"><a href="#cb31-2042" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-2043"><a href="#cb31-2043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2044"><a href="#cb31-2044" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the time series data</span></span>
<span id="cb31-2045"><a href="#cb31-2045" aria-hidden="true" tabindex="-1"></a>ts1 <span class="op">=</span> np.arange(<span class="dv">5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>)</span>
<span id="cb31-2046"><a href="#cb31-2046" aria-hidden="true" tabindex="-1"></a>ts2 <span class="op">=</span> np.arange(<span class="dv">5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>) <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="bu">len</span>(ts1))</span>
<span id="cb31-2047"><a href="#cb31-2047" aria-hidden="true" tabindex="-1"></a>ts3 <span class="op">=</span> np.arange(<span class="dv">5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>) <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="bu">len</span>(ts1))</span>
<span id="cb31-2048"><a href="#cb31-2048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2049"><a href="#cb31-2049" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sinusoidal time series</span></span>
<span id="cb31-2050"><a href="#cb31-2050" aria-hidden="true" tabindex="-1"></a>time_axis <span class="op">=</span> np.arange(<span class="dv">5</span>, <span class="dv">10</span>, <span class="fl">0.01</span>)</span>
<span id="cb31-2051"><a href="#cb31-2051" aria-hidden="true" tabindex="-1"></a>ts1 <span class="op">=</span> np.sin(ts1)</span>
<span id="cb31-2052"><a href="#cb31-2052" aria-hidden="true" tabindex="-1"></a>ts2 <span class="op">=</span> np.sin(ts2)</span>
<span id="cb31-2053"><a href="#cb31-2053" aria-hidden="true" tabindex="-1"></a>ts3 <span class="op">=</span> np.sin(ts3)</span>
<span id="cb31-2054"><a href="#cb31-2054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2055"><a href="#cb31-2055" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics (assuming you have these functions defined)</span></span>
<span id="cb31-2056"><a href="#cb31-2056" aria-hidden="true" tabindex="-1"></a>spects1 <span class="op">=</span> spectral_arclength(ts1, fs<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-2057"><a href="#cb31-2057" aria-hidden="true" tabindex="-1"></a>spects2 <span class="op">=</span> spectral_arclength(ts2, fs<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-2058"><a href="#cb31-2058" aria-hidden="true" tabindex="-1"></a>spects3 <span class="op">=</span> spectral_arclength(ts3, fs<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-2059"><a href="#cb31-2059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2060"><a href="#cb31-2060" aria-hidden="true" tabindex="-1"></a>jerkts1 <span class="op">=</span> dimensionless_squared_jerk_from_position(ts1, time_axis)</span>
<span id="cb31-2061"><a href="#cb31-2061" aria-hidden="true" tabindex="-1"></a>jerkts2 <span class="op">=</span> dimensionless_squared_jerk_from_position(ts2, time_axis)</span>
<span id="cb31-2062"><a href="#cb31-2062" aria-hidden="true" tabindex="-1"></a>jerkts3 <span class="op">=</span> dimensionless_squared_jerk_from_position(ts3, time_axis)</span>
<span id="cb31-2063"><a href="#cb31-2063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2064"><a href="#cb31-2064" aria-hidden="true" tabindex="-1"></a><span class="co"># Create figure with subplots - 1x3 layout</span></span>
<span id="cb31-2065"><a href="#cb31-2065" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">9</span>))</span>
<span id="cb31-2066"><a href="#cb31-2066" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Time Series Analysis: Spectral Arc Length and Dimensionless Squared Jerk'</span>, </span>
<span id="cb31-2067"><a href="#cb31-2067" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">0.98</span>)</span>
<span id="cb31-2068"><a href="#cb31-2068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2069"><a href="#cb31-2069" aria-hidden="true" tabindex="-1"></a><span class="co"># Colors for consistent styling</span></span>
<span id="cb31-2070"><a href="#cb31-2070" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#1f77b4'</span>, <span class="st">'#ff7f0e'</span>, <span class="st">'#d62728'</span>]  <span class="co"># Blue, Orange, Red</span></span>
<span id="cb31-2071"><a href="#cb31-2071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2072"><a href="#cb31-2072" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Individual signals separated (left)</span></span>
<span id="cb31-2073"><a href="#cb31-2073" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb31-2074"><a href="#cb31-2074" aria-hidden="true" tabindex="-1"></a>offset <span class="op">=</span> <span class="dv">3</span>  <span class="co"># Vertical separation between signals</span></span>
<span id="cb31-2075"><a href="#cb31-2075" aria-hidden="true" tabindex="-1"></a>ax1.plot(time_axis, ts1 <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>offset, color<span class="op">=</span>colors[<span class="dv">0</span>], linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Smooth Signal'</span>)</span>
<span id="cb31-2076"><a href="#cb31-2076" aria-hidden="true" tabindex="-1"></a>ax1.plot(time_axis, ts2 <span class="op">+</span> offset, color<span class="op">=</span>colors[<span class="dv">1</span>], linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Low Noise Signal'</span>)</span>
<span id="cb31-2077"><a href="#cb31-2077" aria-hidden="true" tabindex="-1"></a>ax1.plot(time_axis, ts3, color<span class="op">=</span>colors[<span class="dv">2</span>], linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'High Noise Signal'</span>)</span>
<span id="cb31-2078"><a href="#cb31-2078" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Separated Time Series'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb31-2079"><a href="#cb31-2079" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb31-2080"><a href="#cb31-2080" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Amplitude (Offset)'</span>)</span>
<span id="cb31-2081"><a href="#cb31-2081" aria-hidden="true" tabindex="-1"></a>ax1.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb31-2082"><a href="#cb31-2082" aria-hidden="true" tabindex="-1"></a>ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb31-2083"><a href="#cb31-2083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2084"><a href="#cb31-2084" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Metrics comparison - Spectral Arc Length (middle)</span></span>
<span id="cb31-2085"><a href="#cb31-2085" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb31-2086"><a href="#cb31-2086" aria-hidden="true" tabindex="-1"></a>signals <span class="op">=</span> [<span class="st">'Smooth</span><span class="ch">\n</span><span class="st">Signal'</span>, <span class="st">'Low Noise</span><span class="ch">\n</span><span class="st">Signal'</span>, <span class="st">'High Noise</span><span class="ch">\n</span><span class="st">Signal'</span>]</span>
<span id="cb31-2087"><a href="#cb31-2087" aria-hidden="true" tabindex="-1"></a>spect_values <span class="op">=</span> [spects1[<span class="dv">0</span>], spects2[<span class="dv">0</span>], spects3[<span class="dv">0</span>]]</span>
<span id="cb31-2088"><a href="#cb31-2088" aria-hidden="true" tabindex="-1"></a>bars1 <span class="op">=</span> ax2.bar(signals, spect_values, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-2089"><a href="#cb31-2089" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Spectral Arc Length Comparison'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb31-2090"><a href="#cb31-2090" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Spectral Arc Length'</span>)</span>
<span id="cb31-2091"><a href="#cb31-2091" aria-hidden="true" tabindex="-1"></a>ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb31-2092"><a href="#cb31-2092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2093"><a href="#cb31-2093" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels on bars</span></span>
<span id="cb31-2094"><a href="#cb31-2094" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bar, value <span class="kw">in</span> <span class="bu">zip</span>(bars1, spect_values):</span>
<span id="cb31-2095"><a href="#cb31-2095" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> bar.get_height()</span>
<span id="cb31-2096"><a href="#cb31-2096" aria-hidden="true" tabindex="-1"></a>    ax2.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height <span class="op">+</span> <span class="fl">0.01</span>,</span>
<span id="cb31-2097"><a href="#cb31-2097" aria-hidden="true" tabindex="-1"></a>             <span class="ss">f'</span><span class="sc">{</span>value<span class="sc">:.3f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb31-2098"><a href="#cb31-2098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2099"><a href="#cb31-2099" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 3: Metrics comparison - Dimensionless Squared Jerk (right)</span></span>
<span id="cb31-2100"><a href="#cb31-2100" aria-hidden="true" tabindex="-1"></a>ax3 <span class="op">=</span> axes[<span class="dv">2</span>]</span>
<span id="cb31-2101"><a href="#cb31-2101" aria-hidden="true" tabindex="-1"></a>jerk_values <span class="op">=</span> [jerkts1, jerkts2, jerkts3]</span>
<span id="cb31-2102"><a href="#cb31-2102" aria-hidden="true" tabindex="-1"></a>bars2 <span class="op">=</span> ax3.bar(signals, jerk_values, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-2103"><a href="#cb31-2103" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Dimensionless Squared Jerk Comparison'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb31-2104"><a href="#cb31-2104" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Dimensionless Squared Jerk'</span>)</span>
<span id="cb31-2105"><a href="#cb31-2105" aria-hidden="true" tabindex="-1"></a>ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb31-2106"><a href="#cb31-2106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2107"><a href="#cb31-2107" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels on bars</span></span>
<span id="cb31-2108"><a href="#cb31-2108" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bar, value <span class="kw">in</span> <span class="bu">zip</span>(bars2, jerk_values):</span>
<span id="cb31-2109"><a href="#cb31-2109" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> bar.get_height()</span>
<span id="cb31-2110"><a href="#cb31-2110" aria-hidden="true" tabindex="-1"></a>    ax3.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height <span class="op">+</span> <span class="bu">max</span>(jerk_values)<span class="op">*</span><span class="fl">0.02</span>,</span>
<span id="cb31-2111"><a href="#cb31-2111" aria-hidden="true" tabindex="-1"></a>             <span class="ss">f'</span><span class="sc">{</span>value<span class="sc">:.3f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb31-2112"><a href="#cb31-2112" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust layout to prevent overlap</span></span>
<span id="cb31-2113"><a href="#cb31-2113" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.12</span>, <span class="dv">1</span>, <span class="fl">0.95</span>])</span>
<span id="cb31-2114"><a href="#cb31-2114" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.show()</span></span>
<span id="cb31-2115"><a href="#cb31-2115" aria-hidden="true" tabindex="-1"></a><span class="co"># save plot</span></span>
<span id="cb31-2116"><a href="#cb31-2116" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'./images/smoothness_metrics_comparison.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb31-2117"><a href="#cb31-2117" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2118"><a href="#cb31-2118" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-2119"><a href="#cb31-2119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2120"><a href="#cb31-2120" aria-hidden="true" tabindex="-1"></a><span class="al">![Smoothness metrics comparison](./images/smoothness_metrics_comparison.png)</span></span>
<span id="cb31-2121"><a href="#cb31-2121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2122"><a href="#cb31-2122" aria-hidden="true" tabindex="-1"></a>In the below pipeline code for step 2, we calculate smoothness for the distance between the two hands, as well as the distance to the center of mass (COM) and centroid of the two hands. We also calculate the smoothness of the wrist speed profiles, which are derived from the distance time series data. When SPARC is in the variable name, it refers to the spectral arc length metric, while smoothness will refer to the dimensionless squared jerk metric.</span>
<span id="cb31-2123"><a href="#cb31-2123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2124"><a href="#cb31-2124" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-2125"><a href="#cb31-2125" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pipeline code step 2 complete procedure üö©</span></span>
<span id="cb31-2126"><a href="#cb31-2126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2127"><a href="#cb31-2127" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb31-2128"><a href="#cb31-2128" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb31-2129"><a href="#cb31-2129" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb31-2130"><a href="#cb31-2130" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb31-2131"><a href="#cb31-2131" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> integrate</span>
<span id="cb31-2132"><a href="#cb31-2132" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> interpolate</span>
<span id="cb31-2133"><a href="#cb31-2133" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> savgol_filter</span>
<span id="cb31-2134"><a href="#cb31-2134" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-2135"><a href="#cb31-2135" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-2136"><a href="#cb31-2136" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-2137"><a href="#cb31-2137" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb31-2138"><a href="#cb31-2138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2139"><a href="#cb31-2139" aria-hidden="true" tabindex="-1"></a><span class="co"># specifically we might be interested in computing the smoothness of the distance</span></span>
<span id="cb31-2140"><a href="#cb31-2140" aria-hidden="true" tabindex="-1"></a>inputfol <span class="op">=</span> <span class="st">'../dataoutput_STEP1_2_timeseries/'</span></span>
<span id="cb31-2141"><a href="#cb31-2141" aria-hidden="true" tabindex="-1"></a>outputfol <span class="op">=</span> <span class="st">'../dataoutput_STEP2_features/'</span></span>
<span id="cb31-2142"><a href="#cb31-2142" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> pd.read_csv(<span class="st">'../meta/project_pointsibling_metadata_starttimes.csv'</span>, encoding<span class="op">=</span><span class="st">'latin1'</span>)</span>
<span id="cb31-2143"><a href="#cb31-2143" aria-hidden="true" tabindex="-1"></a>constantwindowsize_sec <span class="op">=</span> <span class="dv">100</span> <span class="co"># we want an equal portion of each timeseries to be analyzed</span></span>
<span id="cb31-2144"><a href="#cb31-2144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2145"><a href="#cb31-2145" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate spectral arc length</span></span>
<span id="cb31-2146"><a href="#cb31-2146" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spectral_arclength(movement, fs, padlevel<span class="op">=</span><span class="dv">4</span>, fc<span class="op">=</span><span class="fl">10.0</span>, amp_th<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb31-2147"><a href="#cb31-2147" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-2148"><a href="#cb31-2148" aria-hidden="true" tabindex="-1"></a><span class="co">    Calcualtes the smoothness of the given speed profile using the modified spectral</span></span>
<span id="cb31-2149"><a href="#cb31-2149" aria-hidden="true" tabindex="-1"></a><span class="co">    arc length metric.</span></span>
<span id="cb31-2150"><a href="#cb31-2150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2151"><a href="#cb31-2151" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb31-2152"><a href="#cb31-2152" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb31-2153"><a href="#cb31-2153" aria-hidden="true" tabindex="-1"></a><span class="co">    movement : np.array</span></span>
<span id="cb31-2154"><a href="#cb31-2154" aria-hidden="true" tabindex="-1"></a><span class="co">               The array containing the movement speed profile.</span></span>
<span id="cb31-2155"><a href="#cb31-2155" aria-hidden="true" tabindex="-1"></a><span class="co">    fs       : float</span></span>
<span id="cb31-2156"><a href="#cb31-2156" aria-hidden="true" tabindex="-1"></a><span class="co">               The sampling frequency of the data.</span></span>
<span id="cb31-2157"><a href="#cb31-2157" aria-hidden="true" tabindex="-1"></a><span class="co">    padlevel : integer, optional</span></span>
<span id="cb31-2158"><a href="#cb31-2158" aria-hidden="true" tabindex="-1"></a><span class="co">               Indicates the amount of zero padding to be done to the movement</span></span>
<span id="cb31-2159"><a href="#cb31-2159" aria-hidden="true" tabindex="-1"></a><span class="co">               data for estimating the spectral arc length. [default = 4]</span></span>
<span id="cb31-2160"><a href="#cb31-2160" aria-hidden="true" tabindex="-1"></a><span class="co">    fc       : float, optional</span></span>
<span id="cb31-2161"><a href="#cb31-2161" aria-hidden="true" tabindex="-1"></a><span class="co">               The max. cut off frequency for calculating the spectral arc</span></span>
<span id="cb31-2162"><a href="#cb31-2162" aria-hidden="true" tabindex="-1"></a><span class="co">               length metric. [default = 10.]</span></span>
<span id="cb31-2163"><a href="#cb31-2163" aria-hidden="true" tabindex="-1"></a><span class="co">    amp_th   : float, optional</span></span>
<span id="cb31-2164"><a href="#cb31-2164" aria-hidden="true" tabindex="-1"></a><span class="co">               The amplitude threshold to used for determing the cut off</span></span>
<span id="cb31-2165"><a href="#cb31-2165" aria-hidden="true" tabindex="-1"></a><span class="co">               frequency upto which the spectral arc length is to be estimated.</span></span>
<span id="cb31-2166"><a href="#cb31-2166" aria-hidden="true" tabindex="-1"></a><span class="co">               [default = 0.05]</span></span>
<span id="cb31-2167"><a href="#cb31-2167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2168"><a href="#cb31-2168" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb31-2169"><a href="#cb31-2169" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb31-2170"><a href="#cb31-2170" aria-hidden="true" tabindex="-1"></a><span class="co">    sal      : float</span></span>
<span id="cb31-2171"><a href="#cb31-2171" aria-hidden="true" tabindex="-1"></a><span class="co">               The spectral arc length estimate of the given movement's</span></span>
<span id="cb31-2172"><a href="#cb31-2172" aria-hidden="true" tabindex="-1"></a><span class="co">               smoothness.</span></span>
<span id="cb31-2173"><a href="#cb31-2173" aria-hidden="true" tabindex="-1"></a><span class="co">    (f, Mf)  : tuple of two np.arrays</span></span>
<span id="cb31-2174"><a href="#cb31-2174" aria-hidden="true" tabindex="-1"></a><span class="co">               This is the frequency(f) and the magntiude spectrum(Mf) of the</span></span>
<span id="cb31-2175"><a href="#cb31-2175" aria-hidden="true" tabindex="-1"></a><span class="co">               given movement data. This spectral is from 0. to fs/2.</span></span>
<span id="cb31-2176"><a href="#cb31-2176" aria-hidden="true" tabindex="-1"></a><span class="co">    (f_sel, Mf_sel) : tuple of two np.arrays</span></span>
<span id="cb31-2177"><a href="#cb31-2177" aria-hidden="true" tabindex="-1"></a><span class="co">                      This is the portion of the spectrum that is selected for</span></span>
<span id="cb31-2178"><a href="#cb31-2178" aria-hidden="true" tabindex="-1"></a><span class="co">                      calculating the spectral arc length.</span></span>
<span id="cb31-2179"><a href="#cb31-2179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2180"><a href="#cb31-2180" aria-hidden="true" tabindex="-1"></a><span class="co">    Notes</span></span>
<span id="cb31-2181"><a href="#cb31-2181" aria-hidden="true" tabindex="-1"></a><span class="co">    -----</span></span>
<span id="cb31-2182"><a href="#cb31-2182" aria-hidden="true" tabindex="-1"></a><span class="co">    This is the modfieid spectral arc length metric, which has been tested only</span></span>
<span id="cb31-2183"><a href="#cb31-2183" aria-hidden="true" tabindex="-1"></a><span class="co">    for discrete movements.</span></span>
<span id="cb31-2184"><a href="#cb31-2184" aria-hidden="true" tabindex="-1"></a><span class="co">    It is suitable for movements that are a few seconds long, but for long</span></span>
<span id="cb31-2185"><a href="#cb31-2185" aria-hidden="true" tabindex="-1"></a><span class="co">    movements it might be slow and results might not make sense (like any other</span></span>
<span id="cb31-2186"><a href="#cb31-2186" aria-hidden="true" tabindex="-1"></a><span class="co">    smoothness metric).</span></span>
<span id="cb31-2187"><a href="#cb31-2187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2188"><a href="#cb31-2188" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb31-2189"><a href="#cb31-2189" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb31-2190"><a href="#cb31-2190" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; t = np.arange(-1, 1, 0.01)</span></span>
<span id="cb31-2191"><a href="#cb31-2191" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; move = np.exp(-5*pow(t, 2))</span></span>
<span id="cb31-2192"><a href="#cb31-2192" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; sal, _, _ = spectral_arclength(move, fs=100.)</span></span>
<span id="cb31-2193"><a href="#cb31-2193" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; '%.5f' % sal</span></span>
<span id="cb31-2194"><a href="#cb31-2194" aria-hidden="true" tabindex="-1"></a><span class="co">    '-1.41403'</span></span>
<span id="cb31-2195"><a href="#cb31-2195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2196"><a href="#cb31-2196" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-2197"><a href="#cb31-2197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of zeros to be padded.</span></span>
<span id="cb31-2198"><a href="#cb31-2198" aria-hidden="true" tabindex="-1"></a>    nfft <span class="op">=</span> <span class="bu">int</span>(<span class="bu">pow</span>(<span class="dv">2</span>, np.ceil(np.log2(<span class="bu">len</span>(movement))) <span class="op">+</span> padlevel))</span>
<span id="cb31-2199"><a href="#cb31-2199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2200"><a href="#cb31-2200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Frequency</span></span>
<span id="cb31-2201"><a href="#cb31-2201" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> np.arange(<span class="dv">0</span>, fs, fs<span class="op">/</span>nfft)</span>
<span id="cb31-2202"><a href="#cb31-2202" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalized magnitude spectrum</span></span>
<span id="cb31-2203"><a href="#cb31-2203" aria-hidden="true" tabindex="-1"></a>    Mf <span class="op">=</span> <span class="bu">abs</span>(np.fft.fft(movement, nfft))</span>
<span id="cb31-2204"><a href="#cb31-2204" aria-hidden="true" tabindex="-1"></a>    Mf <span class="op">=</span> Mf<span class="op">/</span><span class="bu">max</span>(Mf)</span>
<span id="cb31-2205"><a href="#cb31-2205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2206"><a href="#cb31-2206" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Indices to choose only the spectrum within the given cut off frequency Fc.</span></span>
<span id="cb31-2207"><a href="#cb31-2207" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: This is a low pass filtering operation to get rid of high frequency</span></span>
<span id="cb31-2208"><a href="#cb31-2208" aria-hidden="true" tabindex="-1"></a>    <span class="co"># noise from affecting the next step (amplitude threshold based cut off for</span></span>
<span id="cb31-2209"><a href="#cb31-2209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># arc length calculation).</span></span>
<span id="cb31-2210"><a href="#cb31-2210" aria-hidden="true" tabindex="-1"></a>    fc_inx <span class="op">=</span> ((f <span class="op">&lt;=</span> fc)<span class="op">*</span><span class="dv">1</span>).nonzero()</span>
<span id="cb31-2211"><a href="#cb31-2211" aria-hidden="true" tabindex="-1"></a>    f_sel <span class="op">=</span> f[fc_inx]</span>
<span id="cb31-2212"><a href="#cb31-2212" aria-hidden="true" tabindex="-1"></a>    Mf_sel <span class="op">=</span> Mf[fc_inx]</span>
<span id="cb31-2213"><a href="#cb31-2213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2214"><a href="#cb31-2214" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose the amplitude threshold based cut off frequency.</span></span>
<span id="cb31-2215"><a href="#cb31-2215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Index of the last point on the magnitude spectrum that is greater than</span></span>
<span id="cb31-2216"><a href="#cb31-2216" aria-hidden="true" tabindex="-1"></a>    <span class="co"># or equal to the amplitude threshold.</span></span>
<span id="cb31-2217"><a href="#cb31-2217" aria-hidden="true" tabindex="-1"></a>    inx <span class="op">=</span> ((Mf_sel <span class="op">&gt;=</span> amp_th)<span class="op">*</span><span class="dv">1</span>).nonzero()[<span class="dv">0</span>]</span>
<span id="cb31-2218"><a href="#cb31-2218" aria-hidden="true" tabindex="-1"></a>    fc_inx <span class="op">=</span> <span class="bu">range</span>(inx[<span class="dv">0</span>], inx[<span class="op">-</span><span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb31-2219"><a href="#cb31-2219" aria-hidden="true" tabindex="-1"></a>    f_sel <span class="op">=</span> f_sel[fc_inx]</span>
<span id="cb31-2220"><a href="#cb31-2220" aria-hidden="true" tabindex="-1"></a>    Mf_sel <span class="op">=</span> Mf_sel[fc_inx]</span>
<span id="cb31-2221"><a href="#cb31-2221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2222"><a href="#cb31-2222" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate arc length</span></span>
<span id="cb31-2223"><a href="#cb31-2223" aria-hidden="true" tabindex="-1"></a>    new_sal <span class="op">=</span> <span class="op">-</span><span class="bu">sum</span>(np.sqrt(<span class="bu">pow</span>(np.diff(f_sel)<span class="op">/</span>(f_sel[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> f_sel[<span class="dv">0</span>]), <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb31-2224"><a href="#cb31-2224" aria-hidden="true" tabindex="-1"></a>                           <span class="bu">pow</span>(np.diff(Mf_sel), <span class="dv">2</span>)))</span>
<span id="cb31-2225"><a href="#cb31-2225" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_sal, (f, Mf), (f_sel, Mf_sel)</span>
<span id="cb31-2226"><a href="#cb31-2226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2227"><a href="#cb31-2227" aria-hidden="true" tabindex="-1"></a><span class="co"># function to calculate the dimensionless squared jerk metric from position data</span></span>
<span id="cb31-2228"><a href="#cb31-2228" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dimensionless_squared_jerk_from_position(ts, time):</span>
<span id="cb31-2229"><a href="#cb31-2229" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-2230"><a href="#cb31-2230" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate the dimensionless squared jerk metric from position data.</span></span>
<span id="cb31-2231"><a href="#cb31-2231" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-2232"><a href="#cb31-2232" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb31-2233"><a href="#cb31-2233" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb31-2234"><a href="#cb31-2234" aria-hidden="true" tabindex="-1"></a><span class="co">    ts : array_like</span></span>
<span id="cb31-2235"><a href="#cb31-2235" aria-hidden="true" tabindex="-1"></a><span class="co">        Position data points, should be a 1D numpy array</span></span>
<span id="cb31-2236"><a href="#cb31-2236" aria-hidden="true" tabindex="-1"></a><span class="co">    time : array_like</span></span>
<span id="cb31-2237"><a href="#cb31-2237" aria-hidden="true" tabindex="-1"></a><span class="co">        Time points corresponding to the ts data, should be a 1D numpy array</span></span>
<span id="cb31-2238"><a href="#cb31-2238" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-2239"><a href="#cb31-2239" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb31-2240"><a href="#cb31-2240" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb31-2241"><a href="#cb31-2241" aria-hidden="true" tabindex="-1"></a><span class="co">    float</span></span>
<span id="cb31-2242"><a href="#cb31-2242" aria-hidden="true" tabindex="-1"></a><span class="co">        Dimensionless squared jerk metric or NaN if calculation fails</span></span>
<span id="cb31-2243"><a href="#cb31-2243" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-2244"><a href="#cb31-2244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb31-2245"><a href="#cb31-2245" aria-hidden="true" tabindex="-1"></a>        <span class="co"># First check the raw inputs</span></span>
<span id="cb31-2246"><a href="#cb31-2246" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> np.array(ts, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb31-2247"><a href="#cb31-2247" aria-hidden="true" tabindex="-1"></a>        time <span class="op">=</span> np.array(time, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb31-2248"><a href="#cb31-2248" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2249"><a href="#cb31-2249" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Original shape - ts: </span><span class="sc">{</span>ts<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span>time<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2250"><a href="#cb31-2250" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"NaN count before processing - ts: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(ts)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(time)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2251"><a href="#cb31-2251" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2252"><a href="#cb31-2252" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Input validation before preprocessing</span></span>
<span id="cb31-2253"><a href="#cb31-2253" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(ts) <span class="op">!=</span> <span class="bu">len</span>(time):</span>
<span id="cb31-2254"><a href="#cb31-2254" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error: Arrays must have the same length. ts: </span><span class="sc">{</span><span class="bu">len</span>(ts)<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span><span class="bu">len</span>(time)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2255"><a href="#cb31-2255" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb31-2256"><a href="#cb31-2256" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-2257"><a href="#cb31-2257" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(ts) <span class="op">&lt;</span> <span class="dv">11</span>:  <span class="co"># Minimum length for savgol filter</span></span>
<span id="cb31-2258"><a href="#cb31-2258" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error: Input arrays too short for savgol window size=11. Length: </span><span class="sc">{</span><span class="bu">len</span>(ts)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2259"><a href="#cb31-2259" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb31-2260"><a href="#cb31-2260" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2261"><a href="#cb31-2261" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if time has NaNs - we need to fix time first</span></span>
<span id="cb31-2262"><a href="#cb31-2262" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(time).<span class="bu">any</span>():</span>
<span id="cb31-2263"><a href="#cb31-2263" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Warning: Time array contains NaNs, filling with linear sequence"</span>)</span>
<span id="cb31-2264"><a href="#cb31-2264" aria-hidden="true" tabindex="-1"></a>            valid_time_mask <span class="op">=</span> <span class="op">~</span>np.isnan(time)</span>
<span id="cb31-2265"><a href="#cb31-2265" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> valid_time_mask.<span class="bu">any</span>():</span>
<span id="cb31-2266"><a href="#cb31-2266" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Error: All time values are NaN"</span>)</span>
<span id="cb31-2267"><a href="#cb31-2267" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> np.nan</span>
<span id="cb31-2268"><a href="#cb31-2268" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-2269"><a href="#cb31-2269" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a proper time sequence</span></span>
<span id="cb31-2270"><a href="#cb31-2270" aria-hidden="true" tabindex="-1"></a>            time <span class="op">=</span> np.linspace(np.nanmin(time), np.nanmax(time), <span class="bu">len</span>(time))</span>
<span id="cb31-2271"><a href="#cb31-2271" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2272"><a href="#cb31-2272" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if input data is all NaN</span></span>
<span id="cb31-2273"><a href="#cb31-2273" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(ts).<span class="bu">all</span>():</span>
<span id="cb31-2274"><a href="#cb31-2274" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Error: All input values are NaN"</span>)</span>
<span id="cb31-2275"><a href="#cb31-2275" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb31-2276"><a href="#cb31-2276" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2277"><a href="#cb31-2277" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify valid data points for interpolation</span></span>
<span id="cb31-2278"><a href="#cb31-2278" aria-hidden="true" tabindex="-1"></a>        valid_mask <span class="op">=</span> <span class="op">~</span>np.isnan(ts)</span>
<span id="cb31-2279"><a href="#cb31-2279" aria-hidden="true" tabindex="-1"></a>        valid_indices <span class="op">=</span> np.where(valid_mask)[<span class="dv">0</span>]</span>
<span id="cb31-2280"><a href="#cb31-2280" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2281"><a href="#cb31-2281" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_indices) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb31-2282"><a href="#cb31-2282" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error: Not enough valid data points for interpolation. Found </span><span class="sc">{</span><span class="bu">len</span>(valid_indices)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2283"><a href="#cb31-2283" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb31-2284"><a href="#cb31-2284" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2285"><a href="#cb31-2285" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle the interpolation more carefully</span></span>
<span id="cb31-2286"><a href="#cb31-2286" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Use valid points to interpolate</span></span>
<span id="cb31-2287"><a href="#cb31-2287" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(ts).<span class="bu">any</span>():</span>
<span id="cb31-2288"><a href="#cb31-2288" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:               </span>
<span id="cb31-2289"><a href="#cb31-2289" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create interpolator with valid points only</span></span>
<span id="cb31-2290"><a href="#cb31-2290" aria-hidden="true" tabindex="-1"></a>                valid_time <span class="op">=</span> time[valid_mask]</span>
<span id="cb31-2291"><a href="#cb31-2291" aria-hidden="true" tabindex="-1"></a>                valid_data <span class="op">=</span> ts[valid_mask]</span>
<span id="cb31-2292"><a href="#cb31-2292" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-2293"><a href="#cb31-2293" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Sort by time to ensure proper interpolation</span></span>
<span id="cb31-2294"><a href="#cb31-2294" aria-hidden="true" tabindex="-1"></a>                sort_idx <span class="op">=</span> np.argsort(valid_time)</span>
<span id="cb31-2295"><a href="#cb31-2295" aria-hidden="true" tabindex="-1"></a>                valid_time <span class="op">=</span> valid_time[sort_idx]</span>
<span id="cb31-2296"><a href="#cb31-2296" aria-hidden="true" tabindex="-1"></a>                valid_data <span class="op">=</span> valid_data[sort_idx]</span>
<span id="cb31-2297"><a href="#cb31-2297" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-2298"><a href="#cb31-2298" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create interpolation function</span></span>
<span id="cb31-2299"><a href="#cb31-2299" aria-hidden="true" tabindex="-1"></a>                f <span class="op">=</span> interpolate.interp1d(</span>
<span id="cb31-2300"><a href="#cb31-2300" aria-hidden="true" tabindex="-1"></a>                    valid_time, valid_data,</span>
<span id="cb31-2301"><a href="#cb31-2301" aria-hidden="true" tabindex="-1"></a>                    bounds_error<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb31-2302"><a href="#cb31-2302" aria-hidden="true" tabindex="-1"></a>                    fill_value<span class="op">=</span>(valid_data[<span class="dv">0</span>], valid_data[<span class="op">-</span><span class="dv">1</span>])  <span class="co"># Extrapolate with edge values</span></span>
<span id="cb31-2303"><a href="#cb31-2303" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb31-2304"><a href="#cb31-2304" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-2305"><a href="#cb31-2305" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Apply interpolation</span></span>
<span id="cb31-2306"><a href="#cb31-2306" aria-hidden="true" tabindex="-1"></a>                ts_interpolated <span class="op">=</span> f(time)</span>
<span id="cb31-2307"><a href="#cb31-2307" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-2308"><a href="#cb31-2308" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check if interpolation fixed all NaNs</span></span>
<span id="cb31-2309"><a href="#cb31-2309" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> np.isnan(ts_interpolated).<span class="bu">any</span>():</span>
<span id="cb31-2310"><a href="#cb31-2310" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"Warning: Interpolation failed to fix all NaNs. Remaining: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(ts_interpolated)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2311"><a href="#cb31-2311" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Last resort: replace any remaining NaNs with nearest valid value</span></span>
<span id="cb31-2312"><a href="#cb31-2312" aria-hidden="true" tabindex="-1"></a>                    ts_interpolated <span class="op">=</span> pd.Series(ts_interpolated).fillna(method<span class="op">=</span><span class="st">'ffill'</span>).fillna(method<span class="op">=</span><span class="st">'bfill'</span>).values</span>
<span id="cb31-2313"><a href="#cb31-2313" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb31-2314"><a href="#cb31-2314" aria-hidden="true" tabindex="-1"></a>                ts <span class="op">=</span> ts_interpolated</span>
<span id="cb31-2315"><a href="#cb31-2315" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb31-2316"><a href="#cb31-2316" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Error during interpolation: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2317"><a href="#cb31-2317" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> np.nan</span>
<span id="cb31-2318"><a href="#cb31-2318" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2319"><a href="#cb31-2319" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verify no NaNs remain after preprocessing</span></span>
<span id="cb31-2320"><a href="#cb31-2320" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(ts).<span class="bu">any</span>() <span class="kw">or</span> np.isnan(time).<span class="bu">any</span>():</span>
<span id="cb31-2321"><a href="#cb31-2321" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Error: Failed to remove all NaN values"</span>)</span>
<span id="cb31-2322"><a href="#cb31-2322" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb31-2323"><a href="#cb31-2323" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-2324"><a href="#cb31-2324" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure time steps are uniform for derivative calculation</span></span>
<span id="cb31-2325"><a href="#cb31-2325" aria-hidden="true" tabindex="-1"></a>        uniform_time <span class="op">=</span> np.linspace(time[<span class="dv">0</span>], time[<span class="op">-</span><span class="dv">1</span>], <span class="bu">len</span>(time))</span>
<span id="cb31-2326"><a href="#cb31-2326" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.allclose(time, uniform_time):</span>
<span id="cb31-2327"><a href="#cb31-2327" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If time is not uniform, resample the data</span></span>
<span id="cb31-2328"><a href="#cb31-2328" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Warning: Time steps not uniform, resampling data"</span>)</span>
<span id="cb31-2329"><a href="#cb31-2329" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use scipy's interpolation again to resample</span></span>
<span id="cb31-2330"><a href="#cb31-2330" aria-hidden="true" tabindex="-1"></a>            f <span class="op">=</span> interpolate.interp1d(time, ts, bounds_error<span class="op">=</span><span class="va">False</span>, fill_value<span class="op">=</span><span class="st">'extrapolate'</span>)</span>
<span id="cb31-2331"><a href="#cb31-2331" aria-hidden="true" tabindex="-1"></a>            ts <span class="op">=</span> f(uniform_time)</span>
<span id="cb31-2332"><a href="#cb31-2332" aria-hidden="true" tabindex="-1"></a>            time <span class="op">=</span> uniform_time</span>
<span id="cb31-2333"><a href="#cb31-2333" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2334"><a href="#cb31-2334" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the time step</span></span>
<span id="cb31-2335"><a href="#cb31-2335" aria-hidden="true" tabindex="-1"></a>        dt <span class="op">=</span> np.diff(time)[<span class="dv">0</span>]</span>
<span id="cb31-2336"><a href="#cb31-2336" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2337"><a href="#cb31-2337" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dt <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb31-2338"><a href="#cb31-2338" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error: Time steps must be positive. Got dt=</span><span class="sc">{</span>dt<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2339"><a href="#cb31-2339" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb31-2340"><a href="#cb31-2340" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2341"><a href="#cb31-2341" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print state after preprocessing</span></span>
<span id="cb31-2342"><a href="#cb31-2342" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Data after preprocessing - Length: </span><span class="sc">{</span><span class="bu">len</span>(ts)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2343"><a href="#cb31-2343" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"NaN check after preprocessing - ts: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(ts)<span class="sc">.</span><span class="bu">any</span>()<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(time)<span class="sc">.</span><span class="bu">any</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2344"><a href="#cb31-2344" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Range - ts: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(ts)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(ts)<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">min</span>(time)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">max</span>(time)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2345"><a href="#cb31-2345" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2346"><a href="#cb31-2346" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate speed (exactly as in original)</span></span>
<span id="cb31-2347"><a href="#cb31-2347" aria-hidden="true" tabindex="-1"></a>        speed <span class="op">=</span> np.gradient(ts, dt)</span>
<span id="cb31-2348"><a href="#cb31-2348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2349"><a href="#cb31-2349" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth savgol filter (maintaining original settings)</span></span>
<span id="cb31-2350"><a href="#cb31-2350" aria-hidden="true" tabindex="-1"></a>        speed <span class="op">=</span> savgol_filter(speed, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb31-2351"><a href="#cb31-2351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2352"><a href="#cb31-2352" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate acceleration (exactly as in original)</span></span>
<span id="cb31-2353"><a href="#cb31-2353" aria-hidden="true" tabindex="-1"></a>        acceleration <span class="op">=</span> np.gradient(speed, dt)</span>
<span id="cb31-2354"><a href="#cb31-2354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2355"><a href="#cb31-2355" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth (maintaining original settings)</span></span>
<span id="cb31-2356"><a href="#cb31-2356" aria-hidden="true" tabindex="-1"></a>        acceleration <span class="op">=</span> savgol_filter(acceleration, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb31-2357"><a href="#cb31-2357" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2358"><a href="#cb31-2358" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate jerk (exactly as in original)</span></span>
<span id="cb31-2359"><a href="#cb31-2359" aria-hidden="true" tabindex="-1"></a>        jerk <span class="op">=</span> np.gradient(acceleration, dt)</span>
<span id="cb31-2360"><a href="#cb31-2360" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2361"><a href="#cb31-2361" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth (maintaining original settings)</span></span>
<span id="cb31-2362"><a href="#cb31-2362" aria-hidden="true" tabindex="-1"></a>        jerk <span class="op">=</span> savgol_filter(jerk, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb31-2363"><a href="#cb31-2363" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2364"><a href="#cb31-2364" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate movement duration (D)</span></span>
<span id="cb31-2365"><a href="#cb31-2365" aria-hidden="true" tabindex="-1"></a>        movement_duration <span class="op">=</span> time[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> time[<span class="dv">0</span>]</span>
<span id="cb31-2366"><a href="#cb31-2366" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2367"><a href="#cb31-2367" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> movement_duration <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb31-2368"><a href="#cb31-2368" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error: Movement duration must be positive. Got </span><span class="sc">{</span>movement_duration<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2369"><a href="#cb31-2369" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb31-2370"><a href="#cb31-2370" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2371"><a href="#cb31-2371" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate movement amplitude by integrating speed</span></span>
<span id="cb31-2372"><a href="#cb31-2372" aria-hidden="true" tabindex="-1"></a>        position <span class="op">=</span> integrate.simpson(speed, x<span class="op">=</span>time)</span>
<span id="cb31-2373"><a href="#cb31-2373" aria-hidden="true" tabindex="-1"></a>        movement_amplitude <span class="op">=</span> <span class="bu">abs</span>(position)  <span class="co"># Use absolute value to ensure positive</span></span>
<span id="cb31-2374"><a href="#cb31-2374" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2375"><a href="#cb31-2375" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prevent division by zero</span></span>
<span id="cb31-2376"><a href="#cb31-2376" aria-hidden="true" tabindex="-1"></a>        epsilon <span class="op">=</span> <span class="fl">1e-10</span></span>
<span id="cb31-2377"><a href="#cb31-2377" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> movement_amplitude <span class="op">&lt;</span> epsilon:</span>
<span id="cb31-2378"><a href="#cb31-2378" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Warning: Movement amplitude very small (</span><span class="sc">{</span>movement_amplitude<span class="sc">}</span><span class="ss">). Using epsilon."</span>)</span>
<span id="cb31-2379"><a href="#cb31-2379" aria-hidden="true" tabindex="-1"></a>            movement_amplitude <span class="op">=</span> epsilon</span>
<span id="cb31-2380"><a href="#cb31-2380" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-2381"><a href="#cb31-2381" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the squared jerk</span></span>
<span id="cb31-2382"><a href="#cb31-2382" aria-hidden="true" tabindex="-1"></a>        squared_jerk <span class="op">=</span> jerk <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb31-2383"><a href="#cb31-2383" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2384"><a href="#cb31-2384" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Integrate the squared jerk</span></span>
<span id="cb31-2385"><a href="#cb31-2385" aria-hidden="true" tabindex="-1"></a>        integrated_squared_jerk <span class="op">=</span> integrate.simpson(squared_jerk, x<span class="op">=</span>time)</span>
<span id="cb31-2386"><a href="#cb31-2386" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2387"><a href="#cb31-2387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure positive value for integral of squared jerk</span></span>
<span id="cb31-2388"><a href="#cb31-2388" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> integrated_squared_jerk <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb31-2389"><a href="#cb31-2389" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Warning: Negative integral of squared jerk: </span><span class="sc">{</span>integrated_squared_jerk<span class="sc">}</span><span class="ss">. Using absolute value."</span>)</span>
<span id="cb31-2390"><a href="#cb31-2390" aria-hidden="true" tabindex="-1"></a>            integrated_squared_jerk <span class="op">=</span> <span class="bu">abs</span>(integrated_squared_jerk)</span>
<span id="cb31-2391"><a href="#cb31-2391" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2392"><a href="#cb31-2392" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the dimensionless squared jerk</span></span>
<span id="cb31-2393"><a href="#cb31-2393" aria-hidden="true" tabindex="-1"></a>        dimensionless_jerk <span class="op">=</span> integrated_squared_jerk <span class="op">*</span> (movement_duration<span class="op">**</span><span class="dv">5</span> <span class="op">/</span> movement_amplitude<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb31-2394"><a href="#cb31-2394" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2395"><a href="#cb31-2395" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Final sanity check</span></span>
<span id="cb31-2396"><a href="#cb31-2396" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(dimensionless_jerk) <span class="kw">or</span> np.isinf(dimensionless_jerk):</span>
<span id="cb31-2397"><a href="#cb31-2397" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Warning: Result is </span><span class="sc">{</span>dimensionless_jerk<span class="sc">}</span><span class="ss">. Details: "</span>)</span>
<span id="cb31-2398"><a href="#cb31-2398" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Movement duration: </span><span class="sc">{</span>movement_duration<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2399"><a href="#cb31-2399" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Movement amplitude: </span><span class="sc">{</span>movement_amplitude<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2400"><a href="#cb31-2400" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Integrated squared jerk: </span><span class="sc">{</span>integrated_squared_jerk<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2401"><a href="#cb31-2401" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb31-2402"><a href="#cb31-2402" aria-hidden="true" tabindex="-1"></a>        <span class="co"># log the result</span></span>
<span id="cb31-2403"><a href="#cb31-2403" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2404"><a href="#cb31-2404" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Dimensionless squared jerk: </span><span class="sc">{</span>dimensionless_jerk<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2405"><a href="#cb31-2405" aria-hidden="true" tabindex="-1"></a>        <span class="co"># log the dimensionless jerk</span></span>
<span id="cb31-2406"><a href="#cb31-2406" aria-hidden="true" tabindex="-1"></a>        dimensionless_jerk <span class="op">=</span> np.log(dimensionless_jerk)</span>
<span id="cb31-2407"><a href="#cb31-2407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2408"><a href="#cb31-2408" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dimensionless_jerk</span>
<span id="cb31-2409"><a href="#cb31-2409" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-2410"><a href="#cb31-2410" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb31-2411"><a href="#cb31-2411" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error calculating dimensionless squared jerk: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-2412"><a href="#cb31-2412" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb31-2413"><a href="#cb31-2413" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2414"><a href="#cb31-2414" aria-hidden="true" tabindex="-1"></a><span class="co"># df for smoothness date</span></span>
<span id="cb31-2415"><a href="#cb31-2415" aria-hidden="true" tabindex="-1"></a>newdfcolumns <span class="op">=</span> [<span class="st">'videoID'</span>,<span class="st">'timeadjusted'</span>, <span class="st">'originalsamples'</span>,<span class="st">'adjustedsamples'</span>, <span class="st">'start_time_analysiswindow'</span>, <span class="st">'end_time_analysiswindow'</span>, <span class="st">'perc_twopersonsdetected'</span>, <span class="st">'average_com_movementp1'</span>, <span class="st">'average_com_movementp2'</span>, <span class="st">'smoothness_distancecom'</span>, <span class="st">'SPARC_smoothness_distancecom'</span>, <span class="st">'smoothness_distancecentroid'</span>, <span class="st">'smoothness_xy_average_com_p1'</span>, <span class="st">'smoothness_xy_average_com_p2'</span>, <span class="st">'smoothness_xy_average_centroid_p1'</span>, <span class="st">'smoothness_xy_average_centroid_p2'</span>, <span class="st">'smoothness_p1_proximity'</span>, <span class="st">'smoothness_p2_proximity'</span>]</span>
<span id="cb31-2416"><a href="#cb31-2416" aria-hidden="true" tabindex="-1"></a>newdf <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>newdfcolumns)</span>
<span id="cb31-2417"><a href="#cb31-2417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2418"><a href="#cb31-2418" aria-hidden="true" tabindex="-1"></a><span class="co"># check for each csv file for layer2 data</span></span>
<span id="cb31-2419"><a href="#cb31-2419" aria-hidden="true" tabindex="-1"></a>layer2dat <span class="op">=</span> glob.glob(inputfol <span class="op">+</span> <span class="st">'*.csv'</span>)</span>
<span id="cb31-2420"><a href="#cb31-2420" aria-hidden="true" tabindex="-1"></a><span class="co">#print(layer2dat)</span></span>
<span id="cb31-2421"><a href="#cb31-2421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2422"><a href="#cb31-2422" aria-hidden="true" tabindex="-1"></a><span class="co"># loop over the csv layer 2 data</span></span>
<span id="cb31-2423"><a href="#cb31-2423" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> vids <span class="kw">in</span> layer2dat:</span>
<span id="cb31-2424"><a href="#cb31-2424" aria-hidden="true" tabindex="-1"></a>     <span class="bu">print</span>(vids)</span>
<span id="cb31-2425"><a href="#cb31-2425" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Load the CSV timeseries file</span></span>
<span id="cb31-2426"><a href="#cb31-2426" aria-hidden="true" tabindex="-1"></a>     ts <span class="op">=</span> pd.read_csv(vids)</span>
<span id="cb31-2427"><a href="#cb31-2427" aria-hidden="true" tabindex="-1"></a>     <span class="co"># get the features</span></span>
<span id="cb31-2428"><a href="#cb31-2428" aria-hidden="true" tabindex="-1"></a>     videoID <span class="op">=</span> os.path.basename(vids).split(<span class="st">'_processed_data_layer2.csv'</span>)[<span class="dv">0</span>]</span>
<span id="cb31-2429"><a href="#cb31-2429" aria-hidden="true" tabindex="-1"></a>     originalsamples <span class="op">=</span> <span class="bu">len</span>(ts[<span class="st">"time"</span>])</span>
<span id="cb31-2430"><a href="#cb31-2430" aria-hidden="true" tabindex="-1"></a>     perc_twopersonsdetected <span class="op">=</span> ts[<span class="st">'both_tracked'</span>].<span class="bu">sum</span>() <span class="op">/</span> <span class="bu">len</span>(ts)</span>
<span id="cb31-2431"><a href="#cb31-2431" aria-hidden="true" tabindex="-1"></a>     <span class="co"># check metadata start</span></span>
<span id="cb31-2432"><a href="#cb31-2432" aria-hidden="true" tabindex="-1"></a>     start <span class="op">=</span> metadata[metadata[<span class="st">'VIDEO_ID'</span>] <span class="op">==</span> videoID][<span class="st">'start'</span>].values</span>
<span id="cb31-2433"><a href="#cb31-2433" aria-hidden="true" tabindex="-1"></a>     <span class="bu">print</span>(<span class="st">"start time of this video: "</span> <span class="op">+</span> <span class="bu">str</span>(start))</span>
<span id="cb31-2434"><a href="#cb31-2434" aria-hidden="true" tabindex="-1"></a>     <span class="co"># calculate the average movement of the com for each person</span></span>
<span id="cb31-2435"><a href="#cb31-2435" aria-hidden="true" tabindex="-1"></a>     average_com_movementp1 <span class="op">=</span> np.mean(np.sqrt((ts[<span class="st">'com_p1_x'</span>].diff()<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> ts[<span class="st">'com_p1_y'</span>].diff()<span class="op">**</span><span class="dv">2</span>)))</span>
<span id="cb31-2436"><a href="#cb31-2436" aria-hidden="true" tabindex="-1"></a>     average_com_movementp2 <span class="op">=</span> np.mean(np.sqrt((ts[<span class="st">'com_p2_x'</span>].diff()<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> ts[<span class="st">'com_p2_y'</span>].diff()<span class="op">**</span><span class="dv">2</span>)))</span>
<span id="cb31-2437"><a href="#cb31-2437" aria-hidden="true" tabindex="-1"></a>     <span class="co"># add a time adjusted variable to the dataset</span></span>
<span id="cb31-2438"><a href="#cb31-2438" aria-hidden="true" tabindex="-1"></a>     <span class="cf">if</span> start.size <span class="op">&gt;</span> <span class="dv">0</span>: </span>
<span id="cb31-2439"><a href="#cb31-2439" aria-hidden="true" tabindex="-1"></a>        <span class="co"># check if endtime not greater than the last time in the dataset</span></span>
<span id="cb31-2440"><a href="#cb31-2440" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (start[<span class="dv">0</span>] <span class="op">+</span> constantwindowsize_sec) <span class="op">&gt;</span> ts[<span class="st">'time'</span>].<span class="bu">max</span>():</span>
<span id="cb31-2441"><a href="#cb31-2441" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"End time is greater than the last time in the dataset, setting end time to max value"</span>)</span>
<span id="cb31-2442"><a href="#cb31-2442" aria-hidden="true" tabindex="-1"></a>        timeadjusted <span class="op">=</span> <span class="st">"TRUE - Adjusted to start at + "</span> <span class="op">+</span> <span class="bu">str</span>(start[<span class="dv">0</span>]) <span class="op">+</span> <span class="st">"With a window length of: "</span> <span class="op">+</span> <span class="bu">str</span>(constantwindowsize_sec) <span class="op">+</span> <span class="st">" seconds"</span></span>
<span id="cb31-2443"><a href="#cb31-2443" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Take a timeseries chunk of 150 seconds</span></span>
<span id="cb31-2444"><a href="#cb31-2444" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> ts[(ts[<span class="st">'time'</span>] <span class="op">&gt;=</span> start[<span class="dv">0</span>]) <span class="op">&amp;</span> (ts[<span class="st">'time'</span>] <span class="op">&lt;=</span> start[<span class="dv">0</span>] <span class="op">+</span> constantwindowsize_sec)]</span>
<span id="cb31-2445"><a href="#cb31-2445" aria-hidden="true" tabindex="-1"></a>     <span class="cf">if</span> start.size <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb31-2446"><a href="#cb31-2446" aria-hidden="true" tabindex="-1"></a>        timeadjusted <span class="op">=</span> <span class="st">"FALSE - Not adjusted to start time as no start time was given for this video, window length is still set to: "</span> <span class="op">+</span> <span class="bu">str</span>(constantwindowsize_sec) <span class="op">+</span> <span class="st">" seconds"</span></span>
<span id="cb31-2447"><a href="#cb31-2447" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> ts[(ts[<span class="st">'time'</span>] <span class="op">&lt;=</span> constantwindowsize_sec)]</span>
<span id="cb31-2448"><a href="#cb31-2448" aria-hidden="true" tabindex="-1"></a>     adjustedsamples <span class="op">=</span> <span class="bu">len</span>(ts[<span class="st">"time"</span>])</span>
<span id="cb31-2449"><a href="#cb31-2449" aria-hidden="true" tabindex="-1"></a>     <span class="bu">print</span>(timeadjusted) </span>
<span id="cb31-2450"><a href="#cb31-2450" aria-hidden="true" tabindex="-1"></a>     <span class="co"># fps is mode timestaps per second </span></span>
<span id="cb31-2451"><a href="#cb31-2451" aria-hidden="true" tabindex="-1"></a>     fps <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>(ts[<span class="st">'time'</span>].diff().mode()[<span class="dv">0</span>])</span>
<span id="cb31-2452"><a href="#cb31-2452" aria-hidden="true" tabindex="-1"></a>     <span class="co"># add time start and time end</span></span>
<span id="cb31-2453"><a href="#cb31-2453" aria-hidden="true" tabindex="-1"></a>     start_time_analysiswindow <span class="op">=</span> start[<span class="dv">0</span>] <span class="cf">if</span> start.size <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb31-2454"><a href="#cb31-2454" aria-hidden="true" tabindex="-1"></a>     end_time_analysiswindow <span class="op">=</span> start_time_analysiswindow <span class="op">+</span> constantwindowsize_sec</span>
<span id="cb31-2455"><a href="#cb31-2455" aria-hidden="true" tabindex="-1"></a>     <span class="co"># calculate the smoothness of the distance between the com and centroid</span></span>
<span id="cb31-2456"><a href="#cb31-2456" aria-hidden="true" tabindex="-1"></a>     smoothness_distancecom <span class="op">=</span> dimensionless_squared_jerk_from_position(ts[<span class="st">'distance_com'</span>].values, ts[<span class="st">'time'</span>].values)</span>
<span id="cb31-2457"><a href="#cb31-2457" aria-hidden="true" tabindex="-1"></a>     <span class="co"># take the derivative of the distance</span></span>
<span id="cb31-2458"><a href="#cb31-2458" aria-hidden="true" tabindex="-1"></a>     distancecomspeed <span class="op">=</span> np.gradient(ts[<span class="st">'distance_com'</span>].values, ts[<span class="st">'time'</span>].values)</span>
<span id="cb31-2459"><a href="#cb31-2459" aria-hidden="true" tabindex="-1"></a>     SPARCsmoothness_distancecom <span class="op">=</span> spectral_arclength(distancecomspeed, <span class="dv">1</span><span class="op">/</span>fps, padlevel<span class="op">=</span><span class="dv">4</span>, fc<span class="op">=</span><span class="fl">10.0</span>, amp_th<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb31-2460"><a href="#cb31-2460" aria-hidden="true" tabindex="-1"></a>     <span class="co"># it is the first value of the distancecomspeed</span></span>
<span id="cb31-2461"><a href="#cb31-2461" aria-hidden="true" tabindex="-1"></a>     SPARCsmoothness_distancecom <span class="op">=</span> SPARCsmoothness_distancecom[<span class="dv">0</span>]</span>
<span id="cb31-2462"><a href="#cb31-2462" aria-hidden="true" tabindex="-1"></a>     <span class="co">#print(smoothness_distancecom)</span></span>
<span id="cb31-2463"><a href="#cb31-2463" aria-hidden="true" tabindex="-1"></a>     smoothness_distancecentroid <span class="op">=</span> dimensionless_squared_jerk_from_position(ts[<span class="st">'distance'</span>].values, ts[<span class="st">'time'</span>].values)</span>
<span id="cb31-2464"><a href="#cb31-2464" aria-hidden="true" tabindex="-1"></a>     <span class="co"># calculate the smoothness of the xy positions for each person</span></span>
<span id="cb31-2465"><a href="#cb31-2465" aria-hidden="true" tabindex="-1"></a>     smoothness_xy_average_com_p1 <span class="op">=</span> (dimensionless_squared_jerk_from_position(ts[<span class="st">'com_p1_x'</span>],ts[<span class="st">'time'</span>].values)<span class="op">+</span>dimensionless_squared_jerk_from_position(ts[<span class="st">'com_p1_y'</span>],ts[<span class="st">'time'</span>].values))<span class="op">/</span><span class="dv">2</span></span>
<span id="cb31-2466"><a href="#cb31-2466" aria-hidden="true" tabindex="-1"></a>     smoothness_xy_average_com_p2 <span class="op">=</span> (dimensionless_squared_jerk_from_position(ts[<span class="st">'com_p2_x'</span>],ts[<span class="st">'time'</span>].values)<span class="op">+</span>dimensionless_squared_jerk_from_position(ts[<span class="st">'com_p2_y'</span>],ts[<span class="st">'time'</span>].values))<span class="op">/</span><span class="dv">2</span></span>
<span id="cb31-2467"><a href="#cb31-2467" aria-hidden="true" tabindex="-1"></a>     smoothness_xy_average_centroid_p1 <span class="op">=</span> (dimensionless_squared_jerk_from_position(ts[<span class="st">'centroid_p1_x'</span>],ts[<span class="st">'time'</span>].values)<span class="op">+</span>dimensionless_squared_jerk_from_position(ts[<span class="st">'centroid_p1_y'</span>],ts[<span class="st">'time'</span>].values))<span class="op">/</span><span class="dv">2</span></span>
<span id="cb31-2468"><a href="#cb31-2468" aria-hidden="true" tabindex="-1"></a>     smoothness_xy_average_centroid_p2 <span class="op">=</span> (dimensionless_squared_jerk_from_position(ts[<span class="st">'centroid_p2_x'</span>],ts[<span class="st">'time'</span>].values)<span class="op">+</span>dimensionless_squared_jerk_from_position(ts[<span class="st">'centroid_p2_y'</span>],ts[<span class="st">'time'</span>].values))<span class="op">/</span><span class="dv">2</span></span>
<span id="cb31-2469"><a href="#cb31-2469" aria-hidden="true" tabindex="-1"></a>     <span class="co"># calculate the smoothness of the proximity approach</span></span>
<span id="cb31-2470"><a href="#cb31-2470" aria-hidden="true" tabindex="-1"></a>     smoothness_p1_proximity <span class="op">=</span> dimensionless_squared_jerk_from_position(ts[<span class="st">'p1_com_approach_pos'</span>].values, ts[<span class="st">'time'</span>].values)</span>
<span id="cb31-2471"><a href="#cb31-2471" aria-hidden="true" tabindex="-1"></a>     smoothness_p2_proximity <span class="op">=</span> dimensionless_squared_jerk_from_position(ts[<span class="st">'p2_com_approach_pos'</span>].values, ts[<span class="st">'time'</span>].values)</span>
<span id="cb31-2472"><a href="#cb31-2472" aria-hidden="true" tabindex="-1"></a>     <span class="co"># append to the new df using concat</span></span>
<span id="cb31-2473"><a href="#cb31-2473" aria-hidden="true" tabindex="-1"></a>     newdf <span class="op">=</span> pd.concat([newdf, pd.DataFrame([[videoID, timeadjusted, originalsamples, adjustedsamples, start_time_analysiswindow, end_time_analysiswindow, perc_twopersonsdetected, average_com_movementp1, average_com_movementp2, smoothness_distancecom, SPARCsmoothness_distancecom, smoothness_distancecentroid, smoothness_xy_average_com_p1, smoothness_xy_average_com_p2, smoothness_xy_average_centroid_p1, smoothness_xy_average_centroid_p2, smoothness_p1_proximity, smoothness_p2_proximity]], columns<span class="op">=</span>newdfcolumns)], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-2474"><a href="#cb31-2474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2475"><a href="#cb31-2475" aria-hidden="true" tabindex="-1"></a><span class="co"># save the new df</span></span>
<span id="cb31-2476"><a href="#cb31-2476" aria-hidden="true" tabindex="-1"></a>newdf.to_csv(outputfol <span class="op">+</span> <span class="st">'smoothness_data.csv'</span>, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">'latin1'</span>)</span>
<span id="cb31-2477"><a href="#cb31-2477" aria-hidden="true" tabindex="-1"></a>newdf.head()</span>
<span id="cb31-2478"><a href="#cb31-2478" aria-hidden="true" tabindex="-1"></a><span class="co"># print done</span></span>
<span id="cb31-2479"><a href="#cb31-2479" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Done with smoothness processing pipeline!"</span>)</span>
<span id="cb31-2480"><a href="#cb31-2480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2481"><a href="#cb31-2481" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-2482"><a href="#cb31-2482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2483"><a href="#cb31-2483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2484"><a href="#cb31-2484" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-2485"><a href="#cb31-2485" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example output smoothness: üìä</span></span>
<span id="cb31-2486"><a href="#cb31-2486" aria-hidden="true" tabindex="-1"></a>For each video we will now have a smoothness feature set. </span>
<span id="cb31-2487"><a href="#cb31-2487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2488"><a href="#cb31-2488" aria-hidden="true" tabindex="-1"></a><span class="in">```{python examplecsvfilelayer20}</span></span>
<span id="cb31-2489"><a href="#cb31-2489" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-2490"><a href="#cb31-2490" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="im">as</span> glob</span>
<span id="cb31-2491"><a href="#cb31-2491" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-2492"><a href="#cb31-2492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2493"><a href="#cb31-2493" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file</span></span>
<span id="cb31-2494"><a href="#cb31-2494" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">"./dataoutput_STEP2_features/smoothness_data.csv"</span></span>
<span id="cb31-2495"><a href="#cb31-2495" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(csv_file)</span>
<span id="cb31-2496"><a href="#cb31-2496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2497"><a href="#cb31-2497" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb31-2498"><a href="#cb31-2498" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span>
<span id="cb31-2499"><a href="#cb31-2499" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2500"><a href="#cb31-2500" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-2501"><a href="#cb31-2501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2502"><a href="#cb31-2502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2503"><a href="#cb31-2503" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extract features for all videos using tsfresh</span></span>
<span id="cb31-2504"><a href="#cb31-2504" aria-hidden="true" tabindex="-1"></a>To show how easy it is to extract features from the time series data, we use the <span class="in">`tsfresh`</span> library <span class="co">[</span><span class="ot">@christTimeSeriesFeatuRe2018</span><span class="co">]</span>. This library contains a large number of features designed to characterize time series data. While we do not use them in our analysis, it provides a convenient example of how easy it is to extract features from the created time series in a data-driven way. The user can of course change this code to add more features or to extract only a subset of features.</span>
<span id="cb31-2505"><a href="#cb31-2505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2506"><a href="#cb31-2506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2507"><a href="#cb31-2507" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-2508"><a href="#cb31-2508" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extracting more features example tsfresh üè¥</span></span>
<span id="cb31-2509"><a href="#cb31-2509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2510"><a href="#cb31-2510" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, code_folding="hide"}</span></span>
<span id="cb31-2511"><a href="#cb31-2511" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-2512"><a href="#cb31-2512" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb31-2513"><a href="#cb31-2513" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-2514"><a href="#cb31-2514" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tsfresh <span class="im">import</span> extract_features</span>
<span id="cb31-2515"><a href="#cb31-2515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2516"><a href="#cb31-2516" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize list to store features from each file</span></span>
<span id="cb31-2517"><a href="#cb31-2517" aria-hidden="true" tabindex="-1"></a>all_features <span class="op">=</span> []</span>
<span id="cb31-2518"><a href="#cb31-2518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2519"><a href="#cb31-2519" aria-hidden="true" tabindex="-1"></a>timeseries <span class="op">=</span> glob.glob(<span class="st">'./dataoutput_STEP1_2_timeseries/*_processed_data_layer2.csv'</span>)</span>
<span id="cb31-2520"><a href="#cb31-2520" aria-hidden="true" tabindex="-1"></a><span class="co"># for checking lets do the first 2 time series</span></span>
<span id="cb31-2521"><a href="#cb31-2521" aria-hidden="true" tabindex="-1"></a>timeseries <span class="op">=</span> timeseries[:<span class="dv">2</span>] <span class="co"># comment this line to process all files</span></span>
<span id="cb31-2522"><a href="#cb31-2522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2523"><a href="#cb31-2523" aria-hidden="true" tabindex="-1"></a><span class="co"># Process each file individually</span></span>
<span id="cb31-2524"><a href="#cb31-2524" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> timeseries:</span>
<span id="cb31-2525"><a href="#cb31-2525" aria-hidden="true" tabindex="-1"></a>    ts_data <span class="op">=</span> pd.read_csv(<span class="bu">file</span>)</span>
<span id="cb31-2526"><a href="#cb31-2526" aria-hidden="true" tabindex="-1"></a>    video_id <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'_processed'</span>)[<span class="dv">0</span>]</span>
<span id="cb31-2527"><a href="#cb31-2527" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2528"><a href="#cb31-2528" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean NaN values for the current file</span></span>
<span id="cb31-2529"><a href="#cb31-2529" aria-hidden="true" tabindex="-1"></a>    distance_data <span class="op">=</span> ts_data[<span class="st">'distance_com'</span>].copy()</span>
<span id="cb31-2530"><a href="#cb31-2530" aria-hidden="true" tabindex="-1"></a>    distance_data <span class="op">=</span> distance_data.interpolate(method<span class="op">=</span><span class="st">'linear'</span>)</span>
<span id="cb31-2531"><a href="#cb31-2531" aria-hidden="true" tabindex="-1"></a>    distance_data <span class="op">=</span> distance_data.fillna(method<span class="op">=</span><span class="st">'ffill'</span>)</span>
<span id="cb31-2532"><a href="#cb31-2532" aria-hidden="true" tabindex="-1"></a>    distance_data <span class="op">=</span> distance_data.fillna(method<span class="op">=</span><span class="st">'bfill'</span>)</span>
<span id="cb31-2533"><a href="#cb31-2533" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2534"><a href="#cb31-2534" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create DataFrame for current file only</span></span>
<span id="cb31-2535"><a href="#cb31-2535" aria-hidden="true" tabindex="-1"></a>    current_data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb31-2536"><a href="#cb31-2536" aria-hidden="true" tabindex="-1"></a>        <span class="st">'id'</span>: video_id,</span>
<span id="cb31-2537"><a href="#cb31-2537" aria-hidden="true" tabindex="-1"></a>        <span class="st">'time'</span>: <span class="bu">range</span>(<span class="bu">len</span>(distance_data)),</span>
<span id="cb31-2538"><a href="#cb31-2538" aria-hidden="true" tabindex="-1"></a>        <span class="st">'distance_com'</span>: distance_data</span>
<span id="cb31-2539"><a href="#cb31-2539" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb31-2540"><a href="#cb31-2540" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2541"><a href="#cb31-2541" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract features for current file only</span></span>
<span id="cb31-2542"><a href="#cb31-2542" aria-hidden="true" tabindex="-1"></a>    current_features <span class="op">=</span> extract_features(current_data, column_id<span class="op">=</span><span class="st">'id'</span>, column_sort<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb31-2543"><a href="#cb31-2543" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2544"><a href="#cb31-2544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add to our collection</span></span>
<span id="cb31-2545"><a href="#cb31-2545" aria-hidden="true" tabindex="-1"></a>    all_features.append(current_features)</span>
<span id="cb31-2546"><a href="#cb31-2546" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2547"><a href="#cb31-2547" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: print progress</span></span>
<span id="cb31-2548"><a href="#cb31-2548" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processed </span><span class="sc">{</span>video_id<span class="sc">}</span><span class="ss"> - extracted </span><span class="sc">{</span><span class="bu">len</span>(current_features.columns)<span class="sc">}</span><span class="ss"> features"</span>)</span>
<span id="cb31-2549"><a href="#cb31-2549" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-2550"><a href="#cb31-2550" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clear variables to free memory</span></span>
<span id="cb31-2551"><a href="#cb31-2551" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> ts_data, distance_data, current_data, current_features</span>
<span id="cb31-2552"><a href="#cb31-2552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2553"><a href="#cb31-2553" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all features at the end</span></span>
<span id="cb31-2554"><a href="#cb31-2554" aria-hidden="true" tabindex="-1"></a>combined_features <span class="op">=</span> pd.concat(all_features, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-2555"><a href="#cb31-2555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2556"><a href="#cb31-2556" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total: Extracted </span><span class="sc">{</span><span class="bu">len</span>(combined_features.columns)<span class="sc">}</span><span class="ss"> features from </span><span class="sc">{</span><span class="bu">len</span>(combined_features)<span class="sc">}</span><span class="ss"> videos"</span>)</span>
<span id="cb31-2557"><a href="#cb31-2557" aria-hidden="true" tabindex="-1"></a>combined_features.to_csv(<span class="st">'./dataoutput_STEP2_features/tsfresh_features_fromCOMdistance.csv'</span>)</span>
<span id="cb31-2558"><a href="#cb31-2558" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2559"><a href="#cb31-2559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2560"><a href="#cb31-2560" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-2561"><a href="#cb31-2561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2562"><a href="#cb31-2562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2563"><a href="#cb31-2563" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb31-2564"><a href="#cb31-2564" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example output tsfresh: üìä</span></span>
<span id="cb31-2565"><a href="#cb31-2565" aria-hidden="true" tabindex="-1"></a>For each video we will now have a smoothness feature set. </span>
<span id="cb31-2566"><a href="#cb31-2566" aria-hidden="true" tabindex="-1"></a><span class="in">```{python examplecsvfilelayer21}</span></span>
<span id="cb31-2567"><a href="#cb31-2567" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-2568"><a href="#cb31-2568" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="im">as</span> glob</span>
<span id="cb31-2569"><a href="#cb31-2569" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-2570"><a href="#cb31-2570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2571"><a href="#cb31-2571" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file</span></span>
<span id="cb31-2572"><a href="#cb31-2572" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">"./dataoutput_STEP2_features/tsfresh_features_fromCOMdistance.csv"</span></span>
<span id="cb31-2573"><a href="#cb31-2573" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(csv_file)</span>
<span id="cb31-2574"><a href="#cb31-2574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2575"><a href="#cb31-2575" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb31-2576"><a href="#cb31-2576" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span>
<span id="cb31-2577"><a href="#cb31-2577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2578"><a href="#cb31-2578" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-2579"><a href="#cb31-2579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2580"><a href="#cb31-2580" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-settingup collapse="true"}</span>
<span id="cb31-2581"><a href="#cb31-2581" aria-hidden="true" tabindex="-1"></a><span class="fu">## DIY STEP 2: Feature Extraction üõ†Ô∏è</span></span>
<span id="cb31-2582"><a href="#cb31-2582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2583"><a href="#cb31-2583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2584"><a href="#cb31-2584" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 1: Install requirements</span></span>
<span id="cb31-2585"><a href="#cb31-2585" aria-hidden="true" tabindex="-1"></a>For each script we have provided a <span class="in">`requirements.txt`</span> file. You can install the requirements using pip, by first navigating to the folder where the script is located and then running the following command in your terminal:</span>
<span id="cb31-2586"><a href="#cb31-2586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2587"><a href="#cb31-2587" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb31-2588"><a href="#cb31-2588" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP2_smoothness_features/</span>
<span id="cb31-2589"><a href="#cb31-2589" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb31-2590"><a href="#cb31-2590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2591"><a href="#cb31-2591" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 2: Run the python script</span></span>
<span id="cb31-2592"><a href="#cb31-2592" aria-hidden="true" tabindex="-1"></a>Assuming you have timeseries data (<span class="in">`./dataoutput_STEP1_2_timeseries/`</span>), you can run the script using the following command:</span>
<span id="cb31-2593"><a href="#cb31-2593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2594"><a href="#cb31-2594" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb31-2595"><a href="#cb31-2595" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP2_smoothness_features/</span>
<span id="cb31-2596"><a href="#cb31-2596" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> STEP2_featureextraction.py</span>
<span id="cb31-2597"><a href="#cb31-2597" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2598"><a href="#cb31-2598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2599"><a href="#cb31-2599" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-2600"><a href="#cb31-2600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2601"><a href="#cb31-2601" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 3: Non-linear time series analysis (R)</span></span>
<span id="cb31-2602"><a href="#cb31-2602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2603"><a href="#cb31-2603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2604"><a href="#cb31-2604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2605"><a href="#cb31-2605" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 4: Statistical analysis (R)</span></span>
<span id="cb31-2606"><a href="#cb31-2606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2607"><a href="#cb31-2607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb31-2608"><a href="#cb31-2608" aria-hidden="true" tabindex="-1"></a><span class="co"># manually edited this CSV</span></span>
<span id="cb31-2609"><a href="#cb31-2609" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"C:/Users/wiltshir/GitHub/InterPerDynPipelineAnalysis/Re_ Behavioral Dynamics in Social Interactions AP_SI/smoothness_data_top_view_clean.csv"</span>) </span>
<span id="cb31-2610"><a href="#cb31-2610" aria-hidden="true" tabindex="-1"></a><span class="co">#data_cross_cultur&lt;-data[1:18,]</span></span>
<span id="cb31-2611"><a href="#cb31-2611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2612"><a href="#cb31-2612" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove a row</span></span>
<span id="cb31-2613"><a href="#cb31-2613" aria-hidden="true" tabindex="-1"></a>data<span class="ot">&lt;-</span> <span class="fu">subset</span>(data, data<span class="sc">$</span>videoID<span class="sc">!=</span><span class="st">"cop_b09 z g√≥ry"</span>)</span>
<span id="cb31-2614"><a href="#cb31-2614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2615"><a href="#cb31-2615" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a culture grouping variable</span></span>
<span id="cb31-2616"><a href="#cb31-2616" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>culture <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"g√≥ry$"</span>, data<span class="sc">$</span>videoID), <span class="st">"Yurakare"</span>,</span>
<span id="cb31-2617"><a href="#cb31-2617" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"kam_5$"</span>, data<span class="sc">$</span>videoID), <span class="st">"Polish"</span>, <span class="cn">NA</span>))</span>
<span id="cb31-2618"><a href="#cb31-2618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2619"><a href="#cb31-2619" aria-hidden="true" tabindex="-1"></a><span class="co"># Restructure data into long format</span></span>
<span id="cb31-2620"><a href="#cb31-2620" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb31-2621"><a href="#cb31-2621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2622"><a href="#cb31-2622" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb31-2623"><a href="#cb31-2623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2624"><a href="#cb31-2624" aria-hidden="true" tabindex="-1"></a>data_long <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb31-2625"><a href="#cb31-2625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(smoothness_p1_proximity, smoothness_p2_proximity),</span>
<span id="cb31-2626"><a href="#cb31-2626" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"person"</span>,</span>
<span id="cb31-2627"><a href="#cb31-2627" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"smoothness_value"</span>)</span>
<span id="cb31-2628"><a href="#cb31-2628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2629"><a href="#cb31-2629" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4) </span>
<span id="cb31-2630"><a href="#cb31-2630" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest) </span>
<span id="cb31-2631"><a href="#cb31-2631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2632"><a href="#cb31-2632" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(smoothness_value <span class="sc">~</span> culture <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> videoID), <span class="at">data =</span> data_long)</span>
<span id="cb31-2633"><a href="#cb31-2633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2634"><a href="#cb31-2634" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span>
<span id="cb31-2635"><a href="#cb31-2635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-2636"><a href="#cb31-2636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2637"><a href="#cb31-2637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2638"><a href="#cb31-2638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2639"><a href="#cb31-2639" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-settingup collapse="true"}</span>
<span id="cb31-2640"><a href="#cb31-2640" aria-hidden="true" tabindex="-1"></a><span class="fu">## DIY: Analysis üõ†Ô∏è</span></span>
<span id="cb31-2641"><a href="#cb31-2641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2642"><a href="#cb31-2642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2643"><a href="#cb31-2643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2644"><a href="#cb31-2644" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-2645"><a href="#cb31-2645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2646"><a href="#cb31-2646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2647"><a href="#cb31-2647" aria-hidden="true" tabindex="-1"></a><span class="fu"># References</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>