<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Arkadiusz Białek">
<meta name="author" content="Wim Pouw">
<meta name="author" content="James Trujillo">
<meta name="author" content="Fred Hasselman">
<meta name="author" content="Babajide Alamu Owoyele">
<meta name="author" content="Natalia Siekiera">
<meta name="author" content="Joanna Rączaszek-Leonardi">
<meta name="author" content="Travis J. Wiltshire">
<meta name="dcterms.date" content="2025-05-29">

<title>An Open-source Standardized Pipeline for Tracing the Behavioral Dynamics in Social Interactions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-0815c480559380816a4d1ea211a47e91.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-84b3b4cc5777f6fdbd4d01919023a4cd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


<link rel="stylesheet" href="quarto_dependencies/styles/styles.css">
</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a></li>
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset"><span class="header-section-number">2</span> Dataset</a>
  <ul class="collapse">
  <li><a href="#dataset-mother-infant" id="toc-dataset-mother-infant" class="nav-link" data-scroll-target="#dataset-mother-infant"><span class="header-section-number">2.0.1</span> Dataset Mother Infant</a></li>
  <li><a href="#dataset-siblings" id="toc-dataset-siblings" class="nav-link" data-scroll-target="#dataset-siblings"><span class="header-section-number">2.0.2</span> Dataset Siblings</a></li>
  </ul></li>
  <li><a href="#step-1-motion-tracking-and-signal-processing-and-wrangling" id="toc-step-1-motion-tracking-and-signal-processing-and-wrangling" class="nav-link" data-scroll-target="#step-1-motion-tracking-and-signal-processing-and-wrangling"><span class="header-section-number">3</span> Step 1: Motion tracking and signal processing and wrangling</a></li>
  <li><a href="#step-1.1-tracking-two-persons-in-videos-for-top-view-python" id="toc-step-1.1-tracking-two-persons-in-videos-for-top-view-python" class="nav-link" data-scroll-target="#step-1.1-tracking-two-persons-in-videos-for-top-view-python"><span class="header-section-number">4</span> Step 1.1: Tracking two persons in videos for top-view (Python)</a>
  <ul class="collapse">
  <li><a href="#step-3-run-the-python-script" id="toc-step-3-run-the-python-script" class="nav-link" data-scroll-target="#step-3-run-the-python-script"><span class="header-section-number">4.0.3</span> Step 3: Run the python script</a></li>
  </ul></li>
  <li><a href="#step-1.2-raw-pose-data-post-processing-for-timeseries-matrices-python" id="toc-step-1.2-raw-pose-data-post-processing-for-timeseries-matrices-python" class="nav-link" data-scroll-target="#step-1.2-raw-pose-data-post-processing-for-timeseries-matrices-python"><span class="header-section-number">5</span> Step 1.2: Raw pose data post-processing for timeseries matrices (Python)</a></li>
  <li><a href="#step-2-summary-feature-extraction-smoothness" id="toc-step-2-summary-feature-extraction-smoothness" class="nav-link" data-scroll-target="#step-2-summary-feature-extraction-smoothness"><span class="header-section-number">6</span> Step 2: Summary feature extraction: Smoothness</a></li>
  <li><a href="#step-3-calculating-feature-data-e.g.-jerkiness-from-timeseries-python" id="toc-step-3-calculating-feature-data-e.g.-jerkiness-from-timeseries-python" class="nav-link" data-scroll-target="#step-3-calculating-feature-data-e.g.-jerkiness-from-timeseries-python"><span class="header-section-number">7</span> Step 3: Calculating feature data (e.g., jerkiness) from timeseries (Python)</a></li>
  <li><a href="#step-4-statistical-analysis-e.g.-jerkiness-of-proximityapproachavoidance-or-non-linear-recurrence-r" id="toc-step-4-statistical-analysis-e.g.-jerkiness-of-proximityapproachavoidance-or-non-linear-recurrence-r" class="nav-link" data-scroll-target="#step-4-statistical-analysis-e.g.-jerkiness-of-proximityapproachavoidance-or-non-linear-recurrence-r"><span class="header-section-number">8</span> Step 4: Statistical analysis (e.g., jerkiness of proximity/approach/avoidance, or non-linear recurrence) (R)</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">9</span> References</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">An Open-source Standardized Pipeline for Tracing the Behavioral Dynamics in Social Interactions</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Computationally Reproducible Extended Methods Section</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Arkadiusz Białek </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Jagiellonian University, Poland
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Wim Pouw </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Tilburg University, Netherlands
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">James Trujillo </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Amsterdam, Netherlands
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Fred Hasselman </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Radboud University, Netherlands
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Babajide Alamu Owoyele </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Hasso Plattner Institute, University of Potsdam, Germany
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Natalia Siekiera </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Jagiellonian University, Poland
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Joanna Rączaszek-Leonardi </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Warsaw, Poland
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Travis J. Wiltshire </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Tilburg University, Netherlands
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 29, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p><img src="images/ts.gif" class="img-fluid"></p>
<section id="overview" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Overview</h1>
<p>To increase reproducibility of our approach we have designed this Quarto notebook that provides the user with what is effectively a manual-style extended methods and results section. Next to staging and (visually) explaining key Python and R code elements, the notebook contains detailed further “Do It Yourself” (DIY) instructions that can be accessed on demand by clicking on DIY sections, for example providing the technical steps needed to install and then run code for YOLO tracking on (user-defined) data. This Notebook is not simply an add-on supplemental text, but it is a key part of our contribution as it allows for newcomers to social processing to start implementing this pipeline step by step.</p>
<p>The Quarto notebook is structured to have the following components, next to steps:</p>
<ul>
<li><p><strong>code snippets</strong> that overview complete code, or shorter code chunks to for example explain a particular function. Denoted with the symbol 🚩.</p></li>
<li><p><strong>example output</strong> that shows example output. Denoted with the symbol 📊.</p></li>
<li><p><strong>DIY blocks</strong> that provide shorter, step-by-step links to the full code for executing a particular step in the pipeline on your own code 🛠️.</p></li>
</ul>
<p><strong>What the Quarto notebook is not intended to do:</strong> The notebook is not a complete collection of every piece of code needed to replicate the pipeline. It is not intended to be run on its own when replicating the pipeline (whether on your own data, or on the sample data). For actually applying this code, see the <strong>DIY</strong> blocks.</p>
</section>
<section id="dataset" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Dataset</h1>
<p>The following data has been made available in masked form.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Download Guide ⬇️
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The masked data can be downloaded from the repository of Jagellonian University <a href="">here</a>. The unmasked data can be requested from the authors. The unmasked data is not available in this repository for privacy reasons.</p>
</div>
</div>
</div>
<section id="dataset-mother-infant" class="level3" data-number="2.0.1">
<h3 data-number="2.0.1" class="anchored" data-anchor-id="dataset-mother-infant"><span class="header-section-number">2.0.1</span> Dataset Mother Infant</h3>
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>matplotlib.use(<span class="st">'agg'</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>plt.ioff()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>plt.clf() <span class="co"># Clear any existing figures</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'./meta/project_point_metadata_ages.csv'</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert gender to categorical label</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'gender_label'</span>] <span class="op">=</span> df[<span class="st">'gender'</span>].<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'Female'</span>, <span class="dv">1</span>: <span class="st">'Male'</span>})</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 2x2 subplot layout</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>), gridspec_kw<span class="op">=</span>{<span class="st">'width_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>], <span class="st">'height_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>]})</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Mother-Infant Dataset Overview'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for gender</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Female'</span>: <span class="st">'#C55A11'</span>,   <span class="co"># Orange for females</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Male'</span>: <span class="st">'#4472C4'</span>       <span class="co"># Blue for males</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Line plot - Age progression across time points</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    gender <span class="op">=</span> row[<span class="st">'gender_label'</span>]</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create arrays for days and time points, handling NaN values</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    days <span class="op">=</span> []</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    timepoints <span class="op">=</span> []</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):   <span class="co"># T1 to T7</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        day_col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> day_col <span class="kw">in</span> df.columns <span class="kw">and</span> pd.notna(row[day_col]) <span class="kw">and</span> row[day_col] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>            days.append(row[day_col])</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            timepoints.append(i)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the line for this infant</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>, <span class="dv">0</span>].plot(</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        timepoints,</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        days,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>colors[gender],</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">1.5</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Customize the plot</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Infant Age Progression'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>))</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xticklabels([<span class="ss">f'T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>)])</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Add legend patches</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>legend_elements <span class="op">=</span> [</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    Patch(facecolor<span class="op">=</span>colors[<span class="st">'Female'</span>], edgecolor<span class="op">=</span><span class="st">'w'</span>, label<span class="op">=</span><span class="st">'Female'</span>),</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    Patch(facecolor<span class="op">=</span>colors[<span class="st">'Male'</span>], edgecolor<span class="op">=</span><span class="st">'w'</span>, label<span class="op">=</span><span class="st">'Male'</span>)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Box plot - Age distribution at each time point</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>time_point_data <span class="op">=</span> []</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> []</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):   <span class="co"># T1 to T7</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        valid_data <span class="op">=</span> df[col].dropna()</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>            time_point_data.append(valid_data)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="ss">f'T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Create violin plots</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> time_point_data:</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    violin_parts <span class="op">=</span> axs[<span class="dv">0</span>, <span class="dv">1</span>].violinplot(</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>        time_point_data,</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        showmeans<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>        showmedians<span class="op">=</span><span class="va">True</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Color the violin plots</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, pc <span class="kw">in</span> <span class="bu">enumerate</span>(violin_parts[<span class="st">'bodies'</span>]):</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>        pc.set_facecolor(<span class="st">'#7030A0'</span>)  <span class="co"># Purple</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>        pc.set_edgecolor(<span class="st">'black'</span>)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>        pc.set_alpha(<span class="fl">0.7</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(labels) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels(labels)</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Age Distribution by Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Pie chart - Gender distribution</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>gender_counts <span class="op">=</span> df[<span class="st">'gender_label'</span>].value_counts()</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].pie(</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    gender_counts,</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>gender_counts.index,</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>    autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[colors[g] <span class="cf">for</span> g <span class="kw">in</span> gender_counts.index],</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    wedgeprops<span class="op">=</span>{<span class="st">'edgecolor'</span>: <span class="st">'w'</span>, <span class="st">'linewidth'</span>: <span class="dv">1</span>}</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Gender Distribution'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Summary table</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate averages for each time point, handling NaN values</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>averages_days <span class="op">=</span> []</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>        avg <span class="op">=</span> df[col].mean()</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> pd.isna(avg):</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>            avg_months <span class="op">=</span> avg <span class="op">/</span> <span class="fl">30.44</span>  <span class="co"># Convert to months</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>            averages_days.append([<span class="ss">f"T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> Average Age"</span>, <span class="ss">f"</span><span class="sc">{</span>avg<span class="sc">:.1f}</span><span class="ss"> days (</span><span class="sc">{</span>avg_months<span class="sc">:.1f}</span><span class="ss"> months)"</span>])</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Count participants at each time point</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>participants <span class="op">=</span> []</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> df[col].notna().<span class="bu">sum</span>()</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>        participants.append([<span class="ss">f"Participants at T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"</span><span class="sc">{</span>count<span class="sc">}</span><span class="ss">"</span>])</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall statistics</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> [</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Total Infants"</span>, <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Females"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'gender'</span>] <span class="op">==</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Males"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'gender'</span>] <span class="op">==</span> <span class="dv">1</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a><span class="co"># Add age ranges if columns exist</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'age_T1_days'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>    summary_data.append([<span class="st">"Age Range T1"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'age_T1_days'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df[<span class="st">'age_T1_days'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss"> days"</span>])</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>last_tp <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> last_tp <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>last_tp<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns <span class="kw">and</span> df[col].notna().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>        summary_data.append([<span class="ss">f"Age Range T</span><span class="sc">{</span>last_tp<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"</span><span class="sc">{</span>df[col]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df[col]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss"> days"</span>])</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>    last_tp <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the table with the most important summary statistics</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">1</span>].table(</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>    cellText<span class="op">=</span>summary_data <span class="op">+</span> participants,</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>    cellLoc<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>table.scale(<span class="dv">1</span>, <span class="fl">1.5</span>)</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Dataset Summary'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the figure to a file</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">"images/mother_infant_analysis.png"</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>os.makedirs(os.path.dirname(output_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>plt.close(fig) <span class="co"># Explicitly close the figure object</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/mother_infant_analysis.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="600"></p>
</figure>
</div>
<p>In our github repository we use a sample data from this dataset from an infant-mother pair whom we are allowed to share the video data for the current purposes.</p>
</section>
<section id="dataset-siblings" class="level3" data-number="2.0.2">
<h3 data-number="2.0.2" class="anchored" data-anchor-id="dataset-siblings"><span class="header-section-number">2.0.2</span> Dataset Siblings</h3>
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'./meta/project_siblings_metadata_ages_gender.csv'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Data preprocessing</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'AgeDifference'</span>] <span class="op">=</span> <span class="bu">abs</span>(df[<span class="st">'P1agedays'</span>] <span class="op">-</span> df[<span class="st">'P2agedays'</span>])</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'AverageAge'</span>] <span class="op">=</span> (df[<span class="st">'P1agedays'</span>] <span class="op">+</span> df[<span class="st">'P2agedays'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'GenderCombo'</span>] <span class="op">=</span> df[<span class="st">'GenderP1'</span>] <span class="op">+</span> <span class="st">'-'</span> <span class="op">+</span> df[<span class="st">'GenderP2'</span>]</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 2x2 subplot layout</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), gridspec_kw<span class="op">=</span>{<span class="st">'width_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>], <span class="st">'height_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>]})</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Sibling Dataset Overview'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for gender combinations</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'M-M'</span>: <span class="st">'#4472C4'</span>,   <span class="co"># Blue</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'M-F'</span>: <span class="st">'#7030A0'</span>,   <span class="co"># Purple</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'F-M'</span>: <span class="st">'#548235'</span>,   <span class="co"># Green</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'F-F'</span>: <span class="st">'#C55A11'</span>    <span class="co"># Rust/Orange</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Scatter plot - P1 age vs P2 age</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gender_combo, group <span class="kw">in</span> df.groupby(<span class="st">'GenderCombo'</span>):</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>, <span class="dv">0</span>].scatter(</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'P1agedays'</span>],</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'P2agedays'</span>],</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>colors.get(gender_combo, <span class="st">'gray'</span>),</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span>gender_combo,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span><span class="dv">50</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Add reference line</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>min_age <span class="op">=</span> <span class="bu">min</span>(df[<span class="st">'P1agedays'</span>].<span class="bu">min</span>(), df[<span class="st">'P2agedays'</span>].<span class="bu">min</span>())</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>max_age <span class="op">=</span> <span class="bu">max</span>(df[<span class="st">'P1agedays'</span>].<span class="bu">max</span>(), df[<span class="st">'P2agedays'</span>].<span class="bu">max</span>())</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].plot([min_age, max_age], [min_age, max_age], <span class="st">'k--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'P1 Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'P2 Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Participant Ages (P1 vs P2)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].legend()</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Bar chart - Age differences</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>bar_positions <span class="op">=</span> np.arange(<span class="bu">len</span>(df))</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>bar_width <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].bar(</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    bar_positions,</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'AgeDifference'</span>],</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span>bar_width,</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>[colors.get(combo, <span class="st">'gray'</span>) <span class="cf">for</span> combo <span class="kw">in</span> df[<span class="st">'GenderCombo'</span>]]</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks(bar_positions)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels(df[<span class="st">'Code'</span>], rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Sibling Pair'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Age Difference (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Age Differences by Sibling Pair'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Pie chart - Gender distribution</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>gender_counts <span class="op">=</span> df[<span class="st">'GenderCombo'</span>].value_counts()</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].pie(</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    gender_counts,</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>gender_counts.index,</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[colors.get(combo, <span class="st">'gray'</span>) <span class="cf">for</span> combo <span class="kw">in</span> gender_counts.index],</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    wedgeprops<span class="op">=</span>{<span class="st">'edgecolor'</span>: <span class="st">'w'</span>, <span class="st">'linewidth'</span>: <span class="dv">1</span>}</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Gender Distribution'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Summary table</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> [</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Total Sibling Pairs"</span>, <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average P1 Age"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'P1agedays'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average P2 Age"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'P2agedays'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average Age Difference"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'AgeDifference'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Number of Males"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'GenderP1'</span>] <span class="op">==</span> <span class="st">'M'</span>)<span class="sc">.</span><span class="bu">sum</span>() <span class="op">+</span> (df[<span class="st">'GenderP2'</span>] <span class="op">==</span> <span class="st">'M'</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Number of Females"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'GenderP1'</span>] <span class="op">==</span> <span class="st">'F'</span>)<span class="sc">.</span><span class="bu">sum</span>() <span class="op">+</span> (df[<span class="st">'GenderP2'</span>] <span class="op">==</span> <span class="st">'F'</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn off axis for table</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">1</span>].table(</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>    cellText<span class="op">=</span>[row <span class="cf">for</span> row <span class="kw">in</span> summary_data],</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    colLabels<span class="op">=</span>[<span class="st">"Measure"</span>, <span class="st">"Value"</span>],</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    cellLoc<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>table.scale(<span class="dv">1</span>, <span class="fl">1.5</span>)</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Dataset Summary'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the figure to a file</span></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">"images/sibling_analysis.png"</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>os.makedirs(os.path.dirname(output_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>plt.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/sibling_analysis.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="600"></p>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
DIY: Setting up 🛠️
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<section id="step-0-github-repo" class="level3 callout-body-container callout-body" data-number="2.0.3">
<h3 data-number="2.0.3" class="anchored" data-anchor-id="step-0-github-repo"><span class="header-section-number">2.0.3</span> Step 0: Github repo</h3>
<p>You should first clone the repository <a href="https://github.com/WimPouw/InterPerDynPipeline">InterPerDynPipeline</a> and move to the root directory. The step 1 code for tracking is in the <code>./code_STEP1_posetrackingprocessing/</code> folder. In this folder you will find the Python script <code>yolo_tracking_processing.py</code>. To check whether you have the correct script you can compare against the code chunk provided below.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/WimPouw/InterPerDynPipeline</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ./InterPerDynPipeline/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
</section>
</section>
<section id="step-1-motion-tracking-and-signal-processing-and-wrangling" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Step 1: Motion tracking and signal processing and wrangling</h1>
<p>The motion tracking and signal processing pipeline is divided into two main steps: 1. <strong>Tracking</strong>: This step involves tracking the movements of individuals in the videos using a pose estimation model. The output is a video with annotated keypoints and a CSV file containing the coordinates of these keypoints. 2. <strong>Signal Processing</strong>: This step involves processing the keypoint data to extract relevant features for analysis. The output are processed timeseries files, and a flat dataset containing our smoothness measures that are directly ready for statistical analysis.</p>
</section>
<section id="step-1.1-tracking-two-persons-in-videos-for-top-view-python" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Step 1.1: Tracking two persons in videos for top-view (Python)</h1>
<p>We have tried several pose tracking solutions, such as OpenPose (model 25B; <span class="citation" data-cites="caoOpenPoseRealtimeMultiPerson2021">Cao et al. (<a href="#ref-caoOpenPoseRealtimeMultiPerson2021" role="doc-biblioref">2021</a>)</span>), Mediapipe (default highest complexity blazepose model; <span class="citation" data-cites="lugaresiMediaPipeFrameworkBuilding2019">Lugaresi et al. (<a href="#ref-lugaresiMediaPipeFrameworkBuilding2019" role="doc-biblioref">2019</a>)</span>) and we found that these models are not well equipped to track persons from top view, most likely because these models are not trained on ground-truth poses of persons from top-view camera angles. However, we found the heaviest model of yolo v8 (“yolov8x-pose-p6.pt”) does perform very well, especially as compared to the other models we tested. Thus, for this pipeline we recommend using YOLOv8 model for top-view tracking.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
DIY: Motion Tracking Set-Up and Execution 🛠️
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="step-1-install-requirements" class="level3" data-number="4.0.1">
<h3 data-number="4.0.1" class="anchored" data-anchor-id="step-1-install-requirements"><span class="header-section-number">4.0.1</span> Step 1: Install requirements</h3>
<p>For each script we have provided a <code>requirements.txt</code> file. You can install the requirements using pip, by first navigating to the folder where the script is located and then running the following command in your terminal:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP1_posetrackingprocessing/</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-download-the-yolov8-model" class="level3" data-number="4.0.2">
<h3 data-number="4.0.2" class="anchored" data-anchor-id="step-2-download-the-yolov8-model"><span class="header-section-number">4.0.2</span> Step 2: Download the YOLOv8 model</h3>
<p>In the current GitHub repo we have a light-weight model <code>yolov8n-pose.pt</code> (~6.5MB) for immediate testing of the code. However, this model is not as accurate as the heaviest model.</p>
<p>We should download the heaviest model (<code>yolov8x-pose-p6.pt</code>) and save it to the <code>./code_STEP1_posetrackingprocessing/model/</code> directory:<br>
https://github.com/ultralytics/assets/releases/download/v8.1.0/yolov8x-pose-p6.pt</p>
<p><strong>Note</strong>: If you’re running the heavyweight model, you will need GPU support for this to run in a reasonable time. The lightweight model can run on CPU.</p>
</section>
</div>
</div>
</div>
<section id="step-3-run-the-python-script" class="level3" data-number="4.0.3">
<h3 data-number="4.0.3" class="anchored" data-anchor-id="step-3-run-the-python-script"><span class="header-section-number">4.0.3</span> Step 3: Run the python script</h3>
<p>Assuming you have videos in your data folder (<code>./data_raw/</code>) and you have a <code>.pt</code> model in the model folder, you can run the script using the following command:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP1_posetrackingprocessing/</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> yolo_tracking_processing.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:::</p>
<p>The code below is the script <code>yolo_tracking_processing.py</code> that you can run to track the videos. The output will be a video with annotated keypoints and a CSV file containing the coordinates of these keypoints. The script processes each video frame-by-frame, detecting people and their pose keypoints (17 points as listed in the script; see the <code>GetKeypoint class</code>). We filter out duplicate detections or skeletons with excessive missing data. Specifically, for each processed video, the script generates two output files: an annotated video showing the original footage with skeleton overlays (green points for accepted keypoints, red for filtered ones, and blue lines connecting the points), and a CSV file containing the raw coordinate data (frame number, person ID, keypoint ID, x-coordinate, y-coordinate). The output filenames include parameters like “c150” (150px proximity threshold) and “miss95” (95% missing data tolerance), which control how the system handles potential duplicate detections and incomplete skeletons. The user could adjust the parameter <code>close_threshold</code> and <code>miss_tolerance</code> to adjust the detection dynamics. We output the annotated video and the CSV file in the <code>./datatracked_afterSTEP1/</code> folder.</p>
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ultralytics <span class="im">import</span> YOLO</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch <span class="co"># for gpu support</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> combinations</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>torch.cuda.set_device(<span class="dv">0</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>modelfolder <span class="op">=</span> <span class="st">'./model/'</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>modellocation <span class="op">=</span> glob.glob(modelfolder<span class="op">+</span><span class="st">"*.pt"</span>)[<span class="dv">0</span>]</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>modelfile <span class="op">=</span> os.path.basename(modellocation)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"We are loading in the following YOLO model: </span><span class="sc">{</span>modelfile<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> YOLO(modellocation)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co"># main variables</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>video_folder <span class="op">=</span> <span class="st">"../data_raw/"</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># avi mp4 or other video formats</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>video_files <span class="op">=</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mp4"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.avi"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mov"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mkv"</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>step1resultfolder <span class="op">=</span> <span class="st">"../datatracked_afterSTEP1/"</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(video_files)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co"># keypoint names</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GetKeypoint(BaseModel):</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    NOSE:           <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    LEFT_EYE:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    RIGHT_EYE:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    LEFT_EAR:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    RIGHT_EAR:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    LEFT_SHOULDER:  <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    RIGHT_SHOULDER: <span class="bu">int</span> <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    LEFT_ELBOW:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    RIGHT_ELBOW:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    LEFT_WRIST:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    RIGHT_WRIST:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    LEFT_HIP:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">11</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    RIGHT_HIP:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    LEFT_KNEE:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    RIGHT_KNEE:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    LEFT_ANKLE:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    RIGHT_ANKLE:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>get_keypoint <span class="op">=</span> GetKeypoint()</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Define skeleton connections</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>skeleton <span class="op">=</span> [</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.RIGHT_SHOULDER),</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.LEFT_ELBOW),</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_SHOULDER, get_keypoint.RIGHT_ELBOW),</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_ELBOW, get_keypoint.LEFT_WRIST),</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_ELBOW, get_keypoint.RIGHT_WRIST),</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.LEFT_HIP),</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_SHOULDER, get_keypoint.RIGHT_HIP),</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_HIP, get_keypoint.RIGHT_HIP),</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_HIP, get_keypoint.LEFT_KNEE),</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_HIP, get_keypoint.RIGHT_KNEE),</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_KNEE, get_keypoint.LEFT_ANKLE),</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_KNEE, get_keypoint.RIGHT_ANKLE),</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tensor_to_matrix(results_tensor):</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this just takes the results output of YOLO and coverts it to a matrix,</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># making it easier to do quick calculations on the coordinates</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    results_list <span class="op">=</span> results_tensor.tolist()</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>    results_matrix <span class="op">=</span> np.matrix(results_list)</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    results_matrix[results_matrix<span class="op">==</span><span class="dv">0</span>] <span class="op">=</span> np.nan</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_matrix</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_for_duplication(results):</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this threshold determines how close two skeletons must be in order to be</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># considered the same person. Arbitrarily chosen for now.</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    close_threshold <span class="op">=</span><span class="dv">150</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># missing data tolerance</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    miss_tolerance <span class="op">=</span> <span class="fl">0.95</span> <span class="co"># this means we can miss up to 75% of the keypoints</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    drop_indices <span class="op">=</span> []</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>        conf_scores <span class="op">=</span> []</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get detection confidence for each skeleton</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> person <span class="kw">in</span> tensor_to_matrix(results[<span class="dv">0</span>].keypoints.conf):</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>            conf_scores.append(np.mean(person))</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this list will stores which comparisons need to be made</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>        combos <span class="op">=</span> <span class="bu">list</span>(combinations(<span class="bu">range</span>(<span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy)), <span class="dv">2</span>))</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># now loop through these comparisons</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> combo <span class="kw">in</span> combos:</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>            closeness <span class="op">=</span> <span class="bu">abs</span>(np.nanmean(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[combo[<span class="dv">0</span>]]) <span class="op">-</span> </span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>                        tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[combo[<span class="dv">1</span>]])))</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if any of them indicate that two skeletons are very close together,</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>            <span class="co"># we keep the one with higher tracking confidence, and remove the other</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> closeness <span class="op">&lt;</span> close_threshold:</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>                conf_list <span class="op">=</span> [conf_scores[combo[<span class="dv">0</span>]], conf_scores[combo[<span class="dv">1</span>]]]</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>                idx_min <span class="op">=</span> conf_list.index(<span class="bu">min</span>(conf_list))</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>                drop_indices.append(combo[idx_min])</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># additional checks:</span></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> person <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy)):</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>           keypoints_missed <span class="op">=</span>  np.isnan(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[person])).<span class="bu">sum</span>()<span class="op">/</span><span class="dv">2</span></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>           perc_missed <span class="op">=</span> keypoints_missed<span class="op">/</span><span class="bu">len</span>(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[person]))</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>           <span class="cf">if</span> perc_missed <span class="op">&gt;</span> miss_tolerance:</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>               drop_indices.append(person)</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">set</span>(drop_indices))</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> video_path <span class="kw">in</span> video_files:</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Video path</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>    video_path <span class="op">=</span> video_path</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only if the output is not there yet</span></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(step1resultfolder<span class="op">+</span> os.path.basename(video_path).split(<span class="st">'.'</span>)[<span class="dv">0</span>]<span class="op">+</span><span class="st">"_annotated_layer1_c150_miss95.mp4"</span>):</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Output video already exists for </span><span class="sc">{</span>video_path<span class="sc">}</span><span class="ss">. Skipping..."</span>)</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># vidname without extension</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> os.path.basename(video_path)</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> vidname.split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Open the video</span></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>    cap <span class="op">=</span> cv2.VideoCapture(video_path)</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get video properties</span></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>    fps <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FPS))</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the output video writer</span></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>    corename <span class="op">=</span> os.path.basename(video_path).split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>    output_path <span class="op">=</span> step1resultfolder<span class="op">+</span> vidname<span class="op">+</span><span class="st">"_annotated_layer1_c150_miss95.mp4"</span></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>    fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span><span class="st">'mp4v'</span>)</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> cv2.VideoWriter(output_path, fourcc, fps, (width, height))</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare CSV file</span></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>    csv_path <span class="op">=</span> step1resultfolder<span class="op">+</span> vidname<span class="op">+</span><span class="st">'_keypoints_data_layer1.csv'</span></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>    csv_file <span class="op">=</span> <span class="bu">open</span>(csv_path, <span class="st">'w'</span>, newline<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>    csv_writer <span class="op">=</span> csv.writer(csv_file)</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write header</span></span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>    header <span class="op">=</span> [<span class="st">'frame'</span>, <span class="st">'person'</span>, <span class="st">'keypoint'</span>, <span class="st">'x'</span>, <span class="st">'y'</span>]</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>    csv_writer.writerow(header)</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>    frame_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> cap.isOpened():</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>        success, frame <span class="op">=</span> cap.read()</span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run YOLOv8 inference on the frame</span></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> model(frame)</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>        <span class="co"># write empty rows if no person is detected</span></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>            csv_writer.writerow([frame_count, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>])</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>        annotated_frame <span class="op">=</span> frame</span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>        <span class="co"># only do this if a person is detected</span></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process the results</span></span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>            drop_indices <span class="op">=</span> []</span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>            drop_indices <span class="op">=</span> check_for_duplication(results)</span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> person_idx, person_keypoints <span class="kw">in</span> <span class="bu">enumerate</span>(results[<span class="dv">0</span>].keypoints.xy):</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> person_idx <span class="kw">not</span> <span class="kw">in</span> drop_indices:</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>                    colourcode <span class="op">=</span> (<span class="dv">0</span>, <span class="dv">255</span>, <span class="dv">0</span>)</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>                    colourcode <span class="op">=</span> (<span class="dv">255</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> keypoint_idx, keypoint <span class="kw">in</span> <span class="bu">enumerate</span>(person_keypoints):</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>                    x, y <span class="op">=</span> keypoint</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Write to CSV</span></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>                    csv_writer.writerow([frame_count, person_idx, keypoint_idx, x.item(), y.item()])</span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Draw keypoint on the frame</span></span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>                    cv2.circle(annotated_frame, (<span class="bu">int</span>(x), <span class="bu">int</span>(y)), <span class="dv">5</span>, colourcode, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw skeleton</span></span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> connection <span class="kw">in</span> skeleton:</span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> connection[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="bu">len</span>(person_keypoints) <span class="kw">and</span> connection[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="bu">len</span>(person_keypoints):</span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>                        start_point <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">map</span>(<span class="bu">int</span>, person_keypoints[connection[<span class="dv">0</span>]]))</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>                        end_point <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">map</span>(<span class="bu">int</span>, person_keypoints[connection[<span class="dv">1</span>]]))</span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">all</span>(start_point) <span class="kw">and</span> <span class="bu">all</span>(end_point):  <span class="co"># Check if both points are valid</span></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>                            cv2.line(annotated_frame, start_point, end_point, (<span class="dv">255</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">2</span>)</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write the frame to the output video</span></span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>            out.write(annotated_frame)</span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>        frame_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Release everything</span></span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>    cap.release()</span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>    out.release()</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>    cv2.destroyAllWindows()</span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>    csv_file.close()</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Output video saved as </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Keypoints data saved as </span><span class="sc">{</span>csv_path<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is an example of the output video with annotated keypoints and skeletons. The green points indicate accepted keypoints, while the red points indicate filtered ones. The blue lines connect the keypoints to form a skeleton.</p>

<video width="300" height="200" controls="">
<source src="./images/videosrerendered/sample.mp4" type="video/mp4">
Your browser does not support the video tag. </video>

<p>Here is an example of the output csv file containing the coordinates of the keypoints. The CSV file contains the following columns: frame number, person ID, keypoint ID, x-coordinate, and y-coordinate. Each row corresponds to a detected keypoint in a specific frame.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example output and code example for YOLO tracking: 📊
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>TESTEST</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="im">as</span> glob</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>folderstep1output <span class="op">=</span> <span class="st">"./data_tracked_afterSTEP1_1/"</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> glob.glob(os.path.join(folderstep1output <span class="op">+</span> <span class="st">"*.csv"</span>))[<span class="dv">0</span>]</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(csv_file)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   frame  person  keypoint    x    y
0      0       0         0  0.0  0.0
1      0       0         1  0.0  0.0
2      0       0         2  0.0  0.0
3      0       0         3  0.0  0.0
4      0       0         4  0.0  0.0</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="step-1.2-raw-pose-data-post-processing-for-timeseries-matrices-python" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Step 1.2: Raw pose data post-processing for timeseries matrices (Python)</h1>
<p>The raw pose data with frame, person, keypoint, and x,y position data that we end up with is not yet in a format that is easy to work with for our purposes. Additionally, sometimes we dont have a person or two persons detected in the frame. We want to transform these raw pose data to timeseries matrix format, whereby we have time in seconds as one column and different meaningful time-varying variables in the other columns. Furthermore, we will smooth and interpolate the data if necessary. The below python code executes this second step whereby we store the position data per person, and furthe derive interpersonal distances measures, and kinematic metrics (e.g.&nbsp;speed) and tracking quality indicators (e.g.&nbsp;tracking status that says something about where it concerns interpolated data).</p>
<p>Next to determining time in seconds from the frame rate of the videos, the script starts with assigning left and right person IDs based on the horizontal position in the frame (with left being ID 1 and right being ID 2). It then processes the time data to calculate statistics for tracked people using upper body keypoints (as the lower body keypoints are unreliable from top-view and may be ignored). Specifically, we reduce the dimensionality of all upper body keypoints by determined relative positions and their distances: We calculate a bounding box (determined by the outer edges of the keypoints) and determine the center in x and y coordinates (<code>centroid_x</code>, <code>centroid_y</code>) and their P1-P2 distance of those centroids (<code>distance</code>), and the center of mass (<code>com_x</code>, <code>com_y</code>) for each person and the distnace (<code>distance_com</code>). Further we determine the midpoint of the shoulders as another relevant position (<code>shoulder_midpoint_x</code>, <code>shoulder_midpoint_y</code>) and compute its distance (<code>distance_shoulder_midpoint</code>). Additionally, information about body parts such as arm motions by taking the wrist positions (<code>wrist_left_x</code>, <code>wrist_left_y</code>, <code>wrist_right_x</code>, <code>wrist_right_y</code>), and further deriving total motion per second, called speed (based on a euclidean sum of the changes of position along x and y).</p>
<p>The Savitzky-Golay filter is applied for smoothing jittering position data (using a window size of 11 frames, polynomial order of 3). The script handles missing data through two complementary techniques: linear interpolation for brief gaps in tracking (up to 5 frames) and we take the last known location for longer gaps (up to 20 frames). The script also calculates the speed of the center of mass and wrist positions, and here we also smooth the values using the Savitzky-Golay filter to reduce noise that is amplified during differientation (see <span class="citation" data-cites="winterBiomechanicsMotorControl2009">Winter (<a href="#ref-winterBiomechanicsMotorControl2009" role="doc-biblioref">2009</a>)</span>).</p>
<p>The more sophisticated measure that we have created is the proximity calculation measure (see function <code>calculate_approach()</code> in the step2 script). This function establishes initial reference position for both participants and then projects their subsequent movements onto the connecting line between them. This allows for quantifying approach and retreat behaviors for each person seperately (which a distance measure does not allow for) while allowing for relative angle changes between them - positive values indicate movement toward the other person (relative from start), while negative values indicate withdrawal (relative from start).</p>
<p>Below is an animation to what we are measuring. We are here capturing only movements that are changing the distance between them. When someone moves in a circle around the other person we want to make sure we do not register that as approach or retreat (which we would do if we just capture horizontal position for example). However we also want capture each person their own approach/avoidance value (which would not be possible when using a simple distance measure). By always measuring the signed length of the projected line from the initial position (based on the current connected line), the method tracks cumulative approach/avoidance for each person over time.</p>
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.animation <span class="im">import</span> FuncAnimation</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> patches</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.lines <span class="im">as</span> mlines</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Force matplotlib to use Agg backend to avoid display issues</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>matplotlib.use(<span class="st">'Agg'</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">"images/proximity_visualization"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation parameters</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>num_frames <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>p1_color <span class="op">=</span> <span class="st">'#3498db'</span>  <span class="co"># Blue</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>p2_color <span class="op">=</span> <span class="st">'#e74c3c'</span>  <span class="co"># Red</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>vector_color <span class="op">=</span> <span class="st">'#2ecc71'</span>  <span class="co"># Green</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create initial positions for two people - now on a horizontal line</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 1 on the left, Person 2 on the right (same y-coordinate)</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>p1_initial <span class="op">=</span> np.array([<span class="dv">3</span>, <span class="dv">5</span>])</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>p2_initial <span class="op">=</span> np.array([<span class="dv">7</span>, <span class="dv">5</span>])</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate movement paths with MORE EXTREME approach and avoidance</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 1 will make a dramatic approach followed by retreat</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 2 will make a clear retreat followed by approach</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>np.pi, num_frames)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Create more dramatic movement path for Person 1</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Increase the amplitude of movement to make it more extreme</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>p1_path_x <span class="op">=</span> p1_initial[<span class="dv">0</span>] <span class="op">+</span> <span class="fl">2.5</span> <span class="op">*</span> np.sin(t<span class="op">/</span><span class="dv">2</span>)  <span class="co"># Larger horizontal movement (was 1.5)</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>p1_path_y <span class="op">=</span> p1_initial[<span class="dv">1</span>] <span class="op">+</span> <span class="fl">2.5</span> <span class="op">*</span> np.sin(t)   <span class="co"># Larger vertical movement (was 2.0)</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Create more dramatic movement path for Person 2</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the retreat phase more obvious</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>p2_path_x <span class="op">=</span> p2_initial[<span class="dv">0</span>] <span class="op">-</span> <span class="fl">1.2</span> <span class="op">*</span> np.sin(t)    <span class="co"># More horizontal movement (was 0.5)</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>p2_path_y <span class="op">=</span> p2_initial[<span class="dv">1</span>] <span class="op">-</span> <span class="fl">2.0</span> <span class="op">*</span> np.sin(t<span class="op">*</span><span class="fl">1.5</span>)  <span class="co"># More vertical movement (was 1.0)</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Store positions for each frame</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>p1_positions <span class="op">=</span> np.column_stack((p1_path_x, p1_path_y))</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>p2_positions <span class="op">=</span> np.column_stack((p2_path_x, p2_path_y))</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrays to store approach values</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>p1_approach_values <span class="op">=</span> np.zeros(num_frames)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>p2_approach_values <span class="op">=</span> np.zeros(num_frames)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate proximity approach values</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_approach(positions1, positions2):</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate approach values similar to the script's approach"""</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use first frame as reference</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    reference_p1_pos <span class="op">=</span> positions1[<span class="dv">0</span>].copy()</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    reference_p2_pos <span class="op">=</span> positions2[<span class="dv">0</span>].copy()</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    p1_approach <span class="op">=</span> np.zeros(<span class="bu">len</span>(positions1))</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    p2_approach <span class="op">=</span> np.zeros(<span class="bu">len</span>(positions2))</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(positions1)):</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current positions</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> positions1[i]</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> positions2[i]</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current connecting vector and direction</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>        current_connect <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>        current_distance <span class="op">=</span> np.linalg.norm(current_connect)</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_distance <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>            current_direction <span class="op">=</span> current_connect <span class="op">/</span> current_distance</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Vectors from reference positions</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>            p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> reference_p1_pos</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>            p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> reference_p2_pos</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Project onto connecting line</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>            p1_approach[i] <span class="op">=</span> np.dot(p1_vector, current_direction)</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P2, a positive value should mean movement toward P1</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>            <span class="co"># So we use the negative connecting direction (from P2 to P1)</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>            <span class="co"># And a positive dot product means approaching</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>            p2_direction <span class="op">=</span> <span class="op">-</span>current_direction  <span class="co"># Direction from P2 to P1</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>            p2_approach[i] <span class="op">=</span> np.dot(p2_vector, p2_direction)</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> p1_approach, p2_approach</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate approach values</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>p1_approach_values, p2_approach_values <span class="op">=</span> calculate_approach(p1_positions, p2_positions)</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the main visualization</span></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_detailed_animation():</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set up the figure explicitly with DPI</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>), dpi<span class="op">=</span><span class="dv">100</span>)  <span class="co"># Larger figure for better visibility</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> init():</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>        ax.clear()</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>        ax.set_aspect(<span class="st">'equal'</span>)</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> animate(i):</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>        ax.clear()</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set up the axes</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>        ax.set_aspect(<span class="st">'equal'</span>)</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">'Proximity Approach Visualization (Extreme Movements)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">'X Position'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Y Position'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get current positions</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> p1_positions[i]</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> p2_positions[i]</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the initial connecting vector (reference)</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>        ax.plot([p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">0</span>]], </span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>                [p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>]], </span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the current connection vector</span></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>        ax.plot([p1_pos[<span class="dv">0</span>], p2_pos[<span class="dv">0</span>]], [p1_pos[<span class="dv">1</span>], p2_pos[<span class="dv">1</span>]], </span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="fl">2.5</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw person markers</span></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p1_pos[<span class="dv">0</span>], p1_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">180</span>, color<span class="op">=</span>p1_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p2_pos[<span class="dv">0</span>], p2_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">180</span>, color<span class="op">=</span>p2_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw initial positions</span></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span>p1_color, </span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>                   alpha<span class="op">=</span><span class="fl">0.5</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span>p2_color, </span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>                   alpha<span class="op">=</span><span class="fl">0.5</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw trails (last 15 positions)</span></span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>        start_idx <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, i<span class="op">-</span><span class="dv">15</span>)</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>        ax.plot(p1_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">0</span>], p1_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>], </span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-'</span>, color<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>        ax.plot(p2_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">0</span>], p2_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>], </span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-'</span>, color<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Visualize the approach values with text - make them larger and more visible</span></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>        approach_text <span class="op">=</span> (<span class="ss">f"P1 approach: </span><span class="sc">{</span>p1_approach_values[i]<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f"P2 approach: </span><span class="sc">{</span>p2_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.05</span>, <span class="fl">0.95</span>, approach_text, transform<span class="op">=</span>ax.transAxes, </span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>                verticalalignment<span class="op">=</span><span class="st">'top'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>                bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>))</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add projection visualization</span></span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get current connecting direction</span></span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>            connect_vector <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>            connect_distance <span class="op">=</span> np.linalg.norm(connect_vector)</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>            connect_direction <span class="op">=</span> connect_vector <span class="op">/</span> connect_distance</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Person 1 projection</span></span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>            p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> p1_positions[<span class="dv">0</span>]</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>            p1_projection <span class="op">=</span> np.dot(p1_vector, connect_direction) <span class="op">*</span> connect_direction</span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection line for P1</span></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>            p1_proj_point <span class="op">=</span> p1_positions[<span class="dv">0</span>] <span class="op">+</span> p1_projection</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Person 2 projection - use direction from P2 to P1</span></span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>            p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> p2_positions[<span class="dv">0</span>]</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>            p2_direction <span class="op">=</span> <span class="op">-</span>connect_direction  <span class="co"># Direction from P2 to P1</span></span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>            p2_projection <span class="op">=</span> np.dot(p2_vector, p2_direction) <span class="op">*</span> p2_direction</span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection line for P2</span></span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>            p2_proj_point <span class="op">=</span> p2_positions[<span class="dv">0</span>] <span class="op">+</span> p2_projection</span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection lines with arrows to show direction</span></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P1</span></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>            p1_approach <span class="op">=</span> p1_approach_values[i]</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(p1_approach) <span class="op">&gt;</span> <span class="fl">0.1</span>:  <span class="co"># Only draw if there's a significant approach value</span></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw line with increased width</span></span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>                ax.plot([p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_proj_point[<span class="dv">0</span>]], </span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>                        [p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], p1_proj_point[<span class="dv">1</span>]], </span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'--'</span>, color<span class="op">=</span>p1_color, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add arrow to show direction - make arrow larger</span></span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>                arrow_length <span class="op">=</span> <span class="bu">min</span>(<span class="bu">abs</span>(p1_approach) <span class="op">*</span> <span class="fl">0.2</span>, <span class="fl">0.6</span>)  <span class="co"># Scale arrow size</span></span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>                arrow_width <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> p1_approach <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Approaching</span></span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position toward projection point</span></span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>                            arrow_length <span class="op">*</span> connect_direction[<span class="dv">0</span>], arrow_length <span class="op">*</span> connect_direction[<span class="dv">1</span>],</span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p1_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:  <span class="co"># Retreating</span></span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position away from projection point</span></span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>                            <span class="op">-</span>arrow_length <span class="op">*</span> connect_direction[<span class="dv">0</span>], <span class="op">-</span>arrow_length <span class="op">*</span> connect_direction[<span class="dv">1</span>],</span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p1_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add value label near the projection line</span></span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>                mid_x <span class="op">=</span> (p1_positions[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> p1_proj_point[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>                mid_y <span class="op">=</span> (p1_positions[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> p1_proj_point[<span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a>                ax.text(mid_x, mid_y, <span class="ss">f"</span><span class="sc">{</span>p1_approach<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>p1_color, fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a>                        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, boxstyle<span class="op">=</span><span class="st">'round,pad=0.2'</span>))</span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P2</span></span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a>            p2_approach <span class="op">=</span> p2_approach_values[i]</span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(p2_approach) <span class="op">&gt;</span> <span class="fl">0.1</span>:  <span class="co"># Only draw if there's a significant approach value</span></span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw line with increased width</span></span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>                ax.plot([p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_proj_point[<span class="dv">0</span>]], </span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>                        [p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], p2_proj_point[<span class="dv">1</span>]], </span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'--'</span>, color<span class="op">=</span>p2_color, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add arrow to show direction - make arrow larger</span></span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a>                arrow_length <span class="op">=</span> <span class="bu">min</span>(<span class="bu">abs</span>(p2_approach) <span class="op">*</span> <span class="fl">0.2</span>, <span class="fl">0.6</span>)  <span class="co"># Scale arrow size</span></span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a>                arrow_width <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> p2_approach <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Approaching</span></span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position toward P1</span></span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a>                            arrow_length <span class="op">*</span> p2_direction[<span class="dv">0</span>], arrow_length <span class="op">*</span> p2_direction[<span class="dv">1</span>],</span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p2_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:  <span class="co"># Retreating</span></span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position away from P1</span></span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a>                            <span class="op">-</span>arrow_length <span class="op">*</span> p2_direction[<span class="dv">0</span>], <span class="op">-</span>arrow_length <span class="op">*</span> p2_direction[<span class="dv">1</span>],</span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p2_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add value label near the projection line</span></span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a>                mid_x <span class="op">=</span> (p2_positions[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> p2_proj_point[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a>                mid_y <span class="op">=</span> (p2_positions[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> p2_proj_point[<span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a>                ax.text(mid_x, mid_y, <span class="ss">f"</span><span class="sc">{</span>p2_approach<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>p2_color, fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a>                        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, boxstyle<span class="op">=</span><span class="st">'round,pad=0.2'</span>))</span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add small markers at projection points</span></span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_proj_point[<span class="dv">0</span>], p1_proj_point[<span class="dv">1</span>], </span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a>                      color<span class="op">=</span>p1_color, s<span class="op">=</span><span class="dv">70</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_proj_point[<span class="dv">0</span>], p2_proj_point[<span class="dv">1</span>], </span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a>                      color<span class="op">=</span>p2_color, s<span class="op">=</span><span class="dv">70</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw horizontal dotted line at initial y-coordinate to emphasize horizontal start</span></span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a>            ax.axhline(y<span class="op">=</span>p1_initial[<span class="dv">1</span>], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add legend</span></span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a>        legend_elements <span class="op">=</span> [</span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>p1_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Person 1'</span>),</span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>p2_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Person 2'</span>),</span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>vector_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Connection Vector'</span>),</span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a>            mlines.Line2D([], [], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, label<span class="op">=</span><span class="st">'Initial Horizontal Line'</span>),</span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a>            mlines.Line2D([], [], color<span class="op">=</span>p1_color, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Projection Length = Approach Value'</span>)</span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a>        ax.legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add a frame counter</span></span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.95</span>, <span class="fl">0.05</span>, <span class="ss">f"Frame: </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>num_frames<span class="op">-</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>, transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a>               horizontalalignment<span class="op">=</span><span class="st">'right'</span>, verticalalignment<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true" tabindex="-1"></a>               bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add description text</span></span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a>        description <span class="op">=</span> (</span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Proximity Calculation Visualization</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Large dots: Current positions</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Small dots: Initial positions (horizontal alignment)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Green line: Current connecting vector</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Dashed lines: Projection of movement (length = approach value)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Arrows: Direction of approach/retreat</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Positive values: Movement toward other person</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Negative values: Movement away from other person</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- X markers: Projected positions"</span></span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.05</span>, <span class="fl">0.05</span>, description, transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a>               verticalalignment<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a>               bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>))</span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the animation with explicit FPS and DPI</span></span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a>    ani <span class="op">=</span> FuncAnimation(fig, animate, frames<span class="op">=</span>num_frames, init_func<span class="op">=</span>init, </span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a>                        blit<span class="op">=</span><span class="va">True</span>, interval<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the animation as a GIF with explicit DPI</span></span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a>    ani.save(<span class="st">'images/proximity_visualization/proximity_calculation_extreme.gif'</span>, writer<span class="op">=</span><span class="st">'pillow'</span>, fps<span class="op">=</span><span class="dv">10</span>, dpi<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a>    plt.close(fig)</span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the animation</span></span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Creating animation..."</span>)</span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true" tabindex="-1"></a>    create_detailed_animation()</span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GIF created successfully in the 'images/proximity_visualization' folder."</span>)</span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error creating animation: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alternative approach if the above fails - create static frames</span></span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Trying alternative approach with static frames..."</span>)</span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a static image sequence instead</span></span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a>        os.makedirs(<span class="st">"images/proximity_visualization/frames"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create 10 static frames instead of full animation</span></span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a>        sample_frames <span class="op">=</span> np.linspace(<span class="dv">0</span>, num_frames<span class="op">-</span><span class="dv">1</span>, <span class="dv">10</span>, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, i <span class="kw">in</span> <span class="bu">enumerate</span>(sample_frames):</span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a>            fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), dpi<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Set up the axes</span></span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a>            ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a>            ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a>            ax.set_title(<span class="ss">f'Proximity Calculation (Frame </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get current positions</span></span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a>            p1_pos <span class="op">=</span> p1_positions[i]</span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a>            p2_pos <span class="op">=</span> p2_positions[i]</span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw the connection vector</span></span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a>            ax.plot([p1_pos[<span class="dv">0</span>], p2_pos[<span class="dv">0</span>]], [p1_pos[<span class="dv">1</span>], p2_pos[<span class="dv">1</span>]], </span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-315"><a href="#cb9-315" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-316"><a href="#cb9-316" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw person markers</span></span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_pos[<span class="dv">0</span>], p1_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">150</span>, color<span class="op">=</span>p1_color, label<span class="op">=</span><span class="st">'Person 1'</span>)</span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_pos[<span class="dv">0</span>], p2_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">150</span>, color<span class="op">=</span>p2_color, label<span class="op">=</span><span class="st">'Person 2'</span>)</span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw initial positions</span></span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-324"><a href="#cb9-324" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw horizontal dotted line at initial y-coordinate</span></span>
<span id="cb9-325"><a href="#cb9-325" aria-hidden="true" tabindex="-1"></a>            ax.axhline(y<span class="op">=</span>p1_initial[<span class="dv">1</span>], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb9-326"><a href="#cb9-326" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-327"><a href="#cb9-327" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Show approach values</span></span>
<span id="cb9-328"><a href="#cb9-328" aria-hidden="true" tabindex="-1"></a>            ax.text(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="ss">f"Person 1 approach: </span><span class="sc">{</span>p1_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb9-329"><a href="#cb9-329" aria-hidden="true" tabindex="-1"></a>                    transform<span class="op">=</span>ax.transAxes, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb9-330"><a href="#cb9-330" aria-hidden="true" tabindex="-1"></a>                    bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.3</span>))</span>
<span id="cb9-331"><a href="#cb9-331" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-332"><a href="#cb9-332" aria-hidden="true" tabindex="-1"></a>            ax.text(<span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="ss">f"Person 2 approach: </span><span class="sc">{</span>p2_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb9-333"><a href="#cb9-333" aria-hidden="true" tabindex="-1"></a>                    transform<span class="op">=</span>ax.transAxes, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb9-334"><a href="#cb9-334" aria-hidden="true" tabindex="-1"></a>                    bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.3</span>))</span>
<span id="cb9-335"><a href="#cb9-335" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-336"><a href="#cb9-336" aria-hidden="true" tabindex="-1"></a>            ax.legend()</span>
<span id="cb9-337"><a href="#cb9-337" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-338"><a href="#cb9-338" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the frame</span></span>
<span id="cb9-339"><a href="#cb9-339" aria-hidden="true" tabindex="-1"></a>            plt.tight_layout()</span>
<span id="cb9-340"><a href="#cb9-340" aria-hidden="true" tabindex="-1"></a>            plt.savefig(<span class="ss">f'images/proximity_visualization/frames/frame_</span><span class="sc">{</span>idx<span class="sc">:02d}</span><span class="ss">.png'</span>)</span>
<span id="cb9-341"><a href="#cb9-341" aria-hidden="true" tabindex="-1"></a>            plt.close(fig)</span>
<span id="cb9-342"><a href="#cb9-342" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-343"><a href="#cb9-343" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Static frames created successfully in 'images/proximity_visualization/frames' folder."</span>)</span>
<span id="cb9-344"><a href="#cb9-344" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-345"><a href="#cb9-345" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Alternative approach also failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Creating animation...
GIF created successfully in the 'images/proximity_visualization' folder.</code></pre>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/proximity_visualization/proximity_calculation.gif" class="img-fluid figure-img"></p>
<figcaption>Proximity Calculation Visualization</figcaption>
</figure>
</div>
<p>We further check for any remaining missing values after processing and confirms time continuity to detect any frame drops or temporal misalignments.</p>
<p>The output of this script is a timeseries matrix for each video, which contains the time in seconds and the calculated variables. The timeseries matrices are saved in the <code>./data_timeseries_afterSTEP2/</code> folder. The code below is the script <code>STEP2_process_timeseries.py</code> that you can run to process the raw pose data.</p>
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bisect <span class="im">import</span> bisect_left</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> savgol_filter</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Path Definitions</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>INPUT_LAYER1_PATH <span class="op">=</span> <span class="st">'../data_tracked_afterSTEP1/'</span>  <span class="co"># Input directory containing tracked keypoint data from STEP1</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>VIDEO_PATH <span class="op">=</span> <span class="st">"../data_raw/"</span>                        <span class="co"># Raw video files directory</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>OUTPUT_PATH <span class="op">=</span> <span class="st">'../data_timeseries_afterSTEP2/'</span>     <span class="co"># Output directory for processed timeseries data</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable Explanations:</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Positional Variables:</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># - x, y: 2D coordinates in the image frame</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># - x_min, x_max, y_min, y_max: Bounding box coordinates for a person</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># - centroid_x, centroid_y: Center point of a person's bounding box</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co"># - com_x, com_y: Center of mass for a person (average of upper body keypoint positions)</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># - shoulder_midpoint_*: Midpoint between left and right shoulders for each person (p1, p2)</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co"># - wrist_left_*, wrist_right_*: Positions of left and right wrists for each person (p1, p2)</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance Variables:</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance: Euclidean distance between the centroids of both people</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance_com: Euclidean distance between centers of mass of both people</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance_shoulder_midpoint: Distance between shoulder midpoints of both people</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="co"># - *_speed: Euclidean speed of different body parts (calculated from position differences)</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co"># - *_speed_smooth: Smoothed version of speed using Savitzky-Golay filter</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Movement Analysis:</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="co"># - p1_com_approach_pos, p2_com_approach_pos: Position of each person's COM relative to their</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="co">#   initial position, projected onto the connecting line between people. Positive values </span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="co">#   indicate movement toward the other person.</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Tracking Status:</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="co"># - both_tracked: Boolean indicating if both people are tracked in the current frame</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="co"># - single_tracked: Boolean indicating if only one person is tracked in the current frame</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> frame_to_time(ts, fps):</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert frame numbers to time in seconds"""</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    ts[<span class="st">"time"</span>] <span class="op">=</span> [row[<span class="dv">1</span>][<span class="st">"frame"</span>] <span class="op">/</span> fps <span class="cf">for</span> row <span class="kw">in</span> ts.iterrows()]</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> take_closest(myList, myNumber):</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="co">    Assumes myList is sorted. Returns closest value to myNumber.</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="co">    If two numbers are equally close, return the smallest number.</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">=</span> bisect_left(myList, myNumber)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> myList[<span class="dv">0</span>]</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">==</span> <span class="bu">len</span>(myList):</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> myList[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>    before <span class="op">=</span> myList[pos <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    after <span class="op">=</span> myList[pos]</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> after <span class="op">-</span> myNumber <span class="op">&lt;</span> myNumber <span class="op">-</span> before:</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> after</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> before</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_left_right(ts):</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Assign person IDs (0 or 1) based on x-position in the frame"""</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>    min_x <span class="op">=</span> np.<span class="bu">min</span>([val <span class="cf">for</span> val <span class="kw">in</span> ts[<span class="st">'x'</span>] <span class="cf">if</span> val <span class="op">!=</span> <span class="dv">0</span>])</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>    max_x <span class="op">=</span> np.<span class="bu">max</span>([val <span class="cf">for</span> val <span class="kw">in</span> ts[<span class="st">'x'</span>] <span class="cf">if</span> val <span class="op">!=</span> <span class="dv">0</span>])</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> ts.iterrows():</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'x'</span>] <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># Skip untracked points</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> take_closest([min_x, max_x], row[<span class="st">'x'</span>]) <span class="op">==</span> min_x:</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>            ts.loc[index, <span class="st">'person'</span>] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Left person</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>            ts.loc[index, <span class="st">'person'</span>] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Right person</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_time_data(ts):</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate statistics for tracked people using upper body keypoints"""</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    ts_upper <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>] <span class="op">&lt;</span> <span class="dv">11</span>]  <span class="co"># Filter to upper body keypoints only</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate stats per person and time</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> ts_upper.groupby([<span class="st">'time'</span>, <span class="st">'person'</span>]).agg({</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">'x'</span>: [<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>],</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y'</span>: [<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>]</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    stats.columns <span class="op">=</span> [<span class="st">'time'</span>, <span class="st">'person'</span>, <span class="st">'x_min'</span>, <span class="st">'x_max'</span>, <span class="st">'com_x'</span>, <span class="st">'y_min'</span>, <span class="st">'y_max'</span>, <span class="st">'com_y'</span>]</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    stats[<span class="st">'centroid_x'</span>] <span class="op">=</span> (stats[<span class="st">'x_min'</span>] <span class="op">+</span> stats[<span class="st">'x_max'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    stats[<span class="st">'centroid_y'</span>] <span class="op">=</span> (stats[<span class="st">'y_min'</span>] <span class="op">+</span> stats[<span class="st">'y_max'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stats</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_people_data_vectorized(ts, stats):</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a><span class="co">    Process keypoint data to calculate relative positions and distances.</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a><span class="co">    Preserves time alignment and handles COM/centroid assignment.</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all unique times from the original data</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>    all_times <span class="op">=</span> <span class="bu">sorted</span>(ts[<span class="st">'time'</span>].unique())</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>all_times)</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>    result.index.name <span class="op">=</span> <span class="st">'time'</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process shoulders first (keypoints 5 and 6)</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>    shoulders <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>].isin([<span class="dv">5</span>, <span class="dv">6</span>])].groupby([<span class="st">'time'</span>, <span class="st">'person'</span>]).agg({</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>        <span class="st">'x'</span>: <span class="st">'mean'</span>,</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y'</span>: <span class="st">'mean'</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process wrists (keypoints 7 and 8)</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>    wrists <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>].isin([<span class="dv">7</span>, <span class="dv">8</span>])].pivot_table(</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="st">'time'</span>, <span class="st">'person'</span>],</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span><span class="st">'keypoint'</span>,</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[<span class="st">'x'</span>, <span class="st">'y'</span>]</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>    wrists.columns <span class="op">=</span> [<span class="st">'time'</span>, <span class="st">'person'</span>, <span class="st">'left_x'</span>, <span class="st">'right_x'</span>, <span class="st">'left_y'</span>, <span class="st">'right_y'</span>]</span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get person-specific data</span></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>    p0_stats <span class="op">=</span> stats[stats[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">0</span>].set_index(<span class="st">'time'</span>)</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>    p1_stats <span class="op">=</span> stats[stats[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">1</span>].set_index(<span class="st">'time'</span>)</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process distances where both people exist</span></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>    common_times <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>(p0_stats.index) <span class="op">&amp;</span> <span class="bu">set</span>(p1_stats.index))</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> common_times:  <span class="co"># Only calculate if we have common times</span></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>        result.loc[common_times, <span class="st">'distance'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'centroid_x'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'centroid_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'centroid_y'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'centroid_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>        result.loc[common_times, <span class="st">'distance_com'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'com_x'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'com_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'com_y'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'com_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process shoulders per person</span></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> person, prefix <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'p1'</span>), (<span class="dv">1</span>, <span class="st">'p2'</span>)]:</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>        s_person <span class="op">=</span> shoulders[shoulders[<span class="st">'person'</span>] <span class="op">==</span> person].set_index(<span class="st">'time'</span>)</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'shoulder_midpoint_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> s_person[<span class="st">'x'</span>]</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'shoulder_midpoint_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> s_person[<span class="st">'y'</span>]</span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate shoulder midpoint distance where possible</span></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>    shoulder_cols <span class="op">=</span> [<span class="st">'shoulder_midpoint_p1_x'</span>, <span class="st">'shoulder_midpoint_p2_x'</span>,</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'shoulder_midpoint_p1_y'</span>, <span class="st">'shoulder_midpoint_p2_y'</span>]</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>    shoulder_mask <span class="op">=</span> result[shoulder_cols].notna().<span class="bu">all</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> shoulder_mask.<span class="bu">any</span>():</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>        result.loc[shoulder_mask, <span class="st">'distance_shoulder_midpoint'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>            (result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p1_x'</span>] <span class="op">-</span> result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p2_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>            (result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p1_y'</span>] <span class="op">-</span> result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p2_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process wrists per person and add COM/centroid</span></span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> person, prefix <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'p1'</span>), (<span class="dv">1</span>, <span class="st">'p2'</span>)]:</span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>        w_person <span class="op">=</span> wrists[wrists[<span class="st">'person'</span>] <span class="op">==</span> person].set_index(<span class="st">'time'</span>)</span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_left_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> w_person[<span class="st">'left_x'</span>]</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_left_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> w_person[<span class="st">'left_y'</span>]</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_right_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> w_person[<span class="st">'right_x'</span>]</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_right_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> w_person[<span class="st">'right_y'</span>]</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the correct stats object based on person ID</span></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>        person_stats <span class="op">=</span> p0_stats <span class="cf">if</span> person <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> p1_stats</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add com and centroid with the correct stats object</span></span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'com_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> person_stats[<span class="st">'com_x'</span>]</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'com_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> person_stats[<span class="st">'com_y'</span>]</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'centroid_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> person_stats[<span class="st">'centroid_x'</span>]</span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'centroid_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> person_stats[<span class="st">'centroid_y'</span>]</span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add tracking quality indicators using original data</span></span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>    person_counts <span class="op">=</span> ts.groupby(<span class="st">'time'</span>)[<span class="st">'person'</span>].nunique()</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>    result[<span class="st">'both_tracked'</span>] <span class="op">=</span> result.index.<span class="bu">map</span>(<span class="kw">lambda</span> x: person_counts.get(x, <span class="dv">0</span>) <span class="op">==</span> <span class="dv">2</span>)</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>    result[<span class="st">'single_tracked'</span>] <span class="op">=</span> result.index.<span class="bu">map</span>(<span class="kw">lambda</span> x: person_counts.get(x, <span class="dv">0</span>) <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_proximity_approach(timeseries_data):</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate each person's position relative to their initial position,</span></span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a><span class="co">    projecting movement onto the current connecting line between people.</span></span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a><span class="co">    This handles rotation and changing spatial relationships between people.</span></span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a><span class="co">    Positive values indicate movement toward the other person from initial position.</span></span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a><span class="co">    The reference positions are only established when both people are detected.</span></span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create columns for our measurements</span></span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'p1_com_approach_pos'</span> <span class="kw">not</span> <span class="kw">in</span> timeseries_data.columns:</span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> np.nan</span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'p2_com_approach_pos'</span> <span class="kw">not</span> <span class="kw">in</span> timeseries_data.columns:</span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> np.nan</span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort data by time</span></span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a>    sorted_data <span class="op">=</span> timeseries_data.sort_values(<span class="st">'time'</span>)</span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find first valid frame to establish reference positions</span></span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a>    reference_p1_pos <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>    reference_p2_pos <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>    reference_distance <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First pass: find reference frame where both people are detected</span></span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> sorted_data.iterrows():</span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip rows with NaN values or where both_tracked is False</span></span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (np.isnan(row[<span class="st">'com_p1_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p1_y'</span>]) <span class="kw">or</span> </span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>            np.isnan(row[<span class="st">'com_p2_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p2_y'</span>]) <span class="kw">or</span></span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'both_tracked'</span> <span class="kw">in</span> row.index <span class="kw">and</span> row[<span class="st">'both_tracked'</span>] <span class="op">==</span> <span class="va">False</span>)):</span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get positions for this frame</span></span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> np.array([row[<span class="st">'com_p1_x'</span>], row[<span class="st">'com_p1_y'</span>]])</span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> np.array([row[<span class="st">'com_p2_x'</span>], row[<span class="st">'com_p2_y'</span>]])</span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate connecting vector</span></span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a>        connect_vector <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> np.linalg.norm(connect_vector)</span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> distance <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We found a valid reference frame</span></span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a>            reference_p1_pos <span class="op">=</span> p1_pos.copy()</span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>            reference_p2_pos <span class="op">=</span> p2_pos.copy()</span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a>            reference_distance <span class="op">=</span> distance</span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Reference frame established at time=</span><span class="sc">{</span>row[<span class="st">'time'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference p1_pos: </span><span class="sc">{</span>reference_p1_pos<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference p2_pos: </span><span class="sc">{</span>reference_p2_pos<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference distance: </span><span class="sc">{</span>reference_distance<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> reference_p1_pos <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"ERROR: Could not establish a reference frame. No valid frames found with both people detected."</span>)</span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> timeseries_data</span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Second pass: calculate projected positions for all frames</span></span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> sorted_data.iterrows():</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip rows with NaN values</span></span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (np.isnan(row[<span class="st">'com_p1_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p1_y'</span>]) <span class="kw">or</span> </span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a>            np.isnan(row[<span class="st">'com_p2_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p2_y'</span>])):</span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get current positions</span></span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> np.array([row[<span class="st">'com_p1_x'</span>], row[<span class="st">'com_p1_y'</span>]])</span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> np.array([row[<span class="st">'com_p2_x'</span>], row[<span class="st">'com_p2_y'</span>]])</span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate current connecting vector and direction</span></span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a>        current_connect <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a>        current_distance <span class="op">=</span> np.linalg.norm(current_connect)</span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip frames where people are at the same position</span></span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_distance <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a>        current_direction <span class="op">=</span> current_connect <span class="op">/</span> current_distance</span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate vector from reference position to current position</span></span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a>        p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> reference_p1_pos</span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a>        p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> reference_p2_pos</span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Project these vectors onto the current connecting line</span></span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Positive values mean moving toward the other person</span></span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a>        p1_projection <span class="op">=</span> np.dot(p1_vector, current_direction)</span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a>        p2_projection <span class="op">=</span> <span class="op">-</span>np.dot(p2_vector, <span class="op">-</span>current_direction)</span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store values</span></span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>        timeseries_data.loc[idx, <span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> p1_projection</span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a>        timeseries_data.loc[idx, <span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> p2_projection</span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify results</span></span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a>    filled_p1 <span class="op">=</span> timeseries_data[<span class="st">'p1_com_approach_pos'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a>    filled_p2 <span class="op">=</span> timeseries_data[<span class="st">'p2_com_approach_pos'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Frames with filled values - p1: </span><span class="sc">{</span>filled_p1<span class="sc">}</span><span class="ss">, p2: </span><span class="sc">{</span>filled_p2<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> timeseries_data</span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main processing function"""</span></span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a>    os.makedirs(OUTPUT_PATH, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all CSV files from layer 1 processing</span></span>
<span id="cb11-283"><a href="#cb11-283" aria-hidden="true" tabindex="-1"></a>    layer1_files <span class="op">=</span> glob.glob(INPUT_LAYER1_PATH <span class="op">+</span> <span class="st">'*.csv'</span>)</span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each file</span></span>
<span id="cb11-286"><a href="#cb11-286" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_path <span class="kw">in</span> layer1_files:</span>
<span id="cb11-287"><a href="#cb11-287" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract video name from file path</span></span>
<span id="cb11-288"><a href="#cb11-288" aria-hidden="true" tabindex="-1"></a>        vid_name <span class="op">=</span> os.path.basename(file_path).split(<span class="st">'_keypoints_data_layer1.csv'</span>)[<span class="dv">0</span>]</span>
<span id="cb11-289"><a href="#cb11-289" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Processing video: </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-290"><a href="#cb11-290" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-291"><a href="#cb11-291" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if already processed</span></span>
<span id="cb11-292"><a href="#cb11-292" aria-hidden="true" tabindex="-1"></a>        output_file <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>OUTPUT_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">_processed_data_layer2.csv"</span></span>
<span id="cb11-293"><a href="#cb11-293" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(output_file):</span>
<span id="cb11-294"><a href="#cb11-294" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Already processed, skipping..."</span>)</span>
<span id="cb11-295"><a href="#cb11-295" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-296"><a href="#cb11-296" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-297"><a href="#cb11-297" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine video format and get FPS</span></span>
<span id="cb11-298"><a href="#cb11-298" aria-hidden="true" tabindex="-1"></a>        video_path <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-299"><a href="#cb11-299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ext <span class="kw">in</span> [<span class="st">'.avi'</span>, <span class="st">'.mp4'</span>, <span class="st">'.mov'</span>]:</span>
<span id="cb11-300"><a href="#cb11-300" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> os.path.exists(<span class="ss">f"</span><span class="sc">{</span>VIDEO_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}{</span>ext<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb11-301"><a href="#cb11-301" aria-hidden="true" tabindex="-1"></a>                video_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>VIDEO_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}{</span>ext<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb11-302"><a href="#cb11-302" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb11-303"><a href="#cb11-303" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-304"><a href="#cb11-304" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> video_path:</span>
<span id="cb11-305"><a href="#cb11-305" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Video file not found for </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-306"><a href="#cb11-306" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-307"><a href="#cb11-307" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-308"><a href="#cb11-308" aria-hidden="true" tabindex="-1"></a>        cap <span class="op">=</span> cv2.VideoCapture(video_path)</span>
<span id="cb11-309"><a href="#cb11-309" aria-hidden="true" tabindex="-1"></a>        fps <span class="op">=</span> cap.get(cv2.CAP_PROP_FPS)</span>
<span id="cb11-310"><a href="#cb11-310" aria-hidden="true" tabindex="-1"></a>        cap.release()</span>
<span id="cb11-311"><a href="#cb11-311" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Working on: </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss"> with fps = </span><span class="sc">{</span>fps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-312"><a href="#cb11-312" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-313"><a href="#cb11-313" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load and preprocess data</span></span>
<span id="cb11-314"><a href="#cb11-314" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> pd.read_csv(file_path)</span>
<span id="cb11-315"><a href="#cb11-315" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> frame_to_time(ts, fps<span class="op">=</span>fps)</span>
<span id="cb11-316"><a href="#cb11-316" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> assign_left_right(ts)</span>
<span id="cb11-317"><a href="#cb11-317" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-318"><a href="#cb11-318" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate statistics</span></span>
<span id="cb11-319"><a href="#cb11-319" aria-hidden="true" tabindex="-1"></a>        stats <span class="op">=</span> process_time_data(ts)</span>
<span id="cb11-320"><a href="#cb11-320" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-321"><a href="#cb11-321" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process tracked data</span></span>
<span id="cb11-322"><a href="#cb11-322" aria-hidden="true" tabindex="-1"></a>        processed_data <span class="op">=</span> process_people_data_vectorized(ts, stats)</span>
<span id="cb11-323"><a href="#cb11-323" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-324"><a href="#cb11-324" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create final data frame</span></span>
<span id="cb11-325"><a href="#cb11-325" aria-hidden="true" tabindex="-1"></a>        bb_data <span class="op">=</span> pd.merge(</span>
<span id="cb11-326"><a href="#cb11-326" aria-hidden="true" tabindex="-1"></a>            stats, </span>
<span id="cb11-327"><a href="#cb11-327" aria-hidden="true" tabindex="-1"></a>            processed_data.reset_index(), </span>
<span id="cb11-328"><a href="#cb11-328" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">'time'</span>, </span>
<span id="cb11-329"><a href="#cb11-329" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">'outer'</span></span>
<span id="cb11-330"><a href="#cb11-330" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-331"><a href="#cb11-331" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-332"><a href="#cb11-332" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract time series data (using person 0 as reference)</span></span>
<span id="cb11-333"><a href="#cb11-333" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> bb_data[bb_data[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">0</span>].copy()  <span class="co"># Make a copy to avoid SettingWithCopyWarning</span></span>
<span id="cb11-334"><a href="#cb11-334" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-335"><a href="#cb11-335" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove unnecessary columns</span></span>
<span id="cb11-336"><a href="#cb11-336" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.drop(columns<span class="op">=</span><span class="st">'person'</span>)</span>
<span id="cb11-337"><a href="#cb11-337" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-338"><a href="#cb11-338" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate desired time step based on FPS</span></span>
<span id="cb11-339"><a href="#cb11-339" aria-hidden="true" tabindex="-1"></a>        desired_time_step <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>fps</span>
<span id="cb11-340"><a href="#cb11-340" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-341"><a href="#cb11-341" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Interpolate missing values</span></span>
<span id="cb11-342"><a href="#cb11-342" aria-hidden="true" tabindex="-1"></a>        nan_cols <span class="op">=</span> timeseries_data.columns[timeseries_data.isna().<span class="bu">any</span>()].tolist()</span>
<span id="cb11-343"><a href="#cb11-343" aria-hidden="true" tabindex="-1"></a>        timeseries_data[nan_cols] <span class="op">=</span> timeseries_data[nan_cols].interpolate()</span>
<span id="cb11-344"><a href="#cb11-344" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-345"><a href="#cb11-345" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth distance with Savitzky-Golay filter</span></span>
<span id="cb11-346"><a href="#cb11-346" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'distance_smooth'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'distance'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb11-347"><a href="#cb11-347" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-348"><a href="#cb11-348" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate and smooth wrist speeds</span></span>
<span id="cb11-349"><a href="#cb11-349" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> wrist <span class="kw">in</span> [<span class="st">'wrist_left_p1'</span>, <span class="st">'wrist_right_p1'</span>, <span class="st">'wrist_left_p2'</span>, <span class="st">'wrist_right_p2'</span>]:</span>
<span id="cb11-350"><a href="#cb11-350" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate speed as Euclidean distance between consecutive positions</span></span>
<span id="cb11-351"><a href="#cb11-351" aria-hidden="true" tabindex="-1"></a>            timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb11-352"><a href="#cb11-352" aria-hidden="true" tabindex="-1"></a>                timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_x'</span>].diff()<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_y'</span>].diff()<span class="op">**</span><span class="dv">2</span></span>
<span id="cb11-353"><a href="#cb11-353" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-354"><a href="#cb11-354" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-355"><a href="#cb11-355" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Apply Savitzky-Golay filter for smoothing</span></span>
<span id="cb11-356"><a href="#cb11-356" aria-hidden="true" tabindex="-1"></a>            timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed_smooth'</span>] <span class="op">=</span> savgol_filter(</span>
<span id="cb11-357"><a href="#cb11-357" aria-hidden="true" tabindex="-1"></a>                timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed'</span>].values, <span class="dv">11</span>, <span class="dv">3</span></span>
<span id="cb11-358"><a href="#cb11-358" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-359"><a href="#cb11-359" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-360"><a href="#cb11-360" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill NaN values before calculating proximity approach</span></span>
<span id="cb11-361"><a href="#cb11-361" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.fillna(method<span class="op">=</span><span class="st">'ffill'</span>)</span>
<span id="cb11-362"><a href="#cb11-362" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-363"><a href="#cb11-363" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate proximity approach</span></span>
<span id="cb11-364"><a href="#cb11-364" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> calculate_proximity_approach(timeseries_data)</span>
<span id="cb11-365"><a href="#cb11-365" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-366"><a href="#cb11-366" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill any remaining NaN values</span></span>
<span id="cb11-367"><a href="#cb11-367" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.fillna(method<span class="op">=</span><span class="st">'ffill'</span>)</span>
<span id="cb11-368"><a href="#cb11-368" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-369"><a href="#cb11-369" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth proximity approach values</span></span>
<span id="cb11-370"><a href="#cb11-370" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'p1_com_approach_pos'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb11-371"><a href="#cb11-371" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'p2_com_approach_pos'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb11-372"><a href="#cb11-372" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-373"><a href="#cb11-373" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for any remaining NaN values</span></span>
<span id="cb11-374"><a href="#cb11-374" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Checking for NaN values..."</span>)</span>
<span id="cb11-375"><a href="#cb11-375" aria-hidden="true" tabindex="-1"></a>        nan_counts <span class="op">=</span> timeseries_data.isna().<span class="bu">sum</span>()</span>
<span id="cb11-376"><a href="#cb11-376" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> nan_counts.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb11-377"><a href="#cb11-377" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Found NaN values after processing:"</span>)</span>
<span id="cb11-378"><a href="#cb11-378" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(nan_counts)</span>
<span id="cb11-379"><a href="#cb11-379" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-380"><a href="#cb11-380" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No NaN values found."</span>)</span>
<span id="cb11-381"><a href="#cb11-381" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-382"><a href="#cb11-382" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save processed data</span></span>
<span id="cb11-383"><a href="#cb11-383" aria-hidden="true" tabindex="-1"></a>        timeseries_data.to_csv(output_file, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-384"><a href="#cb11-384" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-385"><a href="#cb11-385" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for time continuity</span></span>
<span id="cb11-386"><a href="#cb11-386" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Checking time continuity..."</span>)</span>
<span id="cb11-387"><a href="#cb11-387" aria-hidden="true" tabindex="-1"></a>        time_diffs <span class="op">=</span> np.array([<span class="bu">round</span>(val, <span class="dv">2</span>) <span class="cf">for</span> val <span class="kw">in</span> np.diff(timeseries_data[<span class="st">'time'</span>])])</span>
<span id="cb11-388"><a href="#cb11-388" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.<span class="bu">all</span>(time_diffs <span class="op">==</span> desired_time_step):</span>
<span id="cb11-389"><a href="#cb11-389" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Found gaps at times: </span><span class="sc">{</span>np<span class="sc">.</span>where(time_diffs <span class="op">!=</span> desired_time_step)[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-390"><a href="#cb11-390" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-391"><a href="#cb11-391" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No missing time points."</span>)</span>
<span id="cb11-392"><a href="#cb11-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-393"><a href="#cb11-393" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb11-394"><a href="#cb11-394" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To provide an example of the data we plot here a timeseries of the resultant data.</p>
</section>
<section id="step-2-summary-feature-extraction-smoothness" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Step 2: Summary feature extraction: Smoothness</h1>
</section>
<section id="step-3-calculating-feature-data-e.g.-jerkiness-from-timeseries-python" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Step 3: Calculating feature data (e.g., jerkiness) from timeseries (Python)</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
DIY: Feature Extraction 🛠️
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
</section>
<section id="step-4-statistical-analysis-e.g.-jerkiness-of-proximityapproachavoidance-or-non-linear-recurrence-r" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Step 4: Statistical analysis (e.g., jerkiness of proximity/approach/avoidance, or non-linear recurrence) (R)</h1>
<div class="cell" data-code_folding="hide">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># manually edited this CSV</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"C:/Users/wiltshir/GitHub/InterPerDynPipelineAnalysis/Re_ Behavioral Dynamics in Social Interactions AP_SI/smoothness_data_top_view_clean.csv"</span>) </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#data_cross_cultur&lt;-data[1:18,]</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove a row</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>data<span class="ot">&lt;-</span> <span class="fu">subset</span>(data, data<span class="sc">$</span>videoID<span class="sc">!=</span><span class="st">"cop_b09 z góry"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a culture grouping variable</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>culture <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"góry$"</span>, data<span class="sc">$</span>videoID), <span class="st">"Yurakare"</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"kam_5$"</span>, data<span class="sc">$</span>videoID), <span class="st">"Polish"</span>, <span class="cn">NA</span>))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Restructure data into long format</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>data_long <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(smoothness_p1_proximity, smoothness_p2_proximity),</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"person"</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"smoothness_value"</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4) </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest) </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(smoothness_value <span class="sc">~</span> culture <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> videoID), <span class="at">data =</span> data_long)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
DIY: Analysis 🛠️
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
</section>
<section id="references" class="level1" data-number="9">

<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">9 References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-caoOpenPoseRealtimeMultiPerson2021" class="csl-entry" role="listitem">
Cao, Zhe, Gines Hidalgo, Tomas Simon, Shih-En Wei, and Yaser Sheikh. 2021. <span>“<span>OpenPose</span>: <span>Realtime Multi-Person 2D Pose Estimation Using Part Affinity Fields</span>.”</span> <em>IEEE Transactions on Pattern Analysis and Machine Intelligence</em> 43 (1): 172–86. <a href="https://doi.org/10.1109/TPAMI.2019.2929257">https://doi.org/10.1109/TPAMI.2019.2929257</a>.
</div>
<div id="ref-lugaresiMediaPipeFrameworkBuilding2019" class="csl-entry" role="listitem">
Lugaresi, Camillo, Jiuqiang Tang, Hadon Nash, Chris McClanahan, Esha Uboweja, Michael Hays, Fan Zhang, et al. 2019. <span>“<span>MediaPipe</span>: <span>A Framework</span> for <span>Building Perception Pipelines</span>.”</span> arXiv. <a href="https://doi.org/10.48550/arXiv.1906.08172">https://doi.org/10.48550/arXiv.1906.08172</a>.
</div>
<div id="ref-winterBiomechanicsMotorControl2009" class="csl-entry" role="listitem">
Winter, David A. 2009. <em>Biomechanics and <span>Motor Control</span> of <span>Human Movement</span></em>. John Wiley &amp; Sons.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb13" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "An Open-source Standardized Pipeline for Tracing the Behavioral Dynamics in Social Interactions"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Computationally Reproducible Extended Methods Section"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "`r format(Sys.time(), '%B %d, %Y')`"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> </span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Arkadiusz Białek</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Jagiellonian University, Poland</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Wim Pouw</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Tilburg University, Netherlands</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: James Trujillo</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: University of Amsterdam, Netherlands</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Fred Hasselman</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Radboud University, Netherlands</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Babajide Alamu Owoyele</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Hasso Plattner Institute, University of Potsdam, Germany</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Natalia Siekiera</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Jagiellonian University, Poland</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Joanna Rączaszek-Leonardi</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: University of Warsaw, Poland</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Travis J. Wiltshire</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliation: Tilburg University, Netherlands</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="an">contact:</span><span class="co"> </span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Wim Pouw</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co">    email: w.pouw@tilburguniversity.edu</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> quarto_dependencies/references/refs.bib</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="an">theme:</span><span class="co"> journal</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="an">css:</span><span class="co"> quarto_dependencies/styles/styles.css</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: left</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-title: "Contents"</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/ts.gif)</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="fu"># Overview</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>To increase reproducibility of our approach we have designed this Quarto notebook that provides the user with what is effectively a manual-style extended methods and results section. Next to staging and (visually) explaining key Python and R code elements, the notebook contains detailed further “Do It Yourself” (DIY) instructions that can be accessed on demand by clicking on DIY sections, for example providing the technical steps needed to install and then run code for YOLO tracking on (user-defined) data. This Notebook is not simply an add-on supplemental text, but it is a key part of our contribution as it allows for newcomers to social processing to start implementing this pipeline step by step.</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>The Quarto notebook is structured to have the following components, next to steps:</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**code snippets** that overview complete code, or shorter code chunks to for example explain a particular function. Denoted with the symbol 🚩.</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**example output** that shows example output. Denoted with the symbol 📊.</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**DIY blocks** that provide shorter, step-by-step links to the full code for executing a particular step in the pipeline on your own code 🛠️.</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>**What the Quarto notebook is not intended to do:** The notebook is not a complete collection of every piece of code needed to replicate the pipeline. It is not intended to be run on its own when replicating the pipeline (whether on your own data, or on the sample data). For actually applying this code, see the  **DIY** blocks. </span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="fu"># Dataset</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>The following data has been made available in masked form.</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-download collapse="true"}</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a><span class="fu">## Download Guide ⬇️</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>The masked data can be downloaded from the repository of Jagellonian University <span class="co">[</span><span class="ot">here</span><span class="co">]()</span>. The unmasked data can be requested from the authors. The unmasked data is not available in this repository for privacy reasons.</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dataset Mother Infant</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>matplotlib.use(<span class="st">'agg'</span>)</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>plt.ioff()</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>plt.clf() <span class="co"># Clear any existing figures</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'./meta/project_point_metadata_ages.csv'</span>)</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert gender to categorical label</span></span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'gender_label'</span>] <span class="op">=</span> df[<span class="st">'gender'</span>].<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'Female'</span>, <span class="dv">1</span>: <span class="st">'Male'</span>})</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 2x2 subplot layout</span></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>), gridspec_kw<span class="op">=</span>{<span class="st">'width_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>], <span class="st">'height_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>]})</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Mother-Infant Dataset Overview'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for gender</span></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Female'</span>: <span class="st">'#C55A11'</span>,   <span class="co"># Orange for females</span></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Male'</span>: <span class="st">'#4472C4'</span>       <span class="co"># Blue for males</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Line plot - Age progression across time points</span></span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>    gender <span class="op">=</span> row[<span class="st">'gender_label'</span>]</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create arrays for days and time points, handling NaN values</span></span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>    days <span class="op">=</span> []</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>    timepoints <span class="op">=</span> []</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):   <span class="co"># T1 to T7</span></span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>        day_col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> day_col <span class="kw">in</span> df.columns <span class="kw">and</span> pd.notna(row[day_col]) <span class="kw">and</span> row[day_col] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>            days.append(row[day_col])</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>            timepoints.append(i)</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the line for this infant</span></span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>, <span class="dv">0</span>].plot(</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>        timepoints,</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>        days,</span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>        marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>colors[gender],</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">1.5</span></span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Customize the plot</span></span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Infant Age Progression'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>))</span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xticklabels([<span class="ss">f'T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>)])</span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Add legend patches</span></span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>legend_elements <span class="op">=</span> [</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a>    Patch(facecolor<span class="op">=</span>colors[<span class="st">'Female'</span>], edgecolor<span class="op">=</span><span class="st">'w'</span>, label<span class="op">=</span><span class="st">'Female'</span>),</span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a>    Patch(facecolor<span class="op">=</span>colors[<span class="st">'Male'</span>], edgecolor<span class="op">=</span><span class="st">'w'</span>, label<span class="op">=</span><span class="st">'Male'</span>)</span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Box plot - Age distribution at each time point</span></span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>time_point_data <span class="op">=</span> []</span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> []</span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):   <span class="co"># T1 to T7</span></span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>        valid_data <span class="op">=</span> df[col].dropna()</span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>            time_point_data.append(valid_data)</span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>            labels.append(<span class="ss">f'T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Create violin plots</span></span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> time_point_data:</span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>    violin_parts <span class="op">=</span> axs[<span class="dv">0</span>, <span class="dv">1</span>].violinplot(</span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>        time_point_data,</span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>        showmeans<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a>        showmedians<span class="op">=</span><span class="va">True</span></span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Color the violin plots</span></span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, pc <span class="kw">in</span> <span class="bu">enumerate</span>(violin_parts[<span class="st">'bodies'</span>]):</span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>        pc.set_facecolor(<span class="st">'#7030A0'</span>)  <span class="co"># Purple</span></span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>        pc.set_edgecolor(<span class="st">'black'</span>)</span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a>        pc.set_alpha(<span class="fl">0.7</span>)</span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels</span></span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(labels) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels(labels)</span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Age Distribution by Time Point'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Pie chart - Gender distribution</span></span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a>gender_counts <span class="op">=</span> df[<span class="st">'gender_label'</span>].value_counts()</span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].pie(</span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a>    gender_counts,</span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>gender_counts.index,</span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a>    autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[colors[g] <span class="cf">for</span> g <span class="kw">in</span> gender_counts.index],</span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a>    wedgeprops<span class="op">=</span>{<span class="st">'edgecolor'</span>: <span class="st">'w'</span>, <span class="st">'linewidth'</span>: <span class="dv">1</span>}</span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Gender Distribution'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Summary table</span></span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate averages for each time point, handling NaN values</span></span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a>averages_days <span class="op">=</span> []</span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):</span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb13-181"><a href="#cb13-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb13-182"><a href="#cb13-182" aria-hidden="true" tabindex="-1"></a>        avg <span class="op">=</span> df[col].mean()</span>
<span id="cb13-183"><a href="#cb13-183" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> pd.isna(avg):</span>
<span id="cb13-184"><a href="#cb13-184" aria-hidden="true" tabindex="-1"></a>            avg_months <span class="op">=</span> avg <span class="op">/</span> <span class="fl">30.44</span>  <span class="co"># Convert to months</span></span>
<span id="cb13-185"><a href="#cb13-185" aria-hidden="true" tabindex="-1"></a>            averages_days.append([<span class="ss">f"T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> Average Age"</span>, <span class="ss">f"</span><span class="sc">{</span>avg<span class="sc">:.1f}</span><span class="ss"> days (</span><span class="sc">{</span>avg_months<span class="sc">:.1f}</span><span class="ss"> months)"</span>])</span>
<span id="cb13-186"><a href="#cb13-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-187"><a href="#cb13-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Count participants at each time point</span></span>
<span id="cb13-188"><a href="#cb13-188" aria-hidden="true" tabindex="-1"></a>participants <span class="op">=</span> []</span>
<span id="cb13-189"><a href="#cb13-189" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">8</span>):</span>
<span id="cb13-190"><a href="#cb13-190" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb13-191"><a href="#cb13-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb13-192"><a href="#cb13-192" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> df[col].notna().<span class="bu">sum</span>()</span>
<span id="cb13-193"><a href="#cb13-193" aria-hidden="true" tabindex="-1"></a>        participants.append([<span class="ss">f"Participants at T</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"</span><span class="sc">{</span>count<span class="sc">}</span><span class="ss">"</span>])</span>
<span id="cb13-194"><a href="#cb13-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-195"><a href="#cb13-195" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall statistics</span></span>
<span id="cb13-196"><a href="#cb13-196" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> [</span>
<span id="cb13-197"><a href="#cb13-197" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Total Infants"</span>, <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb13-198"><a href="#cb13-198" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Females"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'gender'</span>] <span class="op">==</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb13-199"><a href="#cb13-199" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Males"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'gender'</span>] <span class="op">==</span> <span class="dv">1</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb13-200"><a href="#cb13-200" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb13-201"><a href="#cb13-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-202"><a href="#cb13-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Add age ranges if columns exist</span></span>
<span id="cb13-203"><a href="#cb13-203" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'age_T1_days'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb13-204"><a href="#cb13-204" aria-hidden="true" tabindex="-1"></a>    summary_data.append([<span class="st">"Age Range T1"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'age_T1_days'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df[<span class="st">'age_T1_days'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss"> days"</span>])</span>
<span id="cb13-205"><a href="#cb13-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-206"><a href="#cb13-206" aria-hidden="true" tabindex="-1"></a>last_tp <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb13-207"><a href="#cb13-207" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> last_tp <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-208"><a href="#cb13-208" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f'age_T</span><span class="sc">{</span>last_tp<span class="sc">}</span><span class="ss">_days'</span></span>
<span id="cb13-209"><a href="#cb13-209" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> df.columns <span class="kw">and</span> df[col].notna().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-210"><a href="#cb13-210" aria-hidden="true" tabindex="-1"></a>        summary_data.append([<span class="ss">f"Age Range T</span><span class="sc">{</span>last_tp<span class="sc">}</span><span class="ss">"</span>, <span class="ss">f"</span><span class="sc">{</span>df[col]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>df[col]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss"> days"</span>])</span>
<span id="cb13-211"><a href="#cb13-211" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb13-212"><a href="#cb13-212" aria-hidden="true" tabindex="-1"></a>    last_tp <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb13-213"><a href="#cb13-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-214"><a href="#cb13-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the table with the most important summary statistics</span></span>
<span id="cb13-215"><a href="#cb13-215" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb13-216"><a href="#cb13-216" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">1</span>].table(</span>
<span id="cb13-217"><a href="#cb13-217" aria-hidden="true" tabindex="-1"></a>    cellText<span class="op">=</span>summary_data <span class="op">+</span> participants,</span>
<span id="cb13-218"><a href="#cb13-218" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb13-219"><a href="#cb13-219" aria-hidden="true" tabindex="-1"></a>    cellLoc<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb13-220"><a href="#cb13-220" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-221"><a href="#cb13-221" aria-hidden="true" tabindex="-1"></a>table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb13-222"><a href="#cb13-222" aria-hidden="true" tabindex="-1"></a>table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb13-223"><a href="#cb13-223" aria-hidden="true" tabindex="-1"></a>table.scale(<span class="dv">1</span>, <span class="fl">1.5</span>)</span>
<span id="cb13-224"><a href="#cb13-224" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Dataset Summary'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-225"><a href="#cb13-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-226"><a href="#cb13-226" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-227"><a href="#cb13-227" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb13-228"><a href="#cb13-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-229"><a href="#cb13-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the figure to a file</span></span>
<span id="cb13-230"><a href="#cb13-230" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">"images/mother_infant_analysis.png"</span></span>
<span id="cb13-231"><a href="#cb13-231" aria-hidden="true" tabindex="-1"></a>os.makedirs(os.path.dirname(output_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-232"><a href="#cb13-232" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb13-233"><a href="#cb13-233" aria-hidden="true" tabindex="-1"></a>plt.close(fig) <span class="co"># Explicitly close the figure object</span></span>
<span id="cb13-234"><a href="#cb13-234" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-235"><a href="#cb13-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-236"><a href="#cb13-236" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/mother_infant_analysis.png)</span>{fig-align="center" width=600}</span>
<span id="cb13-237"><a href="#cb13-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-238"><a href="#cb13-238" aria-hidden="true" tabindex="-1"></a>In our github repository we use a sample data from this dataset from an infant-mother pair whom we are allowed to share the video data for the current purposes.</span>
<span id="cb13-239"><a href="#cb13-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-240"><a href="#cb13-240" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dataset Siblings</span></span>
<span id="cb13-241"><a href="#cb13-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-242"><a href="#cb13-242" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb13-243"><a href="#cb13-243" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-244"><a href="#cb13-244" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-245"><a href="#cb13-245" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-246"><a href="#cb13-246" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-247"><a href="#cb13-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-248"><a href="#cb13-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb13-249"><a href="#cb13-249" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'./meta/project_siblings_metadata_ages_gender.csv'</span>)</span>
<span id="cb13-250"><a href="#cb13-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-251"><a href="#cb13-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Data preprocessing</span></span>
<span id="cb13-252"><a href="#cb13-252" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'AgeDifference'</span>] <span class="op">=</span> <span class="bu">abs</span>(df[<span class="st">'P1agedays'</span>] <span class="op">-</span> df[<span class="st">'P2agedays'</span>])</span>
<span id="cb13-253"><a href="#cb13-253" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'AverageAge'</span>] <span class="op">=</span> (df[<span class="st">'P1agedays'</span>] <span class="op">+</span> df[<span class="st">'P2agedays'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb13-254"><a href="#cb13-254" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'GenderCombo'</span>] <span class="op">=</span> df[<span class="st">'GenderP1'</span>] <span class="op">+</span> <span class="st">'-'</span> <span class="op">+</span> df[<span class="st">'GenderP2'</span>]</span>
<span id="cb13-255"><a href="#cb13-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-256"><a href="#cb13-256" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 2x2 subplot layout</span></span>
<span id="cb13-257"><a href="#cb13-257" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), gridspec_kw<span class="op">=</span>{<span class="st">'width_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>], <span class="st">'height_ratios'</span>: [<span class="fl">1.5</span>, <span class="dv">1</span>]})</span>
<span id="cb13-258"><a href="#cb13-258" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Sibling Dataset Overview'</span>, fontsize<span class="op">=</span><span class="dv">16</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-259"><a href="#cb13-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-260"><a href="#cb13-260" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colors for gender combinations</span></span>
<span id="cb13-261"><a href="#cb13-261" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {</span>
<span id="cb13-262"><a href="#cb13-262" aria-hidden="true" tabindex="-1"></a>    <span class="st">'M-M'</span>: <span class="st">'#4472C4'</span>,   <span class="co"># Blue</span></span>
<span id="cb13-263"><a href="#cb13-263" aria-hidden="true" tabindex="-1"></a>    <span class="st">'M-F'</span>: <span class="st">'#7030A0'</span>,   <span class="co"># Purple</span></span>
<span id="cb13-264"><a href="#cb13-264" aria-hidden="true" tabindex="-1"></a>    <span class="st">'F-M'</span>: <span class="st">'#548235'</span>,   <span class="co"># Green</span></span>
<span id="cb13-265"><a href="#cb13-265" aria-hidden="true" tabindex="-1"></a>    <span class="st">'F-F'</span>: <span class="st">'#C55A11'</span>    <span class="co"># Rust/Orange</span></span>
<span id="cb13-266"><a href="#cb13-266" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-267"><a href="#cb13-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-268"><a href="#cb13-268" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Scatter plot - P1 age vs P2 age</span></span>
<span id="cb13-269"><a href="#cb13-269" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gender_combo, group <span class="kw">in</span> df.groupby(<span class="st">'GenderCombo'</span>):</span>
<span id="cb13-270"><a href="#cb13-270" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>, <span class="dv">0</span>].scatter(</span>
<span id="cb13-271"><a href="#cb13-271" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'P1agedays'</span>],</span>
<span id="cb13-272"><a href="#cb13-272" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'P2agedays'</span>],</span>
<span id="cb13-273"><a href="#cb13-273" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>colors.get(gender_combo, <span class="st">'gray'</span>),</span>
<span id="cb13-274"><a href="#cb13-274" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb13-275"><a href="#cb13-275" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span>gender_combo,</span>
<span id="cb13-276"><a href="#cb13-276" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span><span class="dv">50</span></span>
<span id="cb13-277"><a href="#cb13-277" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-278"><a href="#cb13-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-279"><a href="#cb13-279" aria-hidden="true" tabindex="-1"></a><span class="co"># Add reference line</span></span>
<span id="cb13-280"><a href="#cb13-280" aria-hidden="true" tabindex="-1"></a>min_age <span class="op">=</span> <span class="bu">min</span>(df[<span class="st">'P1agedays'</span>].<span class="bu">min</span>(), df[<span class="st">'P2agedays'</span>].<span class="bu">min</span>())</span>
<span id="cb13-281"><a href="#cb13-281" aria-hidden="true" tabindex="-1"></a>max_age <span class="op">=</span> <span class="bu">max</span>(df[<span class="st">'P1agedays'</span>].<span class="bu">max</span>(), df[<span class="st">'P2agedays'</span>].<span class="bu">max</span>())</span>
<span id="cb13-282"><a href="#cb13-282" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].plot([min_age, max_age], [min_age, max_age], <span class="st">'k--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb13-283"><a href="#cb13-283" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_xlabel(<span class="st">'P1 Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-284"><a href="#cb13-284" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_ylabel(<span class="st">'P2 Age (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-285"><a href="#cb13-285" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].set_title(<span class="st">'Participant Ages (P1 vs P2)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-286"><a href="#cb13-286" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb13-287"><a href="#cb13-287" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">0</span>].legend()</span>
<span id="cb13-288"><a href="#cb13-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-289"><a href="#cb13-289" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Bar chart - Age differences</span></span>
<span id="cb13-290"><a href="#cb13-290" aria-hidden="true" tabindex="-1"></a>bar_positions <span class="op">=</span> np.arange(<span class="bu">len</span>(df))</span>
<span id="cb13-291"><a href="#cb13-291" aria-hidden="true" tabindex="-1"></a>bar_width <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb13-292"><a href="#cb13-292" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].bar(</span>
<span id="cb13-293"><a href="#cb13-293" aria-hidden="true" tabindex="-1"></a>    bar_positions,</span>
<span id="cb13-294"><a href="#cb13-294" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'AgeDifference'</span>],</span>
<span id="cb13-295"><a href="#cb13-295" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span>bar_width,</span>
<span id="cb13-296"><a href="#cb13-296" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>[colors.get(combo, <span class="st">'gray'</span>) <span class="cf">for</span> combo <span class="kw">in</span> df[<span class="st">'GenderCombo'</span>]]</span>
<span id="cb13-297"><a href="#cb13-297" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-298"><a href="#cb13-298" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticks(bar_positions)</span>
<span id="cb13-299"><a href="#cb13-299" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xticklabels(df[<span class="st">'Code'</span>], rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb13-300"><a href="#cb13-300" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Sibling Pair'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-301"><a href="#cb13-301" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Age Difference (days)'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-302"><a href="#cb13-302" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].set_title(<span class="st">'Age Differences by Sibling Pair'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-303"><a href="#cb13-303" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>, <span class="dv">1</span>].grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb13-304"><a href="#cb13-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-305"><a href="#cb13-305" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Pie chart - Gender distribution</span></span>
<span id="cb13-306"><a href="#cb13-306" aria-hidden="true" tabindex="-1"></a>gender_counts <span class="op">=</span> df[<span class="st">'GenderCombo'</span>].value_counts()</span>
<span id="cb13-307"><a href="#cb13-307" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].pie(</span>
<span id="cb13-308"><a href="#cb13-308" aria-hidden="true" tabindex="-1"></a>    gender_counts,</span>
<span id="cb13-309"><a href="#cb13-309" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>gender_counts.index,</span>
<span id="cb13-310"><a href="#cb13-310" aria-hidden="true" tabindex="-1"></a>    autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb13-311"><a href="#cb13-311" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[colors.get(combo, <span class="st">'gray'</span>) <span class="cf">for</span> combo <span class="kw">in</span> gender_counts.index],</span>
<span id="cb13-312"><a href="#cb13-312" aria-hidden="true" tabindex="-1"></a>    wedgeprops<span class="op">=</span>{<span class="st">'edgecolor'</span>: <span class="st">'w'</span>, <span class="st">'linewidth'</span>: <span class="dv">1</span>}</span>
<span id="cb13-313"><a href="#cb13-313" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-314"><a href="#cb13-314" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">0</span>].set_title(<span class="st">'Gender Distribution'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-315"><a href="#cb13-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-316"><a href="#cb13-316" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Summary table</span></span>
<span id="cb13-317"><a href="#cb13-317" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> [</span>
<span id="cb13-318"><a href="#cb13-318" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Total Sibling Pairs"</span>, <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb13-319"><a href="#cb13-319" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average P1 Age"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'P1agedays'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb13-320"><a href="#cb13-320" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average P2 Age"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'P2agedays'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb13-321"><a href="#cb13-321" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Average Age Difference"</span>, <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'AgeDifference'</span>]<span class="sc">.</span>mean()<span class="op">/</span><span class="dv">30</span><span class="sc">:.1f}</span><span class="ss"> months"</span>],</span>
<span id="cb13-322"><a href="#cb13-322" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Number of Males"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'GenderP1'</span>] <span class="op">==</span> <span class="st">'M'</span>)<span class="sc">.</span><span class="bu">sum</span>() <span class="op">+</span> (df[<span class="st">'GenderP2'</span>] <span class="op">==</span> <span class="st">'M'</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb13-323"><a href="#cb13-323" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"Number of Females"</span>, <span class="ss">f"</span><span class="sc">{</span>(df[<span class="st">'GenderP1'</span>] <span class="op">==</span> <span class="st">'F'</span>)<span class="sc">.</span><span class="bu">sum</span>() <span class="op">+</span> (df[<span class="st">'GenderP2'</span>] <span class="op">==</span> <span class="st">'F'</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb13-324"><a href="#cb13-324" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb13-325"><a href="#cb13-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-326"><a href="#cb13-326" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn off axis for table</span></span>
<span id="cb13-327"><a href="#cb13-327" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb13-328"><a href="#cb13-328" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> axs[<span class="dv">1</span>, <span class="dv">1</span>].table(</span>
<span id="cb13-329"><a href="#cb13-329" aria-hidden="true" tabindex="-1"></a>    cellText<span class="op">=</span>[row <span class="cf">for</span> row <span class="kw">in</span> summary_data],</span>
<span id="cb13-330"><a href="#cb13-330" aria-hidden="true" tabindex="-1"></a>    colLabels<span class="op">=</span>[<span class="st">"Measure"</span>, <span class="st">"Value"</span>],</span>
<span id="cb13-331"><a href="#cb13-331" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb13-332"><a href="#cb13-332" aria-hidden="true" tabindex="-1"></a>    cellLoc<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb13-333"><a href="#cb13-333" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-334"><a href="#cb13-334" aria-hidden="true" tabindex="-1"></a>table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb13-335"><a href="#cb13-335" aria-hidden="true" tabindex="-1"></a>table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb13-336"><a href="#cb13-336" aria-hidden="true" tabindex="-1"></a>table.scale(<span class="dv">1</span>, <span class="fl">1.5</span>)</span>
<span id="cb13-337"><a href="#cb13-337" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>, <span class="dv">1</span>].set_title(<span class="st">'Dataset Summary'</span>, fontfamily<span class="op">=</span><span class="st">'serif'</span>)</span>
<span id="cb13-338"><a href="#cb13-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-339"><a href="#cb13-339" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-340"><a href="#cb13-340" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb13-341"><a href="#cb13-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-342"><a href="#cb13-342" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the figure to a file</span></span>
<span id="cb13-343"><a href="#cb13-343" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">"images/sibling_analysis.png"</span></span>
<span id="cb13-344"><a href="#cb13-344" aria-hidden="true" tabindex="-1"></a>os.makedirs(os.path.dirname(output_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-345"><a href="#cb13-345" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb13-346"><a href="#cb13-346" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
<span id="cb13-347"><a href="#cb13-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-348"><a href="#cb13-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-349"><a href="#cb13-349" aria-hidden="true" tabindex="-1"></a><span class="al">![](images/sibling_analysis.png)</span>{fig-align="center" width=600}</span>
<span id="cb13-350"><a href="#cb13-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-351"><a href="#cb13-351" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-settingup collapse="true"}</span>
<span id="cb13-352"><a href="#cb13-352" aria-hidden="true" tabindex="-1"></a><span class="fu">## DIY: Setting up 🛠️</span></span>
<span id="cb13-353"><a href="#cb13-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-354"><a href="#cb13-354" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 0: Github repo</span></span>
<span id="cb13-355"><a href="#cb13-355" aria-hidden="true" tabindex="-1"></a>You should first clone the repository <span class="co">[</span><span class="ot">InterPerDynPipeline</span><span class="co">](https://github.com/WimPouw/InterPerDynPipeline)</span> and move to the root directory. The step 1 code for tracking is in the <span class="in">`./code_STEP1_posetrackingprocessing/`</span> folder. In this folder you will find the Python script <span class="in">`yolo_tracking_processing.py`</span>. To check whether you have the correct script you can compare against the code chunk provided below.</span>
<span id="cb13-356"><a href="#cb13-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-357"><a href="#cb13-357" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb13-358"><a href="#cb13-358" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/WimPouw/InterPerDynPipeline</span>
<span id="cb13-359"><a href="#cb13-359" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ./InterPerDynPipeline/</span>
<span id="cb13-360"><a href="#cb13-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-361"><a href="#cb13-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-362"><a href="#cb13-362" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb13-363"><a href="#cb13-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-364"><a href="#cb13-364" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 1: Motion tracking and signal processing and wrangling</span></span>
<span id="cb13-365"><a href="#cb13-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-366"><a href="#cb13-366" aria-hidden="true" tabindex="-1"></a>The motion tracking and signal processing pipeline is divided into two main steps: </span>
<span id="cb13-367"><a href="#cb13-367" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Tracking**: This step involves tracking the movements of individuals in the videos using a pose estimation model. The output is a video with annotated keypoints and a CSV file containing the coordinates of these keypoints.</span>
<span id="cb13-368"><a href="#cb13-368" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Signal Processing**: This step involves processing the keypoint data to extract relevant features for analysis. The output are processed timeseries files, and a flat dataset containing our smoothness measures that are directly ready for statistical analysis.</span>
<span id="cb13-369"><a href="#cb13-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-370"><a href="#cb13-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-371"><a href="#cb13-371" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 1.1: Tracking two persons in videos for top-view (Python)</span></span>
<span id="cb13-372"><a href="#cb13-372" aria-hidden="true" tabindex="-1"></a>We have tried several pose tracking solutions, such as OpenPose (model 25B; @caoOpenPoseRealtimeMultiPerson2021), Mediapipe (default highest complexity blazepose model; @lugaresiMediaPipeFrameworkBuilding2019) and we found that these models are not well equipped to track persons from top view, most likely because these models are not trained on ground-truth poses of persons from top-view camera angles. However, we found the heaviest model of yolo v8 ("yolov8x-pose-p6.pt") does perform very well, especially as compared to the other models we tested. Thus, for this pipeline we recommend using YOLOv8 model for top-view tracking.</span>
<span id="cb13-373"><a href="#cb13-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-374"><a href="#cb13-374" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb13-375"><a href="#cb13-375" aria-hidden="true" tabindex="-1"></a><span class="fu">## DIY: Motion Tracking Set-Up and Execution 🛠️</span></span>
<span id="cb13-376"><a href="#cb13-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-377"><a href="#cb13-377" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 1: Install requirements</span></span>
<span id="cb13-378"><a href="#cb13-378" aria-hidden="true" tabindex="-1"></a>For each script we have provided a <span class="in">`requirements.txt`</span> file. You can install the requirements using pip, by first navigating to the folder where the script is located and then running the following command in your terminal:</span>
<span id="cb13-379"><a href="#cb13-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-380"><a href="#cb13-380" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb13-381"><a href="#cb13-381" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP1_posetrackingprocessing/</span>
<span id="cb13-382"><a href="#cb13-382" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb13-383"><a href="#cb13-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-384"><a href="#cb13-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-385"><a href="#cb13-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-386"><a href="#cb13-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-387"><a href="#cb13-387" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 2: Download the YOLOv8 model</span></span>
<span id="cb13-388"><a href="#cb13-388" aria-hidden="true" tabindex="-1"></a>In the current GitHub repo we have a light-weight model <span class="in">`yolov8n-pose.pt`</span> (~6.5MB) for immediate testing of the code. However, this model is not as accurate as the heaviest model.</span>
<span id="cb13-389"><a href="#cb13-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-390"><a href="#cb13-390" aria-hidden="true" tabindex="-1"></a>We should download the heaviest model (<span class="in">`yolov8x-pose-p6.pt`</span>) and save it to the <span class="in">`./code_STEP1_posetrackingprocessing/model/`</span> directory:  </span>
<span id="cb13-391"><a href="#cb13-391" aria-hidden="true" tabindex="-1"></a>https://github.com/ultralytics/assets/releases/download/v8.1.0/yolov8x-pose-p6.pt</span>
<span id="cb13-392"><a href="#cb13-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-393"><a href="#cb13-393" aria-hidden="true" tabindex="-1"></a>**Note**: If you're running the heavyweight model, you will need GPU support for this to run in a reasonable time. The lightweight model can run on CPU.</span>
<span id="cb13-394"><a href="#cb13-394" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb13-395"><a href="#cb13-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-396"><a href="#cb13-396" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 3: Run the python script</span></span>
<span id="cb13-397"><a href="#cb13-397" aria-hidden="true" tabindex="-1"></a>Assuming you have videos in your data folder (<span class="in">`./data_raw/`</span>) and you have a <span class="in">`.pt`</span> model in the model folder, you can run the script using the following command:</span>
<span id="cb13-398"><a href="#cb13-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-399"><a href="#cb13-399" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb13-400"><a href="#cb13-400" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="pp">[</span><span class="ss">yourspecificrootadress</span><span class="pp">]</span>/code_STEP1_posetrackingprocessing/</span>
<span id="cb13-401"><a href="#cb13-401" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> yolo_tracking_processing.py</span>
<span id="cb13-402"><a href="#cb13-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-403"><a href="#cb13-403" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb13-404"><a href="#cb13-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-405"><a href="#cb13-405" aria-hidden="true" tabindex="-1"></a>The code below is the script <span class="in">`yolo_tracking_processing.py`</span> that you can run to track the videos. The output will be a video with annotated keypoints and a CSV file containing the coordinates of these keypoints. The script processes each video frame-by-frame, detecting people and their pose keypoints (17 points as listed in the script; see the <span class="in">`GetKeypoint class`</span>). We filter out duplicate detections or skeletons with excessive missing data. Specifically, for each processed video, the script generates two output files: an annotated video showing the original footage with skeleton overlays (green points for accepted keypoints, red for filtered ones, and blue lines connecting the points), and a CSV file containing the raw coordinate data (frame number, person ID, keypoint ID, x-coordinate, y-coordinate). The output filenames include parameters like "c150" (150px proximity threshold) and "miss95" (95% missing data tolerance), which control how the system handles potential duplicate detections and incomplete skeletons. The user could adjust the parameter <span class="in">`close_threshold`</span> and <span class="in">`miss_tolerance`</span> to adjust the detection dynamics. We output the annotated video and the CSV file in the <span class="in">`./datatracked_afterSTEP1/`</span> folder.</span>
<span id="cb13-406"><a href="#cb13-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-407"><a href="#cb13-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb13-408"><a href="#cb13-408" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ultralytics <span class="im">import</span> YOLO</span>
<span id="cb13-409"><a href="#cb13-409" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel</span>
<span id="cb13-410"><a href="#cb13-410" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb13-411"><a href="#cb13-411" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb13-412"><a href="#cb13-412" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-413"><a href="#cb13-413" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb13-414"><a href="#cb13-414" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-415"><a href="#cb13-415" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch <span class="co"># for gpu support</span></span>
<span id="cb13-416"><a href="#cb13-416" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> combinations</span>
<span id="cb13-417"><a href="#cb13-417" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb13-418"><a href="#cb13-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-419"><a href="#cb13-419" aria-hidden="true" tabindex="-1"></a>torch.cuda.set_device(<span class="dv">0</span>)</span>
<span id="cb13-420"><a href="#cb13-420" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the model</span></span>
<span id="cb13-421"><a href="#cb13-421" aria-hidden="true" tabindex="-1"></a>modelfolder <span class="op">=</span> <span class="st">'./model/'</span></span>
<span id="cb13-422"><a href="#cb13-422" aria-hidden="true" tabindex="-1"></a>modellocation <span class="op">=</span> glob.glob(modelfolder<span class="op">+</span><span class="st">"*.pt"</span>)[<span class="dv">0</span>]</span>
<span id="cb13-423"><a href="#cb13-423" aria-hidden="true" tabindex="-1"></a>modelfile <span class="op">=</span> os.path.basename(modellocation)</span>
<span id="cb13-424"><a href="#cb13-424" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"We are loading in the following YOLO model: </span><span class="sc">{</span>modelfile<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-425"><a href="#cb13-425" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> YOLO(modellocation)</span>
<span id="cb13-426"><a href="#cb13-426" aria-hidden="true" tabindex="-1"></a><span class="co"># main variables</span></span>
<span id="cb13-427"><a href="#cb13-427" aria-hidden="true" tabindex="-1"></a>video_folder <span class="op">=</span> <span class="st">"../data_raw/"</span></span>
<span id="cb13-428"><a href="#cb13-428" aria-hidden="true" tabindex="-1"></a><span class="co"># avi mp4 or other video formats</span></span>
<span id="cb13-429"><a href="#cb13-429" aria-hidden="true" tabindex="-1"></a>video_files <span class="op">=</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mp4"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.avi"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mov"</span>) <span class="op">+</span> glob.glob(video_folder <span class="op">+</span> <span class="st">"*.mkv"</span>)</span>
<span id="cb13-430"><a href="#cb13-430" aria-hidden="true" tabindex="-1"></a>step1resultfolder <span class="op">=</span> <span class="st">"../datatracked_afterSTEP1/"</span></span>
<span id="cb13-431"><a href="#cb13-431" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(video_files)</span>
<span id="cb13-432"><a href="#cb13-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-433"><a href="#cb13-433" aria-hidden="true" tabindex="-1"></a><span class="co"># keypoint names</span></span>
<span id="cb13-434"><a href="#cb13-434" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GetKeypoint(BaseModel):</span>
<span id="cb13-435"><a href="#cb13-435" aria-hidden="true" tabindex="-1"></a>    NOSE:           <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-436"><a href="#cb13-436" aria-hidden="true" tabindex="-1"></a>    LEFT_EYE:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb13-437"><a href="#cb13-437" aria-hidden="true" tabindex="-1"></a>    RIGHT_EYE:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb13-438"><a href="#cb13-438" aria-hidden="true" tabindex="-1"></a>    LEFT_EAR:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb13-439"><a href="#cb13-439" aria-hidden="true" tabindex="-1"></a>    RIGHT_EAR:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb13-440"><a href="#cb13-440" aria-hidden="true" tabindex="-1"></a>    LEFT_SHOULDER:  <span class="bu">int</span> <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb13-441"><a href="#cb13-441" aria-hidden="true" tabindex="-1"></a>    RIGHT_SHOULDER: <span class="bu">int</span> <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb13-442"><a href="#cb13-442" aria-hidden="true" tabindex="-1"></a>    LEFT_ELBOW:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb13-443"><a href="#cb13-443" aria-hidden="true" tabindex="-1"></a>    RIGHT_ELBOW:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb13-444"><a href="#cb13-444" aria-hidden="true" tabindex="-1"></a>    LEFT_WRIST:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">9</span></span>
<span id="cb13-445"><a href="#cb13-445" aria-hidden="true" tabindex="-1"></a>    RIGHT_WRIST:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb13-446"><a href="#cb13-446" aria-hidden="true" tabindex="-1"></a>    LEFT_HIP:       <span class="bu">int</span> <span class="op">=</span> <span class="dv">11</span></span>
<span id="cb13-447"><a href="#cb13-447" aria-hidden="true" tabindex="-1"></a>    RIGHT_HIP:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb13-448"><a href="#cb13-448" aria-hidden="true" tabindex="-1"></a>    LEFT_KNEE:      <span class="bu">int</span> <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb13-449"><a href="#cb13-449" aria-hidden="true" tabindex="-1"></a>    RIGHT_KNEE:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb13-450"><a href="#cb13-450" aria-hidden="true" tabindex="-1"></a>    LEFT_ANKLE:     <span class="bu">int</span> <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb13-451"><a href="#cb13-451" aria-hidden="true" tabindex="-1"></a>    RIGHT_ANKLE:    <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb13-452"><a href="#cb13-452" aria-hidden="true" tabindex="-1"></a>get_keypoint <span class="op">=</span> GetKeypoint()</span>
<span id="cb13-453"><a href="#cb13-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-454"><a href="#cb13-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-455"><a href="#cb13-455" aria-hidden="true" tabindex="-1"></a><span class="co"># Define skeleton connections</span></span>
<span id="cb13-456"><a href="#cb13-456" aria-hidden="true" tabindex="-1"></a>skeleton <span class="op">=</span> [</span>
<span id="cb13-457"><a href="#cb13-457" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.RIGHT_SHOULDER),</span>
<span id="cb13-458"><a href="#cb13-458" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.LEFT_ELBOW),</span>
<span id="cb13-459"><a href="#cb13-459" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_SHOULDER, get_keypoint.RIGHT_ELBOW),</span>
<span id="cb13-460"><a href="#cb13-460" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_ELBOW, get_keypoint.LEFT_WRIST),</span>
<span id="cb13-461"><a href="#cb13-461" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_ELBOW, get_keypoint.RIGHT_WRIST),</span>
<span id="cb13-462"><a href="#cb13-462" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_SHOULDER, get_keypoint.LEFT_HIP),</span>
<span id="cb13-463"><a href="#cb13-463" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_SHOULDER, get_keypoint.RIGHT_HIP),</span>
<span id="cb13-464"><a href="#cb13-464" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_HIP, get_keypoint.RIGHT_HIP),</span>
<span id="cb13-465"><a href="#cb13-465" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_HIP, get_keypoint.LEFT_KNEE),</span>
<span id="cb13-466"><a href="#cb13-466" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_HIP, get_keypoint.RIGHT_KNEE),</span>
<span id="cb13-467"><a href="#cb13-467" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.LEFT_KNEE, get_keypoint.LEFT_ANKLE),</span>
<span id="cb13-468"><a href="#cb13-468" aria-hidden="true" tabindex="-1"></a>    (get_keypoint.RIGHT_KNEE, get_keypoint.RIGHT_ANKLE),</span>
<span id="cb13-469"><a href="#cb13-469" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb13-470"><a href="#cb13-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-471"><a href="#cb13-471" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tensor_to_matrix(results_tensor):</span>
<span id="cb13-472"><a href="#cb13-472" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this just takes the results output of YOLO and coverts it to a matrix,</span></span>
<span id="cb13-473"><a href="#cb13-473" aria-hidden="true" tabindex="-1"></a>    <span class="co"># making it easier to do quick calculations on the coordinates</span></span>
<span id="cb13-474"><a href="#cb13-474" aria-hidden="true" tabindex="-1"></a>    results_list <span class="op">=</span> results_tensor.tolist()</span>
<span id="cb13-475"><a href="#cb13-475" aria-hidden="true" tabindex="-1"></a>    results_matrix <span class="op">=</span> np.matrix(results_list)</span>
<span id="cb13-476"><a href="#cb13-476" aria-hidden="true" tabindex="-1"></a>    results_matrix[results_matrix<span class="op">==</span><span class="dv">0</span>] <span class="op">=</span> np.nan</span>
<span id="cb13-477"><a href="#cb13-477" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_matrix</span>
<span id="cb13-478"><a href="#cb13-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-479"><a href="#cb13-479" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_for_duplication(results):</span>
<span id="cb13-480"><a href="#cb13-480" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this threshold determines how close two skeletons must be in order to be</span></span>
<span id="cb13-481"><a href="#cb13-481" aria-hidden="true" tabindex="-1"></a>    <span class="co"># considered the same person. Arbitrarily chosen for now.</span></span>
<span id="cb13-482"><a href="#cb13-482" aria-hidden="true" tabindex="-1"></a>    close_threshold <span class="op">=</span><span class="dv">150</span></span>
<span id="cb13-483"><a href="#cb13-483" aria-hidden="true" tabindex="-1"></a>    <span class="co"># missing data tolerance</span></span>
<span id="cb13-484"><a href="#cb13-484" aria-hidden="true" tabindex="-1"></a>    miss_tolerance <span class="op">=</span> <span class="fl">0.95</span> <span class="co"># this means we can miss up to 75% of the keypoints</span></span>
<span id="cb13-485"><a href="#cb13-485" aria-hidden="true" tabindex="-1"></a>    drop_indices <span class="op">=</span> []</span>
<span id="cb13-486"><a href="#cb13-486" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb13-487"><a href="#cb13-487" aria-hidden="true" tabindex="-1"></a>        conf_scores <span class="op">=</span> []</span>
<span id="cb13-488"><a href="#cb13-488" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get detection confidence for each skeleton</span></span>
<span id="cb13-489"><a href="#cb13-489" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> person <span class="kw">in</span> tensor_to_matrix(results[<span class="dv">0</span>].keypoints.conf):</span>
<span id="cb13-490"><a href="#cb13-490" aria-hidden="true" tabindex="-1"></a>            conf_scores.append(np.mean(person))</span>
<span id="cb13-491"><a href="#cb13-491" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb13-492"><a href="#cb13-492" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this list will stores which comparisons need to be made</span></span>
<span id="cb13-493"><a href="#cb13-493" aria-hidden="true" tabindex="-1"></a>        combos <span class="op">=</span> <span class="bu">list</span>(combinations(<span class="bu">range</span>(<span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy)), <span class="dv">2</span>))</span>
<span id="cb13-494"><a href="#cb13-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-495"><a href="#cb13-495" aria-hidden="true" tabindex="-1"></a>        <span class="co"># now loop through these comparisons</span></span>
<span id="cb13-496"><a href="#cb13-496" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> combo <span class="kw">in</span> combos:</span>
<span id="cb13-497"><a href="#cb13-497" aria-hidden="true" tabindex="-1"></a>            closeness <span class="op">=</span> <span class="bu">abs</span>(np.nanmean(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[combo[<span class="dv">0</span>]]) <span class="op">-</span> </span>
<span id="cb13-498"><a href="#cb13-498" aria-hidden="true" tabindex="-1"></a>                        tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[combo[<span class="dv">1</span>]])))</span>
<span id="cb13-499"><a href="#cb13-499" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if any of them indicate that two skeletons are very close together,</span></span>
<span id="cb13-500"><a href="#cb13-500" aria-hidden="true" tabindex="-1"></a>            <span class="co"># we keep the one with higher tracking confidence, and remove the other</span></span>
<span id="cb13-501"><a href="#cb13-501" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> closeness <span class="op">&lt;</span> close_threshold:</span>
<span id="cb13-502"><a href="#cb13-502" aria-hidden="true" tabindex="-1"></a>                conf_list <span class="op">=</span> [conf_scores[combo[<span class="dv">0</span>]], conf_scores[combo[<span class="dv">1</span>]]]</span>
<span id="cb13-503"><a href="#cb13-503" aria-hidden="true" tabindex="-1"></a>                idx_min <span class="op">=</span> conf_list.index(<span class="bu">min</span>(conf_list))</span>
<span id="cb13-504"><a href="#cb13-504" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-505"><a href="#cb13-505" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-506"><a href="#cb13-506" aria-hidden="true" tabindex="-1"></a>                drop_indices.append(combo[idx_min])</span>
<span id="cb13-507"><a href="#cb13-507" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-508"><a href="#cb13-508" aria-hidden="true" tabindex="-1"></a>        <span class="co"># additional checks:</span></span>
<span id="cb13-509"><a href="#cb13-509" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> person <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy)):</span>
<span id="cb13-510"><a href="#cb13-510" aria-hidden="true" tabindex="-1"></a>           keypoints_missed <span class="op">=</span>  np.isnan(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[person])).<span class="bu">sum</span>()<span class="op">/</span><span class="dv">2</span></span>
<span id="cb13-511"><a href="#cb13-511" aria-hidden="true" tabindex="-1"></a>           perc_missed <span class="op">=</span> keypoints_missed<span class="op">/</span><span class="bu">len</span>(tensor_to_matrix(results[<span class="dv">0</span>].keypoints.xy[person]))</span>
<span id="cb13-512"><a href="#cb13-512" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb13-513"><a href="#cb13-513" aria-hidden="true" tabindex="-1"></a>           <span class="cf">if</span> perc_missed <span class="op">&gt;</span> miss_tolerance:</span>
<span id="cb13-514"><a href="#cb13-514" aria-hidden="true" tabindex="-1"></a>               drop_indices.append(person)</span>
<span id="cb13-515"><a href="#cb13-515" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-516"><a href="#cb13-516" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">set</span>(drop_indices))</span>
<span id="cb13-517"><a href="#cb13-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-518"><a href="#cb13-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-519"><a href="#cb13-519" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> video_path <span class="kw">in</span> video_files:</span>
<span id="cb13-520"><a href="#cb13-520" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Video path</span></span>
<span id="cb13-521"><a href="#cb13-521" aria-hidden="true" tabindex="-1"></a>    video_path <span class="op">=</span> video_path</span>
<span id="cb13-522"><a href="#cb13-522" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only if the output is not there yet</span></span>
<span id="cb13-523"><a href="#cb13-523" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(step1resultfolder<span class="op">+</span> os.path.basename(video_path).split(<span class="st">'.'</span>)[<span class="dv">0</span>]<span class="op">+</span><span class="st">"_annotated_layer1_c150_miss95.mp4"</span>):</span>
<span id="cb13-524"><a href="#cb13-524" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Output video already exists for </span><span class="sc">{</span>video_path<span class="sc">}</span><span class="ss">. Skipping..."</span>)</span>
<span id="cb13-525"><a href="#cb13-525" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb13-526"><a href="#cb13-526" aria-hidden="true" tabindex="-1"></a>    <span class="co"># vidname without extension</span></span>
<span id="cb13-527"><a href="#cb13-527" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> os.path.basename(video_path)</span>
<span id="cb13-528"><a href="#cb13-528" aria-hidden="true" tabindex="-1"></a>    vidname <span class="op">=</span> vidname.split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb13-529"><a href="#cb13-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-530"><a href="#cb13-530" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Open the video</span></span>
<span id="cb13-531"><a href="#cb13-531" aria-hidden="true" tabindex="-1"></a>    cap <span class="op">=</span> cv2.VideoCapture(video_path)</span>
<span id="cb13-532"><a href="#cb13-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-533"><a href="#cb13-533" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get video properties</span></span>
<span id="cb13-534"><a href="#cb13-534" aria-hidden="true" tabindex="-1"></a>    fps <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FPS))</span>
<span id="cb13-535"><a href="#cb13-535" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span>
<span id="cb13-536"><a href="#cb13-536" aria-hidden="true" tabindex="-1"></a>    height <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span>
<span id="cb13-537"><a href="#cb13-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-538"><a href="#cb13-538" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the output video writer</span></span>
<span id="cb13-539"><a href="#cb13-539" aria-hidden="true" tabindex="-1"></a>    corename <span class="op">=</span> os.path.basename(video_path).split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb13-540"><a href="#cb13-540" aria-hidden="true" tabindex="-1"></a>    output_path <span class="op">=</span> step1resultfolder<span class="op">+</span> vidname<span class="op">+</span><span class="st">"_annotated_layer1_c150_miss95.mp4"</span></span>
<span id="cb13-541"><a href="#cb13-541" aria-hidden="true" tabindex="-1"></a>    fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span><span class="st">'mp4v'</span>)</span>
<span id="cb13-542"><a href="#cb13-542" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> cv2.VideoWriter(output_path, fourcc, fps, (width, height))</span>
<span id="cb13-543"><a href="#cb13-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-544"><a href="#cb13-544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare CSV file</span></span>
<span id="cb13-545"><a href="#cb13-545" aria-hidden="true" tabindex="-1"></a>    csv_path <span class="op">=</span> step1resultfolder<span class="op">+</span> vidname<span class="op">+</span><span class="st">'_keypoints_data_layer1.csv'</span></span>
<span id="cb13-546"><a href="#cb13-546" aria-hidden="true" tabindex="-1"></a>    csv_file <span class="op">=</span> <span class="bu">open</span>(csv_path, <span class="st">'w'</span>, newline<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb13-547"><a href="#cb13-547" aria-hidden="true" tabindex="-1"></a>    csv_writer <span class="op">=</span> csv.writer(csv_file)</span>
<span id="cb13-548"><a href="#cb13-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-549"><a href="#cb13-549" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write header</span></span>
<span id="cb13-550"><a href="#cb13-550" aria-hidden="true" tabindex="-1"></a>    header <span class="op">=</span> [<span class="st">'frame'</span>, <span class="st">'person'</span>, <span class="st">'keypoint'</span>, <span class="st">'x'</span>, <span class="st">'y'</span>]</span>
<span id="cb13-551"><a href="#cb13-551" aria-hidden="true" tabindex="-1"></a>    csv_writer.writerow(header)</span>
<span id="cb13-552"><a href="#cb13-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-553"><a href="#cb13-553" aria-hidden="true" tabindex="-1"></a>    frame_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-554"><a href="#cb13-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-555"><a href="#cb13-555" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> cap.isOpened():</span>
<span id="cb13-556"><a href="#cb13-556" aria-hidden="true" tabindex="-1"></a>        success, frame <span class="op">=</span> cap.read()</span>
<span id="cb13-557"><a href="#cb13-557" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb13-558"><a href="#cb13-558" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb13-559"><a href="#cb13-559" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-560"><a href="#cb13-560" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run YOLOv8 inference on the frame</span></span>
<span id="cb13-561"><a href="#cb13-561" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> model(frame)</span>
<span id="cb13-562"><a href="#cb13-562" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb13-563"><a href="#cb13-563" aria-hidden="true" tabindex="-1"></a>        <span class="co"># write empty rows if no person is detected</span></span>
<span id="cb13-564"><a href="#cb13-564" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb13-565"><a href="#cb13-565" aria-hidden="true" tabindex="-1"></a>            csv_writer.writerow([frame_count, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>])</span>
<span id="cb13-566"><a href="#cb13-566" aria-hidden="true" tabindex="-1"></a>        annotated_frame <span class="op">=</span> frame</span>
<span id="cb13-567"><a href="#cb13-567" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-568"><a href="#cb13-568" aria-hidden="true" tabindex="-1"></a>        <span class="co"># only do this if a person is detected</span></span>
<span id="cb13-569"><a href="#cb13-569" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(results[<span class="dv">0</span>].keypoints.xy) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-570"><a href="#cb13-570" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process the results</span></span>
<span id="cb13-571"><a href="#cb13-571" aria-hidden="true" tabindex="-1"></a>            drop_indices <span class="op">=</span> []</span>
<span id="cb13-572"><a href="#cb13-572" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-573"><a href="#cb13-573" aria-hidden="true" tabindex="-1"></a>            drop_indices <span class="op">=</span> check_for_duplication(results)</span>
<span id="cb13-574"><a href="#cb13-574" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-575"><a href="#cb13-575" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-576"><a href="#cb13-576" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> person_idx, person_keypoints <span class="kw">in</span> <span class="bu">enumerate</span>(results[<span class="dv">0</span>].keypoints.xy):</span>
<span id="cb13-577"><a href="#cb13-577" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> person_idx <span class="kw">not</span> <span class="kw">in</span> drop_indices:</span>
<span id="cb13-578"><a href="#cb13-578" aria-hidden="true" tabindex="-1"></a>                    colourcode <span class="op">=</span> (<span class="dv">0</span>, <span class="dv">255</span>, <span class="dv">0</span>)</span>
<span id="cb13-579"><a href="#cb13-579" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb13-580"><a href="#cb13-580" aria-hidden="true" tabindex="-1"></a>                    colourcode <span class="op">=</span> (<span class="dv">255</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb13-581"><a href="#cb13-581" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-582"><a href="#cb13-582" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> keypoint_idx, keypoint <span class="kw">in</span> <span class="bu">enumerate</span>(person_keypoints):</span>
<span id="cb13-583"><a href="#cb13-583" aria-hidden="true" tabindex="-1"></a>                    x, y <span class="op">=</span> keypoint</span>
<span id="cb13-584"><a href="#cb13-584" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-585"><a href="#cb13-585" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Write to CSV</span></span>
<span id="cb13-586"><a href="#cb13-586" aria-hidden="true" tabindex="-1"></a>                    csv_writer.writerow([frame_count, person_idx, keypoint_idx, x.item(), y.item()])</span>
<span id="cb13-587"><a href="#cb13-587" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb13-588"><a href="#cb13-588" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Draw keypoint on the frame</span></span>
<span id="cb13-589"><a href="#cb13-589" aria-hidden="true" tabindex="-1"></a>                    cv2.circle(annotated_frame, (<span class="bu">int</span>(x), <span class="bu">int</span>(y)), <span class="dv">5</span>, colourcode, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb13-590"><a href="#cb13-590" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-591"><a href="#cb13-591" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw skeleton</span></span>
<span id="cb13-592"><a href="#cb13-592" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> connection <span class="kw">in</span> skeleton:</span>
<span id="cb13-593"><a href="#cb13-593" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> connection[<span class="dv">0</span>] <span class="op">&lt;</span> <span class="bu">len</span>(person_keypoints) <span class="kw">and</span> connection[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="bu">len</span>(person_keypoints):</span>
<span id="cb13-594"><a href="#cb13-594" aria-hidden="true" tabindex="-1"></a>                        start_point <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">map</span>(<span class="bu">int</span>, person_keypoints[connection[<span class="dv">0</span>]]))</span>
<span id="cb13-595"><a href="#cb13-595" aria-hidden="true" tabindex="-1"></a>                        end_point <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">map</span>(<span class="bu">int</span>, person_keypoints[connection[<span class="dv">1</span>]]))</span>
<span id="cb13-596"><a href="#cb13-596" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">all</span>(start_point) <span class="kw">and</span> <span class="bu">all</span>(end_point):  <span class="co"># Check if both points are valid</span></span>
<span id="cb13-597"><a href="#cb13-597" aria-hidden="true" tabindex="-1"></a>                            cv2.line(annotated_frame, start_point, end_point, (<span class="dv">255</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">2</span>)</span>
<span id="cb13-598"><a href="#cb13-598" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-599"><a href="#cb13-599" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write the frame to the output video</span></span>
<span id="cb13-600"><a href="#cb13-600" aria-hidden="true" tabindex="-1"></a>            out.write(annotated_frame)</span>
<span id="cb13-601"><a href="#cb13-601" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-602"><a href="#cb13-602" aria-hidden="true" tabindex="-1"></a>        frame_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb13-603"><a href="#cb13-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-604"><a href="#cb13-604" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Release everything</span></span>
<span id="cb13-605"><a href="#cb13-605" aria-hidden="true" tabindex="-1"></a>    cap.release()</span>
<span id="cb13-606"><a href="#cb13-606" aria-hidden="true" tabindex="-1"></a>    out.release()</span>
<span id="cb13-607"><a href="#cb13-607" aria-hidden="true" tabindex="-1"></a>    cv2.destroyAllWindows()</span>
<span id="cb13-608"><a href="#cb13-608" aria-hidden="true" tabindex="-1"></a>    csv_file.close()</span>
<span id="cb13-609"><a href="#cb13-609" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Output video saved as </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-610"><a href="#cb13-610" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Keypoints data saved as </span><span class="sc">{</span>csv_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-611"><a href="#cb13-611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-612"><a href="#cb13-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-613"><a href="#cb13-613" aria-hidden="true" tabindex="-1"></a>Here is an example of the output video with annotated keypoints and skeletons. The green points indicate accepted keypoints, while the red points indicate filtered ones. The blue lines connect the keypoints to form a skeleton.</span>
<span id="cb13-614"><a href="#cb13-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-615"><a href="#cb13-615" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb13-616"><a href="#cb13-616" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">video</span><span class="ot"> width</span><span class="op">=</span><span class="st">"300"</span><span class="ot"> height</span><span class="op">=</span><span class="st">"200"</span><span class="ot"> controls</span><span class="dt">&gt;</span></span>
<span id="cb13-617"><a href="#cb13-617" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">source</span><span class="ot"> src</span><span class="op">=</span><span class="st">"./images/videosrerendered/sample.mp4"</span><span class="ot"> type</span><span class="op">=</span><span class="st">"video/mp4"</span><span class="dt">&gt;</span></span>
<span id="cb13-618"><a href="#cb13-618" aria-hidden="true" tabindex="-1"></a>  Your browser does not support the video tag.</span>
<span id="cb13-619"><a href="#cb13-619" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">video</span><span class="dt">&gt;</span></span>
<span id="cb13-620"><a href="#cb13-620" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb13-621"><a href="#cb13-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-622"><a href="#cb13-622" aria-hidden="true" tabindex="-1"></a>Here is an example of the output csv file containing the coordinates of the keypoints. The CSV file contains the following columns: frame number, person ID, keypoint ID, x-coordinate, and y-coordinate. Each row corresponds to a detected keypoint in a specific frame.</span>
<span id="cb13-623"><a href="#cb13-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-624"><a href="#cb13-624" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-installation collapse="true"}</span>
<span id="cb13-625"><a href="#cb13-625" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example output and code example for YOLO tracking: 📊</span></span>
<span id="cb13-626"><a href="#cb13-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-627"><a href="#cb13-627" aria-hidden="true" tabindex="-1"></a>TESTEST</span>
<span id="cb13-628"><a href="#cb13-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-629"><a href="#cb13-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-630"><a href="#cb13-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-631"><a href="#cb13-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-632"><a href="#cb13-632" aria-hidden="true" tabindex="-1"></a><span class="in">```{python examplecsvfile}</span></span>
<span id="cb13-633"><a href="#cb13-633" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-634"><a href="#cb13-634" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="im">as</span> glob</span>
<span id="cb13-635"><a href="#cb13-635" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-636"><a href="#cb13-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-637"><a href="#cb13-637" aria-hidden="true" tabindex="-1"></a>folderstep1output <span class="op">=</span> <span class="st">"./data_tracked_afterSTEP1_1/"</span></span>
<span id="cb13-638"><a href="#cb13-638" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file</span></span>
<span id="cb13-639"><a href="#cb13-639" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> glob.glob(os.path.join(folderstep1output <span class="op">+</span> <span class="st">"*.csv"</span>))[<span class="dv">0</span>]</span>
<span id="cb13-640"><a href="#cb13-640" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(csv_file)</span>
<span id="cb13-641"><a href="#cb13-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-642"><a href="#cb13-642" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame</span></span>
<span id="cb13-643"><a href="#cb13-643" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span>
<span id="cb13-644"><a href="#cb13-644" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-645"><a href="#cb13-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-646"><a href="#cb13-646" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb13-647"><a href="#cb13-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-648"><a href="#cb13-648" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 1.2: Raw pose data post-processing for timeseries matrices (Python)</span></span>
<span id="cb13-649"><a href="#cb13-649" aria-hidden="true" tabindex="-1"></a>The raw pose data with frame, person, keypoint, and x,y  position data that we end up with is not yet in a format that is easy to work with for our purposes. Additionally, sometimes we dont have a person or two persons detected in the frame. We want to transform these raw pose data to timeseries matrix format, whereby we have time in seconds as one column and different meaningful time-varying variables in the other columns. Furthermore, we will smooth and interpolate the data if necessary. The below python code executes this second step whereby we store the position data per person, and furthe derive interpersonal distances measures, and kinematic metrics (e.g. speed) and tracking quality indicators (e.g. tracking status that says something about where it concerns interpolated data).</span>
<span id="cb13-650"><a href="#cb13-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-651"><a href="#cb13-651" aria-hidden="true" tabindex="-1"></a>Next to determining time in seconds from the frame rate of the videos, the script starts with assigning left and right person IDs based on the horizontal position in the frame (with left being ID 1 and right being ID 2). It then processes the time data to calculate statistics for tracked people using upper body keypoints (as the lower body keypoints are unreliable from top-view and may be ignored). Specifically, we reduce the dimensionality of all upper body keypoints by determined relative positions and their distances: We calculate a bounding box (determined by the outer edges of the keypoints) and determine the center in x and y coordinates (<span class="in">`centroid_x`</span>, <span class="in">`centroid_y`</span>) and their P1-P2 distance of those centroids (<span class="in">`distance`</span>), and the center of mass (<span class="in">`com_x`</span>, <span class="in">`com_y`</span>) for each person and the distnace (<span class="in">`distance_com`</span>). Further we determine the midpoint of the shoulders as another relevant position (<span class="in">`shoulder_midpoint_x`</span>, <span class="in">`shoulder_midpoint_y`</span>) and compute its distance (<span class="in">`distance_shoulder_midpoint`</span>). Additionally, information about body parts such as arm motions by taking the wrist positions (<span class="in">`wrist_left_x`</span>, <span class="in">`wrist_left_y`</span>, <span class="in">`wrist_right_x`</span>, <span class="in">`wrist_right_y`</span>), and further deriving total motion per second, called speed (based on a euclidean sum of the changes of position along x and y). </span>
<span id="cb13-652"><a href="#cb13-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-653"><a href="#cb13-653" aria-hidden="true" tabindex="-1"></a>The Savitzky-Golay filter is applied for smoothing jittering position data (using a window size of 11 frames, polynomial order of 3). The script handles missing data through two complementary techniques: linear interpolation for brief gaps in tracking (up to 5 frames) and we take the last known location for longer gaps (up to 20 frames). The script also calculates the speed of the center of mass and wrist positions, and here we also smooth the values using the Savitzky-Golay filter to reduce noise that is amplified during differientation (see @winterBiomechanicsMotorControl2009).</span>
<span id="cb13-654"><a href="#cb13-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-655"><a href="#cb13-655" aria-hidden="true" tabindex="-1"></a>The more sophisticated measure that we have created is the proximity calculation measure (see function <span class="in">`calculate_approach()`</span> in the step2 script). This function establishes initial reference position for both participants and then projects their subsequent movements onto the connecting line between them. This allows for quantifying approach and retreat behaviors for each person seperately (which a distance measure does not allow for) while allowing for relative angle changes between them - positive values indicate movement toward the other person (relative from start), while negative values indicate withdrawal (relative from start).</span>
<span id="cb13-656"><a href="#cb13-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-657"><a href="#cb13-657" aria-hidden="true" tabindex="-1"></a>Below is an animation to what we are measuring. We are here capturing only movements that are changing the distance between them. When someone moves in a circle around the other person we want to make sure we do not register that as approach or retreat (which we would do if we just capture horizontal position for example). However we also want capture each person their own approach/avoidance value (which would not be possible when using a simple distance measure). By always measuring the signed length of the projected line from the initial position (based on the current connected line), the method tracks cumulative approach/avoidance for each person over time. </span>
<span id="cb13-658"><a href="#cb13-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-659"><a href="#cb13-659" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, code_folding="hide"}</span></span>
<span id="cb13-660"><a href="#cb13-660" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-661"><a href="#cb13-661" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-662"><a href="#cb13-662" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.animation <span class="im">import</span> FuncAnimation</span>
<span id="cb13-663"><a href="#cb13-663" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> patches</span>
<span id="cb13-664"><a href="#cb13-664" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.lines <span class="im">as</span> mlines</span>
<span id="cb13-665"><a href="#cb13-665" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-666"><a href="#cb13-666" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb13-667"><a href="#cb13-667" aria-hidden="true" tabindex="-1"></a><span class="co"># Force matplotlib to use Agg backend to avoid display issues</span></span>
<span id="cb13-668"><a href="#cb13-668" aria-hidden="true" tabindex="-1"></a>matplotlib.use(<span class="st">'Agg'</span>)</span>
<span id="cb13-669"><a href="#cb13-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-670"><a href="#cb13-670" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb13-671"><a href="#cb13-671" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">"images/proximity_visualization"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-672"><a href="#cb13-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-673"><a href="#cb13-673" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation parameters</span></span>
<span id="cb13-674"><a href="#cb13-674" aria-hidden="true" tabindex="-1"></a>num_frames <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb13-675"><a href="#cb13-675" aria-hidden="true" tabindex="-1"></a>p1_color <span class="op">=</span> <span class="st">'#3498db'</span>  <span class="co"># Blue</span></span>
<span id="cb13-676"><a href="#cb13-676" aria-hidden="true" tabindex="-1"></a>p2_color <span class="op">=</span> <span class="st">'#e74c3c'</span>  <span class="co"># Red</span></span>
<span id="cb13-677"><a href="#cb13-677" aria-hidden="true" tabindex="-1"></a>vector_color <span class="op">=</span> <span class="st">'#2ecc71'</span>  <span class="co"># Green</span></span>
<span id="cb13-678"><a href="#cb13-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-679"><a href="#cb13-679" aria-hidden="true" tabindex="-1"></a><span class="co"># Create initial positions for two people - now on a horizontal line</span></span>
<span id="cb13-680"><a href="#cb13-680" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 1 on the left, Person 2 on the right (same y-coordinate)</span></span>
<span id="cb13-681"><a href="#cb13-681" aria-hidden="true" tabindex="-1"></a>p1_initial <span class="op">=</span> np.array([<span class="dv">3</span>, <span class="dv">5</span>])</span>
<span id="cb13-682"><a href="#cb13-682" aria-hidden="true" tabindex="-1"></a>p2_initial <span class="op">=</span> np.array([<span class="dv">7</span>, <span class="dv">5</span>])</span>
<span id="cb13-683"><a href="#cb13-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-684"><a href="#cb13-684" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate movement paths with MORE EXTREME approach and avoidance</span></span>
<span id="cb13-685"><a href="#cb13-685" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 1 will make a dramatic approach followed by retreat</span></span>
<span id="cb13-686"><a href="#cb13-686" aria-hidden="true" tabindex="-1"></a><span class="co"># Person 2 will make a clear retreat followed by approach</span></span>
<span id="cb13-687"><a href="#cb13-687" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>np.pi, num_frames)</span>
<span id="cb13-688"><a href="#cb13-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-689"><a href="#cb13-689" aria-hidden="true" tabindex="-1"></a><span class="co"># Create more dramatic movement path for Person 1</span></span>
<span id="cb13-690"><a href="#cb13-690" aria-hidden="true" tabindex="-1"></a><span class="co"># Increase the amplitude of movement to make it more extreme</span></span>
<span id="cb13-691"><a href="#cb13-691" aria-hidden="true" tabindex="-1"></a>p1_path_x <span class="op">=</span> p1_initial[<span class="dv">0</span>] <span class="op">+</span> <span class="fl">2.5</span> <span class="op">*</span> np.sin(t<span class="op">/</span><span class="dv">2</span>)  <span class="co"># Larger horizontal movement (was 1.5)</span></span>
<span id="cb13-692"><a href="#cb13-692" aria-hidden="true" tabindex="-1"></a>p1_path_y <span class="op">=</span> p1_initial[<span class="dv">1</span>] <span class="op">+</span> <span class="fl">2.5</span> <span class="op">*</span> np.sin(t)   <span class="co"># Larger vertical movement (was 2.0)</span></span>
<span id="cb13-693"><a href="#cb13-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-694"><a href="#cb13-694" aria-hidden="true" tabindex="-1"></a><span class="co"># Create more dramatic movement path for Person 2</span></span>
<span id="cb13-695"><a href="#cb13-695" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the retreat phase more obvious</span></span>
<span id="cb13-696"><a href="#cb13-696" aria-hidden="true" tabindex="-1"></a>p2_path_x <span class="op">=</span> p2_initial[<span class="dv">0</span>] <span class="op">-</span> <span class="fl">1.2</span> <span class="op">*</span> np.sin(t)    <span class="co"># More horizontal movement (was 0.5)</span></span>
<span id="cb13-697"><a href="#cb13-697" aria-hidden="true" tabindex="-1"></a>p2_path_y <span class="op">=</span> p2_initial[<span class="dv">1</span>] <span class="op">-</span> <span class="fl">2.0</span> <span class="op">*</span> np.sin(t<span class="op">*</span><span class="fl">1.5</span>)  <span class="co"># More vertical movement (was 1.0)</span></span>
<span id="cb13-698"><a href="#cb13-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-699"><a href="#cb13-699" aria-hidden="true" tabindex="-1"></a><span class="co"># Store positions for each frame</span></span>
<span id="cb13-700"><a href="#cb13-700" aria-hidden="true" tabindex="-1"></a>p1_positions <span class="op">=</span> np.column_stack((p1_path_x, p1_path_y))</span>
<span id="cb13-701"><a href="#cb13-701" aria-hidden="true" tabindex="-1"></a>p2_positions <span class="op">=</span> np.column_stack((p2_path_x, p2_path_y))</span>
<span id="cb13-702"><a href="#cb13-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-703"><a href="#cb13-703" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrays to store approach values</span></span>
<span id="cb13-704"><a href="#cb13-704" aria-hidden="true" tabindex="-1"></a>p1_approach_values <span class="op">=</span> np.zeros(num_frames)</span>
<span id="cb13-705"><a href="#cb13-705" aria-hidden="true" tabindex="-1"></a>p2_approach_values <span class="op">=</span> np.zeros(num_frames)</span>
<span id="cb13-706"><a href="#cb13-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-707"><a href="#cb13-707" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate proximity approach values</span></span>
<span id="cb13-708"><a href="#cb13-708" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_approach(positions1, positions2):</span>
<span id="cb13-709"><a href="#cb13-709" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate approach values similar to the script's approach"""</span></span>
<span id="cb13-710"><a href="#cb13-710" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use first frame as reference</span></span>
<span id="cb13-711"><a href="#cb13-711" aria-hidden="true" tabindex="-1"></a>    reference_p1_pos <span class="op">=</span> positions1[<span class="dv">0</span>].copy()</span>
<span id="cb13-712"><a href="#cb13-712" aria-hidden="true" tabindex="-1"></a>    reference_p2_pos <span class="op">=</span> positions2[<span class="dv">0</span>].copy()</span>
<span id="cb13-713"><a href="#cb13-713" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-714"><a href="#cb13-714" aria-hidden="true" tabindex="-1"></a>    p1_approach <span class="op">=</span> np.zeros(<span class="bu">len</span>(positions1))</span>
<span id="cb13-715"><a href="#cb13-715" aria-hidden="true" tabindex="-1"></a>    p2_approach <span class="op">=</span> np.zeros(<span class="bu">len</span>(positions2))</span>
<span id="cb13-716"><a href="#cb13-716" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-717"><a href="#cb13-717" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(positions1)):</span>
<span id="cb13-718"><a href="#cb13-718" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current positions</span></span>
<span id="cb13-719"><a href="#cb13-719" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> positions1[i]</span>
<span id="cb13-720"><a href="#cb13-720" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> positions2[i]</span>
<span id="cb13-721"><a href="#cb13-721" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-722"><a href="#cb13-722" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current connecting vector and direction</span></span>
<span id="cb13-723"><a href="#cb13-723" aria-hidden="true" tabindex="-1"></a>        current_connect <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb13-724"><a href="#cb13-724" aria-hidden="true" tabindex="-1"></a>        current_distance <span class="op">=</span> np.linalg.norm(current_connect)</span>
<span id="cb13-725"><a href="#cb13-725" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-726"><a href="#cb13-726" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_distance <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-727"><a href="#cb13-727" aria-hidden="true" tabindex="-1"></a>            current_direction <span class="op">=</span> current_connect <span class="op">/</span> current_distance</span>
<span id="cb13-728"><a href="#cb13-728" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-729"><a href="#cb13-729" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Vectors from reference positions</span></span>
<span id="cb13-730"><a href="#cb13-730" aria-hidden="true" tabindex="-1"></a>            p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> reference_p1_pos</span>
<span id="cb13-731"><a href="#cb13-731" aria-hidden="true" tabindex="-1"></a>            p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> reference_p2_pos</span>
<span id="cb13-732"><a href="#cb13-732" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-733"><a href="#cb13-733" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Project onto connecting line</span></span>
<span id="cb13-734"><a href="#cb13-734" aria-hidden="true" tabindex="-1"></a>            p1_approach[i] <span class="op">=</span> np.dot(p1_vector, current_direction)</span>
<span id="cb13-735"><a href="#cb13-735" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-736"><a href="#cb13-736" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P2, a positive value should mean movement toward P1</span></span>
<span id="cb13-737"><a href="#cb13-737" aria-hidden="true" tabindex="-1"></a>            <span class="co"># So we use the negative connecting direction (from P2 to P1)</span></span>
<span id="cb13-738"><a href="#cb13-738" aria-hidden="true" tabindex="-1"></a>            <span class="co"># And a positive dot product means approaching</span></span>
<span id="cb13-739"><a href="#cb13-739" aria-hidden="true" tabindex="-1"></a>            p2_direction <span class="op">=</span> <span class="op">-</span>current_direction  <span class="co"># Direction from P2 to P1</span></span>
<span id="cb13-740"><a href="#cb13-740" aria-hidden="true" tabindex="-1"></a>            p2_approach[i] <span class="op">=</span> np.dot(p2_vector, p2_direction)</span>
<span id="cb13-741"><a href="#cb13-741" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-742"><a href="#cb13-742" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> p1_approach, p2_approach</span>
<span id="cb13-743"><a href="#cb13-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-744"><a href="#cb13-744" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate approach values</span></span>
<span id="cb13-745"><a href="#cb13-745" aria-hidden="true" tabindex="-1"></a>p1_approach_values, p2_approach_values <span class="op">=</span> calculate_approach(p1_positions, p2_positions)</span>
<span id="cb13-746"><a href="#cb13-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-747"><a href="#cb13-747" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the main visualization</span></span>
<span id="cb13-748"><a href="#cb13-748" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_detailed_animation():</span>
<span id="cb13-749"><a href="#cb13-749" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set up the figure explicitly with DPI</span></span>
<span id="cb13-750"><a href="#cb13-750" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>), dpi<span class="op">=</span><span class="dv">100</span>)  <span class="co"># Larger figure for better visibility</span></span>
<span id="cb13-751"><a href="#cb13-751" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-752"><a href="#cb13-752" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> init():</span>
<span id="cb13-753"><a href="#cb13-753" aria-hidden="true" tabindex="-1"></a>        ax.clear()</span>
<span id="cb13-754"><a href="#cb13-754" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb13-755"><a href="#cb13-755" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb13-756"><a href="#cb13-756" aria-hidden="true" tabindex="-1"></a>        ax.set_aspect(<span class="st">'equal'</span>)</span>
<span id="cb13-757"><a href="#cb13-757" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb13-758"><a href="#cb13-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-759"><a href="#cb13-759" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> animate(i):</span>
<span id="cb13-760"><a href="#cb13-760" aria-hidden="true" tabindex="-1"></a>        ax.clear()</span>
<span id="cb13-761"><a href="#cb13-761" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-762"><a href="#cb13-762" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set up the axes</span></span>
<span id="cb13-763"><a href="#cb13-763" aria-hidden="true" tabindex="-1"></a>        ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb13-764"><a href="#cb13-764" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb13-765"><a href="#cb13-765" aria-hidden="true" tabindex="-1"></a>        ax.set_aspect(<span class="st">'equal'</span>)</span>
<span id="cb13-766"><a href="#cb13-766" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">'Proximity Approach Visualization (Extreme Movements)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb13-767"><a href="#cb13-767" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">'X Position'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb13-768"><a href="#cb13-768" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Y Position'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb13-769"><a href="#cb13-769" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-770"><a href="#cb13-770" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get current positions</span></span>
<span id="cb13-771"><a href="#cb13-771" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> p1_positions[i]</span>
<span id="cb13-772"><a href="#cb13-772" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> p2_positions[i]</span>
<span id="cb13-773"><a href="#cb13-773" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-774"><a href="#cb13-774" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the initial connecting vector (reference)</span></span>
<span id="cb13-775"><a href="#cb13-775" aria-hidden="true" tabindex="-1"></a>        ax.plot([p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">0</span>]], </span>
<span id="cb13-776"><a href="#cb13-776" aria-hidden="true" tabindex="-1"></a>                [p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>]], </span>
<span id="cb13-777"><a href="#cb13-777" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb13-778"><a href="#cb13-778" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-779"><a href="#cb13-779" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw the current connection vector</span></span>
<span id="cb13-780"><a href="#cb13-780" aria-hidden="true" tabindex="-1"></a>        ax.plot([p1_pos[<span class="dv">0</span>], p2_pos[<span class="dv">0</span>]], [p1_pos[<span class="dv">1</span>], p2_pos[<span class="dv">1</span>]], </span>
<span id="cb13-781"><a href="#cb13-781" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="fl">2.5</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-782"><a href="#cb13-782" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-783"><a href="#cb13-783" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw person markers</span></span>
<span id="cb13-784"><a href="#cb13-784" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p1_pos[<span class="dv">0</span>], p1_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">180</span>, color<span class="op">=</span>p1_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb13-785"><a href="#cb13-785" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p2_pos[<span class="dv">0</span>], p2_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">180</span>, color<span class="op">=</span>p2_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb13-786"><a href="#cb13-786" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-787"><a href="#cb13-787" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw initial positions</span></span>
<span id="cb13-788"><a href="#cb13-788" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span>p1_color, </span>
<span id="cb13-789"><a href="#cb13-789" aria-hidden="true" tabindex="-1"></a>                   alpha<span class="op">=</span><span class="fl">0.5</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb13-790"><a href="#cb13-790" aria-hidden="true" tabindex="-1"></a>        ax.scatter(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span>p2_color, </span>
<span id="cb13-791"><a href="#cb13-791" aria-hidden="true" tabindex="-1"></a>                   alpha<span class="op">=</span><span class="fl">0.5</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb13-792"><a href="#cb13-792" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-793"><a href="#cb13-793" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Draw trails (last 15 positions)</span></span>
<span id="cb13-794"><a href="#cb13-794" aria-hidden="true" tabindex="-1"></a>        start_idx <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, i<span class="op">-</span><span class="dv">15</span>)</span>
<span id="cb13-795"><a href="#cb13-795" aria-hidden="true" tabindex="-1"></a>        ax.plot(p1_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">0</span>], p1_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>], </span>
<span id="cb13-796"><a href="#cb13-796" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-'</span>, color<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb13-797"><a href="#cb13-797" aria-hidden="true" tabindex="-1"></a>        ax.plot(p2_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">0</span>], p2_positions[start_idx:i<span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>], </span>
<span id="cb13-798"><a href="#cb13-798" aria-hidden="true" tabindex="-1"></a>                <span class="st">'-'</span>, color<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb13-799"><a href="#cb13-799" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-800"><a href="#cb13-800" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Visualize the approach values with text - make them larger and more visible</span></span>
<span id="cb13-801"><a href="#cb13-801" aria-hidden="true" tabindex="-1"></a>        approach_text <span class="op">=</span> (<span class="ss">f"P1 approach: </span><span class="sc">{</span>p1_approach_values[i]<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb13-802"><a href="#cb13-802" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f"P2 approach: </span><span class="sc">{</span>p2_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-803"><a href="#cb13-803" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.05</span>, <span class="fl">0.95</span>, approach_text, transform<span class="op">=</span>ax.transAxes, </span>
<span id="cb13-804"><a href="#cb13-804" aria-hidden="true" tabindex="-1"></a>                verticalalignment<span class="op">=</span><span class="st">'top'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb13-805"><a href="#cb13-805" aria-hidden="true" tabindex="-1"></a>                bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>))</span>
<span id="cb13-806"><a href="#cb13-806" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-807"><a href="#cb13-807" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add projection visualization</span></span>
<span id="cb13-808"><a href="#cb13-808" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-809"><a href="#cb13-809" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get current connecting direction</span></span>
<span id="cb13-810"><a href="#cb13-810" aria-hidden="true" tabindex="-1"></a>            connect_vector <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb13-811"><a href="#cb13-811" aria-hidden="true" tabindex="-1"></a>            connect_distance <span class="op">=</span> np.linalg.norm(connect_vector)</span>
<span id="cb13-812"><a href="#cb13-812" aria-hidden="true" tabindex="-1"></a>            connect_direction <span class="op">=</span> connect_vector <span class="op">/</span> connect_distance</span>
<span id="cb13-813"><a href="#cb13-813" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-814"><a href="#cb13-814" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Person 1 projection</span></span>
<span id="cb13-815"><a href="#cb13-815" aria-hidden="true" tabindex="-1"></a>            p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> p1_positions[<span class="dv">0</span>]</span>
<span id="cb13-816"><a href="#cb13-816" aria-hidden="true" tabindex="-1"></a>            p1_projection <span class="op">=</span> np.dot(p1_vector, connect_direction) <span class="op">*</span> connect_direction</span>
<span id="cb13-817"><a href="#cb13-817" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-818"><a href="#cb13-818" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection line for P1</span></span>
<span id="cb13-819"><a href="#cb13-819" aria-hidden="true" tabindex="-1"></a>            p1_proj_point <span class="op">=</span> p1_positions[<span class="dv">0</span>] <span class="op">+</span> p1_projection</span>
<span id="cb13-820"><a href="#cb13-820" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-821"><a href="#cb13-821" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Person 2 projection - use direction from P2 to P1</span></span>
<span id="cb13-822"><a href="#cb13-822" aria-hidden="true" tabindex="-1"></a>            p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> p2_positions[<span class="dv">0</span>]</span>
<span id="cb13-823"><a href="#cb13-823" aria-hidden="true" tabindex="-1"></a>            p2_direction <span class="op">=</span> <span class="op">-</span>connect_direction  <span class="co"># Direction from P2 to P1</span></span>
<span id="cb13-824"><a href="#cb13-824" aria-hidden="true" tabindex="-1"></a>            p2_projection <span class="op">=</span> np.dot(p2_vector, p2_direction) <span class="op">*</span> p2_direction</span>
<span id="cb13-825"><a href="#cb13-825" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-826"><a href="#cb13-826" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection line for P2</span></span>
<span id="cb13-827"><a href="#cb13-827" aria-hidden="true" tabindex="-1"></a>            p2_proj_point <span class="op">=</span> p2_positions[<span class="dv">0</span>] <span class="op">+</span> p2_projection</span>
<span id="cb13-828"><a href="#cb13-828" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-829"><a href="#cb13-829" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw projection lines with arrows to show direction</span></span>
<span id="cb13-830"><a href="#cb13-830" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P1</span></span>
<span id="cb13-831"><a href="#cb13-831" aria-hidden="true" tabindex="-1"></a>            p1_approach <span class="op">=</span> p1_approach_values[i]</span>
<span id="cb13-832"><a href="#cb13-832" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(p1_approach) <span class="op">&gt;</span> <span class="fl">0.1</span>:  <span class="co"># Only draw if there's a significant approach value</span></span>
<span id="cb13-833"><a href="#cb13-833" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw line with increased width</span></span>
<span id="cb13-834"><a href="#cb13-834" aria-hidden="true" tabindex="-1"></a>                ax.plot([p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_proj_point[<span class="dv">0</span>]], </span>
<span id="cb13-835"><a href="#cb13-835" aria-hidden="true" tabindex="-1"></a>                        [p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], p1_proj_point[<span class="dv">1</span>]], </span>
<span id="cb13-836"><a href="#cb13-836" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'--'</span>, color<span class="op">=</span>p1_color, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb13-837"><a href="#cb13-837" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-838"><a href="#cb13-838" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add arrow to show direction - make arrow larger</span></span>
<span id="cb13-839"><a href="#cb13-839" aria-hidden="true" tabindex="-1"></a>                arrow_length <span class="op">=</span> <span class="bu">min</span>(<span class="bu">abs</span>(p1_approach) <span class="op">*</span> <span class="fl">0.2</span>, <span class="fl">0.6</span>)  <span class="co"># Scale arrow size</span></span>
<span id="cb13-840"><a href="#cb13-840" aria-hidden="true" tabindex="-1"></a>                arrow_width <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb13-841"><a href="#cb13-841" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> p1_approach <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Approaching</span></span>
<span id="cb13-842"><a href="#cb13-842" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position toward projection point</span></span>
<span id="cb13-843"><a href="#cb13-843" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb13-844"><a href="#cb13-844" aria-hidden="true" tabindex="-1"></a>                            arrow_length <span class="op">*</span> connect_direction[<span class="dv">0</span>], arrow_length <span class="op">*</span> connect_direction[<span class="dv">1</span>],</span>
<span id="cb13-845"><a href="#cb13-845" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb13-846"><a href="#cb13-846" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p1_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb13-847"><a href="#cb13-847" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:  <span class="co"># Retreating</span></span>
<span id="cb13-848"><a href="#cb13-848" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position away from projection point</span></span>
<span id="cb13-849"><a href="#cb13-849" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb13-850"><a href="#cb13-850" aria-hidden="true" tabindex="-1"></a>                            <span class="op">-</span>arrow_length <span class="op">*</span> connect_direction[<span class="dv">0</span>], <span class="op">-</span>arrow_length <span class="op">*</span> connect_direction[<span class="dv">1</span>],</span>
<span id="cb13-851"><a href="#cb13-851" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb13-852"><a href="#cb13-852" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p1_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb13-853"><a href="#cb13-853" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-854"><a href="#cb13-854" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add value label near the projection line</span></span>
<span id="cb13-855"><a href="#cb13-855" aria-hidden="true" tabindex="-1"></a>                mid_x <span class="op">=</span> (p1_positions[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> p1_proj_point[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb13-856"><a href="#cb13-856" aria-hidden="true" tabindex="-1"></a>                mid_y <span class="op">=</span> (p1_positions[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> p1_proj_point[<span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb13-857"><a href="#cb13-857" aria-hidden="true" tabindex="-1"></a>                ax.text(mid_x, mid_y, <span class="ss">f"</span><span class="sc">{</span>p1_approach<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb13-858"><a href="#cb13-858" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>p1_color, fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb13-859"><a href="#cb13-859" aria-hidden="true" tabindex="-1"></a>                        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, boxstyle<span class="op">=</span><span class="st">'round,pad=0.2'</span>))</span>
<span id="cb13-860"><a href="#cb13-860" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-861"><a href="#cb13-861" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For P2</span></span>
<span id="cb13-862"><a href="#cb13-862" aria-hidden="true" tabindex="-1"></a>            p2_approach <span class="op">=</span> p2_approach_values[i]</span>
<span id="cb13-863"><a href="#cb13-863" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(p2_approach) <span class="op">&gt;</span> <span class="fl">0.1</span>:  <span class="co"># Only draw if there's a significant approach value</span></span>
<span id="cb13-864"><a href="#cb13-864" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Draw line with increased width</span></span>
<span id="cb13-865"><a href="#cb13-865" aria-hidden="true" tabindex="-1"></a>                ax.plot([p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_proj_point[<span class="dv">0</span>]], </span>
<span id="cb13-866"><a href="#cb13-866" aria-hidden="true" tabindex="-1"></a>                        [p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], p2_proj_point[<span class="dv">1</span>]], </span>
<span id="cb13-867"><a href="#cb13-867" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'--'</span>, color<span class="op">=</span>p2_color, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb13-868"><a href="#cb13-868" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-869"><a href="#cb13-869" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add arrow to show direction - make arrow larger</span></span>
<span id="cb13-870"><a href="#cb13-870" aria-hidden="true" tabindex="-1"></a>                arrow_length <span class="op">=</span> <span class="bu">min</span>(<span class="bu">abs</span>(p2_approach) <span class="op">*</span> <span class="fl">0.2</span>, <span class="fl">0.6</span>)  <span class="co"># Scale arrow size</span></span>
<span id="cb13-871"><a href="#cb13-871" aria-hidden="true" tabindex="-1"></a>                arrow_width <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb13-872"><a href="#cb13-872" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> p2_approach <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Approaching</span></span>
<span id="cb13-873"><a href="#cb13-873" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position toward P1</span></span>
<span id="cb13-874"><a href="#cb13-874" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb13-875"><a href="#cb13-875" aria-hidden="true" tabindex="-1"></a>                            arrow_length <span class="op">*</span> p2_direction[<span class="dv">0</span>], arrow_length <span class="op">*</span> p2_direction[<span class="dv">1</span>],</span>
<span id="cb13-876"><a href="#cb13-876" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb13-877"><a href="#cb13-877" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p2_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb13-878"><a href="#cb13-878" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:  <span class="co"># Retreating</span></span>
<span id="cb13-879"><a href="#cb13-879" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Arrow pointing from initial position away from P1</span></span>
<span id="cb13-880"><a href="#cb13-880" aria-hidden="true" tabindex="-1"></a>                    ax.arrow(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], </span>
<span id="cb13-881"><a href="#cb13-881" aria-hidden="true" tabindex="-1"></a>                            <span class="op">-</span>arrow_length <span class="op">*</span> p2_direction[<span class="dv">0</span>], <span class="op">-</span>arrow_length <span class="op">*</span> p2_direction[<span class="dv">1</span>],</span>
<span id="cb13-882"><a href="#cb13-882" aria-hidden="true" tabindex="-1"></a>                            head_width<span class="op">=</span>arrow_width, head_length<span class="op">=</span>arrow_width<span class="op">*</span><span class="fl">1.5</span>, </span>
<span id="cb13-883"><a href="#cb13-883" aria-hidden="true" tabindex="-1"></a>                            fc<span class="op">=</span>p2_color, ec<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb13-884"><a href="#cb13-884" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-885"><a href="#cb13-885" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add value label near the projection line</span></span>
<span id="cb13-886"><a href="#cb13-886" aria-hidden="true" tabindex="-1"></a>                mid_x <span class="op">=</span> (p2_positions[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">+</span> p2_proj_point[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb13-887"><a href="#cb13-887" aria-hidden="true" tabindex="-1"></a>                mid_y <span class="op">=</span> (p2_positions[<span class="dv">0</span>][<span class="dv">1</span>] <span class="op">+</span> p2_proj_point[<span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb13-888"><a href="#cb13-888" aria-hidden="true" tabindex="-1"></a>                ax.text(mid_x, mid_y, <span class="ss">f"</span><span class="sc">{</span>p2_approach<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb13-889"><a href="#cb13-889" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>p2_color, fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb13-890"><a href="#cb13-890" aria-hidden="true" tabindex="-1"></a>                        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, boxstyle<span class="op">=</span><span class="st">'round,pad=0.2'</span>))</span>
<span id="cb13-891"><a href="#cb13-891" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-892"><a href="#cb13-892" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add small markers at projection points</span></span>
<span id="cb13-893"><a href="#cb13-893" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_proj_point[<span class="dv">0</span>], p1_proj_point[<span class="dv">1</span>], </span>
<span id="cb13-894"><a href="#cb13-894" aria-hidden="true" tabindex="-1"></a>                      color<span class="op">=</span>p1_color, s<span class="op">=</span><span class="dv">70</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb13-895"><a href="#cb13-895" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_proj_point[<span class="dv">0</span>], p2_proj_point[<span class="dv">1</span>], </span>
<span id="cb13-896"><a href="#cb13-896" aria-hidden="true" tabindex="-1"></a>                      color<span class="op">=</span>p2_color, s<span class="op">=</span><span class="dv">70</span>, marker<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb13-897"><a href="#cb13-897" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-898"><a href="#cb13-898" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw horizontal dotted line at initial y-coordinate to emphasize horizontal start</span></span>
<span id="cb13-899"><a href="#cb13-899" aria-hidden="true" tabindex="-1"></a>            ax.axhline(y<span class="op">=</span>p1_initial[<span class="dv">1</span>], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb13-900"><a href="#cb13-900" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-901"><a href="#cb13-901" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add legend</span></span>
<span id="cb13-902"><a href="#cb13-902" aria-hidden="true" tabindex="-1"></a>        legend_elements <span class="op">=</span> [</span>
<span id="cb13-903"><a href="#cb13-903" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>p1_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Person 1'</span>),</span>
<span id="cb13-904"><a href="#cb13-904" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>p2_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Person 2'</span>),</span>
<span id="cb13-905"><a href="#cb13-905" aria-hidden="true" tabindex="-1"></a>            patches.Patch(facecolor<span class="op">=</span>vector_color, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Connection Vector'</span>),</span>
<span id="cb13-906"><a href="#cb13-906" aria-hidden="true" tabindex="-1"></a>            mlines.Line2D([], [], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, label<span class="op">=</span><span class="st">'Initial Horizontal Line'</span>),</span>
<span id="cb13-907"><a href="#cb13-907" aria-hidden="true" tabindex="-1"></a>            mlines.Line2D([], [], color<span class="op">=</span>p1_color, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Projection Length = Approach Value'</span>)</span>
<span id="cb13-908"><a href="#cb13-908" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb13-909"><a href="#cb13-909" aria-hidden="true" tabindex="-1"></a>        ax.legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-910"><a href="#cb13-910" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-911"><a href="#cb13-911" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add a frame counter</span></span>
<span id="cb13-912"><a href="#cb13-912" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.95</span>, <span class="fl">0.05</span>, <span class="ss">f"Frame: </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>num_frames<span class="op">-</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>, transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb13-913"><a href="#cb13-913" aria-hidden="true" tabindex="-1"></a>               horizontalalignment<span class="op">=</span><span class="st">'right'</span>, verticalalignment<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb13-914"><a href="#cb13-914" aria-hidden="true" tabindex="-1"></a>               bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb13-915"><a href="#cb13-915" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-916"><a href="#cb13-916" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add description text</span></span>
<span id="cb13-917"><a href="#cb13-917" aria-hidden="true" tabindex="-1"></a>        description <span class="op">=</span> (</span>
<span id="cb13-918"><a href="#cb13-918" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Proximity Calculation Visualization</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb13-919"><a href="#cb13-919" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Large dots: Current positions</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb13-920"><a href="#cb13-920" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Small dots: Initial positions (horizontal alignment)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb13-921"><a href="#cb13-921" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Green line: Current connecting vector</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb13-922"><a href="#cb13-922" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Dashed lines: Projection of movement (length = approach value)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb13-923"><a href="#cb13-923" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Arrows: Direction of approach/retreat</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb13-924"><a href="#cb13-924" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Positive values: Movement toward other person</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb13-925"><a href="#cb13-925" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- Negative values: Movement away from other person</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb13-926"><a href="#cb13-926" aria-hidden="true" tabindex="-1"></a>            <span class="st">"- X markers: Projected positions"</span></span>
<span id="cb13-927"><a href="#cb13-927" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-928"><a href="#cb13-928" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.05</span>, <span class="fl">0.05</span>, description, transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb13-929"><a href="#cb13-929" aria-hidden="true" tabindex="-1"></a>               verticalalignment<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb13-930"><a href="#cb13-930" aria-hidden="true" tabindex="-1"></a>               bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>))</span>
<span id="cb13-931"><a href="#cb13-931" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-932"><a href="#cb13-932" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb13-933"><a href="#cb13-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-934"><a href="#cb13-934" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the animation with explicit FPS and DPI</span></span>
<span id="cb13-935"><a href="#cb13-935" aria-hidden="true" tabindex="-1"></a>    ani <span class="op">=</span> FuncAnimation(fig, animate, frames<span class="op">=</span>num_frames, init_func<span class="op">=</span>init, </span>
<span id="cb13-936"><a href="#cb13-936" aria-hidden="true" tabindex="-1"></a>                        blit<span class="op">=</span><span class="va">True</span>, interval<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb13-937"><a href="#cb13-937" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-938"><a href="#cb13-938" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the animation as a GIF with explicit DPI</span></span>
<span id="cb13-939"><a href="#cb13-939" aria-hidden="true" tabindex="-1"></a>    ani.save(<span class="st">'images/proximity_visualization/proximity_calculation_extreme.gif'</span>, writer<span class="op">=</span><span class="st">'pillow'</span>, fps<span class="op">=</span><span class="dv">10</span>, dpi<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb13-940"><a href="#cb13-940" aria-hidden="true" tabindex="-1"></a>    plt.close(fig)</span>
<span id="cb13-941"><a href="#cb13-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-942"><a href="#cb13-942" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the animation</span></span>
<span id="cb13-943"><a href="#cb13-943" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb13-944"><a href="#cb13-944" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Creating animation..."</span>)</span>
<span id="cb13-945"><a href="#cb13-945" aria-hidden="true" tabindex="-1"></a>    create_detailed_animation()</span>
<span id="cb13-946"><a href="#cb13-946" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GIF created successfully in the 'images/proximity_visualization' folder."</span>)</span>
<span id="cb13-947"><a href="#cb13-947" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb13-948"><a href="#cb13-948" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error creating animation: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-949"><a href="#cb13-949" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-950"><a href="#cb13-950" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alternative approach if the above fails - create static frames</span></span>
<span id="cb13-951"><a href="#cb13-951" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Trying alternative approach with static frames..."</span>)</span>
<span id="cb13-952"><a href="#cb13-952" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb13-953"><a href="#cb13-953" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a static image sequence instead</span></span>
<span id="cb13-954"><a href="#cb13-954" aria-hidden="true" tabindex="-1"></a>        os.makedirs(<span class="st">"images/proximity_visualization/frames"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-955"><a href="#cb13-955" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-956"><a href="#cb13-956" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create 10 static frames instead of full animation</span></span>
<span id="cb13-957"><a href="#cb13-957" aria-hidden="true" tabindex="-1"></a>        sample_frames <span class="op">=</span> np.linspace(<span class="dv">0</span>, num_frames<span class="op">-</span><span class="dv">1</span>, <span class="dv">10</span>, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb13-958"><a href="#cb13-958" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-959"><a href="#cb13-959" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, i <span class="kw">in</span> <span class="bu">enumerate</span>(sample_frames):</span>
<span id="cb13-960"><a href="#cb13-960" aria-hidden="true" tabindex="-1"></a>            fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), dpi<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb13-961"><a href="#cb13-961" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-962"><a href="#cb13-962" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Set up the axes</span></span>
<span id="cb13-963"><a href="#cb13-963" aria-hidden="true" tabindex="-1"></a>            ax.set_xlim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb13-964"><a href="#cb13-964" aria-hidden="true" tabindex="-1"></a>            ax.set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb13-965"><a href="#cb13-965" aria-hidden="true" tabindex="-1"></a>            ax.set_title(<span class="ss">f'Proximity Calculation (Frame </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb13-966"><a href="#cb13-966" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-967"><a href="#cb13-967" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get current positions</span></span>
<span id="cb13-968"><a href="#cb13-968" aria-hidden="true" tabindex="-1"></a>            p1_pos <span class="op">=</span> p1_positions[i]</span>
<span id="cb13-969"><a href="#cb13-969" aria-hidden="true" tabindex="-1"></a>            p2_pos <span class="op">=</span> p2_positions[i]</span>
<span id="cb13-970"><a href="#cb13-970" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-971"><a href="#cb13-971" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw the connection vector</span></span>
<span id="cb13-972"><a href="#cb13-972" aria-hidden="true" tabindex="-1"></a>            ax.plot([p1_pos[<span class="dv">0</span>], p2_pos[<span class="dv">0</span>]], [p1_pos[<span class="dv">1</span>], p2_pos[<span class="dv">1</span>]], </span>
<span id="cb13-973"><a href="#cb13-973" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span>vector_color, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb13-974"><a href="#cb13-974" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-975"><a href="#cb13-975" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw person markers</span></span>
<span id="cb13-976"><a href="#cb13-976" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_pos[<span class="dv">0</span>], p1_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">150</span>, color<span class="op">=</span>p1_color, label<span class="op">=</span><span class="st">'Person 1'</span>)</span>
<span id="cb13-977"><a href="#cb13-977" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_pos[<span class="dv">0</span>], p2_pos[<span class="dv">1</span>], s<span class="op">=</span><span class="dv">150</span>, color<span class="op">=</span>p2_color, label<span class="op">=</span><span class="st">'Person 2'</span>)</span>
<span id="cb13-978"><a href="#cb13-978" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-979"><a href="#cb13-979" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw initial positions</span></span>
<span id="cb13-980"><a href="#cb13-980" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p1_positions[<span class="dv">0</span>][<span class="dv">0</span>], p1_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb13-981"><a href="#cb13-981" aria-hidden="true" tabindex="-1"></a>            ax.scatter(p2_positions[<span class="dv">0</span>][<span class="dv">0</span>], p2_positions[<span class="dv">0</span>][<span class="dv">1</span>], s<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb13-982"><a href="#cb13-982" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-983"><a href="#cb13-983" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Draw horizontal dotted line at initial y-coordinate</span></span>
<span id="cb13-984"><a href="#cb13-984" aria-hidden="true" tabindex="-1"></a>            ax.axhline(y<span class="op">=</span>p1_initial[<span class="dv">1</span>], color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb13-985"><a href="#cb13-985" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-986"><a href="#cb13-986" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Show approach values</span></span>
<span id="cb13-987"><a href="#cb13-987" aria-hidden="true" tabindex="-1"></a>            ax.text(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="ss">f"Person 1 approach: </span><span class="sc">{</span>p1_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb13-988"><a href="#cb13-988" aria-hidden="true" tabindex="-1"></a>                    transform<span class="op">=</span>ax.transAxes, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb13-989"><a href="#cb13-989" aria-hidden="true" tabindex="-1"></a>                    bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span>p1_color, alpha<span class="op">=</span><span class="fl">0.3</span>))</span>
<span id="cb13-990"><a href="#cb13-990" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-991"><a href="#cb13-991" aria-hidden="true" tabindex="-1"></a>            ax.text(<span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="ss">f"Person 2 approach: </span><span class="sc">{</span>p2_approach_values[i]<span class="sc">:.2f}</span><span class="ss">"</span>, </span>
<span id="cb13-992"><a href="#cb13-992" aria-hidden="true" tabindex="-1"></a>                    transform<span class="op">=</span>ax.transAxes, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb13-993"><a href="#cb13-993" aria-hidden="true" tabindex="-1"></a>                    bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span>p2_color, alpha<span class="op">=</span><span class="fl">0.3</span>))</span>
<span id="cb13-994"><a href="#cb13-994" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-995"><a href="#cb13-995" aria-hidden="true" tabindex="-1"></a>            ax.legend()</span>
<span id="cb13-996"><a href="#cb13-996" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-997"><a href="#cb13-997" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the frame</span></span>
<span id="cb13-998"><a href="#cb13-998" aria-hidden="true" tabindex="-1"></a>            plt.tight_layout()</span>
<span id="cb13-999"><a href="#cb13-999" aria-hidden="true" tabindex="-1"></a>            plt.savefig(<span class="ss">f'images/proximity_visualization/frames/frame_</span><span class="sc">{</span>idx<span class="sc">:02d}</span><span class="ss">.png'</span>)</span>
<span id="cb13-1000"><a href="#cb13-1000" aria-hidden="true" tabindex="-1"></a>            plt.close(fig)</span>
<span id="cb13-1001"><a href="#cb13-1001" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-1002"><a href="#cb13-1002" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Static frames created successfully in 'images/proximity_visualization/frames' folder."</span>)</span>
<span id="cb13-1003"><a href="#cb13-1003" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb13-1004"><a href="#cb13-1004" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Alternative approach also failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-1005"><a href="#cb13-1005" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-1006"><a href="#cb13-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1007"><a href="#cb13-1007" aria-hidden="true" tabindex="-1"></a><span class="al">![Proximity Calculation Visualization](./images/proximity_visualization/proximity_calculation.gif)</span></span>
<span id="cb13-1008"><a href="#cb13-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1009"><a href="#cb13-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1010"><a href="#cb13-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1011"><a href="#cb13-1011" aria-hidden="true" tabindex="-1"></a>We further check for any remaining missing values after processing and confirms time continuity to detect any frame drops or temporal misalignments. </span>
<span id="cb13-1012"><a href="#cb13-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1013"><a href="#cb13-1013" aria-hidden="true" tabindex="-1"></a>The output of this script is a timeseries matrix for each video, which contains the time in seconds and the calculated variables. The timeseries matrices are saved in the <span class="in">`./data_timeseries_afterSTEP2/`</span> folder. The code below is the script <span class="in">`STEP2_process_timeseries.py`</span> that you can run to process the raw pose data.</span>
<span id="cb13-1014"><a href="#cb13-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1015"><a href="#cb13-1015" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb13-1016"><a href="#cb13-1016" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-1017"><a href="#cb13-1017" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-1018"><a href="#cb13-1018" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb13-1019"><a href="#cb13-1019" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-1020"><a href="#cb13-1020" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb13-1021"><a href="#cb13-1021" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb13-1022"><a href="#cb13-1022" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bisect <span class="im">import</span> bisect_left</span>
<span id="cb13-1023"><a href="#cb13-1023" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.signal <span class="im">import</span> savgol_filter</span>
<span id="cb13-1024"><a href="#cb13-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1025"><a href="#cb13-1025" aria-hidden="true" tabindex="-1"></a><span class="co"># Path Definitions</span></span>
<span id="cb13-1026"><a href="#cb13-1026" aria-hidden="true" tabindex="-1"></a>INPUT_LAYER1_PATH <span class="op">=</span> <span class="st">'../data_tracked_afterSTEP1/'</span>  <span class="co"># Input directory containing tracked keypoint data from STEP1</span></span>
<span id="cb13-1027"><a href="#cb13-1027" aria-hidden="true" tabindex="-1"></a>VIDEO_PATH <span class="op">=</span> <span class="st">"../data_raw/"</span>                        <span class="co"># Raw video files directory</span></span>
<span id="cb13-1028"><a href="#cb13-1028" aria-hidden="true" tabindex="-1"></a>OUTPUT_PATH <span class="op">=</span> <span class="st">'../data_timeseries_afterSTEP2/'</span>     <span class="co"># Output directory for processed timeseries data</span></span>
<span id="cb13-1029"><a href="#cb13-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1030"><a href="#cb13-1030" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable Explanations:</span></span>
<span id="cb13-1031"><a href="#cb13-1031" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb13-1032"><a href="#cb13-1032" aria-hidden="true" tabindex="-1"></a><span class="co"># Positional Variables:</span></span>
<span id="cb13-1033"><a href="#cb13-1033" aria-hidden="true" tabindex="-1"></a><span class="co"># - x, y: 2D coordinates in the image frame</span></span>
<span id="cb13-1034"><a href="#cb13-1034" aria-hidden="true" tabindex="-1"></a><span class="co"># - x_min, x_max, y_min, y_max: Bounding box coordinates for a person</span></span>
<span id="cb13-1035"><a href="#cb13-1035" aria-hidden="true" tabindex="-1"></a><span class="co"># - centroid_x, centroid_y: Center point of a person's bounding box</span></span>
<span id="cb13-1036"><a href="#cb13-1036" aria-hidden="true" tabindex="-1"></a><span class="co"># - com_x, com_y: Center of mass for a person (average of upper body keypoint positions)</span></span>
<span id="cb13-1037"><a href="#cb13-1037" aria-hidden="true" tabindex="-1"></a><span class="co"># - shoulder_midpoint_*: Midpoint between left and right shoulders for each person (p1, p2)</span></span>
<span id="cb13-1038"><a href="#cb13-1038" aria-hidden="true" tabindex="-1"></a><span class="co"># - wrist_left_*, wrist_right_*: Positions of left and right wrists for each person (p1, p2)</span></span>
<span id="cb13-1039"><a href="#cb13-1039" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb13-1040"><a href="#cb13-1040" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance Variables:</span></span>
<span id="cb13-1041"><a href="#cb13-1041" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance: Euclidean distance between the centroids of both people</span></span>
<span id="cb13-1042"><a href="#cb13-1042" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance_com: Euclidean distance between centers of mass of both people</span></span>
<span id="cb13-1043"><a href="#cb13-1043" aria-hidden="true" tabindex="-1"></a><span class="co"># - distance_shoulder_midpoint: Distance between shoulder midpoints of both people</span></span>
<span id="cb13-1044"><a href="#cb13-1044" aria-hidden="true" tabindex="-1"></a><span class="co"># - *_speed: Euclidean speed of different body parts (calculated from position differences)</span></span>
<span id="cb13-1045"><a href="#cb13-1045" aria-hidden="true" tabindex="-1"></a><span class="co"># - *_speed_smooth: Smoothed version of speed using Savitzky-Golay filter</span></span>
<span id="cb13-1046"><a href="#cb13-1046" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb13-1047"><a href="#cb13-1047" aria-hidden="true" tabindex="-1"></a><span class="co"># Movement Analysis:</span></span>
<span id="cb13-1048"><a href="#cb13-1048" aria-hidden="true" tabindex="-1"></a><span class="co"># - p1_com_approach_pos, p2_com_approach_pos: Position of each person's COM relative to their</span></span>
<span id="cb13-1049"><a href="#cb13-1049" aria-hidden="true" tabindex="-1"></a><span class="co">#   initial position, projected onto the connecting line between people. Positive values </span></span>
<span id="cb13-1050"><a href="#cb13-1050" aria-hidden="true" tabindex="-1"></a><span class="co">#   indicate movement toward the other person.</span></span>
<span id="cb13-1051"><a href="#cb13-1051" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb13-1052"><a href="#cb13-1052" aria-hidden="true" tabindex="-1"></a><span class="co"># Tracking Status:</span></span>
<span id="cb13-1053"><a href="#cb13-1053" aria-hidden="true" tabindex="-1"></a><span class="co"># - both_tracked: Boolean indicating if both people are tracked in the current frame</span></span>
<span id="cb13-1054"><a href="#cb13-1054" aria-hidden="true" tabindex="-1"></a><span class="co"># - single_tracked: Boolean indicating if only one person is tracked in the current frame</span></span>
<span id="cb13-1055"><a href="#cb13-1055" aria-hidden="true" tabindex="-1"></a><span class="co"># =====================================================</span></span>
<span id="cb13-1056"><a href="#cb13-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1057"><a href="#cb13-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1058"><a href="#cb13-1058" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> frame_to_time(ts, fps):</span>
<span id="cb13-1059"><a href="#cb13-1059" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert frame numbers to time in seconds"""</span></span>
<span id="cb13-1060"><a href="#cb13-1060" aria-hidden="true" tabindex="-1"></a>    ts[<span class="st">"time"</span>] <span class="op">=</span> [row[<span class="dv">1</span>][<span class="st">"frame"</span>] <span class="op">/</span> fps <span class="cf">for</span> row <span class="kw">in</span> ts.iterrows()]</span>
<span id="cb13-1061"><a href="#cb13-1061" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts</span>
<span id="cb13-1062"><a href="#cb13-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1063"><a href="#cb13-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1064"><a href="#cb13-1064" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> take_closest(myList, myNumber):</span>
<span id="cb13-1065"><a href="#cb13-1065" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-1066"><a href="#cb13-1066" aria-hidden="true" tabindex="-1"></a><span class="co">    Assumes myList is sorted. Returns closest value to myNumber.</span></span>
<span id="cb13-1067"><a href="#cb13-1067" aria-hidden="true" tabindex="-1"></a><span class="co">    If two numbers are equally close, return the smallest number.</span></span>
<span id="cb13-1068"><a href="#cb13-1068" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-1069"><a href="#cb13-1069" aria-hidden="true" tabindex="-1"></a>    pos <span class="op">=</span> bisect_left(myList, myNumber)</span>
<span id="cb13-1070"><a href="#cb13-1070" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb13-1071"><a href="#cb13-1071" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> myList[<span class="dv">0</span>]</span>
<span id="cb13-1072"><a href="#cb13-1072" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos <span class="op">==</span> <span class="bu">len</span>(myList):</span>
<span id="cb13-1073"><a href="#cb13-1073" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> myList[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb13-1074"><a href="#cb13-1074" aria-hidden="true" tabindex="-1"></a>    before <span class="op">=</span> myList[pos <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb13-1075"><a href="#cb13-1075" aria-hidden="true" tabindex="-1"></a>    after <span class="op">=</span> myList[pos]</span>
<span id="cb13-1076"><a href="#cb13-1076" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> after <span class="op">-</span> myNumber <span class="op">&lt;</span> myNumber <span class="op">-</span> before:</span>
<span id="cb13-1077"><a href="#cb13-1077" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> after</span>
<span id="cb13-1078"><a href="#cb13-1078" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-1079"><a href="#cb13-1079" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> before</span>
<span id="cb13-1080"><a href="#cb13-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1081"><a href="#cb13-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1082"><a href="#cb13-1082" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_left_right(ts):</span>
<span id="cb13-1083"><a href="#cb13-1083" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Assign person IDs (0 or 1) based on x-position in the frame"""</span></span>
<span id="cb13-1084"><a href="#cb13-1084" aria-hidden="true" tabindex="-1"></a>    min_x <span class="op">=</span> np.<span class="bu">min</span>([val <span class="cf">for</span> val <span class="kw">in</span> ts[<span class="st">'x'</span>] <span class="cf">if</span> val <span class="op">!=</span> <span class="dv">0</span>])</span>
<span id="cb13-1085"><a href="#cb13-1085" aria-hidden="true" tabindex="-1"></a>    max_x <span class="op">=</span> np.<span class="bu">max</span>([val <span class="cf">for</span> val <span class="kw">in</span> ts[<span class="st">'x'</span>] <span class="cf">if</span> val <span class="op">!=</span> <span class="dv">0</span>])</span>
<span id="cb13-1086"><a href="#cb13-1086" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, row <span class="kw">in</span> ts.iterrows():</span>
<span id="cb13-1087"><a href="#cb13-1087" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'x'</span>] <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># Skip untracked points</span></span>
<span id="cb13-1088"><a href="#cb13-1088" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb13-1089"><a href="#cb13-1089" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> take_closest([min_x, max_x], row[<span class="st">'x'</span>]) <span class="op">==</span> min_x:</span>
<span id="cb13-1090"><a href="#cb13-1090" aria-hidden="true" tabindex="-1"></a>            ts.loc[index, <span class="st">'person'</span>] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Left person</span></span>
<span id="cb13-1091"><a href="#cb13-1091" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-1092"><a href="#cb13-1092" aria-hidden="true" tabindex="-1"></a>            ts.loc[index, <span class="st">'person'</span>] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Right person</span></span>
<span id="cb13-1093"><a href="#cb13-1093" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ts</span>
<span id="cb13-1094"><a href="#cb13-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1095"><a href="#cb13-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1096"><a href="#cb13-1096" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_time_data(ts):</span>
<span id="cb13-1097"><a href="#cb13-1097" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate statistics for tracked people using upper body keypoints"""</span></span>
<span id="cb13-1098"><a href="#cb13-1098" aria-hidden="true" tabindex="-1"></a>    ts_upper <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>] <span class="op">&lt;</span> <span class="dv">11</span>]  <span class="co"># Filter to upper body keypoints only</span></span>
<span id="cb13-1099"><a href="#cb13-1099" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1100"><a href="#cb13-1100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate stats per person and time</span></span>
<span id="cb13-1101"><a href="#cb13-1101" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> ts_upper.groupby([<span class="st">'time'</span>, <span class="st">'person'</span>]).agg({</span>
<span id="cb13-1102"><a href="#cb13-1102" aria-hidden="true" tabindex="-1"></a>        <span class="st">'x'</span>: [<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>],</span>
<span id="cb13-1103"><a href="#cb13-1103" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y'</span>: [<span class="st">'min'</span>, <span class="st">'max'</span>, <span class="st">'mean'</span>]</span>
<span id="cb13-1104"><a href="#cb13-1104" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb13-1105"><a href="#cb13-1105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1106"><a href="#cb13-1106" aria-hidden="true" tabindex="-1"></a>    stats.columns <span class="op">=</span> [<span class="st">'time'</span>, <span class="st">'person'</span>, <span class="st">'x_min'</span>, <span class="st">'x_max'</span>, <span class="st">'com_x'</span>, <span class="st">'y_min'</span>, <span class="st">'y_max'</span>, <span class="st">'com_y'</span>]</span>
<span id="cb13-1107"><a href="#cb13-1107" aria-hidden="true" tabindex="-1"></a>    stats[<span class="st">'centroid_x'</span>] <span class="op">=</span> (stats[<span class="st">'x_min'</span>] <span class="op">+</span> stats[<span class="st">'x_max'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb13-1108"><a href="#cb13-1108" aria-hidden="true" tabindex="-1"></a>    stats[<span class="st">'centroid_y'</span>] <span class="op">=</span> (stats[<span class="st">'y_min'</span>] <span class="op">+</span> stats[<span class="st">'y_max'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb13-1109"><a href="#cb13-1109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1110"><a href="#cb13-1110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stats</span>
<span id="cb13-1111"><a href="#cb13-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1112"><a href="#cb13-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1113"><a href="#cb13-1113" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_people_data_vectorized(ts, stats):</span>
<span id="cb13-1114"><a href="#cb13-1114" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-1115"><a href="#cb13-1115" aria-hidden="true" tabindex="-1"></a><span class="co">    Process keypoint data to calculate relative positions and distances.</span></span>
<span id="cb13-1116"><a href="#cb13-1116" aria-hidden="true" tabindex="-1"></a><span class="co">    Preserves time alignment and handles COM/centroid assignment.</span></span>
<span id="cb13-1117"><a href="#cb13-1117" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-1118"><a href="#cb13-1118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all unique times from the original data</span></span>
<span id="cb13-1119"><a href="#cb13-1119" aria-hidden="true" tabindex="-1"></a>    all_times <span class="op">=</span> <span class="bu">sorted</span>(ts[<span class="st">'time'</span>].unique())</span>
<span id="cb13-1120"><a href="#cb13-1120" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>all_times)</span>
<span id="cb13-1121"><a href="#cb13-1121" aria-hidden="true" tabindex="-1"></a>    result.index.name <span class="op">=</span> <span class="st">'time'</span></span>
<span id="cb13-1122"><a href="#cb13-1122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1123"><a href="#cb13-1123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process shoulders first (keypoints 5 and 6)</span></span>
<span id="cb13-1124"><a href="#cb13-1124" aria-hidden="true" tabindex="-1"></a>    shoulders <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>].isin([<span class="dv">5</span>, <span class="dv">6</span>])].groupby([<span class="st">'time'</span>, <span class="st">'person'</span>]).agg({</span>
<span id="cb13-1125"><a href="#cb13-1125" aria-hidden="true" tabindex="-1"></a>        <span class="st">'x'</span>: <span class="st">'mean'</span>,</span>
<span id="cb13-1126"><a href="#cb13-1126" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y'</span>: <span class="st">'mean'</span></span>
<span id="cb13-1127"><a href="#cb13-1127" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb13-1128"><a href="#cb13-1128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1129"><a href="#cb13-1129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process wrists (keypoints 7 and 8)</span></span>
<span id="cb13-1130"><a href="#cb13-1130" aria-hidden="true" tabindex="-1"></a>    wrists <span class="op">=</span> ts[ts[<span class="st">'keypoint'</span>].isin([<span class="dv">7</span>, <span class="dv">8</span>])].pivot_table(</span>
<span id="cb13-1131"><a href="#cb13-1131" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="st">'time'</span>, <span class="st">'person'</span>],</span>
<span id="cb13-1132"><a href="#cb13-1132" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span><span class="st">'keypoint'</span>,</span>
<span id="cb13-1133"><a href="#cb13-1133" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[<span class="st">'x'</span>, <span class="st">'y'</span>]</span>
<span id="cb13-1134"><a href="#cb13-1134" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb13-1135"><a href="#cb13-1135" aria-hidden="true" tabindex="-1"></a>    wrists.columns <span class="op">=</span> [<span class="st">'time'</span>, <span class="st">'person'</span>, <span class="st">'left_x'</span>, <span class="st">'right_x'</span>, <span class="st">'left_y'</span>, <span class="st">'right_y'</span>]</span>
<span id="cb13-1136"><a href="#cb13-1136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1137"><a href="#cb13-1137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get person-specific data</span></span>
<span id="cb13-1138"><a href="#cb13-1138" aria-hidden="true" tabindex="-1"></a>    p0_stats <span class="op">=</span> stats[stats[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">0</span>].set_index(<span class="st">'time'</span>)</span>
<span id="cb13-1139"><a href="#cb13-1139" aria-hidden="true" tabindex="-1"></a>    p1_stats <span class="op">=</span> stats[stats[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">1</span>].set_index(<span class="st">'time'</span>)</span>
<span id="cb13-1140"><a href="#cb13-1140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1141"><a href="#cb13-1141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process distances where both people exist</span></span>
<span id="cb13-1142"><a href="#cb13-1142" aria-hidden="true" tabindex="-1"></a>    common_times <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>(p0_stats.index) <span class="op">&amp;</span> <span class="bu">set</span>(p1_stats.index))</span>
<span id="cb13-1143"><a href="#cb13-1143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> common_times:  <span class="co"># Only calculate if we have common times</span></span>
<span id="cb13-1144"><a href="#cb13-1144" aria-hidden="true" tabindex="-1"></a>        result.loc[common_times, <span class="st">'distance'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb13-1145"><a href="#cb13-1145" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'centroid_x'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'centroid_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb13-1146"><a href="#cb13-1146" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'centroid_y'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'centroid_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb13-1147"><a href="#cb13-1147" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-1148"><a href="#cb13-1148" aria-hidden="true" tabindex="-1"></a>        result.loc[common_times, <span class="st">'distance_com'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb13-1149"><a href="#cb13-1149" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'com_x'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'com_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb13-1150"><a href="#cb13-1150" aria-hidden="true" tabindex="-1"></a>            (p0_stats.loc[common_times, <span class="st">'com_y'</span>] <span class="op">-</span> p1_stats.loc[common_times, <span class="st">'com_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb13-1151"><a href="#cb13-1151" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-1152"><a href="#cb13-1152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1153"><a href="#cb13-1153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process shoulders per person</span></span>
<span id="cb13-1154"><a href="#cb13-1154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> person, prefix <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'p1'</span>), (<span class="dv">1</span>, <span class="st">'p2'</span>)]:</span>
<span id="cb13-1155"><a href="#cb13-1155" aria-hidden="true" tabindex="-1"></a>        s_person <span class="op">=</span> shoulders[shoulders[<span class="st">'person'</span>] <span class="op">==</span> person].set_index(<span class="st">'time'</span>)</span>
<span id="cb13-1156"><a href="#cb13-1156" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'shoulder_midpoint_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> s_person[<span class="st">'x'</span>]</span>
<span id="cb13-1157"><a href="#cb13-1157" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'shoulder_midpoint_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> s_person[<span class="st">'y'</span>]</span>
<span id="cb13-1158"><a href="#cb13-1158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1159"><a href="#cb13-1159" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate shoulder midpoint distance where possible</span></span>
<span id="cb13-1160"><a href="#cb13-1160" aria-hidden="true" tabindex="-1"></a>    shoulder_cols <span class="op">=</span> [<span class="st">'shoulder_midpoint_p1_x'</span>, <span class="st">'shoulder_midpoint_p2_x'</span>,</span>
<span id="cb13-1161"><a href="#cb13-1161" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'shoulder_midpoint_p1_y'</span>, <span class="st">'shoulder_midpoint_p2_y'</span>]</span>
<span id="cb13-1162"><a href="#cb13-1162" aria-hidden="true" tabindex="-1"></a>    shoulder_mask <span class="op">=</span> result[shoulder_cols].notna().<span class="bu">all</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-1163"><a href="#cb13-1163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> shoulder_mask.<span class="bu">any</span>():</span>
<span id="cb13-1164"><a href="#cb13-1164" aria-hidden="true" tabindex="-1"></a>        result.loc[shoulder_mask, <span class="st">'distance_shoulder_midpoint'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb13-1165"><a href="#cb13-1165" aria-hidden="true" tabindex="-1"></a>            (result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p1_x'</span>] <span class="op">-</span> result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p2_x'</span>])<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb13-1166"><a href="#cb13-1166" aria-hidden="true" tabindex="-1"></a>            (result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p1_y'</span>] <span class="op">-</span> result.loc[shoulder_mask, <span class="st">'shoulder_midpoint_p2_y'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb13-1167"><a href="#cb13-1167" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-1168"><a href="#cb13-1168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1169"><a href="#cb13-1169" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process wrists per person and add COM/centroid</span></span>
<span id="cb13-1170"><a href="#cb13-1170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> person, prefix <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'p1'</span>), (<span class="dv">1</span>, <span class="st">'p2'</span>)]:</span>
<span id="cb13-1171"><a href="#cb13-1171" aria-hidden="true" tabindex="-1"></a>        w_person <span class="op">=</span> wrists[wrists[<span class="st">'person'</span>] <span class="op">==</span> person].set_index(<span class="st">'time'</span>)</span>
<span id="cb13-1172"><a href="#cb13-1172" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_left_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> w_person[<span class="st">'left_x'</span>]</span>
<span id="cb13-1173"><a href="#cb13-1173" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_left_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> w_person[<span class="st">'left_y'</span>]</span>
<span id="cb13-1174"><a href="#cb13-1174" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_right_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> w_person[<span class="st">'right_x'</span>]</span>
<span id="cb13-1175"><a href="#cb13-1175" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'wrist_right_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> w_person[<span class="st">'right_y'</span>]</span>
<span id="cb13-1176"><a href="#cb13-1176" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1177"><a href="#cb13-1177" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the correct stats object based on person ID</span></span>
<span id="cb13-1178"><a href="#cb13-1178" aria-hidden="true" tabindex="-1"></a>        person_stats <span class="op">=</span> p0_stats <span class="cf">if</span> person <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> p1_stats</span>
<span id="cb13-1179"><a href="#cb13-1179" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-1180"><a href="#cb13-1180" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add com and centroid with the correct stats object</span></span>
<span id="cb13-1181"><a href="#cb13-1181" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'com_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> person_stats[<span class="st">'com_x'</span>]</span>
<span id="cb13-1182"><a href="#cb13-1182" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'com_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> person_stats[<span class="st">'com_y'</span>]</span>
<span id="cb13-1183"><a href="#cb13-1183" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'centroid_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_x'</span>] <span class="op">=</span> person_stats[<span class="st">'centroid_x'</span>]</span>
<span id="cb13-1184"><a href="#cb13-1184" aria-hidden="true" tabindex="-1"></a>        result[<span class="ss">f'centroid_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_y'</span>] <span class="op">=</span> person_stats[<span class="st">'centroid_y'</span>]</span>
<span id="cb13-1185"><a href="#cb13-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1186"><a href="#cb13-1186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add tracking quality indicators using original data</span></span>
<span id="cb13-1187"><a href="#cb13-1187" aria-hidden="true" tabindex="-1"></a>    person_counts <span class="op">=</span> ts.groupby(<span class="st">'time'</span>)[<span class="st">'person'</span>].nunique()</span>
<span id="cb13-1188"><a href="#cb13-1188" aria-hidden="true" tabindex="-1"></a>    result[<span class="st">'both_tracked'</span>] <span class="op">=</span> result.index.<span class="bu">map</span>(<span class="kw">lambda</span> x: person_counts.get(x, <span class="dv">0</span>) <span class="op">==</span> <span class="dv">2</span>)</span>
<span id="cb13-1189"><a href="#cb13-1189" aria-hidden="true" tabindex="-1"></a>    result[<span class="st">'single_tracked'</span>] <span class="op">=</span> result.index.<span class="bu">map</span>(<span class="kw">lambda</span> x: person_counts.get(x, <span class="dv">0</span>) <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb13-1190"><a href="#cb13-1190" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1191"><a href="#cb13-1191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb13-1192"><a href="#cb13-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1193"><a href="#cb13-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1194"><a href="#cb13-1194" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_proximity_approach(timeseries_data):</span>
<span id="cb13-1195"><a href="#cb13-1195" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-1196"><a href="#cb13-1196" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate each person's position relative to their initial position,</span></span>
<span id="cb13-1197"><a href="#cb13-1197" aria-hidden="true" tabindex="-1"></a><span class="co">    projecting movement onto the current connecting line between people.</span></span>
<span id="cb13-1198"><a href="#cb13-1198" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-1199"><a href="#cb13-1199" aria-hidden="true" tabindex="-1"></a><span class="co">    This handles rotation and changing spatial relationships between people.</span></span>
<span id="cb13-1200"><a href="#cb13-1200" aria-hidden="true" tabindex="-1"></a><span class="co">    Positive values indicate movement toward the other person from initial position.</span></span>
<span id="cb13-1201"><a href="#cb13-1201" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-1202"><a href="#cb13-1202" aria-hidden="true" tabindex="-1"></a><span class="co">    The reference positions are only established when both people are detected.</span></span>
<span id="cb13-1203"><a href="#cb13-1203" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-1204"><a href="#cb13-1204" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create columns for our measurements</span></span>
<span id="cb13-1205"><a href="#cb13-1205" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'p1_com_approach_pos'</span> <span class="kw">not</span> <span class="kw">in</span> timeseries_data.columns:</span>
<span id="cb13-1206"><a href="#cb13-1206" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> np.nan</span>
<span id="cb13-1207"><a href="#cb13-1207" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'p2_com_approach_pos'</span> <span class="kw">not</span> <span class="kw">in</span> timeseries_data.columns:</span>
<span id="cb13-1208"><a href="#cb13-1208" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> np.nan</span>
<span id="cb13-1209"><a href="#cb13-1209" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1210"><a href="#cb13-1210" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort data by time</span></span>
<span id="cb13-1211"><a href="#cb13-1211" aria-hidden="true" tabindex="-1"></a>    sorted_data <span class="op">=</span> timeseries_data.sort_values(<span class="st">'time'</span>)</span>
<span id="cb13-1212"><a href="#cb13-1212" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1213"><a href="#cb13-1213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find first valid frame to establish reference positions</span></span>
<span id="cb13-1214"><a href="#cb13-1214" aria-hidden="true" tabindex="-1"></a>    reference_p1_pos <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-1215"><a href="#cb13-1215" aria-hidden="true" tabindex="-1"></a>    reference_p2_pos <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-1216"><a href="#cb13-1216" aria-hidden="true" tabindex="-1"></a>    reference_distance <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-1217"><a href="#cb13-1217" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1218"><a href="#cb13-1218" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First pass: find reference frame where both people are detected</span></span>
<span id="cb13-1219"><a href="#cb13-1219" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> sorted_data.iterrows():</span>
<span id="cb13-1220"><a href="#cb13-1220" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip rows with NaN values or where both_tracked is False</span></span>
<span id="cb13-1221"><a href="#cb13-1221" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (np.isnan(row[<span class="st">'com_p1_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p1_y'</span>]) <span class="kw">or</span> </span>
<span id="cb13-1222"><a href="#cb13-1222" aria-hidden="true" tabindex="-1"></a>            np.isnan(row[<span class="st">'com_p2_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p2_y'</span>]) <span class="kw">or</span></span>
<span id="cb13-1223"><a href="#cb13-1223" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'both_tracked'</span> <span class="kw">in</span> row.index <span class="kw">and</span> row[<span class="st">'both_tracked'</span>] <span class="op">==</span> <span class="va">False</span>)):</span>
<span id="cb13-1224"><a href="#cb13-1224" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb13-1225"><a href="#cb13-1225" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-1226"><a href="#cb13-1226" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get positions for this frame</span></span>
<span id="cb13-1227"><a href="#cb13-1227" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> np.array([row[<span class="st">'com_p1_x'</span>], row[<span class="st">'com_p1_y'</span>]])</span>
<span id="cb13-1228"><a href="#cb13-1228" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> np.array([row[<span class="st">'com_p2_x'</span>], row[<span class="st">'com_p2_y'</span>]])</span>
<span id="cb13-1229"><a href="#cb13-1229" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1230"><a href="#cb13-1230" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate connecting vector</span></span>
<span id="cb13-1231"><a href="#cb13-1231" aria-hidden="true" tabindex="-1"></a>        connect_vector <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb13-1232"><a href="#cb13-1232" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> np.linalg.norm(connect_vector)</span>
<span id="cb13-1233"><a href="#cb13-1233" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1234"><a href="#cb13-1234" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> distance <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-1235"><a href="#cb13-1235" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We found a valid reference frame</span></span>
<span id="cb13-1236"><a href="#cb13-1236" aria-hidden="true" tabindex="-1"></a>            reference_p1_pos <span class="op">=</span> p1_pos.copy()</span>
<span id="cb13-1237"><a href="#cb13-1237" aria-hidden="true" tabindex="-1"></a>            reference_p2_pos <span class="op">=</span> p2_pos.copy()</span>
<span id="cb13-1238"><a href="#cb13-1238" aria-hidden="true" tabindex="-1"></a>            reference_distance <span class="op">=</span> distance</span>
<span id="cb13-1239"><a href="#cb13-1239" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Reference frame established at time=</span><span class="sc">{</span>row[<span class="st">'time'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-1240"><a href="#cb13-1240" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference p1_pos: </span><span class="sc">{</span>reference_p1_pos<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-1241"><a href="#cb13-1241" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference p2_pos: </span><span class="sc">{</span>reference_p2_pos<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-1242"><a href="#cb13-1242" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Reference distance: </span><span class="sc">{</span>reference_distance<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-1243"><a href="#cb13-1243" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb13-1244"><a href="#cb13-1244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1245"><a href="#cb13-1245" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> reference_p1_pos <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb13-1246"><a href="#cb13-1246" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"ERROR: Could not establish a reference frame. No valid frames found with both people detected."</span>)</span>
<span id="cb13-1247"><a href="#cb13-1247" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> timeseries_data</span>
<span id="cb13-1248"><a href="#cb13-1248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1249"><a href="#cb13-1249" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Second pass: calculate projected positions for all frames</span></span>
<span id="cb13-1250"><a href="#cb13-1250" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> sorted_data.iterrows():</span>
<span id="cb13-1251"><a href="#cb13-1251" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip rows with NaN values</span></span>
<span id="cb13-1252"><a href="#cb13-1252" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (np.isnan(row[<span class="st">'com_p1_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p1_y'</span>]) <span class="kw">or</span> </span>
<span id="cb13-1253"><a href="#cb13-1253" aria-hidden="true" tabindex="-1"></a>            np.isnan(row[<span class="st">'com_p2_x'</span>]) <span class="kw">or</span> np.isnan(row[<span class="st">'com_p2_y'</span>])):</span>
<span id="cb13-1254"><a href="#cb13-1254" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb13-1255"><a href="#cb13-1255" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-1256"><a href="#cb13-1256" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get current positions</span></span>
<span id="cb13-1257"><a href="#cb13-1257" aria-hidden="true" tabindex="-1"></a>        p1_pos <span class="op">=</span> np.array([row[<span class="st">'com_p1_x'</span>], row[<span class="st">'com_p1_y'</span>]])</span>
<span id="cb13-1258"><a href="#cb13-1258" aria-hidden="true" tabindex="-1"></a>        p2_pos <span class="op">=</span> np.array([row[<span class="st">'com_p2_x'</span>], row[<span class="st">'com_p2_y'</span>]])</span>
<span id="cb13-1259"><a href="#cb13-1259" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1260"><a href="#cb13-1260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate current connecting vector and direction</span></span>
<span id="cb13-1261"><a href="#cb13-1261" aria-hidden="true" tabindex="-1"></a>        current_connect <span class="op">=</span> p2_pos <span class="op">-</span> p1_pos</span>
<span id="cb13-1262"><a href="#cb13-1262" aria-hidden="true" tabindex="-1"></a>        current_distance <span class="op">=</span> np.linalg.norm(current_connect)</span>
<span id="cb13-1263"><a href="#cb13-1263" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1264"><a href="#cb13-1264" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip frames where people are at the same position</span></span>
<span id="cb13-1265"><a href="#cb13-1265" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_distance <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb13-1266"><a href="#cb13-1266" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb13-1267"><a href="#cb13-1267" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-1268"><a href="#cb13-1268" aria-hidden="true" tabindex="-1"></a>        current_direction <span class="op">=</span> current_connect <span class="op">/</span> current_distance</span>
<span id="cb13-1269"><a href="#cb13-1269" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1270"><a href="#cb13-1270" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate vector from reference position to current position</span></span>
<span id="cb13-1271"><a href="#cb13-1271" aria-hidden="true" tabindex="-1"></a>        p1_vector <span class="op">=</span> p1_pos <span class="op">-</span> reference_p1_pos</span>
<span id="cb13-1272"><a href="#cb13-1272" aria-hidden="true" tabindex="-1"></a>        p2_vector <span class="op">=</span> p2_pos <span class="op">-</span> reference_p2_pos</span>
<span id="cb13-1273"><a href="#cb13-1273" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1274"><a href="#cb13-1274" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Project these vectors onto the current connecting line</span></span>
<span id="cb13-1275"><a href="#cb13-1275" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Positive values mean moving toward the other person</span></span>
<span id="cb13-1276"><a href="#cb13-1276" aria-hidden="true" tabindex="-1"></a>        p1_projection <span class="op">=</span> np.dot(p1_vector, current_direction)</span>
<span id="cb13-1277"><a href="#cb13-1277" aria-hidden="true" tabindex="-1"></a>        p2_projection <span class="op">=</span> <span class="op">-</span>np.dot(p2_vector, <span class="op">-</span>current_direction)</span>
<span id="cb13-1278"><a href="#cb13-1278" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1279"><a href="#cb13-1279" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store values</span></span>
<span id="cb13-1280"><a href="#cb13-1280" aria-hidden="true" tabindex="-1"></a>        timeseries_data.loc[idx, <span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> p1_projection</span>
<span id="cb13-1281"><a href="#cb13-1281" aria-hidden="true" tabindex="-1"></a>        timeseries_data.loc[idx, <span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> p2_projection</span>
<span id="cb13-1282"><a href="#cb13-1282" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1283"><a href="#cb13-1283" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify results</span></span>
<span id="cb13-1284"><a href="#cb13-1284" aria-hidden="true" tabindex="-1"></a>    filled_p1 <span class="op">=</span> timeseries_data[<span class="st">'p1_com_approach_pos'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb13-1285"><a href="#cb13-1285" aria-hidden="true" tabindex="-1"></a>    filled_p2 <span class="op">=</span> timeseries_data[<span class="st">'p2_com_approach_pos'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb13-1286"><a href="#cb13-1286" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1287"><a href="#cb13-1287" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Frames with filled values - p1: </span><span class="sc">{</span>filled_p1<span class="sc">}</span><span class="ss">, p2: </span><span class="sc">{</span>filled_p2<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-1288"><a href="#cb13-1288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1289"><a href="#cb13-1289" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> timeseries_data</span>
<span id="cb13-1290"><a href="#cb13-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1291"><a href="#cb13-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1292"><a href="#cb13-1292" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb13-1293"><a href="#cb13-1293" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main processing function"""</span></span>
<span id="cb13-1294"><a href="#cb13-1294" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb13-1295"><a href="#cb13-1295" aria-hidden="true" tabindex="-1"></a>    os.makedirs(OUTPUT_PATH, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-1296"><a href="#cb13-1296" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1297"><a href="#cb13-1297" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all CSV files from layer 1 processing</span></span>
<span id="cb13-1298"><a href="#cb13-1298" aria-hidden="true" tabindex="-1"></a>    layer1_files <span class="op">=</span> glob.glob(INPUT_LAYER1_PATH <span class="op">+</span> <span class="st">'*.csv'</span>)</span>
<span id="cb13-1299"><a href="#cb13-1299" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-1300"><a href="#cb13-1300" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each file</span></span>
<span id="cb13-1301"><a href="#cb13-1301" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_path <span class="kw">in</span> layer1_files:</span>
<span id="cb13-1302"><a href="#cb13-1302" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract video name from file path</span></span>
<span id="cb13-1303"><a href="#cb13-1303" aria-hidden="true" tabindex="-1"></a>        vid_name <span class="op">=</span> os.path.basename(file_path).split(<span class="st">'_keypoints_data_layer1.csv'</span>)[<span class="dv">0</span>]</span>
<span id="cb13-1304"><a href="#cb13-1304" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Processing video: </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-1305"><a href="#cb13-1305" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1306"><a href="#cb13-1306" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if already processed</span></span>
<span id="cb13-1307"><a href="#cb13-1307" aria-hidden="true" tabindex="-1"></a>        output_file <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>OUTPUT_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">_processed_data_layer2.csv"</span></span>
<span id="cb13-1308"><a href="#cb13-1308" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(output_file):</span>
<span id="cb13-1309"><a href="#cb13-1309" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Already processed, skipping..."</span>)</span>
<span id="cb13-1310"><a href="#cb13-1310" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb13-1311"><a href="#cb13-1311" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-1312"><a href="#cb13-1312" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine video format and get FPS</span></span>
<span id="cb13-1313"><a href="#cb13-1313" aria-hidden="true" tabindex="-1"></a>        video_path <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-1314"><a href="#cb13-1314" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ext <span class="kw">in</span> [<span class="st">'.avi'</span>, <span class="st">'.mp4'</span>, <span class="st">'.mov'</span>]:</span>
<span id="cb13-1315"><a href="#cb13-1315" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> os.path.exists(<span class="ss">f"</span><span class="sc">{</span>VIDEO_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}{</span>ext<span class="sc">}</span><span class="ss">"</span>):</span>
<span id="cb13-1316"><a href="#cb13-1316" aria-hidden="true" tabindex="-1"></a>                video_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>VIDEO_PATH<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>vid_name<span class="sc">}{</span>ext<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb13-1317"><a href="#cb13-1317" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb13-1318"><a href="#cb13-1318" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-1319"><a href="#cb13-1319" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> video_path:</span>
<span id="cb13-1320"><a href="#cb13-1320" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Video file not found for </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-1321"><a href="#cb13-1321" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb13-1322"><a href="#cb13-1322" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-1323"><a href="#cb13-1323" aria-hidden="true" tabindex="-1"></a>        cap <span class="op">=</span> cv2.VideoCapture(video_path)</span>
<span id="cb13-1324"><a href="#cb13-1324" aria-hidden="true" tabindex="-1"></a>        fps <span class="op">=</span> cap.get(cv2.CAP_PROP_FPS)</span>
<span id="cb13-1325"><a href="#cb13-1325" aria-hidden="true" tabindex="-1"></a>        cap.release()</span>
<span id="cb13-1326"><a href="#cb13-1326" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Working on: </span><span class="sc">{</span>vid_name<span class="sc">}</span><span class="ss"> with fps = </span><span class="sc">{</span>fps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-1327"><a href="#cb13-1327" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1328"><a href="#cb13-1328" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Load and preprocess data</span></span>
<span id="cb13-1329"><a href="#cb13-1329" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> pd.read_csv(file_path)</span>
<span id="cb13-1330"><a href="#cb13-1330" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> frame_to_time(ts, fps<span class="op">=</span>fps)</span>
<span id="cb13-1331"><a href="#cb13-1331" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> assign_left_right(ts)</span>
<span id="cb13-1332"><a href="#cb13-1332" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1333"><a href="#cb13-1333" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate statistics</span></span>
<span id="cb13-1334"><a href="#cb13-1334" aria-hidden="true" tabindex="-1"></a>        stats <span class="op">=</span> process_time_data(ts)</span>
<span id="cb13-1335"><a href="#cb13-1335" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1336"><a href="#cb13-1336" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process tracked data</span></span>
<span id="cb13-1337"><a href="#cb13-1337" aria-hidden="true" tabindex="-1"></a>        processed_data <span class="op">=</span> process_people_data_vectorized(ts, stats)</span>
<span id="cb13-1338"><a href="#cb13-1338" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1339"><a href="#cb13-1339" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create final data frame</span></span>
<span id="cb13-1340"><a href="#cb13-1340" aria-hidden="true" tabindex="-1"></a>        bb_data <span class="op">=</span> pd.merge(</span>
<span id="cb13-1341"><a href="#cb13-1341" aria-hidden="true" tabindex="-1"></a>            stats, </span>
<span id="cb13-1342"><a href="#cb13-1342" aria-hidden="true" tabindex="-1"></a>            processed_data.reset_index(), </span>
<span id="cb13-1343"><a href="#cb13-1343" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">'time'</span>, </span>
<span id="cb13-1344"><a href="#cb13-1344" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">'outer'</span></span>
<span id="cb13-1345"><a href="#cb13-1345" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-1346"><a href="#cb13-1346" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1347"><a href="#cb13-1347" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract time series data (using person 0 as reference)</span></span>
<span id="cb13-1348"><a href="#cb13-1348" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> bb_data[bb_data[<span class="st">'person'</span>] <span class="op">==</span> <span class="dv">0</span>].copy()  <span class="co"># Make a copy to avoid SettingWithCopyWarning</span></span>
<span id="cb13-1349"><a href="#cb13-1349" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1350"><a href="#cb13-1350" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove unnecessary columns</span></span>
<span id="cb13-1351"><a href="#cb13-1351" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.drop(columns<span class="op">=</span><span class="st">'person'</span>)</span>
<span id="cb13-1352"><a href="#cb13-1352" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1353"><a href="#cb13-1353" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate desired time step based on FPS</span></span>
<span id="cb13-1354"><a href="#cb13-1354" aria-hidden="true" tabindex="-1"></a>        desired_time_step <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>fps</span>
<span id="cb13-1355"><a href="#cb13-1355" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1356"><a href="#cb13-1356" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Interpolate missing values</span></span>
<span id="cb13-1357"><a href="#cb13-1357" aria-hidden="true" tabindex="-1"></a>        nan_cols <span class="op">=</span> timeseries_data.columns[timeseries_data.isna().<span class="bu">any</span>()].tolist()</span>
<span id="cb13-1358"><a href="#cb13-1358" aria-hidden="true" tabindex="-1"></a>        timeseries_data[nan_cols] <span class="op">=</span> timeseries_data[nan_cols].interpolate()</span>
<span id="cb13-1359"><a href="#cb13-1359" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1360"><a href="#cb13-1360" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth distance with Savitzky-Golay filter</span></span>
<span id="cb13-1361"><a href="#cb13-1361" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'distance_smooth'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'distance'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb13-1362"><a href="#cb13-1362" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1363"><a href="#cb13-1363" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate and smooth wrist speeds</span></span>
<span id="cb13-1364"><a href="#cb13-1364" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> wrist <span class="kw">in</span> [<span class="st">'wrist_left_p1'</span>, <span class="st">'wrist_right_p1'</span>, <span class="st">'wrist_left_p2'</span>, <span class="st">'wrist_right_p2'</span>]:</span>
<span id="cb13-1365"><a href="#cb13-1365" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate speed as Euclidean distance between consecutive positions</span></span>
<span id="cb13-1366"><a href="#cb13-1366" aria-hidden="true" tabindex="-1"></a>            timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed'</span>] <span class="op">=</span> np.sqrt(</span>
<span id="cb13-1367"><a href="#cb13-1367" aria-hidden="true" tabindex="-1"></a>                timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_x'</span>].diff()<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_y'</span>].diff()<span class="op">**</span><span class="dv">2</span></span>
<span id="cb13-1368"><a href="#cb13-1368" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb13-1369"><a href="#cb13-1369" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-1370"><a href="#cb13-1370" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Apply Savitzky-Golay filter for smoothing</span></span>
<span id="cb13-1371"><a href="#cb13-1371" aria-hidden="true" tabindex="-1"></a>            timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed_smooth'</span>] <span class="op">=</span> savgol_filter(</span>
<span id="cb13-1372"><a href="#cb13-1372" aria-hidden="true" tabindex="-1"></a>                timeseries_data[<span class="ss">f'</span><span class="sc">{</span>wrist<span class="sc">}</span><span class="ss">_speed'</span>].values, <span class="dv">11</span>, <span class="dv">3</span></span>
<span id="cb13-1373"><a href="#cb13-1373" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb13-1374"><a href="#cb13-1374" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1375"><a href="#cb13-1375" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill NaN values before calculating proximity approach</span></span>
<span id="cb13-1376"><a href="#cb13-1376" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.fillna(method<span class="op">=</span><span class="st">'ffill'</span>)</span>
<span id="cb13-1377"><a href="#cb13-1377" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1378"><a href="#cb13-1378" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate proximity approach</span></span>
<span id="cb13-1379"><a href="#cb13-1379" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> calculate_proximity_approach(timeseries_data)</span>
<span id="cb13-1380"><a href="#cb13-1380" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1381"><a href="#cb13-1381" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill any remaining NaN values</span></span>
<span id="cb13-1382"><a href="#cb13-1382" aria-hidden="true" tabindex="-1"></a>        timeseries_data <span class="op">=</span> timeseries_data.fillna(method<span class="op">=</span><span class="st">'ffill'</span>)</span>
<span id="cb13-1383"><a href="#cb13-1383" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1384"><a href="#cb13-1384" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Smooth proximity approach values</span></span>
<span id="cb13-1385"><a href="#cb13-1385" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p1_com_approach_pos'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'p1_com_approach_pos'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb13-1386"><a href="#cb13-1386" aria-hidden="true" tabindex="-1"></a>        timeseries_data[<span class="st">'p2_com_approach_pos'</span>] <span class="op">=</span> savgol_filter(timeseries_data[<span class="st">'p2_com_approach_pos'</span>].values, <span class="dv">11</span>, <span class="dv">3</span>)</span>
<span id="cb13-1387"><a href="#cb13-1387" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1388"><a href="#cb13-1388" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for any remaining NaN values</span></span>
<span id="cb13-1389"><a href="#cb13-1389" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Checking for NaN values..."</span>)</span>
<span id="cb13-1390"><a href="#cb13-1390" aria-hidden="true" tabindex="-1"></a>        nan_counts <span class="op">=</span> timeseries_data.isna().<span class="bu">sum</span>()</span>
<span id="cb13-1391"><a href="#cb13-1391" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> nan_counts.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-1392"><a href="#cb13-1392" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Found NaN values after processing:"</span>)</span>
<span id="cb13-1393"><a href="#cb13-1393" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(nan_counts)</span>
<span id="cb13-1394"><a href="#cb13-1394" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-1395"><a href="#cb13-1395" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No NaN values found."</span>)</span>
<span id="cb13-1396"><a href="#cb13-1396" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1397"><a href="#cb13-1397" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save processed data</span></span>
<span id="cb13-1398"><a href="#cb13-1398" aria-hidden="true" tabindex="-1"></a>        timeseries_data.to_csv(output_file, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-1399"><a href="#cb13-1399" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-1400"><a href="#cb13-1400" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for time continuity</span></span>
<span id="cb13-1401"><a href="#cb13-1401" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Checking time continuity..."</span>)</span>
<span id="cb13-1402"><a href="#cb13-1402" aria-hidden="true" tabindex="-1"></a>        time_diffs <span class="op">=</span> np.array([<span class="bu">round</span>(val, <span class="dv">2</span>) <span class="cf">for</span> val <span class="kw">in</span> np.diff(timeseries_data[<span class="st">'time'</span>])])</span>
<span id="cb13-1403"><a href="#cb13-1403" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.<span class="bu">all</span>(time_diffs <span class="op">==</span> desired_time_step):</span>
<span id="cb13-1404"><a href="#cb13-1404" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Found gaps at times: </span><span class="sc">{</span>np<span class="sc">.</span>where(time_diffs <span class="op">!=</span> desired_time_step)[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-1405"><a href="#cb13-1405" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-1406"><a href="#cb13-1406" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No missing time points."</span>)</span>
<span id="cb13-1407"><a href="#cb13-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1408"><a href="#cb13-1408" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb13-1409"><a href="#cb13-1409" aria-hidden="true" tabindex="-1"></a>    main()</span>
<span id="cb13-1410"><a href="#cb13-1410" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-1411"><a href="#cb13-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1412"><a href="#cb13-1412" aria-hidden="true" tabindex="-1"></a>To provide an example of the data we plot here a timeseries of the resultant data.</span>
<span id="cb13-1413"><a href="#cb13-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1414"><a href="#cb13-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1415"><a href="#cb13-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1416"><a href="#cb13-1416" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 2: Summary feature extraction: Smoothness</span></span>
<span id="cb13-1417"><a href="#cb13-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1418"><a href="#cb13-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1419"><a href="#cb13-1419" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 3: Calculating feature data (e.g., jerkiness) from timeseries (Python)</span></span>
<span id="cb13-1420"><a href="#cb13-1420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1421"><a href="#cb13-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1422"><a href="#cb13-1422" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-settingup collapse="true"}</span>
<span id="cb13-1423"><a href="#cb13-1423" aria-hidden="true" tabindex="-1"></a><span class="fu">## DIY: Feature Extraction 🛠️</span></span>
<span id="cb13-1424"><a href="#cb13-1424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1425"><a href="#cb13-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1426"><a href="#cb13-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1427"><a href="#cb13-1427" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb13-1428"><a href="#cb13-1428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1429"><a href="#cb13-1429" aria-hidden="true" tabindex="-1"></a><span class="fu"># Step 4: Statistical analysis (e.g., jerkiness of proximity/approach/avoidance, or non-linear recurrence) (R)</span></span>
<span id="cb13-1430"><a href="#cb13-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1431"><a href="#cb13-1431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE, code_folding="hide"}</span></span>
<span id="cb13-1432"><a href="#cb13-1432" aria-hidden="true" tabindex="-1"></a><span class="co"># manually edited this CSV</span></span>
<span id="cb13-1433"><a href="#cb13-1433" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"C:/Users/wiltshir/GitHub/InterPerDynPipelineAnalysis/Re_ Behavioral Dynamics in Social Interactions AP_SI/smoothness_data_top_view_clean.csv"</span>) </span>
<span id="cb13-1434"><a href="#cb13-1434" aria-hidden="true" tabindex="-1"></a><span class="co">#data_cross_cultur&lt;-data[1:18,]</span></span>
<span id="cb13-1435"><a href="#cb13-1435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1436"><a href="#cb13-1436" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove a row</span></span>
<span id="cb13-1437"><a href="#cb13-1437" aria-hidden="true" tabindex="-1"></a>data<span class="ot">&lt;-</span> <span class="fu">subset</span>(data, data<span class="sc">$</span>videoID<span class="sc">!=</span><span class="st">"cop_b09 z góry"</span>)</span>
<span id="cb13-1438"><a href="#cb13-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1439"><a href="#cb13-1439" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a culture grouping variable</span></span>
<span id="cb13-1440"><a href="#cb13-1440" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>culture <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"góry$"</span>, data<span class="sc">$</span>videoID), <span class="st">"Yurakare"</span>,</span>
<span id="cb13-1441"><a href="#cb13-1441" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"kam_5$"</span>, data<span class="sc">$</span>videoID), <span class="st">"Polish"</span>, <span class="cn">NA</span>))</span>
<span id="cb13-1442"><a href="#cb13-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1443"><a href="#cb13-1443" aria-hidden="true" tabindex="-1"></a><span class="co"># Restructure data into long format</span></span>
<span id="cb13-1444"><a href="#cb13-1444" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb13-1445"><a href="#cb13-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1446"><a href="#cb13-1446" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb13-1447"><a href="#cb13-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1448"><a href="#cb13-1448" aria-hidden="true" tabindex="-1"></a>data_long <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb13-1449"><a href="#cb13-1449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(smoothness_p1_proximity, smoothness_p2_proximity),</span>
<span id="cb13-1450"><a href="#cb13-1450" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"person"</span>,</span>
<span id="cb13-1451"><a href="#cb13-1451" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"smoothness_value"</span>)</span>
<span id="cb13-1452"><a href="#cb13-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1453"><a href="#cb13-1453" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4) </span>
<span id="cb13-1454"><a href="#cb13-1454" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest) </span>
<span id="cb13-1455"><a href="#cb13-1455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1456"><a href="#cb13-1456" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(smoothness_value <span class="sc">~</span> culture <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> videoID), <span class="at">data =</span> data_long)</span>
<span id="cb13-1457"><a href="#cb13-1457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1458"><a href="#cb13-1458" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span>
<span id="cb13-1459"><a href="#cb13-1459" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-1460"><a href="#cb13-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1461"><a href="#cb13-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1462"><a href="#cb13-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1463"><a href="#cb13-1463" aria-hidden="true" tabindex="-1"></a>::: {.callout-note .callout-settingup collapse="true"}</span>
<span id="cb13-1464"><a href="#cb13-1464" aria-hidden="true" tabindex="-1"></a><span class="fu">## DIY: Analysis 🛠️</span></span>
<span id="cb13-1465"><a href="#cb13-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1466"><a href="#cb13-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1467"><a href="#cb13-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1468"><a href="#cb13-1468" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb13-1469"><a href="#cb13-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1470"><a href="#cb13-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-1471"><a href="#cb13-1471" aria-hidden="true" tabindex="-1"></a><span class="fu"># References</span></span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>